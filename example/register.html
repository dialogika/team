<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulir Rekrutmen Bertahap - Dialogika</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        .form-step { display: none; transition: all 0.4s ease-in-out; }
        .form-step-active { display: block; animation: fadeIn 0.5s; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .step-circle {
            width: 40px; height: 40px; border-radius: 50%; border: 2px solid #e2e8f0;
            display: flex; align-items: center; justify-content: center;
            background: white; color: #94a3b8; font-weight: bold; transition: all 0.3s;
        }
        .step-active .step-circle { border-color: #003366; background: #003366; color: white; }
        .step-completed .step-circle { border-color: #003366; background: #003366; color: white; }
        
        .input-field { border: 1px solid #e2e8f0; border-radius: 8px; padding: 10px 14px; width: 100%; transition: 0.2s; }
        .input-field:focus { outline: none; border-color: #003366; box-shadow: 0 0 0 3px rgba(0, 51, 102, 0.1); }
        label { font-weight: 500; color: #475569; font-size: 0.875rem; margin-bottom: 6px; display: block; }
    </style>
</head>
<body class="py-10 px-4">

    <div class="max-w-3xl mx-auto">
        <!-- Logo Header -->
        <div class="flex text-center justify-center mb-10">
            <img src="https://www.dialogika.co/assets/img/logo.webp" alt="Dialogika Logo" class="h-14 text-center">
        </div>
        <p class="text-2xl font-bold text-slate-800 text-center" style="margin-top: -30px;">Formulir Pendaftaran Internship di Dialogika</p>



        <!-- Progress Indicator -->
        <div class="flex justify-between items-center mb-10 relative">
            <!-- Progress Line -->
            <div class="absolute top-1/2 left-0 w-full h-0.5 bg-gray-200 -z-10 transform -translate-y-1/2"></div>
            
            <div class="step-item step-active relative" id="step-icon-1">
                <div class="step-circle">1</div>
                <p class="absolute -bottom-7 left-1/2 transform -translate-x-1/2 text-[10px] md:text-xs font-semibold uppercase tracking-wider text-slate-500">Info Umum</p>
            </div>
            <div class="step-item relative" id="step-icon-2">
                <div class="step-circle">2</div>
                <p class="absolute -bottom-7 left-1/2 transform -translate-x-1/2 text-[10px] md:text-xs font-semibold uppercase tracking-wider text-slate-500 text-center">Data Pribadi</p>
            </div>
            <div class="step-item relative" id="step-icon-3">
                <div class="step-circle">3</div>
                <p class="absolute -bottom-7 left-1/2 transform -translate-x-1/2 text-[10px] md:text-xs font-semibold uppercase tracking-wider text-slate-500">Dokumen</p>
            </div>
        </div>

        <!-- Card Form -->
        <div class="bg-white rounded-2xl shadow-xl p-8 mt-12">
            <form id="multiStepForm">
                
                <!-- TAHAP 1: INFORMASI UMUM -->
                <div class="form-step form-step-active">
                    <h2 class="text-xl font-bold text-slate-800 mb-6">Informasi Umum</h2>
                    <div class="grid grid-cols-1 gap-6">
                        <div>
                            <label>Mode</label>
                            <select class="input-field" id="candidateMode">
                                <option value="">Pilih mode</option>
                                <option value="WFO">WFO</option>
                                <option value="WFH">WFH</option>
                                <option value="Hybrid">Hybrid</option>
                            </select>
                        </div>
                        <div>
                            <label>Posisi</label>
                            <select class="input-field" id="candidatePosition">
                                <option value="">Pilih posisi</option>
                            </select>
                        </div>
                        <div>
                            <label>Platform</label>
                            <select class="input-field" id="candidatePlatform">
                                <option value="">Pilih platform</option>
                                <option value="Website Dialogika">Website Dialogika</option>
                                <option value="Website MSIB">Website MSIB</option>
                                <option value="LinkedIn">LinkedIn</option>
                                <option value="Instagram">Instagram</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- TAHAP 2: DATA PRIBADI -->
                <div class="form-step">
                    <h2 class="text-xl font-bold text-slate-800 mb-6">Data Pribadi & Kontak</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="md:col-span-1">
                            <label>Nama Lengkap</label>
                            <input type="text" class="input-field" id="candidateFullName" placeholder="Nama sesuai KTP">
                        </div>
                        <div>
                            <label>Foto Profil</label>
                            <input type="file" class="input-field text-sm" id="candidatePhoto">
                        </div>
                        <div class="md:col-span-2">
                            <label>Deskripsi Diri</label>
                            <textarea class="input-field h-24" id="candidateShortDescription" placeholder="Ceritakan singkat siapa Anda..."></textarea>
                        </div>
                        <div>
                            <label>Nomor WhatsApp</label>
                            <input type="tel" class="input-field" id="candidateWhatsapp" placeholder="0812xxxx">
                        </div>
                        <div>
                            <label>Email Aktif</label>
                            <input type="email" class="input-field" id="candidateEmail" placeholder="email@contoh.com">
                        </div>
                    </div>
                </div>

                <!-- TAHAP 3: DOKUMEN & MOTIVASI -->
                <div class="form-step">
                    <h2 class="text-xl font-bold text-slate-800 mb-6">Dokumen & Motivasi</h2>
                    <div class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label>Portofolio (Link/File)</label>
                                <input type="file" class="input-field" id="candidatePortfolio">
                            </div>
                            <div>
                                <label>Resume / CV</label>
                                <input type="file" class="input-field" id="candidateResume">
                            </div>
                        </div>
                        <div>
                            <label>Alasan Memilih Dialogika</label>
                            <textarea class="input-field h-24" id="candidateChoose"></textarea>
                        </div>
                        <div>
                            <label>Harapan Selama Magang</label>
                            <textarea class="input-field h-24" id="candidateHope"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Tombol Navigasi -->
                <div class="flex justify-between mt-10 pt-6 border-t border-slate-100">
                    <button type="button" id="prevBtn" onclick="changeStep(-1)" class="px-6 py-2.5 rounded-lg font-medium text-slate-500 hover:bg-slate-100 transition invisible">
                        Sebelumnya
                    </button>
                    <button type="button" id="nextBtn" onclick="changeStep(1)" class="px-8 py-2.5 bg-[#003366] text-white rounded-lg font-semibold hover:bg-[#002244] transition shadow-lg shadow-blue-900/20">
                        Selanjutnya
                    </button>
                </div>

            </form>
        </div>
        
        <p class="text-center text-slate-400 text-sm mt-8">Â© 2024 Dialogika Career Center</p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import {
            getFirestore,
            collection,
            addDoc,
            getDocs,
            serverTimestamp
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import {
            getStorage,
            ref as storageRef,
            uploadBytes,
            getDownloadURL
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDyzzEYbJkkl-N8snrQf14qvj8De4YliV0",
            authDomain: "pre-dialogika.firebaseapp.com",
            projectId: "pre-dialogika",
            storageBucket: "pre-dialogika.firebasestorage.app",
            messagingSenderId: "343771410480",
            appId: "1:343771410480:web:32881c9868522090237df5",
            measurementId: "G-SXN811P3N0"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);

        async function uploadFileToStorage(file, folder) {
            if (!file) return null;
            const safeFolder = folder || "uploads";
            const path = safeFolder + "/" + Date.now() + "-" + file.name;
            const fileRef = storageRef(storage, path);
            await uploadBytes(fileRef, file);
            const url = await getDownloadURL(fileRef);
            return url;
        }

        async function loadCandidatePositions() {
            const select = document.getElementById("candidatePosition");
            if (!select) return;
            try {
                select.innerHTML = '<option value="">Pilih posisi</option>';
                const snap = await getDocs(collection(db, "positions"));
                if (snap.empty) return;
                const options = [];
                snap.forEach(docSnap => {
                    const data = docSnap.data() || {};
                    const name = (data.name || "").toString().trim();
                    if (!name) return;
                    options.push({ id: docSnap.id, name });
                });
                options
                    .sort((a, b) => a.name.localeCompare(b.name, "id"))
                    .forEach(item => {
                        const opt = document.createElement("option");
                        opt.value = item.id;
                        opt.textContent = item.name;
                        select.appendChild(opt);
                    });
            } catch (e) {
                console.error("Failed to load candidate positions", e);
            }
        }

        window.db = db;
        window.collection = collection;
        window.addDoc = addDoc;
        window.serverTimestamp = serverTimestamp;
        window.storage = storage;
        window.storageRef = storageRef;
        window.uploadBytes = uploadBytes;
        window.getDownloadURL = getDownloadURL;
        window.uploadFileToStorage = uploadFileToStorage;
        window.loadCandidatePositions = loadCandidatePositions;

        loadCandidatePositions();
    </script>

    <script>
        let currentStep = 0;
        const steps = document.querySelectorAll(".form-step");
        const stepIcons = document.querySelectorAll(".step-item");
        const prevBtn = document.getElementById("prevBtn");
        const nextBtn = document.getElementById("nextBtn");

        function changeStep(n) {
            if (n === 1 && currentStep === steps.length - 1) {
                submitApplication();
                return;
            }

            steps[currentStep].classList.remove("form-step-active");
            stepIcons[currentStep].classList.remove("step-active");

            currentStep += n;

            if (currentStep < 0) currentStep = 0;
            if (currentStep >= steps.length) currentStep = steps.length - 1;

            showStep(currentStep);
        }

        function showStep(n) {
            steps[n].classList.add("form-step-active");

            for(let i=0; i <= n; i++) {
                stepIcons[i].classList.add("step-active");
            }
            for(let i=n+1; i < stepIcons.length; i++) {
                stepIcons[i].classList.remove("step-active");
            }

            if (n === 0) {
                prevBtn.classList.add("invisible");
            } else {
                prevBtn.classList.remove("invisible");
            }

            if (n === (steps.length - 1)) {
                nextBtn.innerHTML = "Simpan Lamaran";
                nextBtn.classList.replace("bg-[#003366]", "bg-green-600");
            } else {
                nextBtn.innerHTML = "Selanjutnya";
                nextBtn.classList.replace("bg-green-600", "bg-[#003366]");
            }
        }

        async function submitApplication() {
            const db = window.db;
            const collectionFn = window.collection;
            const addDocFn = window.addDoc;
            const serverTimestampFn = window.serverTimestamp;
            const uploadFileToStorageFn = window.uploadFileToStorage;

            if (!db || !collectionFn || !addDocFn || !serverTimestampFn) {
                alert("Konfigurasi database belum siap. Silakan coba beberapa saat lagi.");
                return;
            }

            const formEl = document.getElementById("multiStepForm");

            const modeSelect = document.getElementById("candidateMode");
            const positionSelect = document.getElementById("candidatePosition");
            const platformSelect = document.getElementById("candidatePlatform");
            const fullNameInput = document.getElementById("candidateFullName");
            const shortDescInput = document.getElementById("candidateShortDescription");
            const whatsappInput = document.getElementById("candidateWhatsapp");
            const emailInput = document.getElementById("candidateEmail");
            const chooseInput = document.getElementById("candidateChoose");
            const hopeInput = document.getElementById("candidateHope");

            const mode = modeSelect ? (modeSelect.value || "").trim() : "";
            const platform = platformSelect ? (platformSelect.value || "").trim() : "";
            const fullName = fullNameInput ? (fullNameInput.value || "").trim() : "";
            const shortDesc = shortDescInput ? (shortDescInput.value || "").trim() : "";
            const whatsapp = whatsappInput ? (whatsappInput.value || "").trim() : "";
            const email = emailInput ? (emailInput.value || "").trim() : "";
            const chooseText = chooseInput ? (chooseInput.value || "").trim() : "";
            const hopeText = hopeInput ? (hopeInput.value || "").trim() : "";

            let positionId = "";
            let positionName = "";
            if (positionSelect) {
                positionId = positionSelect.value || "";
                if (positionSelect.selectedIndex > -1) {
                    positionName = positionSelect.options[positionSelect.selectedIndex].text || "";
                }
            }

            if (!fullName) {
                alert("Nama lengkap wajib diisi.");
                return;
            }

            const ROLE_ID = "internship";
            const ROLE_NAME = "internship";

            const photoInput = document.getElementById("candidatePhoto");
            const portfolioInput = document.getElementById("candidatePortfolio");
            const resumeInput = document.getElementById("candidateResume");

            const photoFile = photoInput && photoInput.files && photoInput.files[0] ? photoInput.files[0] : null;
            const portfolioFile = portfolioInput && portfolioInput.files && portfolioInput.files[0] ? portfolioInput.files[0] : null;
            const resumeFile = resumeInput && resumeInput.files && resumeInput.files[0] ? resumeInput.files[0] : null;

            let avatarUrl = null;
            let portfolioUrl = null;
            let resumeUrl = null;

            const nowIso = new Date().toISOString();

            const payload = {
                basic_info: {
                    full_name: fullName,
                    current_role: ROLE_NAME,
                    avatar_url: null
                },
                contact_info: {
                    address: null,
                    campus: null,
                    whatsapp: whatsapp || null,
                    email: email || null,
                    instagram: null,
                    linkedin: null
                },
                education: null,
                profiling: shortDesc ? { short_description: shortDesc } : null,
                internship: {
                    mode: mode || null,
                    position_id: positionId || null,
                    position: positionName || null,
                    platform: platform || null,
                    address: null,
                    campus: null,
                    whatsapp: whatsapp || null,
                    email: email || null,
                    instagram: null,
                    linkedin: null,
                    portfolio_url: null,
                    resume_url: null,
                    experience: null,
                    choose: chooseText || null,
                    reason: null,
                    hope: hopeText || null,
                    other: null,
                    role_id: ROLE_ID,
                    role_name: ROLE_NAME
                },
                role_id: ROLE_ID,
                role_name: ROLE_NAME,
                recruitment_status: {
                    current: "screening",
                    history: [
                        { status: "screening", date: nowIso }
                    ]
                },
                created_at: serverTimestampFn()
            };

            try {
                nextBtn.disabled = true;
                nextBtn.textContent = "Menyimpan...";

                if (uploadFileToStorageFn) {
                    if (photoFile) {
                        avatarUrl = await uploadFileToStorageFn(photoFile, "talent-avatars");
                        payload.basic_info.avatar_url = avatarUrl || null;
                    }
                    if (portfolioFile) {
                        portfolioUrl = await uploadFileToStorageFn(portfolioFile, "talent-portfolio");
                        payload.internship.portfolio_url = portfolioUrl || null;
                    }
                    if (resumeFile) {
                        resumeUrl = await uploadFileToStorageFn(resumeFile, "talent-resume");
                        payload.internship.resume_url = resumeUrl || null;
                    }
                }

                await addDocFn(collectionFn(db, "talents"), payload);

                if (formEl) {
                    formEl.reset();
                }
                currentStep = 0;
                showStep(currentStep);
                alert("Formulir terkirim! Terima kasih telah mendaftar.");
            } catch (e) {
                console.error("Gagal mengirim lamaran", e);
                alert("Gagal mengirim lamaran. Silakan coba lagi.");
            } finally {
                nextBtn.disabled = false;
                nextBtn.innerHTML = "Simpan Lamaran";
                if (!nextBtn.classList.contains("bg-green-600")) {
                    nextBtn.classList.replace("bg-[#003366]", "bg-green-600");
                }
            }
        }
    </script>
</body>
</html>
