<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>List - Dialogika</title>
    
    <!-- Dependencies -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="../assets/css/style.css" rel="stylesheet" />

    <style>
        /* --- CSS KHUSUS LIST.HTML --- */
        body { background-color: #e5e7eb; }

        /* FIX LAYOUT: Pastikan konten ada di sebelah kanan sidebar */
        .main-content {
            margin-left: 290px;
            width: calc(100% - 290px);
            padding: 40px;
            min-height: 100vh;
        }
        @media (max-width: 991px) {
            .main-content { margin-left: 0; width: 100%; padding: 20px; }
        }

        /* --- 1. PROJECT CONTEXT CARD (KARTU BELAKANG/ATAS) --- */
        .project-context-card {
            max-width: 800px; /* LEBIH KECIL dari card list */
            width: 90%;
            background-color: #fff;
            color: #1f2937; /* Dark Navy */
            margin: 20px auto -20px auto; /* Margin bottom negatif agar tertiban card bawah */
            padding: 15px 25px 35px 25px; /* Padding bawah lebih besar untuk area tiban */
            border-radius: 16px 16px 0 0; /* Rounded atas */
            position: relative;
            z-index: 1; /* Layer bawah */
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.05);
        }

        /* Badge Sample Project */
        .ph-badge {
            background: #FDE047; /* Yellow */
            color: #854D0E;
            font-size: 0.7rem;
            font-weight: 800;
            padding: 4px 8px;
            border-radius: 4px;
            text-transform: uppercase;
            margin-right: 15px;
            letter-spacing: 0.5px;
            position: absolute;
            left: 30px;
            top: 38%;
            transform: translateY(-50%);
        }

        /* Menu Trigger */
        .ph-nav-group {
            display: flex; align-items: center; gap: 10px;
            background: #1f2937; padding: 6px 15px; border-radius: 50px;
            cursor: pointer; transition: 0.2s;
        }
        .ph-nav-group:hover { background: #0B2B6A; }
        .ph-project-name { font-weight: 700; color: white; font-size: 1rem; }

        /* 2. KARTU PUTIH (Main Content) */
        .main-list-card {
            max-width: 1000px; width: 100%; margin: 0 auto 50px auto;
            background: white; border-radius: 16px;
            box-shadow: 0 10px 40px -5px rgba(0, 0, 0, 0.1);
            padding: 60px; position: relative; z-index: 2;
            border: 1px solid #d1d5db; min-height: 400px;
        }

        /* Tombol New List */
        .btn-new-list {
            position: absolute; top: 40px; right: 40px;
            background-color: #0B2B6A; color: white; border-radius: 50px;
            padding: 8px 24px; font-weight: 600; border: none;
            box-shadow: 0 4px 10px rgba(11, 43, 106, 0.2); transition: 0.2s;
        }
        .btn-new-list:hover { background-color: #08204e; transform: translateY(-2px); }

        /* Form New List */
        .new-list-form-wrapper {
            background: white; border: 1px solid #e5e7eb; border-radius: 12px;
            padding: 25px; margin-bottom: 40px; display: none;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
        }
        .input-list-title {
            font-size: 1.5rem; font-weight: 700; border: none; width: 100%;
            outline: none; margin-bottom: 15px; color: #1f2937; border-bottom: 2px solid transparent;
        }
        .input-list-title:focus { border-bottom-color: #e5e7eb; }
        
        /* Empty State */
        .empty-state-card {
            border: 2px dashed #FDE047; background-color: #FFFCF5;
            border-radius: 12px; padding: 50px 20px; text-align: center;
            margin-top: 30px; display: none;
        }

        /* List Items Styling */
        .todo-group-label {
            font-size: 1.2rem; font-weight: 800; color: #1f2937;
            margin-top: 40px; margin-bottom: 15px; border-bottom: 3px solid #1f2937;
            display: inline-block; padding-bottom: 5px;
        }
        .todo-row {
            padding: 12px 10px; border-bottom: 1px solid #f3f4f6;
            display: flex; align-items: start; transition: 0.2s;
        }
        .todo-row:hover { background-color: #f8fafc; border-radius: 6px; }
        .todo-check { width: 22px; height: 22px; margin-right: 15px; cursor: pointer; }
        
        /* New Todo Form (Inner) */
        .todo-creation-wrapper { margin-top: 15px; margin-bottom: 20px; }
        .new-todo-card {
            background: white; border: 1px solid #d1d5db; border-radius: 8px; padding: 0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); display: none;
        }
        .todo-form-header { display: flex; align-items: center; padding: 15px 20px; border-bottom: 1px solid #f3f4f6; }
        .todo-input-desc { border: none; outline: none; width: 100%; font-size: 1.1rem; color: #374151; }
        .todo-form-body { padding: 20px; }
        .todo-form-row { display: flex; align-items: center; margin-bottom: 12px; }
        .todo-label { width: 140px; text-align: right; margin-right: 20px; font-weight: 600; color: #374151; font-size: 0.95rem; }
        .todo-input-detail { flex-grow: 1; border: 1px solid transparent; border-radius: 4px; padding: 6px 10px; color: #4b5563; font-size: 0.95rem; }
        .todo-input-detail:hover, .todo-input-detail:focus { border-color: #d1d5db; background: #f9fafb; outline: none; }
        .todo-form-footer { padding: 15px 20px; background: #f9fafb; border-top: 1px solid #f3f4f6; display: flex; gap: 10px; }

        @media (max-width: 768px) {
            .ph-badge { display: none; }
            .main-list-card { padding: 30px 20px; border-radius: 0; }
            .btn-new-list { position: static; display: block; width: 100%; margin-bottom: 20px; }
        }
    </style>
</head>
<body>

    <!-- 1. TOP BAR -->
    <nav class="top-bar">
        <div class="d-flex align-items-center">
            <button class="mobile-toggle me-3" onclick="toggleSidebar()"><i class="bi bi-list"></i></button>
            <div class="logo-center"><img src="https://www.dialogika.co/assets/img/logo.webp" height="35"></div>
        </div>
        <div class="d-flex align-items-center gap-3">
            <div class="profile-img-container"><img src="https://i.pravatar.cc/300?img=11" class="profile-img"></div>
        </div>
    </nav>

    <div class="dashboard-container">
        
        <!-- 2. SIDEBAR (Light, Smart Filters, Pending Widget) -->
        <aside class="sidebar" id="sidebarNav">
            
            <!-- WRAPPER UNTUK AREA YANG BISA DI-SCROLL -->
            <div class="sidebar-scroll-wrapper">
                
                <!-- Smart Filters (4 Kotak Besar) -->
                <div class="smart-filters-grid">
                    <a href="#" class="filter-card">
                        <div class="filter-top"><div class="filter-icon bg-icon-dark"><i class="bi bi-archive-fill"></i></div><div class="filter-count">429</div></div>
                        <div class="filter-label">All Tasks</div>
                    </a>
                    <a href="#" class="filter-card">
                        <div class="filter-top"><div class="filter-icon bg-icon-blue"><i class="bi bi-calendar-event-fill"></i></div><div class="filter-count">25</div></div>
                        <div class="filter-label">Today</div>
                    </a>
                    <a href="#" class="filter-card">
                        <div class="filter-top"><div class="filter-icon bg-icon-orange"><i class="bi bi-flag-fill"></i></div><div class="filter-count">21</div></div>
                        <div class="filter-label">Urgent</div>
                    </a>
                    <a href="#" class="filter-card">
                        <div class="filter-top"><div class="filter-icon bg-icon-red"><i class="bi bi-calendar-check-fill"></i></div><div class="filter-count">30</div></div>
                        <div class="filter-label">Assigned</div>
                    </a>
                </div>

                <!-- Navigation Links -->
                <div class="nav-category">Main Navigation</div>
                <a href="#" class="sidebar-link active"><i class="bi bi-columns-gap"></i> Dashboard</a>
                <a href="#" class="sidebar-link"><i class="bi bi-list-columns-reverse"></i> Lineup <span class="sidebar-badge">4</span></a>
                <a href="#" class="sidebar-link"><i class="bi bi-chat-dots"></i> Pings</a>
                <a href="#" class="sidebar-link"><i class="bi bi-bell"></i> Hey!</a>
                <a href="#" class="sidebar-link"><i class="bi bi-activity"></i> Activity</a>
                <a href="#" class="sidebar-link"><i class="bi bi-person-circle"></i> My Stuff</a>

                <div class="nav-category mt-4">System</div>
                <a href="#" class="sidebar-link"><i class="bi bi-gear"></i> Settings</a>
                <a href="#" class="sidebar-link text-danger"><i class="bi bi-box-arrow-right"></i> Logout</a>

            </div> <!-- End Scroll Wrapper -->

            <!-- PENDING WIDGET (Pinned di Bawah, di luar scroll wrapper) -->
            <div class="pending-widget">
                <div class="fire-icon-wrapper"><i class="bi bi-fire fire-icon"></i></div>
                <h6 class="fw-bold" style="color:#0B2B6A; margin-bottom: 5px;">Pending Tasks</h6>
                <p class="small text-muted mb-3">You have 5 approvals waiting.</p>
                <button class="btn-review">Review Now</button>
                
                <!-- COPYRIGHT (Muncul hanya saat scroll mentok bawah) -->
                <div class="sidebar-copyright">
                    &copy; 2025 PT Dialogika Persona Indonesia
                </div>
            </div>

        </aside>

        <!-- 3. MAIN CONTENT -->
        <main class="main-content" style="width: 100%;">
            

            <!-- A. KARTU BELAKANG (PROJECT CONTEXT - KECIL) -->
            <div class="project-context-card">
                
                <!-- Badge Sample Project -->
                <div class="ph-badge" id="projectBadge">Loading...</div>
                
                <div class="ph-nav-group" aria-expanded="false">
                    <i class="bi bi-house-fill text-secondary"></i>
                    <span class="ph-project-name" id="projectNameHeader">Loading Project...</span>
                </div>

                <!-- Right Side Option -->
                <div class="position-absolute end-0 me-3">
                    <button class="btn btn-link text-white text-opacity-50"><i class="bi bi-three-dots"></i></button>
                </div>
                
            </div>

            <!-- B. KARTU DEPAN (LIST KONTEN) -->
            <div class="main-list-card">
                
                <!-- Tombol New List -->
                <button class="btn-new-list btn-dlg-blue" onclick="toggleNewListForm()">
                    <i class="bi bi-plus-lg me-1"></i> New List
                </button>

                <!-- Judul Halaman -->
                <div class="text-center mb-5">
                    <h1 class="fw-bold display-5 mb-1" style="color:#111;">All List</h1>
                    <p class="text-muted">Manage your tasks efficiently.</p>
                </div>

                <!-- FORM NEW LIST (Hidden) -->
                <div id="newListForm" class="new-list-form-wrapper">
                    <input type="text" id="inputListName" class="input-list-title" placeholder="Name this list...">
                    <div class="border rounded mb-3 p-2 bg-white" style="min-height: 100px;" contenteditable="true" id="inputListDesc"></div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-dlg-green rounded-pill px-4 btn-save-list" onclick="saveNewList()">Add this list</button>
                        <button class="btn btn-light border rounded-pill px-4" onclick="toggleNewListForm()">Cancel</button>
                    </div>
                </div>

                <!-- LOADING INDICATOR -->
                <div id="loadingState" class="text-center py-5">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="text-muted mt-2">Loading lists...</p>
                </div>

                <!-- EMPTY STATE -->
                <div id="emptyState" class="empty-state-card" style="display: none;">
                    <i class="bi bi-check-circle display-4 text-warning mb-3 d-block"></i>
                    <h3 class="fw-bold text-secondary">No to-do lists just yet</h3>
                    <p class="text-muted">Get started by creating a new list above.</p>
                </div>

                <!-- ERROR STATE -->
                <div id="errorState" class="alert alert-danger text-center" style="display: none;"></div>

                <!-- LIST CONTAINER -->
                <div id="listsContainer"></div>

            </div>
            
        </main>
    </div>

    <!-- Script JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        <script>
            // --- KONFIGURASI API ---
            const API_URL = 'https://script.google.com/macros/s/AKfycbzsRHbU5WcucXdIhQeOFBaWQFvqO1kwGk72dHIfYWKtNcQF7ds5tTOyZNAmEWCQX_M/exec';

            // Ambil ID dari URL
            const urlParams = new URLSearchParams(window.location.search);
            const projectId = urlParams.get('id');

            // --- INIT LOAD ---
            document.addEventListener("DOMContentLoaded", function() {
                if(!projectId) {
                    alert("Error: Tidak ada Project ID di URL.");
                    document.getElementById('loadingState').innerHTML = '<span class="text-danger">Error: Missing ID</span>';
                    return;
                }

                // Set Link Back
                const backLink = document.getElementById('linkBackToProject');
                if(backLink) backLink.href = `../project/project.html?id=${projectId}`;

                fetchListsData();
            });

            // --- FETCH DATA ---
            function fetchListsData() {
                const loading = document.getElementById('loadingState');
                const container = document.getElementById('listsContainer');
                const emptyState = document.getElementById('emptyState');
                
                loading.style.display = 'block';
                container.innerHTML = '';
                if(emptyState) emptyState.style.display = 'none';

                fetch(`${API_URL}?action=getProjectData&id=${projectId}`)
                .then(res => res.json())
                .then(response => {
                    if(response.status === 'success') {
                        const data = response.data;
                        
                        // Update Header
                        if(data.project) {
                            document.getElementById('projectNameHeader').innerText = data.project.name;
                            document.getElementById('projectBadge').innerText = data.project.department || 'Project';
                        }

                        // Render Lists
                        const lists = data.lists || [];
                        renderLists(lists);
                    } else {
                        showError("Gagal memuat data: " + response.message);
                    }
                })
                .catch(err => {
                    showError("Terjadi kesalahan sistem.");
                })
                .finally(() => {
                    loading.style.display = 'none';
                });
            }

            // --- RENDER LISTS & TASK FORM ---
            function renderLists(lists) {
                const container = document.getElementById('listsContainer');
                const emptyState = document.getElementById('emptyState');
                
                container.innerHTML = '';

                if (lists.length === 0) {
                    if(emptyState) emptyState.style.display = 'block';
                    return;
                }
                if(emptyState) emptyState.style.display = 'none';
                
                lists.forEach(list => {
                    let tasksHtml = '';
                    
                    // Render Tasks
                    if (list.tasks && list.tasks.length > 0) {
                        list.tasks.forEach(task => {
                            const status = String(task.status || '').toLowerCase();
                            const isDone = ['done', 'completed', 'true', 'checklist'].includes(status);
                            const checkedAttr = isDone ? 'checked' : '';
                            const textClass = isDone ? 'text-decoration-line-through text-muted' : 'text-dark';

                            tasksHtml += `
                                <div class="todo-row p-2 border-bottom d-flex align-items-start hover-bg-light rounded">
                                    <input type="checkbox" class="todo-check me-3" ${checkedAttr} onclick="event.stopPropagation()">
                                    <div class="w-100">
                                        <div class="${textClass}">${task.title || '(No Title)'}</div>
                                    </div>
                                </div>
                            `;
                        });
                    } else {
                        tasksHtml = '<div class="text-muted small ps-4 fst-italic mb-2">No tasks yet.</div>';
                    }

                    // Render List Group
                    const listHtml = `
                        <div class="mb-5 bg-white p-4 rounded-4 border shadow-sm">
                            <!-- LINK TITLE KE LIST-DETAIL -->
                            <div class="d-flex justify-content-between align-items-center border-bottom pb-2 mb-3">
                                <a href="list-detail.html?listId=${list.id}&projectId=${projectId}" class="text-decoration-none text-dark">
                                    <h4 class="fw-bold mb-0 hover-text-blue">${list.name}</h4>
                                </a>
                                <button class="btn btn-sm btn-light text-muted"><i class="bi bi-three-dots"></i></button>
                            </div>
                            
                            <p class="text-muted small mb-3">${list.desc || ''}</p>
                            
                            <div class="todo-list-items">
                                ${tasksHtml}
                            </div>

                            <!-- ADD TASK SECTION -->
                            <div class="todo-creation-wrapper mt-3 ms-2">
                                
                                <!-- Button Trigger -->
                                <button id="btn-add-${list.id}" class="btn btn-sm btn-outline-secondary rounded-pill fw-bold" 
                                    onclick="showTaskInput('${list.id}')">
                                    <i class="bi bi-plus"></i> Add a to-do
                                </button>

                                <!-- Form Input (Hidden Default) -->
                                <div id="form-add-${list.id}" class="mt-2" style="display:none;">
                                    <input type="text" id="input-task-${list.id}" class="form-control mb-2" placeholder="Describe this to-do...">
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-sm btn-success rounded-pill px-3" onclick="saveTask('${list.id}')">Add this to-do</button>
                                        <button class="btn btn-sm btn-light border rounded-pill px-3" onclick="hideTaskInput('${list.id}')">Cancel</button>
                                    </div>
                                </div>

                            </div>
                        </div>
                    `;
                    
                    container.insertAdjacentHTML('beforeend', listHtml);
                });
            }

            // --- TASK UI INTERACTION ---
            function showTaskInput(listId) {
                document.getElementById(`btn-add-${listId}`).style.display = 'none';
                document.getElementById(`form-add-${listId}`).style.display = 'block';
                document.getElementById(`input-task-${listId}`).focus();
            }

            function hideTaskInput(listId) {
                document.getElementById(`btn-add-${listId}`).style.display = 'inline-block';
                document.getElementById(`form-add-${listId}`).style.display = 'none';
                document.getElementById(`input-task-${listId}`).value = '';
            }

            // --- CREATE NEW TASK FUNCTION ---
            function saveTask(listId) {
                const input = document.getElementById(`input-task-${listId}`);
                const title = input.value;
                const btn = input.nextElementSibling.querySelector('.btn-success');

                if (!title) { alert("Please enter a task title"); return; }

                // Loading state
                btn.innerText = "Saving...";
                btn.disabled = true;

                fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'createTask',
                        listId: listId,
                        title: title
                    })
                })
                .then(res => res.json())
                .then(resp => {
                    if(resp.status === 'success') {
                        // Refresh data tanpa reload page penuh
                        fetchListsData();
                    } else {
                        alert("Error: " + resp.message);
                    }
                })
                .catch(err => {
                    alert("Connection failed.");
                })
                .finally(() => {
                    btn.innerText = "Add this to-do";
                    btn.disabled = false;
                    hideTaskInput(listId);
                });
            }

            // --- CREATE NEW LIST ---
            function saveNewList() {
                const name = document.getElementById('inputListName').value;
                const desc = document.getElementById('inputListDesc').innerText;
                const btn = document.querySelector('.btn-save-list');

                if(!name) { alert("List name cannot be empty"); return; }
                
                btn.innerText = "Saving...";
                btn.disabled = true;

                fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'createList',
                        projectId: projectId,
                        listName: name,
                        description: desc
                    })
                })
                .then(res => res.json())
                .then(resp => {
                    if(resp.status === 'success') {
                        document.getElementById('inputListName').value = '';
                        document.getElementById('inputListDesc').innerText = '';
                        toggleNewListForm();
                        fetchListsData();
                    } else {
                        alert('Error: ' + resp.message);
                    }
                })
                .finally(() => {
                    btn.innerText = "Add this list";
                    btn.disabled = false;
                });
            }

            // Helpers
            function toggleNewListForm() {
                const form = document.getElementById('newListForm');
                const empty = document.getElementById('emptyState');
                
                if (form.style.display === 'none' || form.style.display === '') {
                    form.style.display = 'block';
                    if(empty) empty.style.display = 'none';
                } else {
                    form.style.display = 'none';
                }
            }

            function showError(msg) {
                document.getElementById('loadingState').style.display = 'none';
                const errDiv = document.getElementById('errorState');
                errDiv.innerHTML = msg;
                errDiv.style.display = 'block';
            }

            function toggleSidebar() { document.getElementById('sidebarNav').classList.toggle('show'); }
        </script>
</body>
</html>
