<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>List - Dialogika</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="../assets/css/style.css" rel="stylesheet" />

    <style>
        .todo-row {
            position: relative;
            display: flex;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid #f1f5f9 !important;
            transition: 0.2s;
        }
        .todo-row:hover { background-color: #f8fafc; }
        .task-row-done .task-text-content { text-decoration: line-through; color: #94a3b8; }
        .new-tab-hint {
            opacity: 0;
            font-size: 0.7rem;
            color: #0B2B6A;
            font-weight: 700;
            margin-left: 10px;
            transition: 0.2s;
            text-transform: uppercase;
            cursor: pointer;
        }
        .todo-row:hover .new-tab-hint { opacity: 1; }
        .drag-handle-task { color: #cbd5e1; margin-left: 8px; cursor: grab; }

        .rich-editor {
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            overflow: hidden;
            background: #f9fafb;
        }
        .rich-toolbar {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 6px 10px;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
        }
        .rich-btn {
            border: none;
            background: transparent;
            padding: 4px 6px;
            border-radius: 6px;
            color: #6b7280;
            font-size: 0.9rem;
        }
        .rich-btn:hover {
            background: #e5e7eb;
            color: #111827;
        }
        .rich-editor-body {
            min-height: 90px;
            padding: 10px 12px;
            background: #ffffff;
            outline: none;
        }
        .rich-editor-body[contenteditable="true"]:empty:before {
            content: attr(data-placeholder);
            color: #9ca3af;
        }
        .subtask-indent { margin-left: 40px; border-left: 2px solid #e2e8f0; }

        .search-bar-list input,
        .search-btn,
        .search-btn:before,
        .search-btn:after {
            transition: all 0.25s ease-out;
        }
        .search-bar-list {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0.25rem 0;
            max-width: 100%;
        }
        .search-bar-list input,
        .search-btn {
            width: 3em;
            height: 3em;
        }
        .search-bar-list input:invalid:not(:focus),
        .search-btn {
            cursor: pointer;
        }
        .search-bar-list input:focus,
        .search-bar-list input:valid {
            width: 100%;
        }
        .search-bar-list input:focus,
        .search-bar-list input:not(:focus) + .search-btn:focus {
            outline: transparent;
        }
        .search-bar-list input {
            background: transparent;
            border-radius: 1.5em;
            box-shadow: 0 0 0 0.4em #cbd5e1 inset;
            padding: 0.75em;
            transform: translate(0.5em, 0.5em) scale(0.5);
            transform-origin: 100% 0;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            border: none;
        }
        .search-bar-list input:focus,
        .search-bar-list input:valid {
            background: #ffffff;
            border-radius: 0.375em 0 0 0.375em;
            box-shadow: 0 0 0 0.1em #d9d9d9 inset;
            transform: scale(1);
        }
        .search-btn {
            background: #cbd5e1;
            border-radius: 0 0.75em 0.75em 0 / 0 1.5em 1.5em 0;
            padding: 0.75em;
            position: relative;
            transform: translate(0.25em, 0.25em) rotate(45deg) scale(0.25, 0.125);
            transform-origin: 0 50%;
            border: none;
        }
        .search-btn:before,
        .search-btn:after {
            content: "";
            display: block;
            opacity: 0;
            position: absolute;
        }
        .search-btn:before {
            border-radius: 50%;
            box-shadow: 0 0 0 0.2em #f1f1f1 inset;
            top: 0.75em;
            left: 0.75em;
            width: 1.2em;
            height: 1.2em;
        }
        .search-btn:after {
            background: #f1f1f1;
            border-radius: 0 0.25em 0.25em 0;
            top: 51%;
            left: 51%;
            width: 0.75em;
            height: 0.25em;
            transform: translate(0.2em, 0) rotate(45deg);
            transform-origin: 0 50%;
        }
        .search-btn span {
            display: inline-block;
            overflow: hidden;
            width: 1px;
            height: 1px;
        }
        .search-bar-list input:focus + .search-btn,
        .search-bar-list input:valid + .search-btn {
            background: #0B2B6A;
            border-radius: 0 0.375em 0.375em 0;
            transform: scale(1);
        }
        .search-bar-list input:focus + .search-btn:before,
        .search-bar-list input:focus + .search-btn:after,
        .search-bar-list input:valid + .search-btn:before,
        .search-bar-list input:valid + .search-btn:after {
            opacity: 1;
        }
        .search-bar-list input:focus + .search-btn:hover,
        .search-bar-list input:valid + .search-btn:hover,
        .search-bar-list input:valid:not(:focus) + .search-btn:focus {
            background: #0B2B6A;
        }
        .search-bar-list input:focus + .search-btn:active,
        .search-bar-list input:valid + .search-btn:active {
            transform: translateY(1px);
        }

        .project-context-card {
            max-width: 800px; width: 90%; background: white; color: #1f2937;
            margin: 20px auto -20px auto; padding: 15px 25px 35px 25px;
            border-radius: 16px 16px 0 0; position: relative; z-index: 1;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.05);
        }
        .ph-badge {
            background: #FDE047; color: #854D0E; font-size: 0.7rem; font-weight: 800;
            padding: 4px 8px; border-radius: 4px; text-transform: uppercase;
            position: absolute; left: 30px; top: 38%; transform: translateY(-50%);
        }
        .ph-crumb-container {
            display: flex; align-items: center; gap: 12px;
            background: #1f2937; padding: 8px 20px;
            border-radius: 50px; font-size: 0.95rem; color: white;
        }
        .ph-crumb-link { text-decoration: none; color: #d1d5db; font-weight: 500; transition: 0.2s; }
        .ph-crumb-link:hover { color: white; }
        .ph-crumb-active { color: white; font-weight: 700; border-bottom: 2px solid #FDE047; padding-bottom: 2px; }
        .ph-sep { font-size: 0.8rem; color: white; }

        .main-list-card {
            max-width: 1000px;
            width: 100%;
            margin: 0 auto 50px auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 40px -5px rgba(0, 0, 0, 0.1);
            padding: 50px 60px;
            position: relative;
            z-index: 2;
            border: 1px solid #d1d5db;
        }
        .task-create-panel {
            background: #fff;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 25px;
            margin-top: 15px;
            display: none;
        }
        .task-title-large {
            font-size: 1.5rem;
            font-weight: 700;
            border: none;
            outline: none;
            width: 100%;
            margin-bottom: 15px;
        }

        .status-badge-main {
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            color: white;
        }
        .status-drag-container {
            min-height: 50px;
            background: #f9fafb;
            border-radius: 8px;
            padding: 10px;
        }

        .meta-grid-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px 30px;
        }
        .meta-field-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
        }
        .meta-label-group {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
        }
        .meta-label-text {
            font-size: 0.8rem;
            color: #9ca3af;
        }
        .meta-value {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 6px;
            flex: 1;
        }
        .ghost-input {
            border: 1px solid transparent;
            background: transparent;
            padding: 5px;
            width: 100%;
            border-radius: 4px;
        }
        .ghost-input:hover { background: #f1f5f9; }

        .priority-dropdown {
            position: relative;
            width: 100%;
        }
        .priority-trigger {
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            padding: 6px 10px;
            background: #f9fafb;
            cursor: pointer;
            font-size: 0.9rem;
        }
        .priority-trigger:hover {
            background: #eef2ff;
        }
        .priority-menu {
            position: absolute;
            top: 100%;
            left: 0;
            margin-top: 4px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            box-shadow: 0 10px 20px rgba(15,23,42,0.15);
            padding: 6px 0;
            min-width: 180px;
            z-index: 1050;
            display: none;
        }
        .priority-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        .priority-item:hover {
            background: #f1f5f9;
        }
        .priority-flag {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            color: white;
            font-size: 0.75rem;
        }
        .priority-flag-urgent { background: #ef4444; }
        .priority-flag-high { background: #f59e0b; }
        .priority-flag-normal { background: #3b82f6; }
        .priority-flag-low { background: #6b7280; }

        .tag-selector {
            position: relative;
            width: 100%;
        }
        .tag-selector-control {
            display: flex;
            align-items: center;
            min-height: 34px;
            border-radius: 4px;
            padding: 4px 8px;
            border: 1px solid transparent;
            background: transparent;
            cursor: text;
            width: 100%;
        }
        .tag-selector-control:hover {
            background: #f1f5f9;
        }
        .tag-selected-list {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            flex: 1;
        }
        .tag-placeholder {
            color: #9ca3af;
            font-size: 0.85rem;
        }
        .tag-pill {
            display: inline-flex;
            align-items: center;
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 0.8rem;
            background: #e5e7eb;
            color: #111827;
        }
        .tag-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            margin-top: 4px;
            background: #ffffff;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            box-shadow: 0 18px 45px rgba(15, 23, 42, 0.15);
            padding: 6px 0 4px 0;
            z-index: 40;
            display: none;
        }
        .tag-search-input {
            width: 100%;
            border: none;
            outline: none;
            padding: 6px 12px 8px 12px;
            font-size: 0.85rem;
        }
        .tag-options {
            max-height: 220px;
            overflow-y: auto;
            padding: 0 4px 4px 4px;
        }
        .tag-option {
            display: flex;
            align-items: center;
            padding: 4px 8px;
            cursor: pointer;
            gap: 6px;
        }
        .tag-option:hover {
            background: #f3f4f6;
        }
        .tag-option-selected .tag-pill {
            background: #4338ca;
            color: #eef2ff;
        }
        .tag-create {
            display: flex;
            align-items: center;
            padding: 6px 12px 8px 12px;
            border-top: 1px solid #e5e7eb;
            font-size: 0.8rem;
            color: #6b7280;
            cursor: pointer;
        }
        .tag-create:hover {
            background: #f3f4f6;
        }
        .tag-create-label {
            margin-left: 4px;
            padding: 2px 6px;
            border-radius: 999px;
            background: #e0e7ff;
            color: #4338ca;
        }
        .tag-remove {
            margin-left: 4px;
            cursor: pointer;
            font-size: 0.7rem;
            color: #6b7280;
        }
        .tag-remove:hover {
            color: #111827;
        }

        .user-select {
            position: relative;
            width: 100%;
        }
        .user-select-control {
            display: flex;
            align-items: center;
            width: 100%;
            min-height: 34px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            padding: 6px 10px;
            background: #f9fafb;
            cursor: pointer;
            gap: 8px;
        }
        .user-select-control:hover {
            background: #f3f4ff;
        }
        .user-select-avatar {
            width: 22px;
            height: 22px;
            border-radius: 999px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #e5e7eb;
            flex-shrink: 0;
        }
        .user-select-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .user-select-placeholder {
            font-size: 0.85rem;
            color: #9ca3af;
        }
        .user-select-name {
            font-size: 0.85rem;
            color: #111827;
        }
        .user-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            margin-top: 6px;
            background: #0f172a;
            color: white;
            border-radius: 18px;
            padding: 10px 10px 8px 10px;
            box-shadow: 0 18px 45px rgba(15,23,42,0.45);
            width: 280px;
            z-index: 60;
            display: none;
        }
        .user-search-wrapper {
            display: flex;
            align-items: center;
            background: #020617;
            border-radius: 999px;
            padding: 4px 10px;
            gap: 6px;
            margin-bottom: 8px;
        }
        .user-search-input {
            flex: 1;
            border: none;
            outline: none;
            background: transparent;
            color: #e5e7eb;
            font-size: 0.85rem;
        }
        .user-search-input::placeholder {
            color: #6b7280;
        }
        .user-list-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            color: #9ca3af;
            margin: 4px 2px 4px 2px;
        }
        .user-list {
            max-height: 260px;
            overflow-y: auto;
            padding-right: 4px;
        }
        .user-option {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 4px;
            border-radius: 8px;
            cursor: pointer;
        }
        .user-option:hover {
            background: #111827;
        }
        .user-option-avatar {
            width: 28px;
            height: 28px;
            border-radius: 999px;
            overflow: hidden;
            flex-shrink: 0;
            background: #1f2937;
        }
        .user-option-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .user-option-name {
            font-size: 0.85rem;
        }

        .tag-edit-btn {
            border: none;
            background: transparent;
            padding: 0;
            margin-left: auto;
            color: #9ca3af;
            cursor: pointer;
            font-size: 0.9rem;
        }
        .tag-edit-btn:hover {
            color: #4b5563;
        }
        .tag-editor-popover {
            position: absolute;
            background: #ffffff;
            border-radius: 16px;
            border: 1px solid #e5e7eb;
            box-shadow: 0 18px 45px rgba(15, 23, 42, 0.18);
            padding: 10px 12px 8px 12px;
            z-index: 1000;
            width: 260px;
            display: none;
        }
        .tag-editor-input {
            width: 100%;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 4px 8px;
            font-size: 0.85rem;
            margin-bottom: 8px;
        }
        .tag-color-grid {
            display: grid;
            grid-template-columns: repeat(8, minmax(0, 1fr));
            gap: 4px;
            margin-bottom: 8px;
        }
        .tag-color-swatch {
            width: 18px;
            height: 18px;
            border-radius: 999px;
            border: 2px solid transparent;
            cursor: pointer;
        }
        .tag-color-swatch-selected {
            border-color: #111827;
        }
        .tag-editor-delete {
            display: flex;
            align-items: center;
            gap: 6px;
            color: #ef4444;
            font-size: 0.8rem;
            cursor: pointer;
            padding-top: 4px;
            border-top: 1px solid #e5e7eb;
            margin-top: 4px;
        }

        .comment-bubble {
            background: #f8fafc;
            border-radius: 12px;
            padding: 12px;
            border: 1px solid #e2e8f0;
        }

        .modal-content-custom {
            border-radius: 20px;
            border: 1px solid #e5e7eb;
            box-shadow: 0 18px 45px rgba(15, 23, 42, 0.18);
            background: #f9fafb;
        }
        #projectToolsModal .modal-header {
            padding-bottom: 0.25rem;
        }
        #projectToolsModal .modal-title {
            font-size: 1.1rem;
            letter-spacing: 0.02em;
        }
        .modal-tools-grid {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 16px;
            margin-top: 1.25rem;
        }
        .tool-nav-card {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 16px;
            border-radius: 16px;
            background: #ffffff;
            border: 1px solid #e5e7eb;
            text-decoration: none;
            color: #111827;
            transition: transform 0.18s ease, box-shadow 0.18s ease, border-color 0.18s ease, background-color 0.18s ease;
        }
        .tool-nav-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 16px 40px rgba(15, 23, 42, 0.16);
            border-color: #0b2b6a;
            background: #f9fafb;
        }
        .tool-title {
            font-weight: 600;
            font-size: 0.95rem;
        }
        .tool-nav-icon {
            width: 40px;
            height: 40px;
            border-radius: 999px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #ffffff;
            box-shadow: 0 8px 18px rgba(15, 23, 42, 0.25);
        }
        .tool-nav-icon i {
            font-size: 1.1rem;
        }

        @media (max-width: 768px) {
            .main-content.w-100 {
                margin-left: 0 !important;
            }
            #projectToolsModal .modal-dialog {
                margin: 0.75rem;
            }
            .modal-tools-grid {
                grid-template-columns: repeat(2, minmax(0, 1fr));
                gap: 12px;
            }
            .main-list-card {
                padding: 24px 16px;
                margin: 0 12px 32px 12px;
                border-radius: 14px;
            }
            .project-context-card {
                width: 95%;
                margin: 16px auto -10px auto;
                padding: 12px 16px 28px 16px;
                border-radius: 14px 14px 0 0;
            }
            .ph-badge {
                left: 16px;
                top: 42%;
            }
            .ph-crumb-container {
                max-width: 100%;
                padding: 6px 14px;
                font-size: 0.8rem;
            }
            .main-list-card > .d-flex.justify-content-between.align-items-center {
                flex-direction: column;
                align-items: stretch !important;
                gap: 16px;
            }
            .main-list-card .search-bar-list {
                max-width: 100%;
            }
            .main-list-card .search-bar-list input:focus,
            .main-list-card .search-bar-list input:valid {
                width: 100%;
            }
            .main-list-card .text-center.flex-grow-1 {
                order: -1;
                margin-bottom: 4px;
            }
            .main-list-card h1.fw-bold {
                font-size: 1.4rem;
            }
            .main-list-card p.text-muted {
                font-size: 0.85rem;
            }
            .main-list-card > .d-flex.justify-content-between.align-items-center > button {
                align-self: center;
                width: 100%;
                max-width: 200px;
            }
        }

        @media (max-width: 576px) {
            .modal-tools-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>

    <nav class="top-bar">
        <div class="logo-center">
            <img src="https://www.dialogika.co/assets/img/logo.webp" alt="Dialogika" height="35">
        </div>
        <div class="d-flex align-items-center gap-3 ms-auto pe-4">
            <div class="text-end d-none d-lg-block lh-1">
                <span id="user-name-display" class="fw-bold small">Loading...</span>
            </div>
            <img id="user-photo-display" src="" class="profile-img" style="width:35px; height:35px; border-radius:50%">
        </div>
    </nav>

    <div class="dashboard-container">
        <aside class="sidebar" id="sidebarNav">
            
            <!-- WRAPPER UNTUK AREA YANG BISA DI-SCROLL -->
            <div class="sidebar-scroll-wrapper">
                
                <!-- Smart Filters (4 Kotak Besar) -->
                <div class="smart-filters-grid">
                    <a href="#" class="filter-card">
                        <div class="filter-top"><div class="filter-icon bg-icon-dark"><i class="bi bi-archive-fill"></i></div><div class="filter-count">429</div></div>
                        <div class="filter-label">All Tasks</div>
                    </a>
                    <a href="#" class="filter-card">
                        <div class="filter-top"><div class="filter-icon bg-icon-blue"><i class="bi bi-calendar-event-fill"></i></div><div class="filter-count">25</div></div>
                        <div class="filter-label">Today</div>
                    </a>
                    <a href="#" class="filter-card">
                        <div class="filter-top"><div class="filter-icon bg-icon-orange"><i class="bi bi-flag-fill"></i></div><div class="filter-count">21</div></div>
                        <div class="filter-label">Urgent</div>
                    </a>
                    <a href="#" class="filter-card">
                        <div class="filter-top"><div class="filter-icon bg-icon-red"><i class="bi bi-calendar-check-fill"></i></div><div class="filter-count">30</div></div>
                        <div class="filter-label">Assigned</div>
                    </a>
                </div>

                <!-- Navigation Links -->
                <div class="nav-category">Main Navigation</div>
                <a href="#" class="sidebar-link active"><i class="bi bi-columns-gap"></i> Dashboard</a>
                <a href="#" class="sidebar-link"><i class="bi bi-list-columns-reverse"></i> Lineup <span class="sidebar-badge">4</span></a>
                <a href="#" class="sidebar-link"><i class="bi bi-chat-dots"></i> Pings</a>
                <a href="#" class="sidebar-link"><i class="bi bi-bell"></i> Hey!</a>
                <a href="#" class="sidebar-link"><i class="bi bi-activity"></i> Activity</a>
                <a href="#" class="sidebar-link"><i class="bi bi-person-circle"></i> My Stuff</a>

                <div class="nav-category mt-4">System</div>
                <a href="#" class="sidebar-link"><i class="bi bi-gear"></i> Settings</a>
                <a href="#" class="sidebar-link text-danger"><i class="bi bi-box-arrow-right"></i> Logout</a>

            </div> <!-- End Scroll Wrapper -->

            <!-- PENDING WIDGET (Pinned di Bawah, di luar scroll wrapper) -->
            <div class="pending-widget">
                <div class="fire-icon-wrapper"><i class="bi bi-fire fire-icon"></i></div>
                <h6 class="fw-bold" style="color:#0B2B6A; margin-bottom: 5px;">Pending Tasks</h6>
                <p class="small text-muted mb-3">You have 5 approvals waiting.</p>
                <button class="btn-review">Review Now</button>
                
                <!-- COPYRIGHT (Muncul hanya saat scroll mentok bawah) -->
                <div class="sidebar-copyright">
                    &copy; 2025 PT Dialogika Persona Indonesia
                </div>
            </div>

        </aside>

        <main class="main-content w-100" style="margin-left:290px; padding-top:100px">
            <div class="project-context-card">
                <div class="ph-badge" id="projectBadge">Loading...</div>
                <div class="ph-crumb-container">
                    <a href="../home.html" class="ph-crumb-link"><i class="bi bi-house-fill"></i></a>
                    <i class="bi bi-chevron-right ph-sep"></i>
                    <a href="#" class="ph-crumb-link" id="projectNameHeader">Loading...</a>
                    <i class="bi bi-chevron-right ph-sep"></i>
                    <span class="ph-crumb-active">Lists</span>
                </div>
                <div class="position-absolute end-0 me-3">
                    <button class="btn btn-link text-muted" data-bs-toggle="modal" data-bs-target="#projectToolsModal">
                        <i class="bi bi-three-dots"></i>
                    </button>
                </div>
            </div>

            <div class="main-list-card">
                <div class="d-flex justify-content-between align-items-center mb-5">
                    <div class="d-flex align-items-center flex-grow-1 gap-4">
                        <div style="">
                            <form action="" class="search-bar-list" onsubmit="event.preventDefault();">
                                <input
                                    type="search"
                                    name="search"
                                    id="globalTaskSearch"
                                    pattern=".*\\S.*"
                                    required
                                    oninput="onGlobalTaskSearchChange(this.value)">
                                <button class="search-btn" type="submit">
                                    <span>Search</span>
                                </button>
                            </form>
                        </div>
                        <div class="text-center flex-grow-1">
                            <h1 class="fw-bold mb-1">All Lists</h1>
                            <p class="text-muted mb-1">Manage your tasks efficiently.</p>
                            <span class="badge text-bg-success" id="allListDoneBadge" style="display:none">All Task Done</span>
                        </div>
                    </div>
                    <button class="btn btn-dlg-blue rounded-pill px-4 ms-3" onclick="toggleNewListForm()">+ New List</button>
                </div>

                <div id="newListForm" class="border rounded-4 p-4 mb-4 shadow-sm" style="display:none">
                    <input type="text" id="inputListName" class="task-title-large" placeholder="List Name...">
                    <div class="rich-editor mb-3">
                        <div class="rich-toolbar">
                            <button type="button" class="rich-btn" onclick="applyFormat('inputListDesc','bold')"><i class="bi bi-type-bold"></i></button>
                            <button type="button" class="rich-btn" onclick="applyFormat('inputListDesc','italic')"><i class="bi bi-type-italic"></i></button>
                            <button type="button" class="rich-btn" onclick="applyFormat('inputListDesc','underline')"><i class="bi bi-type-underline"></i></button>
                            <button type="button" class="rich-btn" onclick="applyFormat('inputListDesc','insertUnorderedList')"><i class="bi bi-list-ul"></i></button>
                            <button type="button" class="rich-btn" onclick="applyFormat('inputListDesc','insertOrderedList')"><i class="bi bi-list-ol"></i></button>
                            <button type="button" class="rich-btn ms-auto" onclick="triggerDescFileInput('list')"><i class="bi bi-paperclip"></i></button>
                        </div>
                        <div id="inputListDesc" contenteditable="true" class="rich-editor-body" data-placeholder="List description..."></div>
                        <input type="file" id="list-desc-file-input" multiple style="display:none" onchange="handleDescFiles('list','inputListDesc',this)">
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-dlg-green rounded-pill px-4" onclick="saveNewList()">Create List</button>
                        <button class="btn btn-light rounded-pill" onclick="toggleNewListForm()">Cancel</button>
                    </div>
                </div>

                <div id="loadingState" class="text-center py-5">
                    <div class="spinner-border text-primary"></div>
                </div>
                <div id="listsContainer"></div>
                <div id="emptyState" class="text-center text-muted py-5" style="display:none;">No lists yet.</div>
            </div>
        </main>
    </div>

    <div class="modal fade" id="descModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-4">
                <div class="modal-header border-0">
                    <h5 class="fw-bold" id="descModalTitle"></h5>
                    <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body pt-0" id="descModalBody"></div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="manageStatusModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-4">
                <div class="modal-header">
                    <h5>Manage Statuses</h5>
                    <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="activeListIdForStatus">
                    <div class="mb-3">
                        <label class="small fw-bold">ACTIVE STATUSES</label>
                        <div id="statusListContainer" class="status-drag-container"></div>
                    </div>
                    <div class="input-group">
                        <input type="text" id="newStatusNameInput" class="form-control" placeholder="New status name...">
                        <button class="btn btn-dlg-blue" onclick="addNewStatusToList()">Add</button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-dlg-green w-100 rounded-pill" onclick="saveStatusChanges()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="editListModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-4">
                <div class="modal-header">
                    <h5>Edit List</h5>
                    <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editListId">
                    <div class="mb-3">
                        <label class="small fw-bold">Name</label>
                        <input type="text" class="form-control" id="editListName">
                    </div>
                    <div class="mb-3">
                        <label class="small fw-bold">Description</label>
                        <div id="editListDesc" class="border rounded-3 p-2" contenteditable="true" style="min-height:80px"></div>
                    </div>
                    <div class="mb-0">
                        <label class="small fw-bold">Position</label>
                        <input type="number" class="form-control" id="editListPosition" min="1">
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                    <button class="btn btn-dlg-blue" onclick="saveListEdit()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL PROJECT TOOLS -->
    <div class="modal fade" id="projectToolsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content modal-content-custom p-4">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title fw-bold">Project Tools</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="modal-tools-grid">
                        
                        <!-- URGENT -->
                        <a href="urgent.html" class="tool-nav-card" id="link-urgent">
                            <span class="tool-title">Urgent</span>
                            <div class="tool-nav-icon" style="background-color: #e7181a;">
                                <i class="bi bi-megaphone-fill"></i>
                            </div>
                        </a>

                        <!-- LIST (Current) -->
                        <a href="#" class="tool-nav-card border-primary shadow-sm" data-bs-dismiss="modal">
                            <span class="tool-title text-primary">List</span>
                            <div class="tool-nav-icon" style="background-color: #006a4e;">
                                <i class="bi bi-check2-square"></i>
                            </div>
                        </a>

                        <!-- CARD -->
                        <a href="card.html" class="tool-nav-card" id="link-card">
                            <span class="tool-title">Card</span>
                            <div class="tool-nav-icon" style="background-color: #f7b12c;">
                                <i class="bi bi-layout-three-columns"></i>
                            </div>
                        </a>

                        <!-- FILES -->
                        <a href="files.html" class="tool-nav-card" id="link-files">
                            <span class="tool-title">Files</span>
                            <div class="tool-nav-icon" style="background-color: #1c84e3;">
                                <i class="bi bi-folder-fill"></i>
                            </div>
                        </a>

                        <!-- DISCUSS -->
                        <a href="discuss.html" class="tool-nav-card" id="link-discuss">
                            <span class="tool-title">Discuss</span>
                            <div class="tool-nav-icon" style="background-color: #7204cf;">
                                <i class="bi bi-chat-dots-fill"></i>
                            </div>
                        </a>

                        <!-- SCHEDULE -->
                        <a href="schedule.html" class="tool-nav-card" id="link-schedule">
                            <span class="tool-title">Schedule</span>
                            <div class="tool-nav-icon" style="background-color: #e7181a;">
                                <i class="bi bi-calendar3"></i>
                            </div>
                        </a>

                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import {
            getFirestore, doc, collection, addDoc, updateDoc, deleteDoc,
            query, where, orderBy, onSnapshot, serverTimestamp, getDoc, getDocs, writeBatch
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDyzzEYbJkkl-N8snrQf14qvj8De4YliV0",
            authDomain: "pre-dialogika.firebaseapp.com",
            projectId: "pre-dialogika",
            storageBucket: "pre-dialogika.firebasestorage.app",
            messagingSenderId: "343771410480",
            appId: "1:343771410480:web:32881c9868522090237df5"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        const urlParams = new URLSearchParams(window.location.search);
        const projectId = urlParams.get('id');
        let currentUser = null;
        let projectLists = [];
        let allTasks = [];
        let projectMembers = [];
        let tagEditorState = { tagName: "", color: "", anchorRect: null };
        let statusColorPickerInput = null;
        const storedUser = JSON.parse(localStorage.getItem('userData') || 'null');

        const TAG_COLORS = [
            "#bfdbfe", "#e0f2fe", "#a5f3fc", "#bbf7d0", "#dcfce7", "#fef9c3", "#fee2e2", "#fecaca",
            "#ddd6fe", "#e9d5ff", "#f5d0fe", "#fce7f3", "#fee2e2", "#ffedd5", "#d1fae5", "#bae6fd",
            "#e5e7eb", "#d1d5db", "#f9a8d4", "#fda4af", "#fdba74", "#bef264", "#a7f3d0", "#67e8f9"
        ];

        const DEFAULT_LIST_STATUSES = [
            { name: "Initiate", color: "#0B2B6A", type: "not_started", position: 0 },
            { name: "Complete", color: "#006a4e", type: "done", position: 1 }
        ];

        function getListStatuses(list) {
            const arr = list && Array.isArray(list.statuses) ? list.statuses : [];
            if (!arr.length) return DEFAULT_LIST_STATUSES.slice();
            return arr;
        }

        window.showGlobalSearchInput = () => {
            const input = document.getElementById('globalTaskSearch');
            if (!input) return;
            if (input.style.display === 'none') {
                input.style.display = 'block';
                input.focus();
            }
        };

        window.onGlobalTaskSearchChange = (value) => {
            renderUI();
            const input = document.getElementById('globalTaskSearch');
            if (!input) return;
            if (String(value || "").trim().length === 0) {
                input.blur();
            }
        };

        onAuthStateChanged(auth, (user) => {
            if (user && projectId) {
                currentUser = user;
                setupUserUI(user);
                loadProjectHeader();
                listenToLists();
                listenToTasks();
            } else {
                window.location.href = "../index.html";
            }
        });

        function setupUserUI(user) {
            const nameDisplay = document.getElementById('user-name-display');
            const photoDisplay = document.getElementById('user-photo-display');

            const name = (storedUser && (storedUser.name || storedUser.Name)) || user.displayName || user.email || "User";
            const photo = (storedUser && (storedUser.photo || storedUser.Photo)) || user.photoURL || "https://i.pravatar.cc/300";

            if (nameDisplay) nameDisplay.innerText = name;
            if (photoDisplay) photoDisplay.src = photo;
        }

        async function loadProjectHeader() {
            const snap = await getDoc(doc(db, "projects", projectId));
            if (snap.exists()) {
                const data = snap.data();
                const nameEl = document.getElementById('projectNameHeader');
                const badgeEl = document.getElementById('projectBadge');
                if (nameEl) nameEl.innerText = data.name || "Untitled Project";
                if (badgeEl) badgeEl.innerText = data.department || "General";
                await loadProjectMembers(data.members || []);
                renderUI();
            }
        }

        function getDirectPhotoUrl(url, uid) {
            if (!url) return `https://i.pravatar.cc/150?u=${uid || "user"}`;
            if (url.includes('drive.google.com')) {
                let id = "";
                if (url.includes('id=')) {
                    id = url.split('id=')[1].split('&')[0];
                } else if (url.includes('/d/')) {
                    id = url.split('/d/')[1].split('/')[0];
                }
                if (id) return `https://lh3.googleusercontent.com/u/0/d/${id}`;
            }
            return url;
        }

        async function loadProjectMembers(memberUids) {
            projectMembers = [];
            try {
                if (Array.isArray(memberUids) && memberUids.length > 0) {
                    const promises = memberUids.map(async (uid) => {
                        try {
                            const snap = await getDoc(doc(db, "users", uid));
                            if (snap.exists()) {
                                const u = snap.data();
                                return {
                                    uid,
                                    name: u.name || u.email || uid,
                                    photo: getDirectPhotoUrl(u.photo || "", uid)
                                };
                            }
                        } catch (e) {
                            console.error("Failed to fetch user profile", uid, e);
                        }
                        return {
                            uid,
                            name: uid,
                            photo: `https://i.pravatar.cc/150?u=${uid}`
                        };
                    });
                    const results = await Promise.all(promises);
                    projectMembers = results.filter(Boolean);
                } else {
                    const snap = await getDocs(collection(db, "users"));
                    const members = [];
                    snap.forEach(d => {
                        const u = d.data();
                        members.push({
                            uid: d.id,
                            name: u.name || u.email || d.id,
                            photo: getDirectPhotoUrl(u.photo || "", d.id)
                        });
                    });
                    projectMembers = members;
                }
            } catch (e) {
                console.error("Failed to load project members", e);
                projectMembers = [];
            }
        }

        function listenToLists() {
            const q = query(collection(db, "projects", projectId, "lists"), orderBy("position", "asc"));
            onSnapshot(q, (snapshot) => {
                projectLists = [];
                snapshot.forEach(docSnap => projectLists.push({ id: docSnap.id, ...docSnap.data() }));
                renderUI();
            });
        }

        function listenToTasks() {
            const q = query(collection(db, "tasks"), where("project_id", "==", projectId));
            onSnapshot(q, (snapshot) => {
                allTasks = [];
                snapshot.forEach(docSnap => allTasks.push({ id: docSnap.id, ...docSnap.data() }));
                allTasks.sort((a, b) => {
                    const pa = typeof a.position === "number" ? a.position : 0;
                    const pb = typeof b.position === "number" ? b.position : 0;
                    return pa - pb;
                });
                renderUI();
            }, (error) => {
                console.error("Failed to listen tasks", error);
                alert("Gagal mengambil data tasks: " + error.message);
            });
        }

        function renderUI() {
            const container = document.getElementById('listsContainer');
            const loadingState = document.getElementById('loadingState');
            const emptyState = document.getElementById('emptyState');
            const allDoneBadge = document.getElementById('allListDoneBadge');
            const searchInput = document.getElementById('globalTaskSearch');
            const searchQuery = searchInput ? searchInput.value.trim().toLowerCase() : "";
            const hasSearchQuery = searchQuery.length > 0;

            function matchesSearch(task) {
                if (!hasSearchQuery) return true;
                const title = String(task.title || "").toLowerCase();
                const rawDesc = String(task.description || "").replace(/<[^>]+>/g, " ");
                const desc = rawDesc.toLowerCase();
                return title.includes(searchQuery) || desc.includes(searchQuery);
            }

            let anyTaskMatchedSearch = false;

            if (loadingState) loadingState.style.display = 'none';
            if (!container) return;

            container.innerHTML = '';

            const totalTasks = allTasks.length;
            const completedTasks = allTasks.filter(t => t.status === 'Complete').length;
            if (allDoneBadge) {
                allDoneBadge.style.display = totalTasks > 0 && completedTasks === totalTasks ? 'inline-block' : 'none';
            }

            if (projectLists.length === 0) {
                if (emptyState) emptyState.style.display = 'block';
                return;
            }
            if (emptyState) emptyState.style.display = 'none';

            const tagSet = new Set();
            allTasks.forEach(t => {
                if (Array.isArray(t.tags)) {
                    t.tags.forEach(tag => {
                        if (tag && typeof tag === "string") tagSet.add(tag);
                    });
                }
            });
            const allProjectTags = Array.from(tagSet).sort((a, b) => a.localeCompare(b));

            projectLists.forEach(list => {
                const listTasksBase = allTasks.filter(t => t.list_id === list.id && !t.parent_task_id);
                const listAllTasks = allTasks.filter(t => t.list_id === list.id);
                const hasTasks = listAllTasks.length > 0;
                const allCompleteForList = hasTasks && listAllTasks.every(t => t.status === 'Complete');

                let tasksHtml = "";

                if (hasSearchQuery) {
                    const visibleTasks = [];

                    listTasksBase.forEach(parent => {
                        const subtasks = allTasks.filter(st => st.parent_task_id === parent.id);
                        const matchingSubtasks = subtasks.filter(matchesSearch);

                        if (matchesSearch(parent) || matchingSubtasks.length > 0) {
                            visibleTasks.push({ parent, subtasks: matchingSubtasks });
                        }
                    });

                    if (visibleTasks.length > 0) {
                        anyTaskMatchedSearch = true;
                        tasksHtml = visibleTasks.map(item => renderTaskRow(item.parent, item.subtasks)).join('');
                    }
                } else {
                    const listTasks = listTasksBase;
                    tasksHtml = listTasks.map(t => {
                        const subtasks = allTasks.filter(st => st.parent_task_id === t.id);
                        return renderTaskRow(t, subtasks);
                    }).join('');
                }

                const rawDesc = (list.description || "").replace(/<[^>]+>/g, " ");
                const words = rawDesc.trim().split(/\s+/).filter(Boolean);
                const truncatedDesc = words.length > 8
                    ? words.slice(0, 8).join(" ") + `... <a href="#" onclick="showFullDesc('${list.id}'); return false;">more...</a>`
                    : rawDesc;

                const html = `
                    <div class="mb-5 bg-white p-4 rounded-4 border shadow-sm" id="list-${list.id}">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h2 class="h4 fw-bold mb-1">
                                    <a href="list-detail.html?projectId=${projectId}&listId=${list.id}" class="text-decoration-none text-dark">
                                        ${list.name}
                                        ${allCompleteForList ? `<i class="bi bi-check-circle-fill ms-2" style="color:#006a4e;"></i>` : ''}
                                    </a>
                                </h2>
                                <div class="small text-muted mb-3">${truncatedDesc || ""}</div>
                            </div>
                            <div class="dropdown">
                                <button class="btn btn-sm btn-light border-0" data-bs-toggle="dropdown">
                                    <i class="bi bi-three-dots-vertical"></i>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li><a class="dropdown-item" href="#" onclick="openStatusManager('${list.id}'); return false;">Manage statuses</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="openEditListModal('${list.id}'); return false;">Edit list</a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item text-danger" href="#" onclick="deleteList('${list.id}'); return false;">Delete list</a></li>
                                </ul>
                            </div>
                        </div>

                        <div class="d-flex gap-2 mb-3 align-items-center">
                            ${getListStatuses(list).map(s => `<span class="status-badge-main" style="background:${s.color || '#0B2B6A'}">${s.name}</span>`).join('<i class="bi bi-chevron-right small text-muted"></i>')}
                            <i class="bi bi-plus-circle text-muted cursor-pointer" onclick="openStatusManager('${list.id}')"></i>
                        </div>

                        <div class="task-items-container" id="items-${list.id}">${tasksHtml}</div>

                        <button class="btn btn-sm btn-outline-secondary rounded-pill mt-3" onclick="showTaskForm('${list.id}')">+ Add to-do</button>

                        <div id="form-add-${list.id}" class="task-create-panel">
                            <input type="text" id="title-${list.id}" class="task-title-large" placeholder="Task Name">

                            <div class="meta-grid-container mb-3">
                                <div class="meta-field-row">
                                    <div class="meta-label-group">
                                        <i class="bi bi-record-circle text-muted"></i>
                                        <span class="meta-label-text">Status</span>
                                    </div>
                                    <div class="meta-value">
                                            <select id="status-${list.id}" class="ghost-input">
                                            ${getListStatuses(list).map(s => `<option value="${s.name}">${s.name}</option>`).join('')}
                                        </select>
                                    </div>
                                </div>

                                <div class="meta-field-row">
                                    <div class="meta-label-group">
                                        <i class="bi bi-flag text-muted"></i>
                                        <span class="meta-label-text">Priority</span>
                                    </div>
                                    <div class="meta-value">
                                        <div class="priority-dropdown w-100" id="priority-wrap-${list.id}">
                                            <button type="button" class="priority-trigger" onclick="togglePriorityMenu('${list.id}')">
                                                <span class="priority-flag priority-flag-normal">
                                                    <i class="bi bi-flag-fill"></i>
                                                </span>
                                                <span id="priority-label-${list.id}">Normal</span>
                                                <i class="bi bi-chevron-down ms-auto text-muted small"></i>
                                            </button>
                                            <div class="priority-menu" id="priority-menu-${list.id}">
                                                <div class="priority-item" data-value="urgent" onclick="selectPriority('${list.id}','urgent')">
                                                    <span class="priority-flag priority-flag-urgent"><i class="bi bi-flag-fill"></i></span>
                                                    <span>Urgent</span>
                                                </div>
                                                <div class="priority-item" data-value="high" onclick="selectPriority('${list.id}','high')">
                                                    <span class="priority-flag priority-flag-high"><i class="bi bi-flag-fill"></i></span>
                                                    <span>High</span>
                                                </div>
                                                <div class="priority-item" data-value="normal" onclick="selectPriority('${list.id}','normal')">
                                                    <span class="priority-flag priority-flag-normal"><i class="bi bi-flag-fill"></i></span>
                                                    <span>Normal</span>
                                                </div>
                                                <div class="priority-item" data-value="low" onclick="selectPriority('${list.id}','low')">
                                                    <span class="priority-flag priority-flag-low"><i class="bi bi-flag-fill"></i></span>
                                                    <span>Low</span>
                                                </div>
                                            </div>
                                            <input type="hidden" id="priority-${list.id}" value="normal">
                                        </div>
                                    </div>
                                </div>

                                <div class="meta-field-row">
                                    <div class="meta-label-group">
                                        <i class="bi bi-person-plus text-muted"></i>
                                        <span class="meta-label-text">Assign to</span>
                                    </div>
                                    <div class="meta-value">
                                        <div class="user-select" id="assign-select-${list.id}">
                                            <div class="user-select-control" onclick="toggleUserDropdown('${list.id}', 'assign')">
                                                <div class="user-select-avatar" id="assign-avatar-${list.id}">
                                                    <i class="bi bi-person text-muted"></i>
                                                </div>
                                                <span id="assign-label-${list.id}" class="user-select-placeholder">Select user...</span>
                                                <i class="bi bi-chevron-down ms-auto text-muted small"></i>
                                            </div>
                                            <div class="user-dropdown" id="assign-dropdown-${list.id}">
                                                <div class="user-search-wrapper">
                                                    <i class="bi bi-search text-muted"></i>
                                                    <input type="text" id="assign-search-${list.id}" class="user-search-input" placeholder="Search..." oninput="filterUserOptions('${list.id}', 'assign')">
                                                </div>
                                                <div class="user-list-label">People</div>
                                                <div class="user-list" id="assign-options-${list.id}">
                                                    ${(projectMembers || []).map(m => `
                                                        <div class="user-option" data-user-uid="${m.uid}" onclick="selectUser('${list.id}', 'assign', '${m.uid}')">
                                                            <div class="user-option-avatar">
                                                                <img src="${m.photo}" alt="${m.name}">
                                                            </div>
                                                            <div class="user-option-name">${m.name}</div>
                                                        </div>
                                                    `).join('')}
                                                </div>
                                            </div>
                                            <input type="hidden" id="assign-${list.id}" value="">
                                        </div>
                                    </div>
                                </div>

                                <div class="meta-field-row">
                                    <div class="meta-label-group">
                                        <i class="bi bi-bell text-muted"></i>
                                        <span class="meta-label-text">Notify to</span>
                                    </div>
                                    <div class="meta-value">
                                        <div class="user-select" id="notify-select-${list.id}">
                                            <div class="user-select-control" onclick="toggleUserDropdown('${list.id}', 'notify')">
                                                <div class="user-select-avatar" id="notify-avatar-${list.id}">
                                                    <i class="bi bi-person text-muted"></i>
                                                </div>
                                                <span id="notify-label-${list.id}" class="user-select-placeholder">Select user...</span>
                                                <i class="bi bi-chevron-down ms-auto text-muted small"></i>
                                            </div>
                                            <div class="user-dropdown" id="notify-dropdown-${list.id}">
                                                <div class="user-search-wrapper">
                                                    <i class="bi bi-search text-muted"></i>
                                                    <input type="text" id="notify-search-${list.id}" class="user-search-input" placeholder="Search..." oninput="filterUserOptions('${list.id}', 'notify')">
                                                </div>
                                                <div class="user-list-label">People</div>
                                                <div class="user-list" id="notify-options-${list.id}">
                                                    ${(projectMembers || []).map(m => `
                                                        <div class="user-option" data-user-uid="${m.uid}" onclick="selectUser('${list.id}', 'notify', '${m.uid}')">
                                                            <div class="user-option-avatar">
                                                                <img src="${m.photo}" alt="${m.name}">
                                                            </div>
                                                            <div class="user-option-name">${m.name}</div>
                                                        </div>
                                                    `).join('')}
                                                </div>
                                            </div>
                                            <input type="hidden" id="notify-${list.id}" value="">
                                        </div>
                                    </div>
                                </div>

                                <div class="meta-field-row">
                                    <div class="meta-label-group">
                                        <i class="bi bi-calendar text-muted"></i>
                                        <span class="meta-label-text">Dates</span>
                                    </div>
                                    <div class="meta-value">
                                        <input type="date" id="start-${list.id}" class="ghost-input">
                                        <span class="text-muted small">-</span>
                                        <input type="date" id="due-${list.id}" class="ghost-input">
                                    </div>
                                </div>

                                <div class="meta-field-row">
                                    <div class="meta-label-group">
                                        <i class="bi bi-star text-muted"></i>
                                        <span class="meta-label-text">Task point</span>
                                    </div>
                                    <div class="meta-value">
                                        <input type="number" id="points-${list.id}" class="ghost-input" min="0" placeholder="">
                                    </div>
                                </div>

                                <div class="meta-field-row">
                                    <div class="meta-label-group">
                                        <i class="bi bi-stopwatch text-muted"></i>
                                        <span class="meta-label-text">Track time</span>
                                    </div>
                                    <div class="meta-value">
                                        <span class="text-muted small" id="track-label-${list.id}"></span>
                                        <button type="button" class="btn btn-sm btn-outline-secondary rounded-pill px-3" disabled>Start</button>
                                    </div>
                                </div>

                                <div class="meta-field-row">
                                    <div class="meta-label-group">
                                        <i class="bi bi-tag text-muted"></i>
                                        <span class="meta-label-text">Tags</span>
                                    </div>
                                    <div class="meta-value">
                                        <div class="tag-selector w-100" id="tag-selector-${list.id}">
                                            <div class="tag-selector-control" onclick="toggleTagDropdown('${list.id}')">
                                                <div class="tag-selected-list" id="tag-selected-${list.id}">
                                                    <span class="tag-placeholder">Search or add tags...</span>
                                                </div>
                                                <i class="bi bi-chevron-down ms-auto text-muted small"></i>
                                            </div>
                                            <div class="tag-dropdown" id="tag-dropdown-${list.id}">
                                                <input type="text" id="tag-input-${list.id}" class="tag-search-input" placeholder="Search or add tags..." oninput="filterTagOptions('${list.id}')">
                                                <div class="tag-options" id="tag-options-${list.id}">
                                                    ${allProjectTags.map(tag => `
                                                        <div class="tag-option" data-tag="${tag}" onclick="toggleTagFromOption('${list.id}', this.dataset.tag)">
                                                            <span class="tag-pill" data-tag-pill="${tag}">${tag}</span>
                                                            <button type="button" class="tag-edit-btn" onclick="openTagEditor(event, '${tag}')">
                                                                <i class="bi bi-three-dots-vertical"></i>
                                                            </button>
                                                        </div>
                                                    `).join('')}
                                                </div>
                                                <div class="tag-create" id="tag-create-${list.id}" style="display:none;" onclick="createTagFromInput('${list.id}')">
                                                    <span>Create</span>
                                                    <span class="tag-create-label" id="tag-create-label-${list.id}"></span>
                                                </div>
                                            </div>
                                            <input type="hidden" id="tags-${list.id}" value="">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="mt-3">
                                <div class="rich-editor">
                                    <div class="rich-toolbar">
                                        <button type="button" class="rich-btn" onclick="applyFormat('desc-${list.id}','bold')"><i class="bi bi-type-bold"></i></button>
                                        <button type="button" class="rich-btn" onclick="applyFormat('desc-${list.id}','italic')"><i class="bi bi-type-italic"></i></button>
                                        <button type="button" class="rich-btn" onclick="applyFormat('desc-${list.id}','underline')"><i class="bi bi-type-underline"></i></button>
                                        <button type="button" class="rich-btn" onclick="applyFormat('desc-${list.id}','insertUnorderedList')"><i class="bi bi-list-ul"></i></button>
                                        <button type="button" class="rich-btn" onclick="applyFormat('desc-${list.id}','insertOrderedList')"><i class="bi bi-list-ol"></i></button>
                                        <button type="button" class="rich-btn ms-auto" onclick="triggerDescFileInput('task-${list.id}')"><i class="bi bi-paperclip"></i></button>
                                    </div>
                                    <div class="rich-editor-body" id="desc-${list.id}" contenteditable="true" data-placeholder="Task description or notes..."></div>
                                    <input type="file" id="task-desc-file-input-${list.id}" multiple style="display:none" onchange="handleDescFiles('task-${list.id}','desc-${list.id}',this)">
                                </div>
                            </div>
                            <div class="mt-3 d-flex gap-2 justify-content-end">
                                <button class="btn btn-dlg-blue rounded-pill px-4" onclick="saveTask('${list.id}')">Add to-do</button>
                                <button class="btn btn-light rounded-pill px-4" onclick="hideTaskForm('${list.id}')">Cancel</button>
                            </div>
                        </div>
                    </div>
                `;

                container.insertAdjacentHTML('beforeend', html);
                initTaskSortable(list.id);
            });

            if (hasSearchQuery && !anyTaskMatchedSearch) {
                if (!container.innerHTML.trim()) {
                    container.innerHTML = '<div class="text-center text-muted py-4">No tasks match your search.</div>';
                }
            }
        }

        function renderTaskRow(t, subtasks) {
            const list = projectLists.find(l => l.id === t.list_id);
            let statusColor = '#0B2B6A';

            if (list) {
                const statuses = getListStatuses(list);
                const currentStatusName = String(t.status || '').toLowerCase();
                const found = statuses.find(s => String(s.name || '').toLowerCase() === currentStatusName);
                if (found && found.color) statusColor = found.color;
            }

            let html = `
                <div class="todo-row ${t.status === 'Complete' ? 'task-row-done' : ''}" id="task-${t.id}" onclick="handleTaskRowClick(event, '${t.id}')">
                    <input type="checkbox" class="form-check-input me-2" ${t.status === 'Complete' ? 'checked' : ''} onclick="toggleDone('${t.id}', this.checked); event.stopPropagation();">
                    <div class="flex-grow-1 task-text-content">
                        ${t.title}
                        ${t.description ? `<i class="bi bi-filter-left ms-2 text-muted"></i>` : ''}
                        <span class="new-tab-hint" onclick="openTaskInNewTab(event, '${t.id}')">
                            Open In New Tab <i class="bi bi-box-arrow-in-up-right ms-1"></i>
                        </span>
                    </div>
                    <span class="badge border small" style="background:${statusColor}; color:#ffffff;">${t.status}</span>
                    <i class="bi bi-list drag-handle-task"></i>
                </div>
            `;

            subtasks.forEach(st => {
                html += `
                    <div class="todo-row subtask-indent ${st.status === 'Complete' ? 'task-row-done' : ''}" id="task-${st.id}" onclick="handleTaskRowClick(event, '${st.id}')">
                        <input type="checkbox" class="form-check-input me-2" ${st.status === 'Complete' ? 'checked' : ''} onclick="toggleDone('${st.id}', this.checked); event.stopPropagation();">
                        <div class="small task-text-content">${st.title}</div>
                        <span class="badge bg-light text-dark border small" style="background:${statusColor}; color:#ffffff;">${st.status}</span>
                        <i class="bi bi-list drag-handle-task"></i>
                    </div>
                `;
            });

            return html;
        }

        window.saveNewList = async () => {
            const name = document.getElementById('inputListName').value.trim();
            const desc = document.getElementById('inputListDesc').innerHTML;
            if (!name) return;

            await addDoc(collection(db, "projects", projectId, "lists"), {
                name: name,
                description: desc,
                position: projectLists.length,
                statuses: DEFAULT_LIST_STATUSES,
                created_at: serverTimestamp()
            });

            document.getElementById('inputListName').value = "";
            document.getElementById('inputListDesc').innerHTML = "";
            toggleNewListForm();
        };

        window.openEditListModal = (lid) => {
            const list = projectLists.find(l => l.id === lid);
            if (!list) return;
            const index = projectLists.findIndex(l => l.id === lid);
            const total = projectLists.length || 1;
            const nameInput = document.getElementById('editListName');
            const descInput = document.getElementById('editListDesc');
            const posInput = document.getElementById('editListPosition');
            const idInput = document.getElementById('editListId');
            if (!nameInput || !descInput || !posInput || !idInput) return;
            idInput.value = lid;
            nameInput.value = list.name || "";
            descInput.innerHTML = list.description || "";
            posInput.min = 1;
            posInput.max = total;
            posInput.value = index >= 0 ? index + 1 : total;
            new bootstrap.Modal(document.getElementById('editListModal')).show();
        };

        window.saveListEdit = async () => {
            const idInput = document.getElementById('editListId');
            const nameInput = document.getElementById('editListName');
            const descInput = document.getElementById('editListDesc');
            const posInput = document.getElementById('editListPosition');
            if (!idInput || !nameInput || !descInput || !posInput) return;
            const lid = idInput.value;
            const name = nameInput.value.trim();
            const desc = descInput.innerHTML;
            if (!lid || !name) return;
            const total = projectLists.length || 1;
            let pos = parseInt(posInput.value, 10);
            if (isNaN(pos) || pos < 1) pos = 1;
            if (pos > total) pos = total;
            const ordered = projectLists.slice();
            const currentIndex = ordered.findIndex(l => l.id === lid);
            if (currentIndex === -1) return;
            const item = ordered.splice(currentIndex, 1)[0];
            ordered.splice(pos - 1, 0, item);
            const batch = writeBatch(db);
            ordered.forEach((l, index) => {
                const ref = doc(db, "projects", projectId, "lists", l.id);
                const data = { position: index };
                if (l.id === lid) {
                    data.name = name;
                    data.description = desc;
                }
                batch.update(ref, data);
            });
            await batch.commit();
            const modal = bootstrap.Modal.getInstance(document.getElementById('editListModal'));
            if (modal) modal.hide();
        };

        window.applyFormat = (editorId, command) => {
            const editor = document.getElementById(editorId);
            if (!editor) return;
            editor.focus();
            document.execCommand(command, false, null);
        };

        window.triggerDescFileInput = (scope) => {
            if (scope === 'list') {
                const input = document.getElementById('list-desc-file-input');
                if (input) input.click();
                return;
            }
            const input = document.getElementById(`task-desc-file-input-${scope.replace('task-','')}`);
            if (input) input.click();
        };

        async function uploadDescriptionFiles(context, editorId, files) {
            if (!files || files.length === 0) return;
            const editor = document.getElementById(editorId);
            if (!editor) return;
            for (const file of files) {
                const path = `projects/${projectId || 'no-project'}/${context}/${Date.now()}_${file.name}`;
                const storageRef = ref(storage, path);
                await uploadBytes(storageRef, file);
                const url = await getDownloadURL(storageRef);
                const isImage = file.type && file.type.startsWith("image/");
                const html = isImage
                    ? `<div><img src="${url}" alt="${file.name}" style="max-width:100%; border-radius:8px;"></div>`
                    : `<div><a href="${url}" target="_blank">${file.name}</a></div>`;
                editor.focus();
                document.execCommand('insertHTML', false, html);
            }
        }

        window.handleDescFiles = async (context, editorId, inputEl) => {
            if (!inputEl) return;
            const files = inputEl.files;
            await uploadDescriptionFiles(context, editorId, files);
            inputEl.value = "";
        };

        async function logTaskChange(taskId, action, changes) {
            if (!taskId) return;
            try {
                const payload = {
                    action: action,
                    changes: changes || {},
                    project_id: projectId,
                    user_id: currentUser ? currentUser.uid : "",
                    created_at: serverTimestamp()
                };
                await addDoc(collection(db, "tasks", taskId, "logs"), payload);
            } catch (e) {
                console.error("Failed to log task change", e);
            }
        }

        window.openTaskInNewTab = (event, taskId) => {
            if (event) {
                event.stopPropagation();
                event.preventDefault();
            }
            if (!taskId) return;
            window.open(`item-details.html?id=${taskId}`, '_blank');
        };

        window.handleTaskRowClick = (event, taskId) => {
            const target = event.target;
            if (target.closest('input') || target.closest('.drag-handle-task')) {
                return;
            }
            window.open(`item-details.html?id=${taskId}`, '_blank');
        };

        window.saveTask = async (listId) => {
            const titleEl = document.getElementById(`title-${listId}`);
            if (!titleEl) return;
            const title = titleEl.value.trim();
            if (!title) return;

            const existingForList = allTasks.filter(t => t.list_id === listId);

            const statusEl = document.getElementById(`status-${listId}`);
            const priorityEl = document.getElementById(`priority-${listId}`);
            const startEl = document.getElementById(`start-${listId}`);
            const dueEl = document.getElementById(`due-${listId}`);
            const pointsEl = document.getElementById(`points-${listId}`);
            const assignEl = document.getElementById(`assign-${listId}`);
            const notifyEl = document.getElementById(`notify-${listId}`);
            const tagsEl = document.getElementById(`tags-${listId}`);

            const tagsValue = tagsEl ? tagsEl.value : "";
            const tagList = tagsValue
                ? tagsValue.split(",").map(t => t.trim()).filter(Boolean)
                : [];

            const payload = {
                project_id: projectId,
                list_id: listId,
                title: title,
                description: document.getElementById(`desc-${listId}`).innerHTML || "",
                status: statusEl ? (statusEl.value || "Initiate") : "Initiate",
                priority: priorityEl ? (priorityEl.value || "normal") : "normal",
                start_date: startEl ? (startEl.value || "") : "",
                due_date: dueEl ? (dueEl.value || "") : "",
                points: pointsEl && pointsEl.value ? Number(pointsEl.value) || 0 : 0,
                assign_to: assignEl ? (assignEl.value || "") : "",
                notify_to: notifyEl ? (notifyEl.value || "") : "",
                tags: tagList,
                position: existingForList.length,
                created_at: serverTimestamp(),
                created_by: currentUser ? currentUser.uid : ""
            };

            let docRef;
            try {
                docRef = await addDoc(collection(db, "tasks"), payload);
            } catch (e) {
                console.error("Failed to add task", e, payload);
                alert("Gagal menyimpan task ke Firebase: " + e.message);
                return;
            }

            if (docRef && docRef.id) {
                await logTaskChange(docRef.id, "create", payload);
            }

            titleEl.value = "";
            document.getElementById(`desc-${listId}`).innerHTML = "";
            if (startEl) startEl.value = "";
            if (dueEl) dueEl.value = "";
            if (pointsEl) pointsEl.value = "";
            if (assignEl) assignEl.value = "";
            if (notifyEl) notifyEl.value = "";
            if (tagsEl) tagsEl.value = "";
            hideTaskForm(listId);
        };

        window.togglePriorityMenu = (lid) => {
            const menu = document.getElementById(`priority-menu-${lid}`);
            if (!menu) return;
            menu.style.display = menu.style.display === "block" ? "none" : "block";
        };

        window.selectPriority = (lid, value) => {
            const hidden = document.getElementById(`priority-${lid}`);
            const label = document.getElementById(`priority-label-${lid}`);
            const flag = document.querySelector(`#priority-wrap-${lid} .priority-flag`);
            if (!hidden || !label || !flag) return;

            hidden.value = value;

            let text = "Normal";
            let className = "priority-flag-normal";
            if (value === "urgent") {
                text = "Urgent";
                className = "priority-flag-urgent";
            } else if (value === "high") {
                text = "High";
                className = "priority-flag-high";
            } else if (value === "low") {
                text = "Low";
                className = "priority-flag-low";
            }

            label.innerText = text;

            flag.classList.remove("priority-flag-urgent", "priority-flag-high", "priority-flag-normal", "priority-flag-low");
            flag.classList.add(className);

            const menu = document.getElementById(`priority-menu-${lid}`);
            if (menu) menu.style.display = "none";
        };

        window.toggleTagDropdown = (lid) => {
            const dropdown = document.getElementById(`tag-dropdown-${lid}`);
            if (!dropdown) return;
            dropdown.style.display = dropdown.style.display === "block" ? "none" : "block";
            const input = document.getElementById(`tag-input-${lid}`);
            if (dropdown.style.display === "block" && input) {
                input.focus();
                input.select();
                filterTagOptions(lid);
            }
        };

        window.filterTagOptions = (lid) => {
            const input = document.getElementById(`tag-input-${lid}`);
            const optionsContainer = document.getElementById(`tag-options-${lid}`);
            const createRow = document.getElementById(`tag-create-${lid}`);
            const createLabel = document.getElementById(`tag-create-label-${lid}`);
            if (!input || !optionsContainer || !createRow || !createLabel) return;

            const query = input.value.trim().toLowerCase();
            let hasVisible = false;
            let hasExact = false;

            Array.from(optionsContainer.children).forEach(opt => {
                const tag = (opt.dataset.tag || "").toLowerCase();
                const visible = !query || tag.indexOf(query) !== -1;
                opt.style.display = visible ? "flex" : "none";
                if (visible) {
                    hasVisible = true;
                    if (tag === query) hasExact = true;
                }
            });

            if (query && (!hasVisible || !hasExact)) {
                createRow.style.display = "flex";
                createLabel.innerText = query;
            } else {
                createRow.style.display = "none";
                createLabel.innerText = "";
            }
        };

        function getDefaultTagColor(name) {
            if (!name) return "#e5e7eb";
            let hash = 0;
            for (let i = 0; i < name.length; i++) {
                hash = ((hash << 5) - hash) + name.charCodeAt(i);
                hash |= 0;
            }
            const index = Math.abs(hash) % TAG_COLORS.length;
            return TAG_COLORS[index];
        }

        function getTagColorOverrides() {
            const key = `tagColors:${projectId}`;
            try {
                const raw = localStorage.getItem(key);
                if (!raw) return {};
                const parsed = JSON.parse(raw);
                if (parsed && typeof parsed === "object") return parsed;
                return {};
            } catch {
                return {};
            }
        }

        function saveTagColorOverrides(overrides) {
            const key = `tagColors:${projectId}`;
            try {
                localStorage.setItem(key, JSON.stringify(overrides));
            } catch {
            }
        }

        function getTagColor(name) {
            const overrides = getTagColorOverrides();
            if (overrides && overrides[name]) return overrides[name];
            return getDefaultTagColor(name);
        }

        function setTagsValue(lid, tags) {
            const hidden = document.getElementById(`tags-${lid}`);
            if (!hidden) return;
            const clean = Array.from(new Set(tags.map(t => t.trim()).filter(Boolean)));
            hidden.value = clean.join(",");
            updateSelectedTagUI(lid);
            const optionsContainer = document.getElementById(`tag-options-${lid}`);
            if (!optionsContainer) return;
            Array.from(optionsContainer.children).forEach(opt => {
                const tag = opt.dataset.tag;
                if (!tag) return;
                if (clean.includes(tag)) {
                    opt.classList.add("tag-option-selected");
                } else {
                    opt.classList.remove("tag-option-selected");
                }
            });
        }

        function getTagsValue(lid) {
            const hidden = document.getElementById(`tags-${lid}`);
            if (!hidden) return [];
            if (!hidden.value) return [];
            return hidden.value.split(",").map(t => t.trim()).filter(Boolean);
        }

        function updateSelectedTagUI(lid) {
            const selectedContainer = document.getElementById(`tag-selected-${lid}`);
            if (!selectedContainer) return;
            const tags = getTagsValue(lid);
            selectedContainer.innerHTML = "";
            if (tags.length === 0) {
                const span = document.createElement("span");
                span.className = "tag-placeholder";
                span.innerText = "Search or add tags...";
                selectedContainer.appendChild(span);
                return;
            }
            tags.forEach(tag => {
                const pill = document.createElement("span");
                pill.className = "tag-pill";
                pill.innerText = tag;
                pill.style.background = getTagColor(tag);
                const remove = document.createElement("span");
                remove.className = "tag-remove";
                remove.innerText = "";
                remove.onclick = function (event) {
                    event.stopPropagation();
                    removeTagFromSelection(lid, tag);
                };
                pill.appendChild(remove);
                selectedContainer.appendChild(pill);
            });
        }

        window.openTagEditor = (event, tagName) => {
            event.stopPropagation();
            const existing = document.getElementById("tag-editor-popover");
            let editor = existing;
            if (!editor) {
                editor = document.createElement("div");
                editor.id = "tag-editor-popover";
                editor.className = "tag-editor-popover";
                editor.innerHTML = `
                    <input type="text" id="tag-editor-name" class="tag-editor-input">
                    <div class="tag-color-grid" id="tag-color-grid"></div>
                    <div class="tag-editor-delete" id="tag-editor-delete">
                        <i class="bi bi-trash"></i>
                        <span>Delete</span>
                    </div>
                `;
                document.body.appendChild(editor);
                const grid = editor.querySelector("#tag-color-grid");
                TAG_COLORS.forEach(color => {
                    const swatch = document.createElement("div");
                    swatch.className = "tag-color-swatch";
                    swatch.style.background = color;
                    swatch.dataset.color = color;
                    swatch.onclick = function (e) {
                        e.stopPropagation();
                        chooseTagColor(color);
                    };
                    grid.appendChild(swatch);
                });
                const del = editor.querySelector("#tag-editor-delete");
                del.onclick = function (e) {
                    e.stopPropagation();
                    deleteTagDefinition();
                };
                document.addEventListener("click", function (e) {
                    const panel = document.getElementById("tag-editor-popover");
                    if (!panel) return;
                    if (panel.style.display !== "block") return;
                    if (panel.contains(e.target)) return;
                    panel.style.display = "none";
                });
            }

            tagEditorState.tagName = tagName;
            tagEditorState.color = getTagColor(tagName);

            const input = document.getElementById("tag-editor-name");
            input.value = tagName;
            input.oninput = function () {
                applyTagNameChange(this.value);
            };

            const swatches = editor.querySelectorAll(".tag-color-swatch");
            swatches.forEach(s => {
                if (s.dataset.color === tagEditorState.color) {
                    s.classList.add("tag-color-swatch-selected");
                } else {
                    s.classList.remove("tag-color-swatch-selected");
                }
            });

            const rect = event.currentTarget.getBoundingClientRect();
            editor.style.top = `${window.scrollY + rect.bottom + 4}px`;
            editor.style.left = `${window.scrollX + rect.left}px`;
            editor.style.display = "block";
        };

        function applyTagNameChange(newNameRaw) {
            const newName = newNameRaw.trim();
            if (!newName || newName === tagEditorState.tagName) return;
            const overrides = getTagColorOverrides();
            const color = overrides[tagEditorState.tagName] || tagEditorState.color || getDefaultTagColor(tagEditorState.tagName);
            delete overrides[tagEditorState.tagName];
            overrides[newName] = color;
            saveTagColorOverrides(overrides);
            const options = document.querySelectorAll(`.tag-option[data-tag="${tagEditorState.tagName}"]`);
            options.forEach(opt => {
                opt.dataset.tag = newName;
                const pill = opt.querySelector(".tag-pill");
                if (pill) {
                    pill.innerText = newName;
                    pill.dataset.tagPill = newName;
                    pill.style.background = color;
                }
                const btn = opt.querySelector(".tag-edit-btn");
                if (btn) {
                    btn.setAttribute("onclick", `openTagEditor(event, '${newName}')`);
                }
            });
            const pills = document.querySelectorAll(`.tag-selected-list .tag-pill`);
            pills.forEach(pill => {
                if (pill.innerText === tagEditorState.tagName) {
                    pill.innerText = newName;
                    pill.style.background = color;
                }
            });
            const inputs = document.querySelectorAll(`input[id^="tags-"]`);
            inputs.forEach(input => {
                if (!input.value) return;
                const parts = input.value.split(",").map(t => t.trim()).filter(Boolean);
                let changed = false;
                const updated = parts.map(t => {
                    if (t === tagEditorState.tagName) {
                        changed = true;
                        return newName;
                    }
                    return t;
                });
                if (changed) {
                    input.value = updated.join(",");
                }
            });
            tagEditorState.tagName = newName;
        }

        function chooseTagColor(color) {
            tagEditorState.color = color;
            const overrides = getTagColorOverrides();
            overrides[tagEditorState.tagName] = color;
            saveTagColorOverrides(overrides);
            const swatches = document.querySelectorAll(".tag-color-swatch");
            swatches.forEach(s => {
                if (s.dataset.color === color) {
                    s.classList.add("tag-color-swatch-selected");
                } else {
                    s.classList.remove("tag-color-swatch-selected");
                }
            });
            const pills = document.querySelectorAll(`[data-tag-pill="${tagEditorState.tagName}"]`);
            pills.forEach(pill => {
                pill.style.background = color;
            });
            const selectedPills = document.querySelectorAll(".tag-selected-list .tag-pill");
            selectedPills.forEach(pill => {
                if (pill.innerText === tagEditorState.tagName) {
                    pill.style.background = color;
                }
            });
        }

        function deleteTagDefinition() {
            const name = tagEditorState.tagName;
            if (!name) return;
            const confirmed = confirm(`Delete tag "${name}" from suggestions?`);
            if (!confirmed) return;
            const overrides = getTagColorOverrides();
            delete overrides[name];
            saveTagColorOverrides(overrides);
            const options = document.querySelectorAll(`.tag-option[data-tag="${name}"]`);
            options.forEach(opt => opt.remove());
            const inputs = document.querySelectorAll(`input[id^="tags-"]`);
            inputs.forEach(input => {
                if (!input.value) return;
                const parts = input.value.split(",").map(t => t.trim()).filter(Boolean);
                const updated = parts.filter(t => t !== name);
                if (updated.length !== parts.length) {
                    input.value = updated.join(",");
                }
            });
            const lists = document.querySelectorAll(".tag-selected-list");
            lists.forEach(list => {
                const pills = Array.from(list.querySelectorAll(".tag-pill"));
                let removed = false;
                pills.forEach(p => {
                    if (p.innerText === name) {
                        p.remove();
                        removed = true;
                    }
                });
                if (removed && list.children.length === 0) {
                    const span = document.createElement("span");
                    span.className = "tag-placeholder";
                    span.innerText = "Search or add tags...";
                    list.appendChild(span);
                }
            });
            const editor = document.getElementById("tag-editor-popover");
            if (editor) editor.style.display = "none";
        }

        window.toggleUserDropdown = (lid, field) => {
            const dropdown = document.getElementById(`${field}-dropdown-${lid}`);
            if (!dropdown) return;
            dropdown.style.display = dropdown.style.display === "block" ? "none" : "block";
            const search = document.getElementById(`${field}-search-${lid}`);
            if (dropdown.style.display === "block" && search) {
                search.focus();
                search.select();
                filterUserOptions(lid, field);
            }
        };

        window.filterUserOptions = (lid, field) => {
            const search = document.getElementById(`${field}-search-${lid}`);
            const list = document.getElementById(`${field}-options-${lid}`);
            if (!search || !list) return;
            const q = search.value.trim().toLowerCase();
            Array.from(list.children).forEach(opt => {
                const nameEl = opt.querySelector(".user-option-name");
                const text = nameEl ? nameEl.innerText.toLowerCase() : "";
                const visible = !q || text.indexOf(q) !== -1;
                opt.style.display = visible ? "flex" : "none";
            });
        };

        window.selectUser = (lid, field, uid) => {
            const hidden = document.getElementById(`${field}-${lid}`);
            const label = document.getElementById(`${field}-label-${lid}`);
            const avatarWrap = document.getElementById(`${field}-avatar-${lid}`);
            if (!hidden || !label || !avatarWrap) return;

            const user = projectMembers.find(m => m.uid === uid);
            if (!user) return;

            hidden.value = uid;
            label.className = "user-select-name";
            label.innerText = user.name || "User";

            avatarWrap.innerHTML = "";
            const img = document.createElement("img");
            img.src = user.photo;
            img.alt = user.name || "User";
            avatarWrap.appendChild(img);

            const dropdown = document.getElementById(`${field}-dropdown-${lid}`);
            if (dropdown) dropdown.style.display = "none";
        };

        window.toggleTagFromOption = (lid, tag) => {
            const current = getTagsValue(lid);
            const index = current.indexOf(tag);
            if (index >= 0) {
                current.splice(index, 1);
            } else {
                current.push(tag);
            }
            setTagsValue(lid, current);
        };

        window.createTagFromInput = (lid) => {
            const input = document.getElementById(`tag-input-${lid}`);
            if (!input) return;
            const value = input.value.trim();
            if (!value) return;
            const current = getTagsValue(lid);
            if (!current.includes(value)) {
                current.push(value);
            }
            const optionsContainer = document.getElementById(`tag-options-${lid}`);
            if (optionsContainer && !Array.from(optionsContainer.children).some(opt => opt.dataset.tag === value)) {
                const opt = document.createElement("div");
                opt.className = "tag-option";
                opt.dataset.tag = value;
                opt.onclick = function () {
                    window.toggleTagFromOption(lid, value);
                };
                const pill = document.createElement("span");
                pill.className = "tag-pill";
                pill.innerText = value;
                opt.appendChild(pill);
                optionsContainer.insertBefore(opt, optionsContainer.firstChild || null);
            }
            setTagsValue(lid, current);
            input.value = "";
            filterTagOptions(lid);
        };

        function removeTagFromSelection(lid, tag) {
            const current = getTagsValue(lid);
            const index = current.indexOf(tag);
            if (index >= 0) {
                current.splice(index, 1);
                setTagsValue(lid, current);
            }
        }

        window.toggleDone = async (id, isChecked) => {
            const newStatus = isChecked ? "Complete" : "Initiate";
            await updateDoc(doc(db, "tasks", id), {
                status: newStatus
            });
            await logTaskChange(id, "update_status", { status: newStatus });
        };

        window.openStatusColorPicker = (dotEl) => {
            if (!dotEl) return;
            if (!statusColorPickerInput) {
                statusColorPickerInput = document.createElement("input");
                statusColorPickerInput.type = "color";
                statusColorPickerInput.style.position = "fixed";
                statusColorPickerInput.style.left = "-9999px";
                document.body.appendChild(statusColorPickerInput);
                statusColorPickerInput.addEventListener("input", () => {
                    const target = statusColorPickerInput._targetDot;
                    if (!target) return;
                    const row = target.closest(".status-row");
                    if (!row) return;
                    const color = statusColorPickerInput.value;
                    target.style.borderColor = color;
                    row.dataset.color = color;
                });
            }
            const row = dotEl.closest(".status-row");
            if (!row) return;
            statusColorPickerInput._targetDot = dotEl;
            statusColorPickerInput.value = row.dataset.color || "#0B2B6A";
            statusColorPickerInput.click();
        };

        window.openStatusManager = (lid) => {
            const list = projectLists.find(l => l.id === lid);
            if (!list) return;

            document.getElementById('activeListIdForStatus').value = lid;
            const container = document.getElementById('statusListContainer');

            let statuses = getListStatuses(list).slice().sort((a, b) => {
                const pa = typeof a.position === "number" ? a.position : 0;
                const pb = typeof b.position === "number" ? b.position : 0;
                return pa - pb;
            });

            const groups = {
                prepare: [],
                process: [],
                polish: []
            };

            statuses.forEach(s => {
                const type = String(s.type || "").toLowerCase();
                let key = "process";
                if (type === "not_started" || type === "prepare") key = "prepare";
                else if (type === "done" || type === "polish") key = "polish";
                const color = s.color || "#0B2B6A";
                groups[key].push({
                    name: s.name,
                    color: color
                });
            });

            const buildRows = (items, sectionKey) => {
                return items.map(s => `
                    <div class="d-flex align-items-center gap-2 bg-white border p-2 mb-2 rounded-pill status-row" data-name="${s.name}" data-color="${s.color}">
                        <div class="status-color-ring" style="width:18px; height:18px; border-radius:999px; border:2px solid ${s.color}; cursor:pointer;" onclick="openStatusColorPicker(this)"></div>
                        <span class="fw-bold small flex-grow-1" onclick="editStatusName(this)">${String(s.name || "").toUpperCase()}</span>
                        <button class="btn btn-sm btn-link text-danger p-0" onclick="this.closest('.status-row').remove()">Delete</button>
                        <i class="bi bi-grip-vertical ms-1"></i>
                    </div>
                `).join('');
            };

            const html = `
                <div class="status-section mb-3" data-section="prepare">
                    <div class="small text-muted mb-1">Prepare</div>
                    <div class="status-section-body">
                        ${buildRows(groups.prepare, "prepare")}
                    </div>
                </div>
                <div class="status-section mb-3" data-section="process">
                    <div class="small text-muted mb-1">Process</div>
                    <div class="status-section-body">
                        ${buildRows(groups.process, "process")}
                    </div>
                </div>
                <div class="status-section mb-0" data-section="polish">
                    <div class="small text-muted mb-1">Polish</div>
                    <div class="status-section-body">
                        ${buildRows(groups.polish, "polish")}
                    </div>
                </div>
            `;

            container.innerHTML = html;

            const bodies = container.querySelectorAll(".status-section-body");
            bodies.forEach(body => {
                new Sortable(body, {
                    group: "statuses",
                    handle: ".bi-grip-vertical",
                    animation: 150
                });
            });

            new bootstrap.Modal(document.getElementById('manageStatusModal')).show();
        };

        window.addNewStatusToList = () => {
            const nameInput = document.getElementById('newStatusNameInput');
            const name = nameInput.value.trim();
            if (!name) return;

            const container = document.querySelector('#statusListContainer .status-section[data-section="process"] .status-section-body') || document.getElementById('statusListContainer');
            const color = "#0B2B6A";
            const div = document.createElement('div');
            div.className = "d-flex align-items-center gap-2 bg-white border p-2 mb-2 rounded-pill status-row";
            div.dataset.name = name;
            div.dataset.color = color;
            div.innerHTML = `
                <div class="status-color-ring" style="width:18px; height:18px; border-radius:999px; border:2px solid ${color}; cursor:pointer;" onclick="openStatusColorPicker(this)"></div>
                <span class="fw-bold small flex-grow-1" onclick="editStatusName(this)">${name.toUpperCase()}</span>
                <button class="btn btn-sm btn-link text-danger p-0" onclick="this.closest('.status-row').remove()">Delete</button>
                <i class="bi bi-grip-vertical ms-1"></i>
            `;
            if (container) {
                container.appendChild(div);
                if (container.classList.contains("status-section-body")) {
                    new Sortable(container, {
                        group: "statuses",
                        handle: ".bi-grip-vertical",
                        animation: 150
                    });
                }
            }
            nameInput.value = "";
        };

        window.saveStatusChanges = async () => {
            const lid = document.getElementById('activeListIdForStatus').value;
            if (!lid) return;

            const rows = document.querySelectorAll('#statusListContainer .status-row');
            const newStatuses = [];
            rows.forEach((el, index) => {
                const section = el.closest('.status-section');
                const sectionKey = section ? section.dataset.section : 'process';
                let type = 'process';
                if (sectionKey === 'prepare') type = 'prepare';
                else if (sectionKey === 'polish') type = 'polish';
                newStatuses.push({
                    name: el.dataset.name,
                    color: el.dataset.color || '#0B2B6A',
                    position: index,
                    type: type
                });
            });

            await updateDoc(doc(db, "projects", projectId, "lists", lid), {
                statuses: newStatuses
            });

            const modal = bootstrap.Modal.getInstance(document.getElementById('manageStatusModal'));
            if (modal) modal.hide();
        };

        window.editStatusName = (el) => {
            const row = el.closest('.status-row');
            if (!row) return;
            const current = row.dataset.name || el.textContent || "";
            const next = prompt("Ubah nama status", current);
            if (!next) return;
            const trimmed = next.trim();
            if (!trimmed) return;
            row.dataset.name = trimmed;
            el.textContent = trimmed.toUpperCase();
        };

        window.deleteList = async (lid) => {
            if (!confirm("Delete this list and its tasks?")) return;

            const listRef = doc(db, "projects", projectId, "lists", lid);
            const listSnap = await getDoc(listRef);

            const q = query(collection(db, "tasks"), where("list_id", "==", lid));
            const snap = await getDocs(q);

            const batch = writeBatch(db);

            if (listSnap && listSnap.exists()) {
                const trashRef = doc(collection(db, "trash"));
                batch.set(trashRef, {
                    type: "list",
                    project_id: projectId,
                    entity_id: lid,
                    data: listSnap.data(),
                    deleted_at: serverTimestamp(),
                    deleted_by: currentUser ? currentUser.uid : ""
                });
            }

            snap.forEach(d => {
                const trashRef = doc(collection(db, "trash"));
                batch.set(trashRef, {
                    type: "task",
                    project_id: projectId,
                    list_id: lid,
                    entity_id: d.id,
                    data: d.data(),
                    deleted_at: serverTimestamp(),
                    deleted_by: currentUser ? currentUser.uid : ""
                });
                batch.delete(d.ref);
            });

            batch.delete(listRef);
            await batch.commit();
        };

        window.toggleNewListForm = () => {
            const f = document.getElementById('newListForm');
            if (!f) return;
            f.style.display = f.style.display === 'none' ? 'block' : 'none';
        };

        window.showTaskForm = (lid) => {
            const el = document.getElementById(`form-add-${lid}`);
            if (el) el.style.display = 'block';
        };

        window.hideTaskForm = (lid) => {
            const el = document.getElementById(`form-add-${lid}`);
            if (el) el.style.display = 'none';
        };

        window.showFullDesc = (lid) => {
            const list = projectLists.find(l => l.id === lid);
            if (!list) return;
            const titleEl = document.getElementById('descModalTitle');
            const bodyEl = document.getElementById('descModalBody');
            if (titleEl) titleEl.innerText = list.name;
            if (bodyEl) bodyEl.innerHTML = list.description || "";
            new bootstrap.Modal(document.getElementById('descModal')).show();
        };

        function initTaskSortable(lid) {
            const el = document.getElementById(`items-${lid}`);
            if (!el) return;
            new Sortable(el, {
                handle: '.drag-handle-task',
                animation: 150,
                onEnd: async function () {
                    const rows = el.querySelectorAll('.todo-row');
                    rows.forEach(async (row, index) => {
                        const taskId = row.id.replace('task-', '');
                        await updateDoc(doc(db, "tasks", taskId), { position: index });
                        await logTaskChange(taskId, "update_position", { position: index });
                    });
                }
            });
        }
    </script>
</body>
</html>
