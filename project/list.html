<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>List - Dialogika</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="../assets/css/style.css" rel="stylesheet" />

    <style>
        /* --- BASE LAYOUT --- */
        body { background-color: #f1f7fd; font-family: 'Poppins', sans-serif; }
        .main-content { margin-left: 290px; width: calc(100% - 290px); padding: 40px; min-height: 100vh; }
        @media (max-width: 991px) { .main-content { margin-left: 0; width: 100%; padding: 20px; } }

        /* --- PROJECT CONTEXT CARD (Header) --- */
        .project-context-card {
            max-width: 800px; width: 90%; background: white; color: #1f2937;
            margin: 20px auto -20px auto; padding: 15px 25px 35px 25px;
            border-radius: 16px 16px 0 0; position: relative; z-index: 1;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.05);
        }
        .ph-badge {
            background: #FDE047; color: #854D0E; font-size: 0.7rem; font-weight: 800;
            padding: 4px 8px; border-radius: 4px; text-transform: uppercase;
            position: absolute; left: 30px; top: 38%; transform: translateY(-50%);
        }
        .ph-crumb-container {
            display: flex; align-items: center; gap: 12px;
            background: #1f2937; padding: 8px 20px;
            border-radius: 50px; font-size: 0.95rem; color: white;
        }
        .ph-crumb-link { text-decoration: none; color: #d1d5db; font-weight: 500; transition: 0.2s; }
        .ph-crumb-link:hover { color: white; }
        .ph-crumb-active { color: white; font-weight: 700; border-bottom: 2px solid #FDE047; padding-bottom: 2px; }
        .ph-sep { font-size: 0.8rem; color: white; }

        /* --- MAIN LIST CARD --- */
        .main-list-card {
            max-width: 1000px; width: 100%; margin: 0 auto 50px auto;
            background: white; border-radius: 16px;
            box-shadow: 0 10px 40px -5px rgba(0, 0, 0, 0.1);
            padding: 60px; position: relative; z-index: 2;
            border: 1px solid #d1d5db; min-height: 400px;
        }
        .list-header-container { display: flex; justify-content: space-between; align-items: center; margin-bottom: 3rem; position: relative; }
        .btn-new-list { background-color: #0B2B6A; color: white; border-radius: 50px; padding: 10px 24px; font-weight: 600; font-size: 0.95rem; border: none; transition: 0.2s; white-space: nowrap;  }
        .btn-new-list:hover { background-color: #08204e; transform: translateY(-2px); color: white; }

        /* --- STATUS BADGE SYSTEM (List View) --- */
        .status-pill-container {
            display: flex; align-items: center; gap: 8px;
            flex-wrap: wrap; margin-top: 10px; margin-bottom: 20px;
        }
        .status-badge-main {
            padding: 6px 16px; border-radius: 6px; font-size: 0.75rem; font-weight: 700;
            text-transform: uppercase; color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            cursor: default; transition: 0.2s; display: inline-block;
        }
        .btn-add-status {
            width: 32px; height: 32px; border-radius: 50%; border: 1px dashed #cbd5e1;
            background: white; color: #64748b; display: flex; align-items: center;
            justify-content: center; cursor: pointer; transition: 0.2s;
        }
        .btn-add-status:hover { background: #f1f5f9; border-color: #0B2B6A; color: #0B2B6A; }

        /* --- UI TASK FORM (ClickUp Style Panel) --- */
        .task-create-panel { background: #fff; border: 1px solid #e2e8f0; border-radius: 12px; padding: 30px; margin-top: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); display: none; animation: fadeIn 0.2s; }
        .task-title-large { font-size: 1.8rem; font-weight: 700; color: #1f2937; border: none; outline: none; width: 100%; margin-bottom: 20px; background: transparent; }
        .task-title-large::placeholder { color: #cbd5e1; }
        
        .meta-grid-container { display: grid; grid-template-columns: 1fr 1fr; gap: 15px 40px; margin-bottom: 20px; }
        .meta-row { display: flex; align-items: center; padding: 2px 0; }
        .meta-icon { width: 24px; text-align: center; color: #94a3b8; margin-right: 12px; font-size: 1rem; }
        .meta-label { width: 100px; color: #64748b; font-size: 0.9rem; flex-shrink: 0; }
        .meta-value { flex-grow: 1; min-width: 0; }
        
        .ghost-input { border: 1px solid transparent; background: transparent; padding: 6px 8px; border-radius: 6px; width: 100%; color: #334155; font-size: 0.9rem; transition: 0.2s; }
        .ghost-input:hover, .ghost-input:focus { background: #f1f5f9; border-color: #cbd5e1; outline: none; }

        /* --- TASK STATUS SELECTOR (Inside Form) --- */
        .task-status-selector {
            background: #007bff; /* default */
            color: white; border-radius: 4px; padding: 4px 12px;
            display: inline-flex; align-items: center; gap: 8px;
            font-weight: 700; font-size: 0.75rem; cursor: pointer;
        }
        .task-status-selector select {
            background: transparent; border: none; color: white;
            font-weight: 700; outline: none; text-transform: uppercase; cursor: pointer;
        }
        .task-status-selector select option { color: #333; background: white; }

        /* --- PRIORITY DROPDOWN CUSTOM --- */
        .priority-dropdown {
            position: relative;
            width: 100%;
        }
        .priority-trigger {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            padding: 6px 10px;
            border-radius: 6px;
            transition: 0.2s;
            background: transparent;
        }
        .priority-trigger:hover {
            background: #f1f5f9;
        }
        .priority-menu {
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            display: none;
            z-index: 1050;
            min-width: 160px;
            padding: 6px;
            margin-top: 4px;
        }
        .priority-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 6px;
            font-size: 0.9rem;
            color: #334155;
            transition: 0.2s;
        }
        .priority-item:hover {
            background: #f8fafc;
        }
        .priority-item i {
            font-size: 1rem;
        }

        /* --- ENHANCED TAG SYSTEM --- */ 
        /* Container Dropdown Tag */ 
        .tag-dropdown { 
            position: absolute; 
            top: 100%; 
            left: 0; 
            width: 100%; 
            max-height: 300px; 
            background: white; 
            border-radius: 8px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.15); 
            z-index: 1000; 
            display: none; 
            overflow-y: auto; 
            padding: 8px 0; 
            border: 1px solid #e2e8f0; 
        } 
        
        /* Style Item Tag (Gambar 1) */ 
        .tag-option-item { 
            padding: 8px 16px; 
            display: flex; 
            align-items: center; 
            cursor: pointer; 
            transition: background 0.2s; 
        } 
        .tag-option-item:hover { background: #f8fafc; } 
        
        /* Style Create Tag (Gambar 2) */ 
        .tag-create-prompt { 
            padding: 12px 16px; 
            border-top: 1px solid #f1f5f9; 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            cursor: pointer; 
            color: #64748b; 
            font-size: 0.9rem; 
        } 
        .tag-create-prompt:hover { background: #f0f9ff; color: #0369a1; } 
        
        .create-badge { 
            background: #fef3c7; 
            color: #92400e; 
            padding: 2px 8px; 
            border-radius: 4px; 
            font-weight: 600; 
            margin-left: 8px; 
        }

        /* Edit Tag UI */ 
        .tag-edit-container { padding: 10px; display: none; } 
        .color-mini-grid { 
            display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; margin: 12px 0; 
        } 
        .btn-delete-tag { 
            color: #ef4444; background: none; border: none; font-size: 0.85rem; 
            display: flex; align-items: center; gap: 6px; padding: 5px; width: 100%; 
        } 
        .btn-delete-tag:hover { background: #fef2f2; border-radius: 6px; } 
        
        /* Notes Editor */ 
        .notes-label { font-weight: 600; color: #64748b; font-size: 0.85rem; margin-bottom: 8px; }

        /* Color Picker Grid */
        .color-picker-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; padding: 10px; background: #fff; border: 1px solid #e2e8f0; border-radius: 8px; margin-top: 8px; }
        .color-dot { width: 20px; height: 20px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: 0.2s; }
        .color-dot:hover { transform: scale(1.2); }
        .color-dot.active { border-color: #000; transform: scale(1.1); }

        /* --- EDITOR --- */
        .rich-editor-box { border: 1px solid #d1d5db; border-radius: 8px; overflow: hidden; background: white; transition: 0.2s; }
        .rich-editor-box:focus-within { border-color: #0B2B6A; box-shadow: 0 0 0 3px rgba(11, 43, 106, 0.1); }
        .rich-editor-toolbar { background: #f8fafc; border-bottom: 1px solid #f1f5f9; padding: 6px 10px; display: flex; gap: 5px; flex-wrap: wrap; }
        .editor-btn { border: 1px solid transparent; background: none; color: #64748b; font-size: 0.95rem; width: 32px; height: 32px; border-radius: 4px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; }
        .editor-btn:hover { background: #e2e8f0; color: #0f172a; }
        .rich-editor-content { min-height: 100px; padding: 15px; outline: none; font-size: 0.95rem; line-height: 1.6; }
        .rich-editor-content:empty:before { content: attr(data-placeholder); color: #94a3b8; }

        /* --- UTILITIES --- */
        .cursor-pointer { cursor: pointer; }
        .tag-pill { padding: 4px 10px; border-radius: 4px; font-size: 0.75rem; font-weight: 600; color: white; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* --- USER DROPDOWN (DARK THEME) --- */
        .user-dropdown-container { position: relative; width: 100%; }

        .user-trigger {
            display: flex; align-items: center; gap: 10px;
            padding: 6px 12px; border-radius: 8px; cursor: pointer;
            transition: 0.2s; background: transparent; border: 1px solid transparent;
        }
        .user-trigger:hover { background: #f1f5f9; border-color: #cbd5e1; }

        .user-menu-dark {
            position: absolute; top: 100%; left: 0; width: 300px;
            background: #1e1e1e; color: white; border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); z-index: 2000;
            display: none; padding: 12px; margin-top: 8px;
        }

        .user-search-box {
            background: #121212; border: 1px solid #333; border-radius: 8px;
            display: flex; align-items: center; padding: 8px 12px; margin-bottom: 15px;
        }
        .user-search-box i { color: #888; margin-right: 10px; }
        .user-search-box input {
            background: transparent; border: none; color: white;
            outline: none; width: 100%; font-size: 0.9rem;
        }

        .user-list-scroll { max-height: 300px; overflow-y: auto; }
        .user-section-label { color: #888; font-size: 0.75rem; font-weight: 600; margin: 10px 0 8px 5px; }

        .user-item {
            display: flex; align-items: center; gap: 12px; padding: 8px;
            border-radius: 8px; cursor: pointer; transition: 0.1s;
        }
        .user-item:hover { background: #2d2d2d; }

        .user-avatar {
            width: 32px; height: 32px; border-radius: 50%; object-fit: cover;
            border: 2px solid #444;
        }
        .user-name { font-size: 0.9rem; flex-grow: 1; }
        .verified-badge { color: #7c4dff; font-size: 0.85rem; } /* Verified icon color */

        .selected-user-pill {
            display: flex; align-items: center; gap: 6px;
            background: #f1f5f9; padding: 2px 8px; border-radius: 20px; font-size: 0.85rem;
        }
        /* --- PROJECT TOOLS MODAL STYLE --- */
        .modal-tools-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            padding: 10px;
        }

        @media (min-width: 768px) {
            .modal-tools-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        .tool-nav-card {
            border: 1px solid #e5e7eb;
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            text-decoration: none;
            transition: all 0.2s ease;
            background: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .tool-nav-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.08);
            border-color: #0B2B6A;
        }

        .tool-nav-card .tool-title {
            font-weight: 700;
            color: #1f2937;
            font-size: 1rem;
            margin: 0;
        }

        .tool-nav-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.8rem;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .modal-content-custom {
            border-radius: 24px;
            border: none;
            background-color: #f9fafb;
        }
    </style>
    <!-- Tambahkan di HEAD -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

    <!-- Tambahkan di STYLE -->
    <style>
        /* --- STATUS MANAGER MODAL --- */
    .status-group-label { font-size: 0.85rem; font-weight: 700; color: #64748b; margin-bottom: 10px; display: flex; align-items: center; gap: 5px; }

    /* Pastikan kontainer bisa menerima drop meskipun kosong */ 
    .status-drag-container { 
        min-height: 20px; /* Sangat penting */ 
        padding-bottom: 10px; 
    } 

    .status-item-row { 
        display: flex; 
        align-items: center; 
        gap: 12px; 
        background: white; 
        border: 1px solid #e2e8f0; 
        border-radius: 10px; 
        padding: 10px 15px; 
        margin-bottom: 8px; 
        transition: 0.2s; 
        cursor: default; 
        user-select: none; 
    } 

    .status-item-row:hover { border-color: #0B2B6A; } 

    .drag-handle { 
        cursor: grab; 
        color: #cbd5e1; 
        padding: 0 5px; 
    } 

    .status-dot-btn { 
        width: 16px; 
        height: 16px; 
        border-radius: 50%; 
        cursor: pointer; 
        flex-shrink: 0; 
        border: 1px solid rgba(0,0,0,0.1); 
    } 

    .status-input-inline { 
        border: none; 
        outline: none; 
        font-weight: 600; 
        color: #1f2937; 
        flex-grow: 1; 
        background: transparent; 
    } 
    
    /* New Status Input Card */
    .new-status-card { border: 2px solid #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
    .btn-save-inline { background: #0084ff; color: white; border: none; border-radius: 6px; padding: 4px 12px; font-weight: 600; font-size: 0.85rem; }

    /* Floating Color Picker */ 
    .color-palette-popup { 
        position: absolute; 
        z-index: 3000; 
        background: white; 
        border-radius: 12px; 
        box-shadow: 0 10px 25px rgba(0,0,0,0.2); 
        padding: 15px; 
        width: 250px; 
        display: none; 
    } 
    .color-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; } 
    .color-circle { width: 22px; height: 22px; border-radius: 50%; cursor: pointer; border: 1px solid rgba(0,0,0,0.1); }
    .color-circle:hover { transform: scale(1.2); }
    .color-circle.active { border-color: #000; }

    /* --- TASK ROW STYLING --- */ 
    .todo-row { 
        transition: background-color 0.2s; 
        border-bottom: 1px solid #f1f5f9 !important; 
    } 
    
    /* Checkbox Bulat */ 
    .task-checkbox { 
        width: 20px !important; 
        height: 20px !important; 
        border-radius: 50% !important; /* Membuat bulat */ 
        border: 2px solid #cbd5e1 !important; 
        cursor: pointer; 
        flex-shrink: 0; 
    } 
    
    .task-checkbox:checked { 
        background-color: #0d6efd; 
        border-color: #0d6efd; 
    } 
    
    /* Gaya Tulisan Selesai (Strikeout & Abu-abu) */ 
    .task-row-done .task-text-content { 
        text-decoration: line-through; 
        color: #94a3b8 !important; /* Warna abu-abu */ 
    } 
    
    /* Hover Effect: Munculkan tulisan New Tab */ 
    .new-tab-hint { 
        opacity: 0; 
        font-size: 0.7rem; 
        color: #0B2B6A; 
        font-weight: 700; 
        margin-left: 10px; 
        transition: opacity 0.2s; 
        text-transform: uppercase; 
    } 
    
    .todo-row:hover .new-tab-hint { 
        opacity: 1; 
    } 
    
    .todo-row:hover { 
        background-color: #f8fafc; 
    }
    </style>

</head>
<body>

    <!-- 1. TOP BAR FIXED -->
    <nav class="top-bar">
        <!-- Left: Mobile Toggle & Search -->
        <div class="d-flex align-items-center">
            <button class="mobile-toggle me-3" onclick="toggleSidebar()">
                <i class="bi bi-list"></i>
            </button>
            <div class="input-group d-none d-md-flex" style="width: 250px;">
                <span class="input-group-text bg-light border-end-0 rounded-start-pill text-muted"><i class="bi bi-search"></i></span>
                <input type="text" class="form-control bg-light border-start-0 rounded-end-pill" placeholder="Search...">
            </div>
        </div>

        <!-- CENTER: LOGO DIALOGIKA -->
        <div class="logo-center">
            <img src="https://www.dialogika.co/assets/img/logo.webp" alt="Dialogika Logo" height="35">
        </div>

        <!-- Right: Profile -->
        <div class="d-flex align-items-center gap-3">
            <div class="text-end d-none d-lg-block lh-1">
                <span id="user-name-display" class="d-block fw-bold small text-dark">Loading...</span>
                <small id="user-role-display" class="text-muted" style="font-size:0.7rem">User</small>
            </div>
            <div class="profile-img-container">
                <img id="user-photo-display" src="https://i.pravatar.cc/300" alt="Profile" class="profile-img">
            </div>
        </div>
    </nav>

    <div class="dashboard-container">
        <aside class="sidebar" id="sidebarNav">
            <div class="sidebar-scroll-wrapper">
                <div class="nav-category">Main Navigation</div>
                <a href="../home.html" class="sidebar-link active"><i class="bi bi-columns-gap"></i> Dashboard</a>
                <a href="#" class="sidebar-link"><i class="bi bi-list-columns-reverse"></i> Lineup</a>
            </div>
        </aside>

        <main class="main-content">
            <!-- BREADCRUMB -->
            <div class="project-context-card">
                <div class="ph-badge" id="projectBadge">Loading...</div>
                <div class="ph-crumb-container">
                    <a href="../home.html" class="ph-crumb-link"><i class="bi bi-house-fill"></i></a>
                    <i class="bi bi-chevron-right ph-sep"></i>
                    <a href="#" class="ph-crumb-link" id="projectNameHeader">Loading...</a>
                    <i class="bi bi-chevron-right ph-sep"></i>
                    <span class="ph-crumb-active">Lists</span>
                </div>
                <!-- Bagian Breadcrumb yang diupdate trigger modalnya -->
                <div class="position-absolute end-0 me-3">
                    <button class="btn btn-link text-muted" data-bs-toggle="modal" data-bs-target="#projectToolsModal">
                        <i class="bi bi-three-dots"></i>
                    </button>
                </div>
            </div>

            <div class="main-list-card">
                <div class="list-header-container">
                    <div style="flex: 1;"></div>
                    <div class="text-center" style="flex: 2;">
                        <h1 class="fw-bold display-5 mb-1" style="color:#111;">All List</h1>
                        <p class="text-muted mb-0">Manage your tasks efficiently.</p>
                    </div>
                    <div style="flex: 1; text-align: right;">
                        <button class="btn-new-list btn-dlg-blue" onclick="toggleNewListForm()"><i class="bi bi-plus-lg me-1"></i> New List</button>
                    </div>
                </div>

                <!-- NEW LIST FORM -->
                <div id="newListForm" class="bg-white p-4 rounded-4 border shadow-sm" style="display:none; margin-bottom: 40px;">
                    <div class="mb-3">
                        <input type="text" id="inputListName" class="ghost-input fw-bold" style="font-size: 1.5rem; border-bottom: 1px solid #eee;" placeholder="Name this list...">
                    </div>

                    <div class="editor-container mt-4">
                        <div class="editor-toolbar">
                            <button class="editor-btn" onclick="execEdit('bold')" title="Bold"><i class="bi bi-type-bold"></i></button>
                            <button class="editor-btn" onclick="execEdit('italic')" title="Italic"><i class="bi bi-type-italic"></i></button>
                            <button class="editor-btn" onclick="execEdit('underline')" title="Underline"><i class="bi bi-type-underline"></i></button>
                            <button class="editor-btn" onclick="execEdit('strikeThrough')" title="Strikeout"><i class="bi bi-type-strikethrough"></i></button>
                            <div class="vr mx-1"></div>
                            <button class="editor-btn" onclick="execEdit('formatBlock', 'blockquote')" title="Quote"><i class="bi bi-quote"></i></button>
                            <button class="editor-btn" onclick="execEdit('insertHorizontalRule')" title="Separator"><i class="bi bi-hr"></i></button>
                            <button class="editor-btn" onclick="addCustomLink()" title="Link"><i class="bi bi-link-45deg"></i></button>
                            <div class="color-dropdown">
                                <button class="editor-btn" onclick="toggleColorMenu()"><i class="bi bi-palette"></i></button>
                                <div id="colorMenu" class="color-menu">
                                    <div class="color-swatch" style="background:#000" onclick="execEdit('foreColor', '#000')"></div>
                                    <div class="color-swatch" style="background:#e7181a" onclick="execEdit('foreColor', '#e7181a')"></div>
                                    <div class="color-swatch" style="background:#006a4e" onclick="execEdit('foreColor', '#006a4e')"></div>
                                    <div class="color-swatch" style="background:#0163ea" onclick="execEdit('foreColor', '#0163ea')"></div>
                                    <div class="color-swatch" style="background:#7204cf" onclick="execEdit('foreColor', '#7204cf')"></div>
                                </div>
                            </div>
                            <div class="vr mx-1"></div>
                            <button class="editor-btn" onclick="execEdit('insertUnorderedList')" title="Bullet"><i class="bi bi-list-ul"></i></button>
                            <button class="editor-btn" onclick="execEdit('insertOrderedList')" title="Numbering"><i class="bi bi-list-ol"></i></button>
                            <button class="editor-btn" onclick="execEdit('formatBlock', 'pre')" title="Code"><i class="bi bi-code-slash"></i></button>
                            <button class="editor-btn" onclick="document.getElementById('listFileInput').click()" title="Upload File"><i class="bi bi-paperclip"></i></button>
                        </div>
                        <div id="inputListDesc" class="editor-content" contenteditable="true" data-placeholder="Add extra details or attach a file..."></div>
                        <input type="file" id="listFileInput" style="display:none" onchange="handleListFile(this)">
                    </div>
                    
                    <div id="listFilePreview" class="mt-2 p-2 bg-light border rounded" style="display:none">
                        <small class="text-muted"><i class="bi bi-file-earmark"></i> <span id="listFileName"></span></small>
                        <button class="btn btn-sm text-danger" onclick="clearListFile()">Remove</button>
                    </div>

                    <div class="d-flex gap-2 mt-4">
                        <button class="btn btn-dlg-green rounded-pill px-4 fw-bold" id="btnSaveList" onclick="saveNewList()">Add this list</button>
                        <button class="btn btn-light border rounded-pill px-4" onclick="toggleNewListForm()">Cancel</button>
                    </div>
                </div>
            
                <div id="loadingState" class="text-center py-5"><div class="spinner-border text-primary"></div><p class="text-muted mt-2">Loading lists...</p></div>
                <div id="listsContainer"></div>
                <div id="emptyState" class="text-center text-muted py-5" style="display:none;">No lists yet.</div>

                <hr class="my-5 opacity-25">

                <!-- DISCUSSION SECTION -->
                <div class="mt-5">
                    <h5 class="fw-bold mb-4 text-dark">Discussion</h5>
                    <div id="commentsWrapper" class="d-flex flex-column gap-3 mb-4"></div>
                    
                    <div class="d-flex gap-3">
                        <div class="flex-shrink-0" style="width:40px; height:40px;">
                            <img id="currentUserCommentPhoto" src="" 
                                 class="rounded-circle border" 
                                 style="width:40px; height:40px; object-fit:cover; display:none;">
                        </div>
                        
                        <div class="w-100">
                            <div class="rich-editor-box">
                                <div class="rich-editor-toolbar">
                                    <button class="editor-btn" onclick="execCmd('bold')"><i class="bi bi-type-bold"></i></button>
                                    <button class="editor-btn" onclick="execCmd('italic')"><i class="bi bi-type-italic"></i></button>
                                    <button class="editor-btn" onclick="execCmd('insertUnorderedList')"><i class="bi bi-list-ul"></i></button>
                                    <button class="editor-btn" onclick="addLink()"><i class="bi bi-link-45deg"></i></button>
                                    <button class="editor-btn" onclick="document.getElementById('fileInput').click()"><i class="bi bi-paperclip"></i></button>
                                </div>
                                <div id="richCommentInput" class="rich-editor-content" contenteditable="true" data-placeholder="Add a comment..."></div>
                                <div id="filePreview" class="p-2 border-top bg-light" style="display:none; font-size:0.85rem;">
                                    <i class="bi bi-file-earmark-text me-2"></i> <span id="fileName">file.txt</span>
                                    <button class="btn-close ms-2" style="font-size:0.7rem" onclick="clearFile()"></button>
                                </div>
                            </div>
                            <input type="file" id="fileInput" style="display:none" onchange="handleFile(this)">
                            <div class="mt-2 text-end"><button id="postBtn" class="btn btn-dlg-yellow rounded-pill px-4 fw-bold" onclick="postComment()">Post comment</button></div>
                        </div>
                    </div>
                </div>
                
                <!-- --- SUBSCRIBER SECTION (NEW) --- -->
                <div class="mt-5 pt-4 border-top">
                    <h6 class="fw-bold text-dark">Subscribers</h6>
                    <p class="small text-muted mb-3">People listed below will be notified when comments are posted.</p>
                    
                    <div class="d-flex align-items-center gap-2 flex-wrap" id="subsContainer">
                        <!-- Konten ini akan diisi otomatis oleh JS, "RA" sudah dihapus -->
                    </div>
                    
                    <!-- Status (TAMBAHKAN ID DISINI) -->
                    <div class="mt-3 p-2 bg-light rounded-pill d-inline-block border">
                        <small class="text-dark fw-bold px-2" id="subscriptionText">Checking status...</small>
                        <button class="btn btn-sm btn-link text-primary text-decoration-none p-0" id="subscribeBtn" style="font-size:0.8rem;" onclick="toggleSubscription()">Subscribe me</button>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- MODAL PROJECT TOOLS -->
    <div class="modal fade" id="projectToolsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content modal-content-custom p-4">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title fw-bold">Project Tools</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="modal-tools-grid">
                        
                        <!-- URGENT -->
                        <a href="urgent.html" class="tool-nav-card" id="link-urgent">
                            <span class="tool-title">Urgent</span>
                            <div class="tool-nav-icon" style="background-color: #e7181a;">
                                <i class="bi bi-megaphone-fill"></i>
                            </div>
                        </a>

                        <!-- LIST (Current) -->
                        <a href="#" class="tool-nav-card border-primary shadow-sm" data-bs-dismiss="modal">
                            <span class="tool-title text-primary">List</span>
                            <div class="tool-nav-icon" style="background-color: #006a4e;">
                                <i class="bi bi-check2-square"></i>
                            </div>
                        </a>

                        <!-- CARD -->
                        <a href="card.html" class="tool-nav-card" id="link-card">
                            <span class="tool-title">Card</span>
                            <div class="tool-nav-icon" style="background-color: #f7b12c;">
                                <i class="bi bi-layout-three-columns"></i>
                            </div>
                        </a>

                        <!-- FILES -->
                        <a href="files.html" class="tool-nav-card" id="link-files">
                            <span class="tool-title">Files</span>
                            <div class="tool-nav-icon" style="background-color: #1c84e3;">
                                <i class="bi bi-folder-fill"></i>
                            </div>
                        </a>

                        <!-- DISCUSS -->
                        <a href="discuss.html" class="tool-nav-card" id="link-discuss">
                            <span class="tool-title">Discuss</span>
                            <div class="tool-nav-icon" style="background-color: #7204cf;">
                                <i class="bi bi-chat-dots-fill"></i>
                            </div>
                        </a>

                        <!-- SCHEDULE -->
                        <a href="schedule.html" class="tool-nav-card" id="link-schedule">
                            <span class="tool-title">Schedule</span>
                            <div class="tool-nav-icon" style="background-color: #e7181a;">
                                <i class="bi bi-calendar3"></i>
                            </div>
                        </a>

                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- MODAL MANAGE STATUS -->
    <div class="modal fade" id="manageStatusModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-md">
            <div class="modal-content border-0 rounded-4 shadow-lg">
                <div class="modal-header border-0 p-4 pb-0">
                    <h5 class="fw-bold m-0">Manage Statuses</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <input type="hidden" id="currentManagingListId">
                    
                    <!-- Kelompok: NOT STARTED -->
                    <div class="mb-4">
                        <div class="status-group-label">Not started <i class="bi bi-info-circle"></i> <i class="bi bi-plus ms-auto cursor-pointer" onclick="showInlineInput('not_started')"></i></div>
                        <div id="group-not_started" class="status-drag-container"></div>
                        <div id="input-wrap-not_started" style="display:none"></div>
                    </div>

                    <!-- Kelompok: ACTIVE -->
                    <div class="mb-4">
                        <div class="status-group-label">Active <i class="bi bi-info-circle"></i> <i class="bi bi-plus ms-auto cursor-pointer" onclick="showInlineInput('active')"></i></div>
                        <div id="group-active" class="status-drag-container"></div>
                        <div id="input-wrap-active" style="display:none"></div>
                    </div>

                    <!-- Kelompok: DONE -->
                    <div class="mb-4">
                        <div class="status-group-label">Done <i class="bi bi-info-circle"></i> <i class="bi bi-plus ms-auto cursor-pointer" onclick="showInlineInput('done')"></i></div>
                        <div id="group-done" class="status-drag-container"></div>
                        <div id="input-wrap-done" style="display:none"></div>
                    </div>

                    <!-- Kelompok: CLOSED -->
                    <div class="mb-4">
                        <div class="status-group-label">Closed <i class="bi bi-info-circle"></i></div>
                        <div id="group-closed" class="status-drag-container"></div>
                    </div>
                </div>
                <div class="modal-footer border-0 p-4 pt-0 justify-content-between">
                    &nbsp;
                    <button class="btn btn-dlg-blue rounded-pill px-4 fw-bold" onclick="syncStatusesToDB()" style="border:none">Apply changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- FLOATING COLOR PICKER -->
    <div id="statusColorPicker" class="color-palette-popup">
        <div class="d-flex justify-content-between mb-3 align-items-center">
            <span class="small fw-bold text-muted">Color</span>
            <i class="bi bi-x cursor-pointer" onclick="closeColorPicker()"></i>
        </div>
        <div class="color-grid">
            <!-- Generat via JS -->
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbySwjMcxFHkBC4z591KpmOQmRJkQAyfcnPSMocjLigMHO-5tqL4ncRJ2Op7yucmqDntRQ/exec';
        const projectId = new URLSearchParams(window.location.search).get('id');
        const dialogikaColors = ['#0B2B6A', '#F9C72E', '#231f20', '#7204cf', '#006a4e', '#e7181a', '#f7b12c', '#0163ea', '#1c84e3', '#444444', '#011548'];
        const tagPaletteColors = ['#D3E5EF', '#D3DFFB', '#E7E2F9', '#F1DDF3', '#F9DEDC', '#FDECC8', '#E2F2D1', '#7204cf', '#0163ea', '#1c84e3', '#006a4e', '#0B2B6A', '#F9C72E', '#e7181a']; 

        let globalTags = [];
        let globalUsers = []; 
        let lastFetchedLists = []; 
        let selectedTagsByList = {}; // Menyimpan tag terpilih per List ID 
        
        // 1. Ambil data user di bagian paling atas script 
        const userData = JSON.parse(localStorage.getItem('userData')); 
        
        // Gunakan .Id (I besar) sesuai header Spreadsheet Anda 
        // Kita simpan di variabel global agar bisa diakses semua fungsi 
        let CURRENT_USER_ID = userData ? String(userData.Id || userData.id) : null; 
        
        document.addEventListener("DOMContentLoaded", () => { 
            if (!projectId) return alert("Missing Project ID"); 
            setupUserUI(); // Jalankan UI User segera 
            fetchData(); 
        }); 

        function formatDriveUrl(url) {
            if (!url) return "https://i.pravatar.cc/300";
            if (url.includes('drive.google.com')) {
                let id = "";
                if (url.includes('id=')) {
                    id = url.split('id=')[1].split('&')[0];
                } else {
                    id = url.split('/d/')[1].split('/')[0];
                }
                return `https://lh3.googleusercontent.com/u/0/d/${id}`;
            }
            return url;
        }

        function setupUserUI() { 
            if (!userData) { 
                window.location.href = "../index.html"; 
                return; 
            } 

            const imgEl = document.getElementById('currentUserCommentPhoto'); 
            const initialEl = document.getElementById('currentUserCommentInitial'); 
            
            // Update Navbar & Welcome Msg 
            if(document.getElementById('user-name-display')) document.getElementById('user-name-display').innerText = userData.name; 
            if(document.getElementById('user-photo-display')) document.getElementById('user-photo-display').src = formatDriveUrl(userData.photo); 
            
            const welcomeMsg = document.querySelector('h4.fw-bold'); 
            if(welcomeMsg && userData.name) welcomeMsg.innerText = `Good Morning, ${userData.name.split(' ')[0]}!`; 

            // FIX LINGKARAN BIRU: 
            // Jika ada foto, tampilkan foto dan SEMBUNYIKAN initial sama sekali. 
            if (userData.photo && userData.photo !== "" && userData.photo !== "undefined") { 
                imgEl.src = formatDriveUrl(userData.photo); 
                imgEl.style.display = 'block'; 
                if(initialEl) initialEl.style.display = 'none'; 
            } else { 
                // Jika tidak ada foto, tampilkan initial dan SEMBUNYIKAN elemen foto. 
                if(initialEl) { 
                    initialEl.innerText = userData.name ? userData.name.substring(0, 2).toUpperCase() : 'US'; 
                    initialEl.style.display = 'flex'; 
                } 
                imgEl.style.display = 'none'; 
            } 
        } 
 
        // --- TAG SYSTEM LOGIC (ROBUST) ---
        function handleTagSearch(input, lid) { 
            const query = input.value.trim().toLowerCase(); 
            const dropdown = document.getElementById(`tag-dropdown-${lid}`); 
            // const resultsContainer = document.getElementById(`tag-list-results-${lid}`); 
            // const createSuggestion = document.getElementById(`tag-create-suggestion-${lid}`); 
            
            dropdown.style.display = 'block'; 
        
            // 1. Filter tag yang sudah ada di database (globalTags diambil saat fetchData) 
            const filtered = globalTags.filter(t => t.name.toLowerCase().includes(query)); 
        
            // Render Gambar 1: List Tag 
            if (filtered.length > 0) { 
                dropdown.innerHTML = filtered.map(t => ` 
                    <div class="tag-option-item" onclick="selectExistingTag('${lid}', '${t.id}')"> 
                        <span class="tag-pill" style="background:${t.color}; color: #333; padding: 4px 10px; border-radius: 6px; font-weight: 500;"> 
                            ${t.name} 
                        </span> 
                    </div> 
                `).join(''); 
            } else { 
                dropdown.innerHTML = '<div class="p-3 text-center text-muted small">No tags found</div>'; 
            } 
        
            // 2. Render Gambar 2: Suggestion Create jika tidak ada exact match 
            const exactMatch = globalTags.find(t => t.name.toLowerCase() === query); 
            if (query && !exactMatch) { 
                dropdown.insertAdjacentHTML('beforeend', ` 
                    <div class="tag-create-prompt" onclick="createNewTagAct('${lid}')"> 
                        <div class="d-flex align-items-center"> 
                            <span>Create</span> 
                            <span class="create-badge">${query}</span> 
                        </div> 
                        <i class="bi bi-arrow-return-left"></i> 
                    </div> 
                `); 
            } 
        } 
        
        // Fungsi saat klik "Create" (Gambar 2) 
        async function createNewTagAct(lid) { 
            const input = document.getElementById(`tag-input-${lid}`); 
            const tagName = input.value.trim(); 
            if (!tagName) return; 
        
            // Pilih warna random dari palet Dialogika 
            const randomColor = tagPaletteColors[Math.floor(Math.random() * tagPaletteColors.length)]; 
        
            // Kirim ke database (Master Tag Sheet) 
            const res = await fetch(API_URL, { 
                method: 'POST', 
                body: JSON.stringify({ 
                    action: 'createTag', 
                    tagName: tagName, 
                    color: randomColor 
                }) 
            }).then(r => r.json()); 
        
            if (res.status === 'success') { 
                const newTag = { id: res.tagId, name: res.name, color: res.color }; 
                globalTags.push(newTag); // Update cache lokal 
                selectExistingTag(lid, newTag.id); // Pilih tag tersebut 
                input.value = ''; 
                document.getElementById(`tag-dropdown-${lid}`).style.display = 'none'; 
            } 
        } 
        
        function selectExistingTag(lid, tid) { 
            const tag = globalTags.find(t => String(t.id) === String(tid)); 
            if (!tag) return; 
        
            if (!selectedTagsByList[lid]) selectedTagsByList[lid] = []; 
            
            // Cek agar tidak duplikat di list yang sama 
            if (!selectedTagsByList[lid].find(t => t.id === tid)) { 
                selectedTagsByList[lid].push(tag); 
                renderSelectedTagsUI(lid); 
            } 
            
            document.getElementById(`tag-dropdown-${lid}`).style.display = 'none'; 
        } 
        
        function removeSelectedTag(lid, tid) {
            if (!selectedTagsByList[lid]) return;
            selectedTagsByList[lid] = selectedTagsByList[lid].filter(t => String(t.id) !== String(tid));
            renderSelectedTagsUI(lid);
        }

        function renderSelectedTagsUI(lid) { 
            const container = document.getElementById(`selected-tags-${lid}`); 
            const selected = selectedTagsByList[lid] || []; 
            container.innerHTML = selected.map(t => ` 
                <span class="tag-pill d-flex align-items-center gap-1 shadow-sm" 
                      style="background:${t.color}; color:#333; font-size: 0.75rem; padding: 4px 10px; border-radius: 4px; font-weight: 600;"> 
                    ${t.name} 
                    <i class="bi bi-x-lg cursor-pointer" style="font-size:0.6rem" onclick="removeSelectedTag('${lid}', '${t.id}')"></i> 
                </span> 
            `).join(''); 
        }

        // FUNGSI EDIT TAG UI 
        function openEditTagUI(lid, tid) { 
            event.stopPropagation();
            const tag = globalTags.find(t => String(t.id) === String(tid));
            if (!tag) return;

            document.getElementById(`tag-search-view-${lid}`).style.display = 'none'; 
            const editView = document.getElementById(`tag-edit-view-${lid}`); 
            editView.style.display = 'block'; 
        
            const nameInput = document.getElementById(`edit-tag-name-${lid}`); 
            nameInput.value = tag.name; 
            
            // Render Color Palette 
            const colorGrid = document.getElementById(`edit-tag-colors-${lid}`); 
            colorGrid.innerHTML = tagPaletteColors.map(c => ` 
                <div class="color-circle" style="background:${c}; ${c === tag.color ? 'border: 2px solid black;' : ''}" 
                     onclick="updateTagColor('${lid}', '${tag.id}', '${c}')"></div> 
            `).join(''); 
        
            // Delete Button Act 
            document.getElementById(`btn-delete-tag-act-${lid}`).onclick = () => deleteTagAct(tag.id, lid); 
            
            // Handle rename on enter 
            nameInput.onkeypress = (e) => { 
                if(e.key === 'Enter') updateTagName(lid, tag.id, nameInput.value); 
            } 
        }  
        
        function backToTagSearch(lid) { 
            document.getElementById(`tag-edit-view-${lid}`).style.display = 'none'; 
            document.getElementById(`tag-search-view-${lid}`).style.display = 'block'; 
        } 
        
        // FUNGSI UPDATE/DELETE DI DATABASE (backend) 
        function updateTagColor(lid, tid, newColor) { 
            // Optimistic Update
            const tag = globalTags.find(t => String(t.id) === String(tid));
            if(tag) tag.color = newColor;
            
            // Re-render UI
            openEditTagUI(lid, tid); 
            
            // Update selected tags UI if this tag is selected
            if(selectedTagsByList[lid]) {
                const selTag = selectedTagsByList[lid].find(t => String(t.id) === String(tid));
                if(selTag) selTag.color = newColor;
                renderSelectedTagsUI(lid);
            }

            fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'updateTag', tagId: tid, color: newColor })
            });
        } 

        function updateTagName(lid, tid, newName) {
            const tag = globalTags.find(t => String(t.id) === String(tid));
            if(tag) tag.name = newName;
            
            // Update selected tags UI if this tag is selected
            if(selectedTagsByList[lid]) {
                const selTag = selectedTagsByList[lid].find(t => String(t.id) === String(tid));
                if(selTag) selTag.name = newName;
                renderSelectedTagsUI(lid);
            }
            
            backToTagSearch(lid);
            // Re-trigger search to update list
            const input = document.getElementById(`tag-input-${lid}`);
            if(input) handleTagSearch(input, lid);

            fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'updateTag', tagId: tid, tagName: newName })
            });
        }
        
        function deleteTagAct(tid, lid) { 
            if(!confirm("Delete this tag globally?")) return; 
            
            // Optimistic remove
            globalTags = globalTags.filter(t => String(t.id) !== String(tid)); 
            
            // Remove from selection too
            if(selectedTagsByList[lid]) {
                selectedTagsByList[lid] = selectedTagsByList[lid].filter(t => String(t.id) !== String(tid)); 
                renderSelectedTagsUI(lid);
            }
            
            backToTagSearch(lid); 
            // Re-trigger search
            const input = document.getElementById(`tag-input-${lid}`);
            if(input) handleTagSearch(input, lid);

            fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'deleteTag', tagId: tid })
            });
        }

        let selectedFile = null;

        document.addEventListener("DOMContentLoaded", () => {
            if (!projectId) return alert("Missing Project ID");
            fetchData();
        });

        function fetchData() {
            document.getElementById('loadingState').style.display = 'block';
            fetch(`${API_URL}?action=getProjectData&id=${projectId}`)
                .then(r => r.json())
                .then(resp => {
                    if (resp.status === 'success') {
                        const data = resp.data;
                        document.getElementById('projectNameHeader').innerText = data.project?.name || "Unnamed Project";
                        document.getElementById('projectNameHeader').href = `../project/project.html?id=${projectId}`;
                        document.getElementById('projectBadge').innerText = (data.project?.department || "Project");
                        
                        globalTags = data.tags || [];
                        globalUsers = data.users || []; 
                        lastFetchedLists = data.lists || [];

                        renderLists(lastFetchedLists);
                        renderComments(data.comments || []);
                        updateModalLinks(projectId);
                        
                        const projectSubs = (data.subscribers || []).filter(s => s.projectId === projectId || s.id === projectId);
                                renderSubscribers(projectSubs);
                                checkSubscriptionStatus(projectSubs);
                        
                    }
                })
                .finally(() => document.getElementById('loadingState').style.display = 'none');
        }
        
        // --- UI HELPERS --- 
        function toggleNewListForm() { 
            const form = document.getElementById('newListForm'); 
            form.style.display = form.style.display === 'none' ? 'block' : 'none'; 
        }
        
        let listFile = null;

        // Fungsi Editor
        function execEdit(cmd, val = null) {
            document.execCommand(cmd, false, val);
        }

        function toggleColorMenu() {
            const m = document.getElementById('colorMenu');
            m.style.display = m.style.display === 'grid' ? 'none' : 'grid';
        }

        function addCustomLink() {
            const url = prompt("Enter URL:");
            if (url) execEdit('createLink', url);
        }

        // Handle File di Editor
        function handleListFile(input) {
            if (input.files && input.files[0]) {
                listFile = input.files[0];
                document.getElementById('listFileName').innerText = listFile.name;
                document.getElementById('listFilePreview').style.display = 'block';
            }
        }

        function clearListFile() {
            listFile = null;
            document.getElementById('listFileInput').value = '';
            document.getElementById('listFilePreview').style.display = 'none';
        }

        // Render Lists (Tampilan seperti Gambar 2)
        function renderLists(lists) {
            const container = document.getElementById('listsContainer');
            container.innerHTML = '';
            if (lists.length === 0) {
                document.getElementById('emptyState').style.display = 'block';
                return;
            }
            document.getElementById('emptyState').style.display = 'none';

            lists.forEach(list => {
                // Render Status (Panah >)
                let statusesHtml = '';
                if (list.statuses && list.statuses.length > 0) {
                    const sorted = list.statuses.sort((a,b) => a.position - b.position);
                    statusesHtml = sorted.map((s, index) => {
                        const badge = `<div class="status-item" style="background:${s.color}">${s.name}</div>`;
                        const sep = (index < sorted.length - 1) ? `<i class="bi bi-chevron-right flow-sep"></i>` : '';
                        return badge + sep;
                    }).join('');
                }

                // --- RENDER TASK ITEM ---
                const tasksHtml = (list.tasks || []).map(t => {
                    // Logika Status Selesai
                    const isDone = ['done', 'true', 'completed'].includes(t.status?.toLowerCase());
                    
                    // Logika Deteksi Deskripsi/Notes (asumsi t.description ada di data)
                    const hasContent = (t.description && t.description.trim() !== "" && t.description !== "<br>");

                    return `
                        <div class="todo-row p-2 d-flex align-items-center cursor-pointer ${isDone ? 'task-row-done' : ''}"
                             onclick="window.open('item-details.html?taskId=${t.id}&projectId=${projectId}', '_blank')">
                            
                            <!-- Checkbox Bulat -->
                            <input type="checkbox" class="form-check-input task-checkbox me-3" ${isDone ? 'checked' : ''}
                                   onclick="event.stopPropagation(); updateTaskQuickStatus('${t.id}', this.checked)">
                            
                            <div class="flex-grow-1 d-flex align-items-center">
                                <span class="task-text-content fw-medium">${t.title}</span>
                                
                                <!-- Icon Description jika ada isi -->
                                ${hasContent ? '<i class="bi bi-filter-left text-muted ms-2" style="font-size: 1.1rem;"></i>' : ''}
                                
                                <!-- Hint New Tab saat Hover -->
                                <span class="new-tab-hint"><i class="bi bi-box-arrow-up-right me-1"></i> New Tab</span>
                            </div>

                            <!-- Label Status di sebelah kanan -->
                            <span class="badge bg-light text-dark border ms-2 small" style="font-size:0.65rem; text-transform: uppercase;">
                                ${t.status || 'OPEN'}
                            </span>
                        </div>`;
                }).join('');

                const html = `
                <div class="list-card-container shadow-sm mb-5 bg-white p-4 rounded-4 border">
                    <h2 class="list-card-title h4 fw-bold">${list.name}</h2>
                    <div class="list-card-desc mb-3 small text-muted">${list.description || ''}</div>
                    
                    <div class="status-flow mb-4">
                        ${statusesHtml}
                        <button class="btn-add-status ms-2" onclick="promptNewStatus('${list.id}')">
                            <i class="bi bi-plus-lg"></i>
                        </button>
                    </div>

                    <div class="todo-list-items mb-3">
                        ${tasksHtml}
                    </div>

                    <button class="btn-add-todo-pill mt-2" onclick="showTaskForm('${list.id}')">
                        <i class="bi bi-plus"></i> Add a to-do
                    </button>
                    
                    <div id="form-add-${list.id}" class="task-create-panel" style="display:none">
                        <input type="text" id="task-title-${list.id}" class="task-title-large" placeholder="What needs to be done?">
                        
                        <div class="meta-grid-container">
                            <!-- Priority -->
                            <div class="meta-row">
                                <div class="meta-icon"><i class="bi bi-flag"></i></div>
                                <div class="meta-label">Priority</div>
                                <div class="meta-value">
                                    <div class="priority-dropdown" id="priority-wrapper-${list.id}">
                                        <div class="priority-trigger" onclick="togglePriorityMenu('${list.id}')" id="priority-trigger-${list.id}">
                                            <i class="bi bi-flag text-muted"></i> <span class="text-muted">Normal</span>
                                        </div>
                                        <div class="priority-menu" id="priority-menu-${list.id}">
                                            <div class="priority-item" onclick="selectPriority('${list.id}', 'urgent')"><i class="bi bi-flag-fill text-danger"></i> Urgent</div>
                                            <div class="priority-item" onclick="selectPriority('${list.id}', 'high')"><i class="bi bi-flag-fill text-warning"></i> High</div>
                                            <div class="priority-item" onclick="selectPriority('${list.id}', 'normal')"><i class="bi bi-flag-fill text-primary"></i> Normal</div>
                                            <div class="priority-item" onclick="selectPriority('${list.id}', 'low')"><i class="bi bi-flag-fill text-secondary"></i> Low</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Due Date -->
                            <div class="meta-row">
                                <div class="meta-icon"><i class="bi bi-calendar"></i></div>
                                <div class="meta-label">Due Date</div>
                                <div class="meta-value">
                                    <input type="date" id="task-due-${list.id}" class="ghost-input" style="width:auto">
                                </div>
                            </div>

                            <!-- Assignee -->
                            <div class="meta-row">
                                <div class="meta-icon"><i class="bi bi-person"></i></div>
                                <div class="meta-label">Assignee</div>
                                <div class="meta-value">
                                    <div class="user-dropdown-container">
                                        <div class="user-trigger" onclick="toggleUserMenu('${list.id}')" id="user-trigger-${list.id}">
                                            <i class="bi bi-person-circle text-muted"></i> <span class="text-muted">Unassigned</span>
                                        </div>
                                        <div class="user-menu-dark" id="user-menu-${list.id}">
                                            <div class="user-search-box">
                                                <i class="bi bi-search"></i>
                                                <input type="text" placeholder="Search people..." oninput="filterUsers(this.value, '${list.id}')">
                                            </div>
                                            <div class="user-list-scroll" id="user-list-${list.id}"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- TAGS (NEW) -->
                            <div class="meta-row"> 
                                <div class="meta-icon"><i class="bi bi-tags"></i></div> 
                                <div class="meta-label">Tags</div> 
                                <div class="meta-value position-relative"> 
                                    <!-- Container untuk tag yang sudah dipilih --> 
                                    <div id="selected-tags-${list.id}" class="d-flex flex-wrap gap-1 mb-2"></div> 
                                    
                                    <div class="input-group input-group-sm"> 
                                        <input type="text" class="form-control border-0 bg-light rounded-pill px-3" 
                                               id="tag-input-${list.id}" 
                                               placeholder="Search or add tags..." 
                                               onfocus="handleTagSearch(this, '${list.id}')" 
                                               oninput="handleTagSearch(this, '${list.id}')"> 
                                    </div> 
                                    
                                    <!-- TAG DROPDOWN --> 
                                    <div id="tag-dropdown-${list.id}" class="tag-dropdown shadow-lg" onclick="event.stopPropagation()"> 
                                        <!-- Search View --> 
                                        <div id="tag-search-view-${list.id}"> 
                                            <div class="tag-list-scroll" id="tag-list-results-${list.id}"></div> 
                                            
                                            <!-- Area Suggestion / Tombol Plus --> 
                                            <div id="tag-create-suggestion-${list.id}" class="p-2 border-top bg-light" style="display:none"> 
                                                <button class="btn btn-sm btn-outline-primary w-100 rounded-pill d-flex align-items-center justify-content-center gap-2" 
                                                        onclick="createNewTagAct('${list.id}')"> 
                                                    <i class="bi bi-plus-circle-fill"></i> Create Tag "<span class="new-tag-name-preview"></span>" 
                                                </button> 
                                            </div> 
                                        </div> 
                                        
                                        <!-- Edit View (Tetap sama) --> 
                                        <div id="tag-edit-view-${list.id}" class="tag-edit-container"> 
                                            <div class="d-flex align-items-center gap-2 mb-3"> 
                                                <i class="bi bi-chevron-left cursor-pointer" onclick="backToTagSearch('${list.id}')"></i> 
                                                <input type="text" id="edit-tag-name-${list.id}" class="form-control form-control-sm fw-bold"> 
                                            </div> 
                                            <div class="color-mini-grid" id="edit-tag-colors-${list.id}"></div> 
                                            <hr class="my-2 opacity-50"> 
                                            <button class="btn-delete-tag" id="btn-delete-tag-act-${list.id}"> 
                                                <i class="bi bi-trash"></i> Delete Globally 
                                            </button> 
                                        </div> 
                                    </div> 
                                </div> 
                            </div>
                        </div>

                        <!-- NOTES (NEW) -->
                        <div class="mt-4"> 
                            <div class="notes-label">Notes</div> 
                            <div class="rich-editor-box"> 
                                <div class="rich-editor-toolbar border-bottom bg-light d-flex gap-1 p-1"> 
                                    <button class="editor-btn btn-sm" onclick="execEdit('bold')"><i class="bi bi-type-bold"></i></button> 
                                    <button class="editor-btn btn-sm" onclick="execEdit('italic')"><i class="bi bi-type-italic"></i></button> 
                                    <button class="editor-btn btn-sm" onclick="execEdit('insertUnorderedList')"><i class="bi bi-list-ul"></i></button> 
                                    <button class="editor-btn btn-sm" onclick="addCustomLink()"><i class="bi bi-link-45deg"></i></button> 
                                </div> 
                                <div id="task-desc-${list.id}" class="rich-editor-content p-3" contenteditable="true" data-placeholder="Add notes here..."></div> 
                            </div> 
                        </div>

                        <div class="d-flex gap-2 mt-4 justify-content-end">
                            <button class="btn btn-light border px-4 rounded-pill" onclick="showTaskForm('${list.id}')">Cancel</button>
                            <button class="btn btn-dlg-blue px-4 rounded-pill fw-bold" onclick="saveNewTask('${list.id}')">Create Task</button>
                        </div>
                    </div>
                </div>`;
                container.insertAdjacentHTML('beforeend', html);
            });
        }


        // Simpan List Baru
        async function saveNewList() {
            const name = document.getElementById('inputListName').value;
            const desc = document.getElementById('inputListDesc').innerHTML;
            const btn = document.getElementById('btnSaveList');
            
            if (!name) return alert("List name is required");

            btn.disabled = true;
            btn.innerText = "Saving...";

            let attachmentUrl = "";
            if (listFile) {
                const fileRes = await uploadGenericFile(listFile);
                if (fileRes.status === 'success') attachmentUrl = fileRes.fileUrl;
            }

            fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({
                    action: 'createList',
                    projectId: projectId,
                    name: name,
                    description: desc + (attachmentUrl ? `<br><a href="${attachmentUrl}">Attached File</a>` : "")
                })
            })
            .then(r => r.json())
            .then(res => {
                if(res.status === 'success') {
                    document.getElementById('inputListName').value = '';
                    document.getElementById('inputListDesc').innerHTML = '';
                    clearListFile();
                    toggleNewListForm();
                    fetchData();
                }
            })
            .finally(() => {
                btn.disabled = false;
                btn.innerText = "Add this list";
            });
        }

        // Helper upload file generic
        async function uploadGenericFile(fileObj) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const base64 = e.target.result.split(',')[1];
                    fetch(API_URL, {
                        method: 'POST',
                        body: JSON.stringify({
                            action: 'uploadFile',
                            fileName: fileObj.name,
                            mimeType: fileObj.type,
                            fileData: base64
                        })
                    }).then(r => r.json()).then(resolve).catch(reject);
                };
                reader.readAsDataURL(fileObj);
            });
        }

           // --- STATUS MANAGER LOGIC (FIXED) --- 
           let localStatuses = []; 
           const statusCategories = ['not_started', 'active', 'done', 'closed']; 
           const customPalette = ['#6b46e5', '#3f51b5', '#2196f3', '#009688', '#10b981', '#4caf50', '#ffc107', '#f44336', '#e91e63', '#9c27b0', '#795548', '#607d8b', '#9e9e9e', '#000000']; 
           
           function promptNewStatus(listId) { 
               document.getElementById('currentManagingListId').value = listId; 
               
               // Pastikan mencari di lastFetchedLists 
               const list = lastFetchedLists.find(l => String(l.id) === String(listId)); 
               if (!list) return alert("List data not found"); 
           
               // Copy data agar tidak merusak data utama sebelum di-save 
               localStatuses = list.statuses ? JSON.parse(JSON.stringify(list.statuses)) : []; 
               
               renderStatusManagerUI(); 
               
               const modalEl = document.getElementById('manageStatusModal'); 
               const modal = new bootstrap.Modal(modalEl); 
               modal.show(); 
           
               // Inisialisasi Sortable setelah modal muncul 
               modalEl.addEventListener('shown.bs.modal', function () { 
                   statusCategories.forEach(cat => { 
                       const el = document.getElementById(`group-${cat}`); 
                       if (el) { 
                           // Hapus instance lama jika ada 
                           if (Sortable.get(el)) Sortable.get(el).destroy(); 
                           
                           new Sortable(el, { 
                               group: 'statuses', 
                               animation: 150, 
                               handle: '.drag-handle', 
                               ghostClass: 'bg-light', 
                               onEnd: function() { 
                                   updateLocalPositions(); 
                               } 
                           }); 
                       } 
                   }); 
               }, { once: true }); 
           } 
           
           function renderStatusManagerUI() { 
               statusCategories.forEach(cat => { 
                   const container = document.getElementById(`group-${cat}`); 
                   if (!container) return; 
           
                   // Filter status berdasarkan type (pastikan lowercase untuk keamanan) 
                   const filtered = localStatuses.filter(s => { 
                       const sType = (s.type || 'not_started').toLowerCase(); 
                       return sType === cat; 
                   }); 
                   
                   container.innerHTML = filtered.sort((a,b) => a.position - b.position).map(s => ` 
                       <div class="status-item-row" data-id="${s.id}"> 
                           <div class="drag-handle"><i class="bi bi-grid-3x2-vertical"></i></div> 
                           <div class="status-dot-btn" style="background-color: ${s.color || '#64748b'}" onclick="openColorPicker(event, '${s.id}')"></div> 
                           <input type="text" class="status-input-inline" value="${s.name}" onchange="updateLocalStatusName('${s.id}', this.value)"> 
                           <i class="bi bi-three-dots text-muted cursor-pointer"></i> 
                       </div> 
                   `).join(''); 
               }); 
           } 
           
           function updateLocalStatusName(id, newName) { 
               const status = localStatuses.find(s => String(s.id) === String(id)); 
               if (status) status.name = newName; 
           } 
           
           function showInlineInput(cat) { 
               const wrap = document.getElementById(`input-wrap-${cat}`); 
               wrap.style.display = 'block'; 
               wrap.innerHTML = ` 
                   <div class="status-item-row border-primary shadow-sm mt-2"> 
                       <div class="status-dot-btn" id="new-status-dot-${cat}" style="background-color: #64748b" onclick="openColorPicker(event, 'new-${cat}')"></div> 
                       <input type="text" id="new-input-${cat}" class="status-input-inline" placeholder="Status name..." autofocus> 
                       <button class="btn btn-sm btn-primary rounded-pill px-3" onclick="saveNewStatusLocally('${cat}')">Save</button> 
                   </div> 
               `; 
           } 
           
           function saveNewStatusLocally(cat) { 
               const input = document.getElementById(`new-input-${cat}`); 
               const name = input.value.trim(); 
               if (!name) return; 
           
               const newObj = { 
                   id: 'temp-' + Date.now(), 
                   name: name, 
                   color: tempNewColor || '#64748b', 
                   type: cat, 
                   position: localStatuses.length 
               }; 
               
               localStatuses.push(newObj); 
               document.getElementById(`input-wrap-${cat}`).style.display = 'none'; 
               tempNewColor = "#64748b"; // reset 
               renderStatusManagerUI(); 
           } 
           
           function openColorPicker(event, targetId) { 
               event.stopPropagation(); 
               const picker = document.getElementById('statusColorPicker'); 
               const rect = event.target.getBoundingClientRect(); 
               
               picker.style.top = (rect.bottom + window.scrollY + 5) + 'px'; 
               picker.style.left = (rect.left + window.scrollX) + 'px'; 
               picker.style.display = 'block'; 
               
               const grid = picker.querySelector('.color-grid'); 
               grid.innerHTML = customPalette.map(c => ` 
                   <div class="color-circle" style="background:${c}" onclick="applyColor('${targetId}', '${c}')"></div> 
               `).join(''); 
           } 
           
           let tempNewColor = "#64748b"; 
           function applyColor(targetId, color) { 
               if (targetId.startsWith('new-')) { 
                   tempNewColor = color; 
                   const cat = targetId.replace('new-', ''); 
                   const dot = document.getElementById(`new-status-dot-${cat}`); 
                   if(dot) dot.style.backgroundColor = color; 
               } else { 
                   const status = localStatuses.find(s => String(s.id) === String(targetId)); 
                   if (status) { 
                       status.color = color; 
                       renderStatusManagerUI(); 
                   } 
               } 
               pickerClose(); 
           } 
           
           function pickerClose() { 
               document.getElementById('statusColorPicker').style.display = 'none'; 
           } 
           
           function updateLocalPositions() { 
               const newState = []; 
               let currentPos = 0; 
               
               statusCategories.forEach(cat => { 
                   const groupEl = document.getElementById(`group-${cat}`); 
                   const rows = groupEl.querySelectorAll('.status-item-row'); 
                   
                   rows.forEach(row => { 
                       const id = row.getAttribute('data-id'); 
                       const statusObj = localStatuses.find(s => String(s.id) === String(id)); 
                       if (statusObj) { 
                           statusObj.type = cat; // Update kategori jika dipindah antar grup 
                           statusObj.position = currentPos++; 
                           newState.push(statusObj); 
                       } 
                   }); 
               }); 
               // Simpan hasil drag ke state local 
               localStatuses = newState; 
           } 
           
           function syncStatusesToDB() { 
               const listId = document.getElementById('currentManagingListId').value; 
               updateLocalPositions(); // Final re-check urutan 
           
               const btn = event.target; 
               btn.disabled = true; 
               btn.innerText = "Syncing..."; 
           
               fetch(API_URL, { 
                   method: 'POST', 
                   body: JSON.stringify({ 
                       action: 'syncStatuses', 
                       listId: listId, 
                       statuses: localStatuses 
                   }) 
               }) 
               .then(r => r.json()) 
               .then(res => { 
                   if(res.status === 'success') { 
                       const modalEl = document.getElementById('manageStatusModal'); 
                       bootstrap.Modal.getInstance(modalEl).hide(); 
                       fetchData(); // Refresh tampilan list 
                   } else { 
                       alert("Error: " + res.message); 
                   } 
               }) 
               .catch(err => alert("Connection error")) 
               .finally(() => { 
                   btn.disabled = false; 
                   btn.innerText = "Apply changes"; 
               }); 
           } 
           
           // Close color picker if clicking outside 
           document.addEventListener('mousedown', function(e) { 
               const picker = document.getElementById('statusColorPicker'); 
               if (picker.style.display === 'block' && !picker.contains(e.target)) { 
                   pickerClose(); 
               } 
           });

           // --- FUNGSI COMMENTS ---
        function renderComments(comments) { 
            const wrapper = document.getElementById('commentsWrapper'); 
            if(!wrapper) return; 
        
            wrapper.innerHTML = comments.map(c => { 
                // Cari user pengirim berdasarkan userId dari spreadsheet 
                const sender = globalUsers.find(u => String(u.id).trim() == String(c.userId).trim()) || { name: 'Unknown User', photo: '' }; 
                const senderPhoto = sender.photo ? formatDriveUrl(sender.photo) : `https://ui-avatars.com/api/?name=${encodeURIComponent(sender.name)}`; 
        
                return ` 
                    <div class="d-flex gap-3 p-3 border rounded-4 bg-light shadow-sm mb-3"> 
                        <img src="${senderPhoto}" class="rounded-circle border" style="width:35px; height:35px; object-fit:cover;" onerror="this.src='https://ui-avatars.com/api/?name=U'"> 
                        <div class="flex-grow-1"> 
                            <div class="d-flex justify-content-between mb-1"> 
                                <span class="fw-bold small text-dark">${sender.name}</span> 
                                <span class="text-muted" style="font-size:0.7rem">${c.date}</span> 
                            </div> 
                            <div class="small text-dark">${c.text}</div> 
                            ${c.attachment ? `<div class="mt-2"><a href="${c.attachment}" target="_blank" class="btn btn-sm btn-white border small py-0"><i class="bi bi-paperclip"></i> View File</a></div>` : ''} 
                        </div> 
                    </div> 
                `; 
            }).join(''); 
        }
        
        function renderSubscribers(subs) { 
            const subsContainer = document.getElementById('subsContainer'); 
            if(!subsContainer) return; 
            
            subsContainer.innerHTML = ''; // Menghapus "RA" statis 
            
            if(!subs || subs.length === 0) { 
                subsContainer.innerHTML = '<span class="text-muted small">No subscribers</span>'; 
            } else { 
                subs.forEach(s => { 
                    // PERBAIKAN: Pembandingan s.userId == user.id 
                    const u = globalUsers.find(user => user.id == s.userId); 
                    if(u) { 
                        const photo = u.photo ? formatDriveUrl(u.photo) : `https://ui-avatars.com/api/?name=${encodeURIComponent(u.name)}`; 
                        const html = ` 
                            <div class="position-relative" title="${u.name}"> 
                                <img src="${photo}" class="rounded-circle border" 
                                     style="width:30px; height:30px; object-fit:cover;" 
                                     onerror="this.src='https://ui-avatars.com/api/?name=U'"> 
                            </div>`; 
                        subsContainer.insertAdjacentHTML('beforeend', html); 
                    } 
                }); 
            } 
            
            const btnAddHtml = `<button class="btn btn-light border rounded-pill px-3 py-1 btn-sm text-muted small ms-2" onclick="alert('Feature coming soon')">Add/remove people...</button>`; 
            subsContainer.insertAdjacentHTML('beforeend', btnAddHtml); 
        }

            // 3. Fungsi Cek Status Tombol Subscribe
            function checkSubscriptionStatus(subs) {
                const isSubscribed = subs.some(s => s.userId === CURRENT_USER_ID);
                const textEl = document.getElementById('subscriptionText');
                const btnEl = document.getElementById('subscribeBtn');
                
                if (isSubscribed) {
                    textEl.innerText = "Youre subscribed";
                    btnEl.innerText = "Unsubscribe me";
                    btnEl.classList.replace('text-primary', 'text-muted');
                } else {
                    textEl.innerText = "Youre not subscribed";
                    btnEl.innerText = "Subscribe me";
                    btnEl.classList.replace('text-muted', 'text-primary');
                }
            }

            // 4. Fungsi Kirim Toggle ke Database
            function toggleSubscription() {
                const btn = document.getElementById('subscribeBtn');
                btn.disabled = true;
                btn.innerText = "Processing...";

                fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'toggleSubscriber',
                        contextId: projectId,
                        userId: CURRENT_USER_ID
                    })
                })
                .then(r => r.json())
                .then(res => {
                    if(res.status === 'success') {
                        fetchData(); // Refresh data untuk melihat perubahan avatar dan teks
                    }
                })
                .catch(err => alert("Error toggling subscription"))
                .finally(() => btn.disabled = false);
            }
            
            // Tambahkan di dalam script yang sudah ada
            function updateModalLinks(id) {
                const tools = ['urgent', 'card', 'files', 'discuss', 'schedule'];
                tools.forEach(tool => {
                    const el = document.getElementById(`link-${tool}`);
                    if(el) el.href = `${tool}.html?id=${id}`;
                });
            }

        // 2. Perbaiki fungsi postComment agar tidak menganggap session habis 
        async function postComment() { 
            const text = document.getElementById('richCommentInput').innerHTML; 
            const btn = document.getElementById('postBtn'); 
            
            if (!text || text === '<br>' || text.trim() === "") return alert("Comment cannot be empty"); 
        
            // Gunakan CURRENT_USER_ID yang sudah kita ambil di awal 
            if (!CURRENT_USER_ID || CURRENT_USER_ID === "null") { 
                alert("Session anda tidak valid. Harap login kembali."); 
                window.location.href = "../index.html"; 
                return; 
            } 
        
            btn.disabled = true; 
            btn.innerText = "Posting..."; 
        
            let attachmentUrl = ""; 
            if (selectedFile) { 
                const fileRes = await uploadFile(); 
                if (fileRes.status === 'success') attachmentUrl = fileRes.fileUrl; 
            } 
        
            fetch(API_URL, { 
                method: 'POST', 
                body: JSON.stringify({ 
                    action: 'createComment', 
                    projectId: projectId, 
                    contextId: projectId,  
                    contextType: 'project', 
                    userId: CURRENT_USER_ID, // ID sudah pasti terdeteksi sekarang 
                    text: text,            
                    attachmentUrl: attachmentUrl 
                }) 
            }) 
            .then(r => r.json()) 
            .then(res => { 
                if (res.status === 'success') { 
                    document.getElementById('richCommentInput').innerHTML = ''; 
                    clearFile(); 
                    fetchData(); 
                } 
            }) 
            .finally(() => { 
                btn.disabled = false; 
                btn.innerText = "Post comment"; 
            }); 
        }

           // --- FUNGSI TEXT EDITOR & FILE ---
           function execCmd(command) {
               document.execCommand(command, false, null);
           }

           function addLink() {
               const url = prompt("Enter URL:");
               if (url) document.execCommand('createLink', false, url);
           }

           function handleFile(input) {
               if (input.files && input.files[0]) {
                   selectedFile = input.files[0];
                   document.getElementById('fileName').innerText = selectedFile.name;
                   document.getElementById('filePreview').style.display = 'block';
               }
           }

           function clearFile() {
               selectedFile = null;
               document.getElementById('fileInput').value = '';
               document.getElementById('filePreview').style.display = 'none';
           }

           async function uploadFile() {
               return new Promise((resolve, reject) => {
                   const reader = new FileReader();
                   reader.onload = function(e) {
                       const base64 = e.target.result.split(',')[1];
                       fetch(API_URL, {
                           method: 'POST',
                           body: JSON.stringify({
                               action: 'uploadFile',
                               fileName: selectedFile.name,
                               mimeType: selectedFile.type,
                               fileData: base64
                           })
                       })
                       .then(r => r.json())
                       .then(resolve)
                       .catch(reject);
                   };
                   reader.readAsDataURL(selectedFile);
               });
           }

        function renderLists(lists) {
            const container = document.getElementById('listsContainer');
            container.innerHTML = '';
            if (lists.length === 0) {
                document.getElementById('emptyState').style.display = 'block';
                return;
            }
            document.getElementById('emptyState').style.display = 'none';

            lists.forEach(list => {
                const statusBadgesHtml = (list.statuses || []).sort((a,b) => a.position - b.position).map(s => `
                    <div class="status-badge-main" style="background:${s.color || '#64748b'}">${s.name}</div>
                `).join('<i class="bi bi-chevron-right text-muted small mx-1"></i>');

                const tasksHtml = (list.tasks || []).map(t => {
                    const done = ['done', 'true', 'completed'].includes(t.status?.toLowerCase());
                    return `
                        <div class="todo-row p-2 border-bottom d-flex align-items-center hover-bg-light rounded cursor-pointer" 
                             onclick="window.location.href='item-details.html?taskId=${t.id}&projectId=${projectId}'">
                            <input type="checkbox" class="form-check-input me-3" ${done ? 'checked' : ''} onclick="event.stopPropagation()">
                            <div class="flex-grow-1 ${done ? 'text-decoration-line-through text-muted' : ''}">${t.title}</div>
                            <span class="badge bg-light text-dark border ms-2 small" style="font-size:0.7rem">${t.status || 'OPEN'}</span>
                        </div>`;
                }).join('');

                const html = `
                <div class="mb-5 bg-white p-4 rounded-4 border shadow-sm">
                    <div class="d-flex justify-content-between align-items-start mb-1">
                        <a href="list-detail.html?listId=${list.id}&projectId=${projectId}" 
                           class="text-dark fw-bold h4 text-decoration-none hover-text-blue">${list.name}</a>
                    </div>
                    
                    <div class="status-pill-container d-flex align-items-center gap-1 mb-3">
                        ${statusBadgesHtml}
                        <button class="btn-add-status ms-2" onclick="promptNewStatus('${list.id}')">
                            <i class="bi bi-plus-lg"></i>
                        </button>
                    </div>

                    <div class="todo-list-items">${tasksHtml}</div>
                    
                    <div class="mt-3">
                        <button id="btn-add-${list.id}" class="btn btn-sm btn-outline-secondary rounded-pill fw-bold" onclick="showTaskForm('${list.id}')">
                            <i class="bi bi-plus"></i> Add a to-do
                        </button>
                        
                        <div id="form-add-${list.id}" class="task-create-panel" style="display:none">
                            <input type="text" id="task-title-${list.id}" class="task-title-large" placeholder="Task Name">
                            
                            <div class="meta-grid-container">
                                <div class="meta-row">
                                    <div class="meta-icon"><i class="bi bi-record-circle"></i></div>
                                    <div class="meta-label">Status</div>
                                    <div class="meta-value">${renderStatusDropdown(list.statuses, list.id)}</div>
                                </div>
                                <div class="meta-row">
                                    <div class="meta-icon"><i class="bi bi-flag"></i></div>
                                    <div class="meta-label">Priority</div>
                                    <div class="meta-value">
                                        <div class="priority-dropdown" id="priority-container-${list.id}">
                                            <div class="priority-trigger" onclick="togglePriorityMenu('${list.id}')">
                                                <i class="bi bi-flag-fill" id="priority-icon-display-${list.id}" style="color: #2196f3"></i>
                                                <span id="priority-text-display-${list.id}">Normal</span>
                                                <i class="bi bi-chevron-expand ms-auto text-muted small"></i>
                                            </div>
                                            <div class="priority-menu" id="priority-menu-${list.id}">
                                                <div class="priority-item" onclick="setPriorityValue('${list.id}', 'urgent', '#d32f2f', 'Urgent')">
                                                    <i class="bi bi-flag-fill" style="color: #d32f2f"></i> Urgent
                                                </div>
                                                <div class="priority-item" onclick="setPriorityValue('${list.id}', 'high', '#ffa000', 'High')">
                                                    <i class="bi bi-flag-fill" style="color: #ffa000"></i> High
                                                </div>
                                                <div class="priority-item" onclick="setPriorityValue('${list.id}', 'normal', '#2196f3', 'Normal')">
                                                    <i class="bi bi-flag-fill" style="color: #2196f3"></i> Normal
                                                </div>
                                                <div class="priority-item" onclick="setPriorityValue('${list.id}', 'low', '#9e9e9e', 'Low')">
                                                    <i class="bi bi-flag-fill" style="color: #9e9e9e"></i> Low
                                                </div>
                                            </div>
                                            <input type="hidden" id="task-priority-${list.id}" value="normal">
                                        </div>
                                    </div>
                                </div>

                                <!-- Assign To & Notify To Menggunakan Dropdown Baru -->
                                <div class="meta-row">
                                    <div class="meta-icon"><i class="bi bi-person-plus"></i></div>
                                    <div class="meta-label">Assign to</div>
                                    <div class="meta-value">
                                        ${renderUserDropdownUI(list.id, 'assign')}
                                    </div>
                                </div>
                                <div class="meta-row">
                                    <div class="meta-icon"><i class="bi bi-bell"></i></div>
                                    <div class="meta-label">Notify to</div>
                                    <div class="meta-value">
                                        ${renderUserDropdownUI(list.id, 'notify')}
                                    </div>
                                </div>

                                <div class="meta-row">
                                    <div class="meta-icon"><i class="bi bi-calendar4"></i></div>
                                    <div class="meta-label">Dates</div>
                                    <div class="meta-value d-flex gap-1">
                                        <input type="date" id="task-start-${list.id}" class="ghost-input p-0" style="width:110px">
                                        <span class="text-muted">-</span>
                                        <input type="date" id="task-due-${list.id}" class="ghost-input p-0" style="width:110px">
                                    </div>
                                </div>
                                <div class="meta-row">
                                    <div class="meta-icon"><i class="bi bi-star"></i></div>
                                    <div class="meta-label">Task point</div>
                                    <div class="meta-value">
                                        <input type="number" id="task-points-${list.id}" class="ghost-input" placeholder="Empty" min="0">
                                    </div>
                                </div>

                                <div class="meta-row">
                                    <div class="meta-icon"><i class="bi bi-stopwatch"></i></div>
                                    <div class="meta-label">Track time</div>
                                    <div class="meta-value d-flex align-items-center gap-2">
                                        <span class="text-muted small">Empty</span>
                                        <button class="btn btn-sm btn-light border-0 py-0" style="font-size:0.75rem"><i class="bi bi-play-fill"></i> Start</button>
                                    </div>
                                </div>
                                <div class="meta-row">
                                    <div class="meta-icon"><i class="bi bi-tags"></i></div>
                                    <div class="meta-label">Tags</div>
                                    <div class="meta-value position-relative"> 
                                        <div id="selected-tags-${list.id}" class="d-flex flex-wrap gap-1 mb-1"></div> 
                                        <input type="text" id="tag-input-${list.id}" class="ghost-input w-100" 
                                                placeholder="Search or add tags..." 
                                                oninput="handleTagSearch(this, '${list.id}')" 
                                                onfocus="handleTagSearch(this, '${list.id}')"> 
                                        <div id="tag-dropdown-${list.id}" class="tag-dropdown"></div> 
                                    </div>
                                </div>
                            </div>

                            <div class="rich-editor-box mt-3">
                                <div id="task-desc-${list.id}" class="rich-editor-content" contenteditable="true" data-placeholder="Task description or notes..."></div>
                            </div>

                            <div class="d-flex justify-content-end gap-2 mt-4 pt-3 border-top">
                                <button class="btn btn-dlg-blue rounded-pill px-4" style="" onclick="saveTask('${list.id}')">Add to-do</button>
                                <button class="btn btn-light border rounded-pill px-4" onclick="hideTaskForm('${list.id}')">Cancel</button>
                            </div>
                        </div>
                    </div>
                </div>`;
                container.insertAdjacentHTML('beforeend', html);
            });
        }

        // --- USER DROPDOWN UI HELPERS ---
        function renderUserDropdownUI(lid, type) {
            const inputId = type === 'assign' ? `task-assign-${lid}` : `task-notify-${lid}`;
            
            return `
                <div class="user-dropdown-container" id="container-${type}-${lid}">
                    <div class="user-trigger" onclick="toggleUserMenu('${lid}', '${type}')">
                        <div id="display-${type}-${lid}" class="d-flex align-items-center gap-2">
                            <i class="bi bi-person-circle text-muted"></i>
                            <span class="text-muted small">Select user...</span>
                        </div>
                        <i class="bi bi-chevron-down ms-auto text-muted small"></i>
                    </div>
                    
                    <div class="user-menu-dark" id="menu-${type}-${lid}" style="display:none">
                        <div class="user-search-box">
                            <i class="bi bi-search"></i>
                            <input type="text" placeholder="Search..." onclick="event.stopPropagation()" oninput="filterUsers(this, '${lid}', '${type}')">
                        </div>
                        
                        <div class="user-list-scroll">
                            <div class="user-section-label">People</div>
                            <div id="list-${type}-${lid}">
                                ${renderUserListItems(globalUsers, lid, type)}
                            </div>
                        </div>
                    </div>
                    <input type="hidden" id="${inputId}" value="">
                </div>
            `;
        }

        function renderUserListItems(users, lid, type) {
            if(users.length === 0) return '<div class="p-2 text-muted small">No users found</div>';
            return users.map(u => `
                <div class="user-item" onclick="selectUser('${lid}', '${type}', '${u.id}', '${u.name}', '${u.photo}')">
                    <img src="${u.photo}" class="user-avatar" onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(u.name)}'">
                    <span class="user-name">${u.name}</span>
                    ${u.role === 'Admin' ? '<i class="bi bi-patch-check-fill verified-badge" style="color:#007bff; font-size:0.7rem"></i>' : ''}
                </div>
            `).join('');
        }

        function toggleUserMenu(lid, type) {
            event.stopPropagation();
            // Tutup semua menu lain (priority & user menu lain)
            document.querySelectorAll('.user-menu-dark, .priority-menu').forEach(m => m.style.display = 'none');
            const menu = document.getElementById(`menu-${type}-${lid}`);
            menu.style.display = 'block';
        }

        function filterUsers(input, lid, type) {
            const query = input.value.toLowerCase();
            const filtered = globalUsers.filter(u => u.name.toLowerCase().includes(query) || (u.email && u.email.toLowerCase().includes(query)));
            document.getElementById(`list-${type}-${lid}`).innerHTML = renderUserListItems(filtered, lid, type);
        }

        function selectUser(lid, type, userId, userName, userPhoto) {
            event.stopPropagation();
            // Update Hidden Input (task-assign-lid atau task-notify-lid)
            document.getElementById(`task-${type}-${lid}`).value = userId;
            
            // Update Display Trigger
            document.getElementById(`display-${type}-${lid}`).innerHTML = `
                <img src="${userPhoto}" style="width:20px; height:20px; border-radius:50%" onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(userName)}'">
                <span class="fw-medium" style="font-size:0.85rem">${userName}</span>
            `;
            
            // Tutup Menu
            document.getElementById(`menu-${type}-${lid}`).style.display = 'none';
        }

        // --- PRIORITY FUNCTIONS ---
        function togglePriorityMenu(lid) {
            event.stopPropagation();
            document.querySelectorAll('.user-menu-dark, .priority-menu').forEach(m => m.style.display = 'none');
            const menu = document.getElementById(`priority-menu-${lid}`);
            menu.style.display = 'block';
        }

        function setPriorityValue(lid, value, color, label) {
            const iconDisplay = document.getElementById(`priority-icon-display-${lid}`);
            const textDisplay = document.getElementById(`priority-text-display-${lid}`);
            const hiddenInput = document.getElementById(`task-priority-${lid}`);
            iconDisplay.style.color = color;
            textDisplay.innerText = label;
            hiddenInput.value = value;
            document.getElementById(`priority-menu-${lid}`).style.display = 'none';
        }

        // Klik di luar menutup dropdown 
        document.addEventListener('click', () => { 
            document.querySelectorAll('.tag-dropdown, .user-menu-dark, .priority-menu').forEach(m => m.style.display = 'none'); 
        });

        // --- TASK SAVE LOGIC --- 
        function saveTask(lid) { 
            const title = document.getElementById(`task-title-${lid}`).value; 
            if (!title) return alert("Task Name is required"); 
        
            const btn = event.target; 
            btn.disabled = true; 
            btn.innerText = "Saving..."; 

            const user = JSON.parse(localStorage.getItem('userData')) || {};
        
            const payload = { 
                action: 'createTask', 
                listId: lid, 
                userId: user.id || '',
                title: title, 
                description: document.getElementById(`task-desc-${lid}`).innerHTML, 
                status: document.getElementById(`task-status-${lid}`).value, 
                priority: document.getElementById(`task-priority-${lid}`).value, 
                dueDate: document.getElementById(`task-due-${lid}`).value, 
                assignTo: document.getElementById(`task-assign-${lid}`).value, 
                // AMBIL ARRAY ID TAG YANG DIPILIH 
                tagIds: (selectedTagsByList[lid] || []).map(t => t.id) 
            }; 
        
            fetch(API_URL, { 
                method: 'POST', 
                body: JSON.stringify(payload) 
            }) 
            .then(r => r.json()) 
            .then(res => { 
                if(res.status === 'success') { 
                    selectedTagsByList[lid] = []; // Reset pilihan tag 
                    fetchData(); // Refresh list 
                    hideTaskForm(lid); 
                } 
            }) 
            .finally(() => { 
                btn.disabled = false; 
                btn.innerText = "Add to-do"; 
            }); 
        }

        // --- LAINNYA (TAGS, STATUS UI, FORM UI) ---
        function renderStatusDropdown(statuses, lid) {
            if (!statuses || statuses.length === 0) {
                return `<div class="task-status-selector" style="background:#007bff" id="status-wrap-${lid}"><select id="task-status-${lid}" class="status-select"><option value="OPEN" data-color="#007bff">OPEN</option></select></div>`;
            }
            const options = statuses.map(s => `<option value="${s.name}" data-color="${s.color}">${s.name.toUpperCase()}</option>`).join('');
            return `<div class="task-status-selector" style="background:${statuses[0].color}" id="status-wrap-${lid}"><select id="task-status-${lid}" onchange="updateStatusSelectorColor(this, '${lid}')">${options}</select></div>`;
        }

        function updateStatusSelectorColor(select, lid) {
            const color = select.options[select.selectedIndex].getAttribute('data-color');
            document.getElementById(`status-wrap-${lid}`).style.backgroundColor = color;
        }



        function showTaskForm(lid) { 
            document.getElementById(`btn-add-${lid}`).style.display = 'none'; 
            document.getElementById(`form-add-${lid}`).style.display = 'block'; 
            selectedTagsByList[lid] = []; 
            renderSelectedTagsUI(lid); 
        } 
        
        function hideTaskForm(lid) { 
            document.getElementById(`btn-add-${lid}`).style.display = 'inline-block'; 
            document.getElementById(`form-add-${lid}`).style.display = 'none'; 
        }
    </script>
    <script>
        // Fungsi Logout
        function logout() {
            localStorage.removeItem('userData');
            window.location.href = "index.html";
        }
    </script>
</body>
</html>
