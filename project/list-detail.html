<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>List Detail - Dialogika</title>
    
    <!-- Bootstrap 5.3 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="../assets/css/style.css" rel="stylesheet" />

    <style>
        /* CSS KHUSUS HALAMAN LIST (STACKED CARD EFFECT) */
        
        body { background-color: #e5e7eb; }
        
        /* FIX: Main Content Margin */
        .main-content {
            margin-left: 290px;
            width: calc(100% - 290px);
            padding: 40px;
            min-height: 100vh;
        }

        @media (max-width: 991px) {
            .main-content { margin-left: 0; width: 100%; padding: 20px; }
        }

        /* --- 1. PROJECT CONTEXT CARD (UPDATED STYLE) --- */
        .project-context-card {
            max-width: 800px;
            width: 90%;
            background-color: #1f2937; /* Dark Navy sesuai list.html */
            color: white;
            margin: 20px auto -20px auto;
            padding: 20px 25px 40px 25px;
            border-radius: 16px 16px 0 0;
            position: relative;
            z-index: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.05);
        }

        /* Badge */
        .ph-badge {
            background: #FDE047;
            color: #854D0E;
            font-size: 0.7rem;
            font-weight: 800;
            padding: 4px 8px;
            border-radius: 4px;
            text-transform: uppercase;
            position: absolute;
            left: 30px;
            top: 40%;
            transform: translateY(-50%);
        }

        /* Breadcrumb Navigation Styles */
        .ph-crumb-container {
            display: flex;
            align-items: center;
            gap: 12px;
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 20px;
            border-radius: 50px;
            font-size: 0.95rem;
        }

        .ph-crumb-link {
            text-decoration: none;
            color: #d1d5db; /* Gray Light */
            font-weight: 500;
            transition: 0.2s;
            display: flex; align-items: center;
        }
        .ph-crumb-link:hover { color: white; }
        
        .ph-crumb-active {
            color: white;
            font-weight: 700;
            border-bottom: 2px solid #FDE047; /* Yellow underline */
        }
        
        .ph-sep { font-size: 0.8rem; color: #6b7280; } /* Separator */

        /* --- 2. MAIN LIST CARD --- */
        .main-list-card {
            max-width: 1000px;
            width: 100%;
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 40px -5px rgba(0, 0, 0, 0.1);
            margin: 0 auto 50px auto;
            padding: 50px 60px;
            position: relative;
            z-index: 2;
            border: 1px solid #d1d5db;
        }

        /* Description Expand/Collapse */
        .desc-more-link {
            color: var(--dlg-blue);
            font-weight: 600;
            font-size: 0.85rem;
            cursor: pointer;
            text-decoration: none;
            margin-left: 5px;
        }
        .desc-more-link:hover { text-decoration: underline; }

        /* Todo Styling */
        .todo-group-label {
            font-size: 1.1rem; font-weight: 800; color: #1f2937;
            margin-top: 40px; margin-bottom: 15px; border-bottom: 3px solid #1f2937;
            display: inline-block; padding-bottom: 2px;
        }
        
        .todo-row {
            display: flex; align-items: flex-start; padding: 12px 0;
            border-bottom: 1px solid #f3f4f6; transition: 0.2s;
            font-size: 1.05rem; cursor: pointer;
        }
        .todo-row:hover { background-color: #f9fafb; padding-left: 10px; border-radius: 5px; margin-left: -10px; }
        
        .todo-check {
            width: 24px; height: 24px; margin-right: 15px; margin-top: 3px; cursor: pointer;
            border: 2px solid #cbd5e1; border-radius: 6px;
        }
        .todo-text { color: #374151; font-weight: 500; }
        .todo-row.completed .todo-text { text-decoration: line-through; color: #9ca3af; }

        @media (max-width: 768px) {
            .ph-badge { display: none; }
            .ph-crumb-container { width: 100%; justify-content: center; padding: 8px 10px; gap: 8px; font-size: 0.85rem;}
            .main-list-card { padding: 30px 20px; }
        }
        
    </style>
</head>
<body>

    <!-- 1. TOP BAR FIXED -->
    <nav class="top-bar">
        <!-- Left: Mobile Toggle & Search -->
        <div class="d-flex align-items-center">
            <button class="mobile-toggle me-3" onclick="toggleSidebar()">
                <i class="bi bi-list"></i>
            </button>
            <div class="input-group d-none d-md-flex" style="width: 250px;">
                <span class="input-group-text bg-light border-end-0 rounded-start-pill text-muted"><i class="bi bi-search"></i></span>
                <input type="text" class="form-control bg-light border-start-0 rounded-end-pill" placeholder="Search...">
            </div>
        </div>

        <!-- CENTER: LOGO DIALOGIKA -->
        <div class="logo-center">
            <img src="https://www.dialogika.co/assets/img/logo.webp" alt="Dialogika Logo" height="35">
        </div>

        <!-- Right: Profile -->
        <div class="d-flex align-items-center gap-3">
            <div class="text-end d-none d-lg-block lh-1">
                <span id="user-name-display" class="d-block fw-bold small text-dark">Loading...</span>
                <small id="user-role-display" class="text-muted" style="font-size:0.7rem">User</small>
            </div>
            <div class="profile-img-container">
                <img id="user-photo-display" src="https://i.pravatar.cc/300" alt="Profile" class="profile-img">
            </div>
        </div>
    </nav>

    <div class="dashboard-container">
        
        <!-- 2. SIDEBAR -->
        <aside class="sidebar" id="sidebarNav">
            <div class="sidebar-scroll-wrapper">
                <div class="nav-category">Main Navigation</div>
                <a href="../home.html" class="sidebar-link active"><i class="bi bi-columns-gap"></i> Dashboard</a>
                <a href="#" class="sidebar-link"><i class="bi bi-list-columns-reverse"></i> Lineup</a>
                <div class="sidebar-copyright">&copy; 2025 PT Dialogika Persona Indonesia</div>
            </div>
        </aside>

        <!-- 3. MAIN CONTENT -->
        <main class="main-content">
            
            <!-- A. KARTU BELAKANG (BREADCRUMB NAV) -->
            <div class="project-context-card">
                <!-- Badge (Akan diisi JS) -->
                <div class="ph-badge" id="projectBadge">Loading...</div>

                <!-- Breadcrumb Navigation -->
                <div class="ph-crumb-container">
                    <!-- 1. Home -->
                    <a href="../home.html" class="ph-crumb-link" title="Dashboard">
                        <i class="bi bi-house-fill"></i>
                    </a>
                    
                    <i class="bi bi-chevron-right ph-sep"></i>

                    <!-- 2. Project Name -->
                    <a href="#" id="breadProjectLink" class="ph-crumb-link">...</a>

                    <i class="bi bi-chevron-right ph-sep"></i>

                    <!-- 3. All Lists (To-dos) -->
                    <a href="#" id="breadAllListLink" class="ph-crumb-link">Lists</a>
                </div>

                <!-- Right Option -->
                <div class="position-absolute end-0 me-3">
                    <button class="btn btn-link text-white text-opacity-50"><i class="bi bi-three-dots"></i></button>
                </div>
            </div>

            <!-- B. KARTU DEPAN (DETAIL LIST) -->
            <div class="main-list-card">
                
                <!-- Header Area -->
                <div class="mb-5 text-center">
                    <!-- H1 untuk Judul List -->
                    <h1 class="fw-bold display-5 mb-3" id="listTitleDisplay" style="color:#111;">Loading List...</h1>
                    
                    <!-- P untuk Deskripsi (Max 8 Words) -->
                    <div class="text-muted mx-auto" style="max-width: 700px; line-height: 1.6;">
                        <span id="descShort"></span>
                        <span id="descFull" style="display:none;"></span>
                        <a href="javascript:void(0)" class="desc-more-link" id="readMoreBtn" style="display:none;" onclick="toggleDesc()">Read more...</a>
                    </div>
                </div>

                <!-- TASK LIST WRAPPER -->
                <div class="todo-list-wrapper">
                    <div class="text-center py-4"><div class="spinner-border text-primary"></div></div>
                </div>

                <!-- ADD TASK BUTTON & FORM -->
                <div class="mt-4 ps-3 border-top pt-4">
                    <button id="btn-add-detail" class="btn btn-outline-secondary rounded-pill px-4 btn-sm fw-bold" onclick="showDetailForm()">
                        <i class="bi bi-plus-lg me-1"></i> Add a to-do
                    </button>
                    
                    <div id="form-add-detail" class="mt-3" style="display:none; max-width: 600px;">
                        <input type="text" id="input-task-detail" class="form-control form-control-lg mb-2" placeholder="Describe this to-do...">
                        <div class="d-flex gap-2">
                            <button class="btn btn-success rounded-pill px-4" onclick="saveTaskDetail()">Add this to-do</button>
                            <button class="btn btn-light border rounded-pill px-4" onclick="hideDetailForm()">Cancel</button>
                        </div>
                    </div>
                </div>
                
                <!-- --- COMMENT SECTION (NEW) --- -->
                <div class="mt-5 pt-5 border-top">
                     <!-- COMMENTS CONTAINER -->
                    <div id="commentsContainer" class="mb-4 d-flex flex-column gap-3">
                        <!-- Komentar akan muncul disini -->
                    </div>

                    <!-- FORM KOMENTAR -->
                    <div class="d-flex gap-3">
                        <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center fw-bold flex-shrink-0" style="width:40px; height:40px;">RA</div>
                        <div class="w-100">
                            <div id="commentInput" class="form-control bg-light text-muted p-3 mb-2" contenteditable="true" style="min-height: 80px; border-radius: 12px;">Add a comment here...</div>
                            <button class="btn btn-success rounded-pill px-4 btn-sm fw-bold" onclick="postComment('list')">Post comment</button>
                        </div>
                    </div>
                </div>

                <div class="mt-5 pt-4 border-top">
                    <h6 class="fw-bold text-dark">Subscribers</h6>
                    <p class="small text-muted mb-3">People listed below will be notified when comments are posted.</p>
                    
                    <div class="d-flex align-items-center gap-2 flex-wrap" id="subsContainer"></div>
                    
                    <div class="mt-3 p-2 bg-light rounded-pill d-inline-block border">
                        <small id="subscriptionStatusText" class="text-dark fw-bold px-2">You’re subscribed</small>
                        <button id="subscriptionToggleButton" class="btn btn-sm btn-link text-muted text-decoration-none p-0" style="font-size:0.8rem;" onclick="toggleSubscription()">Unsubscribe me</button>
                    </div>
                </div>
                
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import {
            getFirestore,
            doc,
            collection,
            getDoc,
            getDocs,
            query,
            where,
            orderBy,
            addDoc,
            updateDoc,
            deleteDoc,
            onSnapshot,
            serverTimestamp
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDyzzEYbJkkl-N8snrQf14qvj8De4YliV0",
            authDomain: "pre-dialogika.firebaseapp.com",
            projectId: "pre-dialogika",
            storageBucket: "pre-dialogika.firebasestorage.app",
            messagingSenderId: "343771410480",
            appId: "1:343771410480:web:32881c9868522090237df5"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const urlParams = new URLSearchParams(window.location.search);
        const listId = urlParams.get('listId');
        const projectId = urlParams.get('projectId');

        const tasksWrapper = document.querySelector('.todo-list-wrapper');
        const titleEl = document.getElementById('listTitleDisplay');
        const badgeEl = document.getElementById('projectBadge');
        const commentsContainer = document.getElementById('commentsContainer');
        const subsContainer = document.getElementById('subsContainer');
        const breadProjectLink = document.getElementById('breadProjectLink');
        const breadAllListLink = document.getElementById('breadAllListLink');
        const subscriptionStatusText = document.getElementById('subscriptionStatusText');
        const subscriptionToggleButton = document.getElementById('subscriptionToggleButton');

        let currentUser = null;
        let listTasks = [];
        let currentSubscribers = [];

        document.addEventListener("DOMContentLoaded", () => {
            if (!listId || !projectId) {
                alert("Error: Parameter URL tidak lengkap.");
                return;
            }

            breadProjectLink.href = `../project/project.html?id=${projectId}`;
            breadAllListLink.href = `list.html?id=${projectId}`;

            const commentInput = document.getElementById('commentInput');
            if (commentInput) {
                commentInput.addEventListener('focus', function () {
                    if (this.innerText === 'Add a comment here...') this.innerText = '';
                });
                commentInput.addEventListener('blur', function () {
                    if (this.innerText.trim() === '') this.innerText = 'Add a comment here...';
                });
            }

            loadProjectHeader();
            loadListDetail();
            listenComments();
            listenSubscribers();

            onAuthStateChanged(auth, (user) => {
                currentUser = user || null;
                updateSubscriptionUI();
            });
        });

        async function loadProjectHeader() {
            try {
                const snap = await getDoc(doc(db, "projects", projectId));
                if (!snap.exists()) return;
                const data = snap.data();
                if (breadProjectLink) breadProjectLink.innerText = data.name || "Untitled Project";
                if (badgeEl) badgeEl.innerText = data.department || "Project";
            } catch (e) {
                console.error("Failed to load project header", e);
            }
        }

        async function loadListDetail() {
            if (!tasksWrapper || !titleEl) return;
            tasksWrapper.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary"></div></div>';
            try {
                const listRef = doc(db, "projects", projectId, "lists", listId);
                const snap = await getDoc(listRef);
                if (!snap.exists()) {
                    titleEl.innerText = "List Not Found";
                    tasksWrapper.innerHTML = '<div class="alert alert-warning text-center">List ID tidak ditemukan.</div>';
                    return;
                }
                const listData = { id: snap.id, ...snap.data() };
                renderListHeader(listData);
                await loadTasks();
            } catch (e) {
                console.error("Failed to load list detail", e);
                tasksWrapper.innerHTML = '<div class="alert alert-danger text-center">Gagal mengambil data list.</div>';
            }
        }

        async function loadTasks() {
            try {
                const q = query(
                    collection(db, "tasks"),
                    where("project_id", "==", projectId)
                );
                const snap = await getDocs(q);
                const tasks = [];
                snap.forEach(docSnap => {
                    const data = docSnap.data();
                    if (data.list_id === listId) {
                        tasks.push({ id: docSnap.id, ...data });
                    }
                });
                tasks.sort((a, b) => {
                    const pa = typeof a.position === "number" ? a.position : 0;
                    const pb = typeof b.position === "number" ? b.position : 0;
                    return pa - pb;
                });
                listTasks = tasks;
                renderTasks(listTasks);
            } catch (e) {
                console.error("Failed to load tasks", e);
                if (tasksWrapper) {
                    tasksWrapper.innerHTML = '<div class="alert alert-danger text-center">Gagal mengambil data tasks.</div>';
                }
            }
        }

        function renderListHeader(list) {
            titleEl.innerText = list.name;
            const fullDesc = list.description || list.desc || "No description provided.";
            const words = fullDesc.split(' ');
            
            const shortSpan = document.getElementById('descShort');
            const fullSpan = document.getElementById('descFull');
            const btn = document.getElementById('readMoreBtn');

            if (words.length > 8) {
                shortSpan.innerText = words.slice(0, 8).join(' ') + '...';
                shortSpan.style.display = 'inline';
                fullSpan.innerText = fullDesc;
                fullSpan.style.display = 'none';
                btn.style.display = 'inline';
            } else {
                shortSpan.innerText = fullDesc;
                fullSpan.style.display = 'none';
                btn.style.display = 'none';
            }
        }

        window.toggleDesc = function () {
            const shortSpan = document.getElementById('descShort');
            const fullSpan = document.getElementById('descFull');
            const btn = document.getElementById('readMoreBtn');
            const isShort = shortSpan.style.display !== 'none';
            
            shortSpan.style.display = isShort ? 'none' : 'inline';
            fullSpan.style.display = isShort ? 'inline' : 'none';
            btn.innerText = isShort ? 'Show less' : 'Read more';
        };

        function renderTasks(tasks) {
            tasksWrapper.innerHTML = '';
            if (!tasks || tasks.length === 0) {
                tasksWrapper.innerHTML = '<div class="text-muted fst-italic text-center py-3">No tasks yet.</div>';
                return;
            }

            tasks.forEach(task => {
                const isDone = ['done', 'completed', 'complete', 'true'].includes(String(task.status).toLowerCase());
                
                const itemHtml = `
                    <div class="todo-row ${isDone ? 'completed' : ''} d-flex align-items-start" 
                         onclick="goToTaskDetail('${task.id}')">
                        
                        <input type="checkbox" class="todo-check" ${isDone ? 'checked' : ''} 
                               onclick="event.stopPropagation()" 
                               onchange="handleStatusChange('${task.id}', this)">
                        
                        <div class="w-100">
                            <div class="todo-text">${task.title}</div>
                            <small class="text-muted" style="font-size:0.75rem">Click to see details</small>
                        </div>
                    </div>
                `;
                tasksWrapper.insertAdjacentHTML('beforeend', itemHtml);
            });
        }

        function normalizeTimestamp(value) {
            if (!value) return null;
            if (value.toDate) return value.toDate();
            if (value instanceof Date) return value;
            const d = new Date(value);
            return isNaN(d.getTime()) ? null : d;
        }

        function renderComments(comments) {
            commentsContainer.innerHTML = '';
            if (!comments || comments.length === 0) {
                commentsContainer.innerHTML = '<p class="text-muted small">No comments yet.</p>';
                return;
            }
            
            comments.forEach(c => {
                const createdAt = normalizeTimestamp(c.created_at || c.createdAt);
                const dateStr = createdAt ? createdAt.toLocaleString() : 'Just now';
                const userId = c.user_id || c.userId || '';
                const userName = c.user_name || c.userName || userId || 'User';
                const initialsSource = c.user_initials || userName || userId || '';
                const initials = initialsSource
                    ? initialsSource.trim().split(' ').map(part => part[0]).join('').substring(0, 2).toUpperCase()
                    : '??';

                const html = `
                    <div class="d-flex gap-3 mb-3">
                        <div class="rounded-circle bg-secondary text-white d-flex align-items-center justify-content-center fw-bold flex-shrink-0" style="width:40px; height:40px;">
                            ${initials}
                        </div>
                        <div class="bg-white border rounded p-3 w-100 shadow-sm">
                            <div class="d-flex justify-content-between mb-1">
                                <strong class="small text-dark">${userName}</strong>
                                <small class="text-muted" style="font-size:0.7rem">${dateStr}</small>
                            </div>
                            <div class="text-dark small">${c.text}</div>
                        </div>
                    </div>
                `;
                commentsContainer.insertAdjacentHTML('beforeend', html);
            });
        }

        function renderSubscribers(subs) {
            subsContainer.innerHTML = '';
            if (!subs || subs.length === 0) {
                const btnAddHtml = `<button class="btn btn-light border rounded-pill px-3 py-1 btn-sm text-muted small" type="button">Add/remove people...</button>`;
                subsContainer.insertAdjacentHTML('beforeend', btnAddHtml);
                return;
            }
            
            subs.forEach(s => {
                const userId = s.user_id || s.userId || '';
                const userName = s.user_name || s.userName || userId || 'User';
                const initialsSource = s.user_initials || userName || userId || '';
                const initials = initialsSource
                    ? initialsSource.trim().split(' ').map(part => part[0]).join('').substring(0, 2).toUpperCase()
                    : 'U';
                const html = `<div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center fw-bold" 
                              style="width:30px; height:30px; font-size:0.7rem;" title="${userName}">${initials}</div>`;
                subsContainer.insertAdjacentHTML('beforeend', html);
            });
            
            const btnAddHtml = `<button class="btn btn-light border rounded-pill px-3 py-1 btn-sm text-muted small" type="button">Add/remove people...</button>`;
            subsContainer.insertAdjacentHTML('beforeend', btnAddHtml);
        }

        function listenComments() {
            try {
                const ref = collection(db, "projects", projectId, "lists", listId, "comments");
                const q = query(ref, orderBy("created_at", "asc"));
                onSnapshot(q, (snapshot) => {
                    const comments = [];
                    snapshot.forEach(docSnap => comments.push({ id: docSnap.id, ...docSnap.data() }));
                    renderComments(comments);
                }, (error) => {
                    console.error("Failed to listen comments", error);
                });
            } catch (e) {
                console.error("Failed to start comments listener", e);
            }
        }

        function listenSubscribers() {
            try {
                const ref = collection(db, "projects", projectId, "lists", listId, "subscribers");
                onSnapshot(ref, (snapshot) => {
                    const subs = [];
                    snapshot.forEach(docSnap => subs.push({ id: docSnap.id, ...docSnap.data() }));
                    currentSubscribers = subs;
                    renderSubscribers(subs);
                    updateSubscriptionUI();
                }, (error) => {
                    console.error("Failed to listen subscribers", error);
                });
            } catch (e) {
                console.error("Failed to start subscribers listener", e);
            }
        }

        function updateSubscriptionUI() {
            if (!subscriptionStatusText || !subscriptionToggleButton) return;
            if (!currentUser) {
                subscriptionStatusText.innerText = "You’re not subscribed";
                subscriptionToggleButton.innerText = "Subscribe me";
                subscriptionToggleButton.disabled = true;
                return;
            }
            const uid = currentUser.uid;
            const isSubscribed = currentSubscribers.some(s => (s.user_id || s.userId) === uid);
            subscriptionStatusText.innerText = isSubscribed ? "You’re subscribed" : "You’re not subscribed";
            subscriptionToggleButton.innerText = isSubscribed ? "Unsubscribe me" : "Subscribe me";
            subscriptionToggleButton.disabled = false;
        }

        window.postComment = async function () {
            const input = document.getElementById('commentInput');
            if (!input) return;
            const text = input.innerText.trim();
            if (text === 'Add a comment here...' || text === '') return;
            
            const btn = event && event.target ? event.target : null;
            let originalBtnText = '';
            if (btn) {
                originalBtnText = btn.innerText;
                btn.innerText = 'Posting...';
                btn.disabled = true;
            }

            try {
                const localData = JSON.parse(localStorage.getItem('userData') || 'null');
                const userName = localData && localData.name ? localData.name : (currentUser ? currentUser.email : 'User');
                const uid = currentUser ? currentUser.uid : (localData && localData.uid ? localData.uid : '');
                const initialsSource = userName || uid || '';
                const initials = initialsSource
                    ? initialsSource.trim().split(' ').map(part => part[0]).join('').substring(0, 2).toUpperCase()
                    : 'US';

                await addDoc(collection(db, "projects", projectId, "lists", listId, "comments"), {
                    text: text,
                    user_id: uid,
                    user_name: userName,
                    user_initials: initials,
                    created_at: serverTimestamp()
                });

                input.innerText = 'Add a comment here...';
            } catch (e) {
                console.error("Failed to post comment", e);
                alert("Gagal mengirim komentar: " + e.message);
            } finally {
                if (btn) {
                    btn.innerText = originalBtnText || 'Post comment';
                    btn.disabled = false;
                }
            }
        };

        window.showDetailForm = function () {
            const form = document.getElementById('form-add-detail');
            const btn = document.getElementById('btn-add-detail');
            if (form) form.style.display = 'block';
            if (btn) btn.style.display = 'none';
        };

        window.hideDetailForm = function () {
            const form = document.getElementById('form-add-detail');
            const btn = document.getElementById('btn-add-detail');
            if (form) form.style.display = 'none';
            if (btn) btn.style.display = 'inline-block';
        };

        window.saveTaskDetail = async function () {
            const input = document.getElementById('input-task-detail');
            if (!input) return;
            const title = input.value.trim();
            if (!title) return;

            try {
                const existingForList = listTasks || [];
                const payload = {
                    project_id: projectId,
                    list_id: listId,
                    title: title,
                    description: "",
                    status: "Initiate",
                    priority: "normal",
                    start_date: "",
                    due_date: "",
                    points: 0,
                    assign_to: "",
                    notify_to: "",
                    tags: [],
                    position: existingForList.length,
                    created_at: serverTimestamp(),
                    created_by: currentUser ? currentUser.uid : ""
                };
                await addDoc(collection(db, "tasks"), payload);
                input.value = '';
                await loadTasks();
                window.hideDetailForm();
            } catch (e) {
                console.error("Failed to save task", e);
                alert("Gagal menyimpan task: " + e.message);
            }
        };

        window.handleStatusChange = async function (taskId, checkbox) {
            if (!taskId || !checkbox) return;
            const isChecked = checkbox.checked;
            const newStatus = isChecked ? 'Complete' : 'Initiate';
            const rowElement = checkbox.closest('.todo-row');

            if (rowElement) {
                if (isChecked) rowElement.classList.add('completed');
                else rowElement.classList.remove('completed');
            }

            try {
                await updateDoc(doc(db, "tasks", taskId), { status: newStatus });
            } catch (e) {
                console.error("Failed to update task status", e);
                alert("Gagal memperbarui status: " + e.message);
                checkbox.checked = !isChecked;
                if (rowElement) rowElement.classList.toggle('completed');
            }
        };

        window.goToTaskDetail = function (taskId) {
            if (!taskId) return;
            window.location.href = `item-details.html?taskId=${taskId}&projectId=${projectId}`;
        };

        window.toggleSubscription = async function () {
            if (!currentUser) {
                alert("Harus login terlebih dahulu.");
                return;
            }
            const uid = currentUser.uid;
            const existing = currentSubscribers.find(s => (s.user_id || s.userId) === uid);

            try {
                if (existing && existing.id) {
                    await deleteDoc(doc(db, "projects", projectId, "lists", listId, "subscribers", existing.id));
                } else {
                    const localData = JSON.parse(localStorage.getItem('userData') || 'null');
                    const userName = localData && localData.name ? localData.name : (currentUser.email || 'User');
                    const initialsSource = userName || uid || '';
                    const initials = initialsSource
                        ? initialsSource.trim().split(' ').map(part => part[0]).join('').substring(0, 2).toUpperCase()
                        : 'US';
                    await addDoc(collection(db, "projects", projectId, "lists", listId, "subscribers"), {
                        user_id: uid,
                        user_name: userName,
                        user_initials: initials,
                        created_at: serverTimestamp()
                    });
                }
            } catch (e) {
                console.error("Failed to toggle subscription", e);
                alert("Gagal mengubah status subscribe: " + e.message);
            }
        };

        window.toggleSidebar = function () {
            const sidebar = document.getElementById('sidebarNav');
            if (sidebar) sidebar.classList.toggle('show');
        };
    </script>
     <script>
         document.addEventListener("DOMContentLoaded", function() {
             // 1. Ambil data dari localStorage
             const data = localStorage.getItem('userData');
             
             if (!data) {
                 // Jika tidak ada data login, tendang balik ke login page
                 window.location.href = "index.html";
                 return;
             }

             const user = JSON.parse(data);

             // 2. Fungsi untuk konversi link Google Drive ke Direct Image Link
             function getDirectLink(url) {
                 if (!url) return "https://i.pravatar.cc/300";
                 if (url.includes('drive.google.com')) {
                     let id = "";
                     if (url.includes('id=')) {
                         id = url.split('id=')[1].split('&')[0];
                     } else {
                         id = url.split('/d/')[1].split('/')[0];
                     }
                     return `https://lh3.googleusercontent.com/u/0/d/${id}`;
                 }
                 return url;
             }

             // 3. Update Tampilan Navbar
             document.getElementById('user-name-display').innerText = user.name;
             document.getElementById('user-photo-display').src = getDirectLink(user.photo);
             // Posisi bisa disesuaikan jika ada di spreadsheet
             document.getElementById('user-role-display').innerText = "Dialogika Member";
             
             // Update juga pesan selamat datang jika perlu
             const welcomeMsg = document.querySelector('h4.fw-bold');
             if(welcomeMsg) welcomeMsg.innerText = `Good Morning, ${user.name.split(' ')[0]}!`;
         });

         // Fungsi Logout
         function logout() {
             localStorage.removeItem('userData');
             window.location.href = "index.html";
         }
     </script>
</body>
</html>
