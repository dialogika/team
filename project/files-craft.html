<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Craft Files - Dialogika</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="../assets/css/style.css" rel="stylesheet" />

    <style>
        body { }
        .main-content {
            margin-left: 290px;
            width: calc(100% - 290px);
            padding: 40px;
            min-height: 100vh;
        }
        @media (max-width: 991px) {
            .main-content { margin-left: 0; width: 100%; padding: 20px; }
        }
        .project-context-card {
            max-width: 800px;
            width: 90%;
            background-color: #fff;
            color: white;
            margin: 20px auto -20px auto;
            padding: 20px 25px 40px 25px;
            border-radius: 16px 16px 0 0;
            position: relative;
            z-index: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.05);
        }
        .ph-badge {
            background: #FDE047;
            color: #854D0E;
            font-size: 0.7rem;
            font-weight: 800;
            padding: 4px 8px;
            border-radius: 4px;
            text-transform: uppercase;
            position: absolute;
            left: 30px;
            top: 40%;
            transform: translateY(-50%);
        }
        .ph-crumb-container {
            display: flex;
            align-items: center;
            gap: 12px;
            background: linear-gradient(to bottom, #0f61a8 5%, #0b2b6a 100%);
            padding: 8px 20px;
            border-radius: 50px;
            font-size: 0.95rem;
        }
        .ph-crumb-link {
            text-decoration: none;
            color: #d1d5db;
            font-weight: 500;
            transition: 0.2s;
            display: flex;
            align-items: center;
        }
        .ph-crumb-link:hover { color: white; }
        .ph-crumb-active {
            color: white;
            font-weight: 700;
            border-bottom: 2px solid #FDE047;
        }
        .ph-sep {
            font-size: 0.8rem;
            color: #6b7280;
        }
        .main-list-card {
            max-width: 1000px;
            width: 100%;
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 40px -5px rgba(0, 0, 0, 0.3);
            margin: 0 auto 50px auto;
            padding: 50px 60px;
            position: relative;
            z-index: 2;
            border: 0;
        }
        .rich-editor {
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            overflow: hidden;
            background: #f9fafb;
        }
        .rich-toolbar {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 6px 10px;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
        }
        .rich-btn {
            border: none;
            background: transparent;
            padding: 4px 6px;
            border-radius: 6px;
            color: #6b7280;
            font-size: 0.9rem;
        }
        .rich-btn:hover {
            background: #e5e7eb;
            color: #111827;
        }
        .rich-editor-body {
            min-height: 90px;
            padding: 10px 12px;
            background: #ffffff;
            outline: none;
        }
        .rich-editor-body[contenteditable="true"]:empty:before {
            content: attr(data-placeholder);
            color: #9ca3af;
        }
    </style>
</head>
<body style="background-color: #f1f7fd;">

    <nav class="top-bar">
        <div class="d-flex align-items-center">
            <button class="mobile-toggle me-3" onclick="toggleSidebar()">
                <i class="bi bi-list"></i>
            </button>
            <div class="input-group d-none d-md-flex" style="width: 250px;">
                <span class="input-group-text bg-light border-end-0 rounded-start-pill text-muted"><i class="bi bi-search"></i></span>
                <input type="text" class="form-control bg-light border-start-0 rounded-end-pill" placeholder="Search...">
            </div>
        </div>

        <div class="logo-center">
            <img src="https://www.dialogika.co/assets/img/logo.webp" alt="Dialogika Logo" height="35">
        </div>

        <div class="d-flex align-items-center gap-3">
            <div class="text-end d-none d-lg-block lh-1">
                <span id="user-name-display" class="d-block fw-bold small text-dark">Loading...</span>
                <small id="user-role-display" class="text-muted" style="font-size:0.7rem">User</small>
            </div>
            <div class="profile-img-container">
                <img id="user-photo-display" src="https://i.pravatar.cc/300" alt="Profile" class="profile-img">
            </div>
        </div>
    </nav>

    <div class="dashboard-container">
        <aside class="sidebar" id="sidebarNav">
            <div class="sidebar-scroll-wrapper">
                <div class="smart-filters-grid">
                    <a href="#" class="filter-card">
                        <div class="filter-top"><div class="filter-icon bg-icon-dark"><i class="bi bi-archive-fill"></i></div><div class="filter-count">429</div></div>
                        <div class="filter-label">All Tasks</div>
                    </a>
                    <a href="#" class="filter-card">
                        <div class="filter-top"><div class="filter-icon bg-icon-blue"><i class="bi bi-calendar-event-fill"></i></div><div class="filter-count">25</div></div>
                        <div class="filter-label">Today</div>
                    </a>
                    <a href="#" class="filter-card">
                        <div class="filter-top"><div class="filter-icon bg-icon-orange"><i class="bi bi-flag-fill"></i></div><div class="filter-count">21</div></div>
                        <div class="filter-label">Urgent</div>
                    </a>
                    <a href="#" class="filter-card">
                        <div class="filter-top"><div class="filter-icon bg-icon-red"><i class="bi bi-calendar-check-fill"></i></div><div class="filter-count">30</div></div>
                        <div class="filter-label">Upcoming</div>
                    </a>
                </div>

                <div class="nav-category">Main Navigation</div>
                <a href="#" class="sidebar-link active"><i class="bi bi-columns-gap"></i> Dashboard</a>
                <a href="#" class="sidebar-link"><i class="bi bi-list-columns-reverse"></i> Lineup <span class="sidebar-badge">4</span></a>
                <a href="#" class="sidebar-link"><i class="bi bi-chat-dots"></i> Pings</a>
                <a href="#" class="sidebar-link"><i class="bi bi-bell"></i> Hey!</a>
                <a href="#" class="sidebar-link"><i class="bi bi-activity"></i> Activity</a>
                <a href="#" class="sidebar-link"><i class="bi bi-person-circle"></i> My Stuff</a>

                <div class="nav-category mt-4">System</div>
                <a href="#" class="sidebar-link"><i class="bi bi-gear"></i> Settings</a>
                <a href="#" class="sidebar-link text-danger"><i class="bi bi-box-arrow-right"></i> Logout</a>

            </div>
            <div class="pending-widget">
                <div class="fire-icon-wrapper"><i class="bi bi-fire fire-icon"></i></div>
                <h6 class="fw-bold" style="color:#0B2B6A; margin-bottom: 5px;">Pending Tasks</h6>
                <p class="small text-muted mb-3">You have 5 approvals waiting.</p>
                <button class="btn btn-sm btn-primary rounded-pill px-3">Review now</button>
            </div>
        </aside>

        <main class="main-content">
            <div class="project-context-card">
                <span class="ph-badge" id="projectBadge">Project</span>
                <div class="ph-crumb-container">
                    <a href="../project/project.html" id="breadProjectLink" class="ph-crumb-link">
                        <i class="bi bi-arrow-left-short me-1"></i> Back to project
                    </a>
                    <span class="ph-sep">/</span>
                    <a href="#" id="breadAllListLink" class="ph-crumb-link">Files</a>
                    <span class="ph-sep">/</span>
                    <span class="ph-crumb-active">New file</span>
                </div>
            </div>

            <div class="main-list-card">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                        <h4 id="listTitleDisplay" class="fw-bold mb-1">New Doc</h4>
                        <div class="text-muted small">
                            <span id="descShort"></span><span id="descFull" style="display:none;"></span>
                            <button id="readMoreBtn" class="btn btn-link btn-sm p-0 ms-1 align-baseline" style="font-size:0.8rem; display:none;" onclick="toggleDesc()">Read more</button>
                        </div>
                    </div>
                </div>

                <div class="border-top pt-3 mt-3">
                    <div class="mb-3">
                        <input type="text"
                               id="messageTitleInput"
                               class="form-control border-0 px-0"
                               placeholder="Type a title..."
                               style="font-size:2rem; font-weight:600; box-shadow:none;">
                    </div>

                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <span class="small text-uppercase text-muted fw-semibold" style="letter-spacing:0.08em;">Category</span>
                        </div>
                        <div class="d-flex flex-wrap gap-2 mb-2">
                            <button type="button" class="btn btn-sm btn-outline-secondary rounded-pill" onclick="handleQuickCategoryClick('outcome')">Outcome</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary rounded-pill" onclick="handleQuickCategoryClick('important')">Important</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary rounded-pill" onclick="handleQuickCategoryClick('reference')">Reference</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary rounded-pill" onclick="handleQuickCategoryClick('upcoming')">Upcoming</button>
                        </div>
                        <input type="text"
                               id="categoryInput"
                               class="form-control border-0 px-0"
                               placeholder="Type or customize category..."
                               style="max-width:260px; box-shadow:none;">
                    </div>

                    <div class="mb-4">
                        <div class="rich-editor" style="position:relative;">
                            <div class="rich-toolbar">
                                <button type="button" class="rich-btn" onclick="applyFormat('commentInput','bold')"><i class="bi bi-type-bold"></i></button>
                                <button type="button" class="rich-btn" onclick="applyFormat('commentInput','italic')"><i class="bi bi-type-italic"></i></button>
                                <button type="button" class="rich-btn" onclick="applyFormat('commentInput','underline')"><i class="bi bi-type-underline"></i></button>
                                <button type="button" class="rich-btn" onclick="applyFormat('commentInput','insertUnorderedList')"><i class="bi bi-list-ul"></i></button>
                                <button type="button" class="rich-btn" onclick="applyFormat('commentInput','insertOrderedList')"><i class="bi bi-list-ol"></i></button>
                                <button type="button" class="rich-btn" onclick="applyBlockquote('commentInput')"><i class="bi bi-chat-right-quote"></i></button>
                                <button type="button" class="rich-btn ms-auto" onclick="triggerCommentFileInput()"><i class="bi bi-paperclip"></i></button>
                            </div>
                            <div id="commentInput" class="rich-editor-body" contenteditable="true" data-placeholder="Write away..."></div>
                            <div id="mentionDropdown" class="bg-white border rounded shadow-sm small" style="position:absolute; z-index:1050; display:none; max-height:200px; overflow-y:auto; min-width:180px;"></div>
                        </div>
                        <div id="commentAttachmentPreview" class="small text-muted mb-2"></div>
                        <input type="file" id="comment-file-input" multiple style="display:none">
                    </div>

                    <div class="mt-4 pt-4 border-top">
                        <p class="small fw-semibold mb-2">When I post this, notify...</p>
                        <div class="mb-3">
                            <div class="form-check mb-1">
                                <input class="form-check-input" type="radio" name="notifyOption" id="notifyAll" checked>
                                <label class="form-check-label small" for="notifyAll">
                                    All people who can see this project
                                </label>
                            </div>
                            <div class="ps-4 mb-2">
                                <div class="d-flex align-items-center gap-1 flex-wrap" id="subsContainer"></div>
                            </div>
                            <div class="form-check mb-1">
                                <input class="form-check-input" type="radio" name="notifyOption" id="notifySelected">
                                <label class="form-check-label small" for="notifySelected">
                                    Only the people I select...
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="notifyOption" id="notifyNone">
                                <label class="form-check-label small" for="notifyNone">
                                    No one
                                </label>
                            </div>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="d-none">
                                <span id="subscriptionStatusText"></span>
                                <button id="subscriptionToggleButton" type="button" onclick="toggleSubscription()"></button>
                            </div>
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-outline-success rounded-pill px-4 btn-sm" id="saveDraftButton" style="border-color: #006a4e; ">
                                    Save as a draft
                                </button>
                                <button type="button" class="btn btn-dlg-green rounded-pill px-4 btn-sm" id="postMessageButton" onclick="postComment('list')">
                                    Post this Document
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
        </main>
    </div>

    <div class="modal fade" id="manageSubscribersModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-4 border-0">
                <div class="modal-header border-0 p-4 pb-0">
                    <h5 class="fw-bold">Manage Subscribers</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="input-group mb-3 bg-light rounded-pill px-2">
                        <span class="input-group-text bg-transparent border-0"><i class="bi bi-search"></i></span>
                        <input type="text" class="form-control bg-transparent border-0 shadow-none" placeholder="Search people..." oninput="renderManageSubscriberList(this.value)">
                    </div>
                    <div id="subscriberListScroll" style="max-height: 400px; overflow-y: auto;"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import {
            getFirestore,
            doc,
            collection,
            getDoc,
            getDocs,
            query,
            where,
            orderBy,
            addDoc,
            updateDoc,
            deleteDoc,
            onSnapshot,
            serverTimestamp
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import {
            getStorage,
            ref as storageRef,
            uploadBytes,
            getDownloadURL
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDyzzEYbJkkl-N8snrQf14qvj8De4YliV0",
            authDomain: "pre-dialogika.firebaseapp.com",
            projectId: "pre-dialogika",
            storageBucket: "pre-dialogika.firebasestorage.app",
            messagingSenderId: "343771410480",
            appId: "1:343771410480:web:32881c9868522090237df5"
        };

        window.handleQuickCategoryClick = function (value) {
            if (!categoryInput) return;
            const formatted = value.charAt(0).toUpperCase() + value.slice(1);
            categoryInput.value = formatted;
            categoryInput.focus();
            categoryInput.select();
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        const urlParams = new URLSearchParams(window.location.search);
        let projectId = urlParams.get('projectId') || urlParams.get('id');
        const folderId = urlParams.get('folderId') || "";
        const fileId = urlParams.get('fileId') || "";
        if (!projectId) {
            try {
                const cached = localStorage.getItem('currentProjectId');
                if (cached) projectId = cached;
            } catch (e) {}
        }
        if (!projectId && document.referrer) {
            try {
                const refUrl = new URL(document.referrer);
                const refParams = refUrl.searchParams;
                projectId = refParams.get('projectId') || refParams.get('id');
            } catch (e) {}
        }
        if (projectId) {
            try {
                localStorage.setItem('currentProjectId', projectId);
            } catch (e) {}
        }

        const breadProjectLink = document.getElementById('breadProjectLink');
        const breadAllListLink = document.getElementById('breadAllListLink');
        const badgeEl = document.getElementById('projectBadge');
        const subscriptionStatusText = document.getElementById('subscriptionStatusText');
        const subscriptionToggleButton = document.getElementById('subscriptionToggleButton');
        const commentAvatar = document.getElementById('commentAvatar');
        const manageSubsScroll = document.getElementById('subscriberListScroll');
        const subsContainer = document.getElementById('subsContainer');
        const categoryInput = document.getElementById('categoryInput');

        let currentUser = null;
        let currentSubscribers = [];
        let projectMembers = [];
        let manageSubscriberSearchQuery = "";
        let pendingCommentFiles = [];
        let replyTargetCommentId = null;
        let mentionRange = null;
        let mentionActive = false;
        let mentionQuery = "";
        let mentionDropdownElement = null;
        let existingFileData = null;

        function getDirectPhotoUrl(url, uid) {
            if (!url) return `https://i.pravatar.cc/150?u=${uid || "user"}`;
            if (url.includes('drive.google.com')) {
                let id = "";
                if (url.includes('id=')) {
                    id = url.split('id=')[1].split('&')[0];
                } else if (url.includes('/d/')) {
                    id = url.split('/d/')[1].split('/')[0];
                }
                if (id) return `https://lh3.googleusercontent.com/u/0/d/${id}`;
            }
            return url;
        }

        function getFilesCollectionRef() {
            if (!projectId) return null;
            return collection(db, "projects", projectId, "files");
        }

        function getFileDraftsCollectionRef() {
            if (!projectId) return null;
            return collection(db, "projects", projectId, "file_drafts");
        }

        function getFileSubscribersCollectionRef() {
            if (!projectId) return null;
            return collection(db, "projects", projectId, "file_subscribers");
        }

        function getFileAttachmentPath(fileName) {
            return `files/${projectId}/${Date.now()}_${fileName}`;
        }

        function getCurrentUserUid() {
            try {
                if (currentUser && currentUser.uid) return currentUser.uid;
                const localData = JSON.parse(localStorage.getItem('userData') || 'null');
                if (localData && localData.uid) return localData.uid;
            } catch (e) {}
            return "";
        }

        async function loadProjectHeader() {
            try {
                const snap = await getDoc(doc(db, "projects", projectId));
                if (!snap.exists()) return;
                const data = snap.data();
                if (breadProjectLink) breadProjectLink.innerText = data.name || "Untitled Project";
                if (badgeEl) badgeEl.innerText = data.department || "Project";
                await loadProjectMembers(data.members || []);
                renderManageSubscriberList(manageSubscriberSearchQuery);
            } catch (e) {
                console.error("Failed to load project header", e);
            }
        }

        async function loadExistingFile() {
            if (!projectId || !fileId) return;
            try {
                const ref = doc(db, "projects", projectId, "files", fileId);
                const snap = await getDoc(ref);
                if (!snap.exists()) return;
                const data = snap.data() || {};
                existingFileData = data;
                const titleInput = document.getElementById('messageTitleInput');
                const editor = document.getElementById('commentInput');
                if (titleInput) {
                    titleInput.value = data.title || "";
                }
                if (editor) {
                    editor.innerHTML = data.text || "";
                }
                if (categoryInput) {
                    categoryInput.value = data.category || "";
                }
            } catch (e) {
                console.error("Failed to load file for edit", e);
            }
        }

        async function loadProjectMembers(memberUids) {
            projectMembers = [];
            try {
                const snap = await getDocs(collection(db, "users"));
                const allUsers = [];
                snap.forEach(docSnap => {
                    const u = docSnap.data() || {};
                    allUsers.push({
                        uid: docSnap.id,
                        name: u.name || u.email || "Unknown",
                        email: u.email || "",
                        photo: getDirectPhotoUrl(u.photo || "", docSnap.id)
                    });
                });
                const currentUid = getCurrentUserUid();
                allUsers.sort((a, b) => {
                    if (a.uid === currentUid) return -1;
                    if (b.uid === currentUid) return 1;
                    return a.name.localeCompare(b.name);
                });
                projectMembers = allUsers;
            } catch (e) {
                console.error("Failed to load project members", e);
                if (Array.isArray(memberUids) && memberUids.length > 0) {
                    try {
                        const promises = memberUids.map(async (uid) => {
                            const snap = await getDoc(doc(db, "users", uid));
                            if (snap.exists()) {
                                const u = snap.data();
                                return {
                                    uid,
                                    name: u.name || u.email || "Unknown",
                                    email: u.email || "",
                                    photo: getDirectPhotoUrl(u.photo || "", uid)
                                };
                            }
                            return null;
                        });
                        const results = await Promise.all(promises);
                        projectMembers = results.filter(Boolean);
                    } catch (err2) {
                        console.error("Fallback failed when loading project members", err2);
                    }
                }
            }
        }

        function renderSubscribers(subs) {
            if (!subsContainer) return;
            subsContainer.innerHTML = '';
            if (!subs || subs.length === 0) {
                const btnAddHtml = `<button class="btn btn-light border rounded-pill px-3 py-1 btn-sm text-muted small" type="button" data-bs-toggle="modal" data-bs-target="#manageSubscribersModal">Add/remove people...</button>`;
                subsContainer.insertAdjacentHTML('beforeend', btnAddHtml);
                return;
            }
            subs.forEach(s => {
                const userId = s.user_id || s.userId || '';
                const userName = s.user_name || s.userName || userId || 'User';
                const initialsSource = s.user_initials || userName || userId || '';
                const initials = initialsSource
                    ? initialsSource.trim().split(' ').map(part => part[0]).join('').substring(0, 2).toUpperCase()
                    : 'U';
                const photo = s.user_photo || "";
                const avatar = photo
                    ? `<div class="rounded-circle d-flex align-items-center justify-content-center fw-bold overflow-hidden" style="width:30px; height:30px; font-size:0.7rem;" title="${userName}">
                           <img src="${photo}" alt="${userName}" style="width:100%; height:100%; object-fit:cover;">
                       </div>`
                    : `<div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center fw-bold" 
                         style="width:30px; height:30px; font-size:0.7rem;" title="${userName}">${initials}</div>`;
                const html = avatar;
                subsContainer.insertAdjacentHTML('beforeend', html);
            });
            const btnAddHtml = `<button class="btn btn-light border rounded-pill px-3 py-1 btn-sm text-muted small" type="button" data-bs-toggle="modal" data-bs-target="#manageSubscribersModal">Add/remove people...</button>`;
            subsContainer.insertAdjacentHTML('beforeend', btnAddHtml);
        }

        function updateNotifyPreview() {
            if (!subsContainer) return;
            const notifyNoneRadio = document.getElementById('notifyNone');
            if (notifyNoneRadio && notifyNoneRadio.checked) {
                subsContainer.innerHTML = '<span class="small text-muted">No one will be notified.</span>';
                return;
            }
            renderSubscribers(currentSubscribers);
        }

        function openManageSubscribersModal() {
            const modalEl = document.getElementById('manageSubscribersModal');
            if (!modalEl) return;
            const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
            modal.show();
        }

        function listenSubscribers() {
            try {
                const ref = getFileSubscribersCollectionRef();
                if (!ref) return;
                onSnapshot(ref, (snapshot) => {
                    const subs = [];
                    snapshot.forEach(docSnap => subs.push({ id: docSnap.id, ...docSnap.data() }));
                    currentSubscribers = subs;
                    updateNotifyPreview();
                    updateSubscriptionUI();
                }, (error) => {
                    console.error("Failed to listen subscribers", error);
                });
            } catch (e) {
                console.error("Failed to start subscribers listener", e);
            }
        }

        function updateSubscriptionUI() {
            if (!subscriptionStatusText || !subscriptionToggleButton) return;
            if (!currentUser) {
                subscriptionStatusText.innerText = "You’re not subscribed";
                subscriptionToggleButton.innerText = "Subscribe me";
                subscriptionToggleButton.disabled = true;
                return;
            }
            const uid = currentUser.uid;
            const isSubscribed = currentSubscribers.some(s => (s.user_id || s.userId) === uid);
            subscriptionStatusText.innerText = isSubscribed ? "You’re subscribed" : "You’re not subscribed";
            subscriptionToggleButton.innerText = isSubscribed ? "Unsubscribe me" : "Subscribe me";
            subscriptionToggleButton.disabled = false;
        }

        window.toggleSubscription = async function () {
            if (!currentUser) {
                alert("Harus login terlebih dahulu.");
                return;
            }
            const uid = currentUser.uid;
            try {
                if (!projectId) throw new Error("Project ID tidak valid.");
                const subsRef = collection(db, "projects", projectId, "file_subscribers");
                const existingAll = currentSubscribers.filter(s => (s.user_id || s.userId) === uid && s.id);
                if (existingAll.length > 0) {
                    await Promise.all(
                        existingAll.map(s => deleteDoc(doc(db, "projects", projectId, "file_subscribers", s.id)))
                    );
                } else {
                    const localData = JSON.parse(localStorage.getItem('userData') || 'null');
                    const userName = localData && localData.name ? localData.name : (currentUser.email || 'User');
                    const rawPhoto = localData && localData.photo ? localData.photo : (currentUser && currentUser.photoURL ? currentUser.photoURL : "");
                    const photoUrl = getDirectPhotoUrl(rawPhoto || "", uid || "");
                    const initialsSource = userName || uid || '';
                    const initials = initialsSource
                        ? initialsSource.trim().split(' ').map(part => part[0]).join('').substring(0, 2).toUpperCase()
                        : 'US';
                    await addDoc(subsRef, {
                        user_id: uid,
                        user_name: userName,
                        user_initials: initials,
                        user_photo: photoUrl,
                        created_at: serverTimestamp()
                    });
                }
            } catch (e) {
                console.error("Failed to toggle subscription", e);
                alert("Gagal mengubah status subscribe: " + e.message);
            }
        };

        window.renderManageSubscriberList = function (queryText) {
            if (!manageSubsScroll) return;
            manageSubscriberSearchQuery = (queryText || "").trim().toLowerCase();
            manageSubsScroll.innerHTML = '';

            if (!projectMembers || projectMembers.length === 0) {
                manageSubsScroll.innerHTML = '<p class="text-muted small mb-0">No project members available.</p>';
                return;
            }

            const filtered = projectMembers.filter(m => {
                if (!manageSubscriberSearchQuery) return true;
                const haystack = `${m.name || ""} ${m.email || ""}`.toLowerCase();
                return haystack.includes(manageSubscriberSearchQuery);
            });

            if (filtered.length === 0) {
                manageSubsScroll.innerHTML = '<p class="text-muted small mb-0">No people match your search.</p>';
                return;
            }

            filtered.forEach(m => {
                const isSubscribed = currentSubscribers.some(s => (s.user_id || s.userId) === m.uid);
                const btnClass = isSubscribed ? 'btn-outline-danger' : 'btn-outline-primary';
                const btnText = isSubscribed ? 'Unsubscribe' : 'Subscribe';
                const rowHtml = `
                    <div class="d-flex align-items-center justify-content-between py-2 border-bottom">
                        <div class="d-flex align-items-center gap-2">
                            <div class="rounded-circle overflow-hidden" style="width:32px; height:32px;">
                                <img src="${m.photo}" alt="${m.name}" style="width:100%; height:100%; object-fit:cover;">
                            </div>
                            <div>
                                <div class="small fw-semibold">${m.name}</div>
                                <div class="small text-muted">${m.email || ''}</div>
                            </div>
                        </div>
                        <button class="btn btn-sm ${btnClass} rounded-pill px-3" type="button" onclick="toggleSubscriberForUser('${m.uid}')">
                            ${btnText}
                        </button>
                    </div>
                `;
                manageSubsScroll.insertAdjacentHTML('beforeend', rowHtml);
            });
        };

        window.toggleSubscriberForUser = async function (uid) {
            if (!uid) return;
            try {
                if (!projectId) throw new Error("Project ID tidak valid.");
                const subsRef = collection(db, "projects", projectId, "file_subscribers");
                const existingAll = currentSubscribers.filter(s => (s.user_id || s.userId) === uid && s.id);
                if (existingAll.length > 0) {
                    await Promise.all(
                        existingAll.map(s => deleteDoc(doc(db, "projects", projectId, "file_subscribers", s.id)))
                    );
                } else {
                    const target = projectMembers.find(m => m.uid === uid);
                    const userName = target && target.name ? target.name : 'User';
                    const rawPhoto = target && target.photo ? target.photo : "";
                    const photoUrl = getDirectPhotoUrl(rawPhoto || "", uid || "");
                    const initialsSource = userName || uid || '';
                    const initials = initialsSource
                        ? initialsSource.trim().split(' ').map(part => part[0]).join('').substring(0, 2).toUpperCase()
                        : 'US';
                    await addDoc(subsRef, {
                        user_id: uid,
                        user_name: userName,
                        user_initials: initials,
                        user_photo: photoUrl,
                        created_at: serverTimestamp()
                    });
                }
            } catch (e) {
                console.error("Failed to toggle subscriber for user", e);
                alert("Gagal mengubah subscriber: " + e.message);
            }
        };

        function stopMention() {
            mentionActive = false;
            mentionQuery = "";
            mentionRange = null;
            if (mentionDropdownElement) {
                mentionDropdownElement.style.display = "none";
                mentionDropdownElement.innerHTML = "";
            }
        }

        function handleCommentKeyDown(e) {
            if (mentionActive && e.key === "Escape") {
                e.preventDefault();
                stopMention();
            }
        }

        function handleCommentKeyUp(e) {
            const editor = e.currentTarget;
            const key = e.key;
            if (key === "@") {
                const sel = window.getSelection();
                if (!sel || !sel.rangeCount) return;
                const range = sel.getRangeAt(0);
                if (!editor.contains(range.startContainer)) return;
                const r = range.cloneRange();
                const startOffset = Math.max(0, r.startOffset - 1);
                r.setStart(r.startContainer, startOffset);
                mentionRange = r;
                mentionActive = true;
                mentionQuery = "";
                updateMentionDropdown(editor);
                return;
            }

            if (!mentionActive) return;

            if (key === "Escape" || key === " " || key === "Enter" || key === "Tab") {
                stopMention();
                return;
            }

            const sel = window.getSelection();
            if (!sel || !sel.rangeCount) {
                stopMention();
                return;
            }
            const range = sel.getRangeAt(0);
            if (!editor.contains(range.startContainer) || !mentionRange) {
                stopMention();
                return;
            }
            if (mentionRange.startContainer !== range.startContainer) {
                stopMention();
                return;
            }
            mentionRange.setEnd(range.startContainer, range.startOffset);
            const node = mentionRange.startContainer;
            const text = node.textContent || "";
            const start = mentionRange.startOffset;
            const end = mentionRange.endOffset;
            if (end <= start || start < 0 || end > text.length) {
                stopMention();
                return;
            }
            if (text[start] !== "@") {
                stopMention();
                return;
            }
            mentionQuery = text.substring(start + 1, end);
            updateMentionDropdown(editor);
        }

        function updateMentionDropdown(editor) {
            if (!mentionDropdownElement) return;
            if (!mentionActive) {
                mentionDropdownElement.style.display = "none";
                mentionDropdownElement.innerHTML = "";
                return;
            }
            const query = (mentionQuery || "").toLowerCase();
            let candidates = Array.isArray(projectMembers) ? projectMembers.slice() : [];
            if (query) {
                candidates = candidates.filter(m => {
                    const name = (m.name || "").toLowerCase();
                    const email = (m.email || "").toLowerCase();
                    return name.includes(query) || email.includes(query);
                });
            }
            if (!candidates.length) {
                mentionDropdownElement.style.display = "none";
                mentionDropdownElement.innerHTML = "";
                return;
            }
            const itemsHtml = candidates.map(m => {
                const name = m.name || m.email || m.uid;
                const email = m.email ? ` <span class="text-muted small">(${m.email})</span>` : "";
                return `<div class="px-2 py-1 mention-item" style="cursor:pointer;" onclick="selectMention('${m.uid}')">${name}${email}</div>`;
            }).join("");
            mentionDropdownElement.innerHTML = itemsHtml;
            const sel = window.getSelection();
            if (!sel || !sel.rangeCount) {
                mentionDropdownElement.style.display = "none";
                return;
            }
            const range = sel.getRangeAt(0).cloneRange();
            const rect = range.getBoundingClientRect();
            const container = editor.closest('.rich-editor') || editor.parentElement || editor;
            const containerRect = container.getBoundingClientRect();
            const left = rect.left - containerRect.left;
            const top = rect.bottom - containerRect.top + 4;
            mentionDropdownElement.style.left = `${left}px`;
            mentionDropdownElement.style.top = `${top}px`;
            mentionDropdownElement.style.display = "block";
        }

        window.selectMention = function (uid) {
            const editor = document.getElementById('commentInput');
            if (!editor || !mentionRange) {
                stopMention();
                return;
            }
            const member = (projectMembers || []).find(m => m.uid === uid);
            if (!member) {
                stopMention();
                return;
            }
            const name = member.name || member.email || uid;
            const span = document.createElement('span');
            span.className = 'comment-mention';
            span.setAttribute('data-mention-uid', uid);
            span.setAttribute('data-mention-name', name);
            span.textContent = '@' + name;
            const space = document.createTextNode('\u00A0');
            const fragment = document.createDocumentFragment();
            fragment.appendChild(span);
            fragment.appendChild(space);
            mentionRange.deleteContents();
            mentionRange.insertNode(fragment);
            const sel = window.getSelection();
            if (sel) {
                sel.removeAllRanges();
                const afterRange = document.createRange();
                afterRange.setStartAfter(space);
                afterRange.setEndAfter(space);
                sel.addRange(afterRange);
            }
            stopMention();
        };

        window.triggerCommentFileInput = () => {
            const input = document.getElementById('comment-file-input');
            if (input) input.click();
        };

        window.applyFormat = (editorId, command) => {
            const editor = document.getElementById(editorId);
            if (!editor) return;
            editor.focus();
            document.execCommand(command, false, null);
        };

        window.applyBlockquote = (editorId) => {
            const editor = document.getElementById(editorId);
            if (!editor) return;
            editor.focus();
            document.execCommand('formatBlock', false, 'blockquote');
        };

        window.saveDraftMessage = async function () {
            const input = document.getElementById('commentInput');
            if (!input) return;
            const plainText = input.innerText.replace(/\u200B/g, '').trim();
            const htmlText = input.innerHTML.trim();
            const titleInput = document.getElementById('messageTitleInput');
            const title = titleInput ? (titleInput.value || '').trim() : '';
            if (!plainText && !title) {
                alert("Tidak ada konten untuk disimpan sebagai draft.");
                return;
            }

            const btn = document.getElementById('saveDraftButton');
            let originalBtnText = '';
            if (btn) {
                originalBtnText = btn.innerText;
                btn.innerText = 'Saving...';
                btn.disabled = true;
            }

            try {
                const localData = JSON.parse(localStorage.getItem('userData') || 'null');
                const userName = localData && localData.name ? localData.name : (currentUser ? currentUser.email : 'User');
                const uid = currentUser ? currentUser.uid : (localData && localData.uid ? localData.uid : '');
                const rawPhoto = localData && localData.photo ? localData.photo : (currentUser && currentUser.photoURL ? currentUser.photoURL : "");
                const photoUrl = getDirectPhotoUrl(rawPhoto || "", uid || "");
                const initialsSource = userName || uid || '';
                const initials = initialsSource
                    ? initialsSource.trim().split(' ').map(part => part[0]).join('').substring(0, 2).toUpperCase()
                    : 'US';
                const attachments = [];
                if (pendingCommentFiles && pendingCommentFiles.length > 0) {
                    for (const file of pendingCommentFiles) {
                        try {
                            const path = getFileAttachmentPath(file.name);
                            const ref = storageRef(storage, path);
                            await uploadBytes(ref, file);
                            const url = await getDownloadURL(ref);
                            attachments.push({ name: file.name, url });
                        } catch (e) {
                            console.error("Failed to upload attachment for draft", e);
                        }
                    }
                }
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = htmlText;
                const mentionNodes = tempDiv.querySelectorAll('[data-mention-uid]');
                const mentionedIds = Array.from(mentionNodes).map(node => node.getAttribute('data-mention-uid')).filter(Boolean);
                const mentionedUnique = Array.from(new Set(mentionedIds));
                const draftsRef = getFileDraftsCollectionRef();
                if (!draftsRef) throw new Error("Project ID tidak valid.");
                const category = categoryInput ? (categoryInput.value || "").trim() : "";
                const payload = {
                    title: title,
                    text: htmlText,
                    text_plain: plainText,
                    attachments: attachments,
                    user_id: uid,
                    user_name: userName,
                    user_initials: initials,
                    user_photo: photoUrl,
                    parent_comment_id: replyTargetCommentId || null,
                    mentioned_user_ids: mentionedUnique,
                    category: category || null,
                    parent_id: folderId || null,
                    status: "draft",
                    created_at: serverTimestamp(),
                    updated_at: serverTimestamp()
                };
                await addDoc(draftsRef, payload);
                if (projectId) {
                    let targetUrl = `files.html?id=${encodeURIComponent(projectId)}`;
                    if (folderId) {
                        targetUrl = `files-folder.html?projectId=${encodeURIComponent(projectId)}&folderId=${encodeURIComponent(folderId)}`;
                    }
                    window.location.href = targetUrl;
                }
            } catch (e) {
                console.error("Failed to save draft", e);
                alert("Gagal menyimpan draft: " + e.message);
            } finally {
                if (btn) {
                    btn.innerText = originalBtnText || 'Save as a draft';
                    btn.disabled = false;
                }
            }
        };

        window.postComment = async function () {
            const input = document.getElementById('commentInput');
            if (!input) return;
            const plainText = input.innerText.replace(/\u200B/g, '').trim();
            const htmlText = input.innerHTML.trim();
            if (!plainText) return;

            const titleInput = document.getElementById('messageTitleInput');
            const title = titleInput ? (titleInput.value || '').trim() : '';

            const btn = event && event.target ? event.target : null;
            let originalBtnText = '';
            if (btn) {
                originalBtnText = btn.innerText;
                btn.innerText = 'Posting...';
                btn.disabled = true;
            }

            try {
                const localData = JSON.parse(localStorage.getItem('userData') || 'null');
                const userName = localData && localData.name ? localData.name : (currentUser ? currentUser.email : 'User');
                const uid = currentUser ? currentUser.uid : (localData && localData.uid ? localData.uid : '');
                const rawPhoto = localData && localData.photo ? localData.photo : (currentUser && currentUser.photoURL ? currentUser.photoURL : "");
                const photoUrl = getDirectPhotoUrl(rawPhoto || "", uid || "");
                const initialsSource = userName || uid || '';
                const initials = initialsSource
                    ? initialsSource.trim().split(' ').map(part => part[0]).join('').substring(0, 2).toUpperCase()
                    : 'US';
                const attachments = [];
                if (pendingCommentFiles && pendingCommentFiles.length > 0) {
                    for (const file of pendingCommentFiles) {
                        try {
                            const path = getFileAttachmentPath(file.name);
                            const ref = storageRef(storage, path);
                            await uploadBytes(ref, file);
                            const url = await getDownloadURL(ref);
                            attachments.push({ name: file.name, url });
                        } catch (e) {
                            console.error("Failed to upload attachment", e);
                        }
                    }
                }
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = htmlText;
                const mentionNodes = tempDiv.querySelectorAll('[data-mention-uid]');
                const mentionedIds = Array.from(mentionNodes).map(node => node.getAttribute('data-mention-uid')).filter(Boolean);
                const mentionedUnique = Array.from(new Set(mentionedIds));
                const filesRef = getFilesCollectionRef();
                if (!filesRef) throw new Error("Project ID tidak valid.");
                const category = categoryInput ? (categoryInput.value || "").trim() : "";
                if (fileId) {
                    const ref = doc(db, "projects", projectId, "files", fileId);
                    const baseData = existingFileData || {};
                    const existingAttachments = Array.isArray(baseData.attachments) ? baseData.attachments : [];
                    const mergedAttachments = existingAttachments.concat(attachments);
                    await updateDoc(ref, {
                        title: title,
                        text: htmlText,
                        text_plain: plainText,
                        attachments: mergedAttachments,
                        category: category || null,
                        mentioned_user_ids: mentionedUnique,
                        updated_at: serverTimestamp()
                    });
                } else {
                    await addDoc(filesRef, {
                        title: title,
                        text: htmlText,
                        text_plain: plainText,
                        attachments: attachments,
                        user_id: uid,
                        user_name: userName,
                        user_initials: initials,
                        user_photo: photoUrl,
                        category: category || null,
                        parent_id: folderId || null,
                        created_at: serverTimestamp(),
                        parent_comment_id: replyTargetCommentId || null,
                        mentioned_user_ids: mentionedUnique,
                        file_type: "doc"
                    });
                }

                input.innerHTML = '';
                pendingCommentFiles = [];
                const attachmentPreview = document.getElementById('commentAttachmentPreview');
                if (attachmentPreview) attachmentPreview.innerText = "";
                replyTargetCommentId = null;

                if (projectId) {
                    let targetUrl = `files.html?id=${encodeURIComponent(projectId)}`;
                    if (folderId) {
                        targetUrl = `files-folder.html?projectId=${encodeURIComponent(projectId)}&folderId=${encodeURIComponent(folderId)}`;
                    }
                    window.location.href = targetUrl;
                }
            } catch (e) {
                console.error("Failed to post comment", e);
                alert("Gagal mengirim file: " + e.message);
            } finally {
                if (btn) {
                    btn.innerText = originalBtnText || 'Post this message';
                    btn.disabled = false;
                }
            }
        };

        document.addEventListener("DOMContentLoaded", () => {
            if (!projectId) {
                alert("Error: Project ID tidak ditemukan.");
                return;
            }

            breadProjectLink.href = `../project/project.html?id=${projectId}`;
            breadAllListLink.addEventListener('click', (e) => {
                e.preventDefault();
                if (document.referrer) {
                    window.history.back();
                } else {
                    let targetUrl = `files.html?id=${projectId}`;
                    if (folderId) {
                        targetUrl = `files-folder.html?projectId=${encodeURIComponent(projectId)}&folderId=${encodeURIComponent(folderId)}`;
                    }
                    window.location.href = targetUrl;
                }
            });

            const commentInput = document.getElementById('commentInput');
            const commentFileInput = document.getElementById('comment-file-input');
            const attachmentPreview = document.getElementById('commentAttachmentPreview');
            const mentionDropdown = document.getElementById('mentionDropdown');
            const saveDraftButton = document.getElementById('saveDraftButton');
            const notifyAllRadio = document.getElementById('notifyAll');
            const notifySelectedRadio = document.getElementById('notifySelected');
            const notifyNoneRadio = document.getElementById('notifyNone');

            if (commentFileInput && attachmentPreview) {
                commentFileInput.addEventListener('change', () => {
                    const files = Array.from(commentFileInput.files || []);
                    pendingCommentFiles = files;
                    if (!files.length) {
                        attachmentPreview.innerText = "";
                        return;
                    }
                    const names = files.map(f => f.name).join(', ');
                    attachmentPreview.innerText = `Attached: ${names}`;
                });
            }

            if (commentInput && mentionDropdown) {
                mentionDropdownElement = mentionDropdown;
                commentInput.addEventListener('keydown', handleCommentKeyDown);
                commentInput.addEventListener('keyup', handleCommentKeyUp);
                commentInput.addEventListener('blur', () => {
                    setTimeout(() => {
                        if (!mentionActive && mentionDropdownElement) {
                            mentionDropdownElement.style.display = "none";
                            mentionDropdownElement.innerHTML = "";
                        }
                    }, 150);
                });
            }

            if (notifySelectedRadio) {
                notifySelectedRadio.addEventListener('change', () => {
                    if (notifySelectedRadio.checked) {
                        openManageSubscribersModal();
                    }
                    updateNotifyPreview();
                });
            }
            if (notifyAllRadio) {
                notifyAllRadio.addEventListener('change', updateNotifyPreview);
            }
            if (notifyNoneRadio) {
                notifyNoneRadio.addEventListener('change', updateNotifyPreview);
            }

            if (saveDraftButton) {
                saveDraftButton.addEventListener('click', saveDraftMessage);
            }

            try {
                const storedUser = JSON.parse(localStorage.getItem('userData') || 'null');
                if (storedUser && commentAvatar) {
                    const photoUrl = getDirectPhotoUrl(storedUser.photo || storedUser.Photo || "", storedUser.uid || storedUser.Uid || "");
                    commentAvatar.src = photoUrl;
                }
            } catch (e) {}

            loadProjectHeader();
            listenSubscribers();

            onAuthStateChanged(auth, (user) => {
                currentUser = user || null;
                try {
                    const nameSpan = document.getElementById('user-name-display');
                    const photoImg = document.getElementById('user-photo-display');
                    const roleSpan = document.getElementById('user-role-display');
                    if (nameSpan || photoImg || roleSpan) {
                        const storedUser = JSON.parse(localStorage.getItem('userData') || 'null');
                        const userName = storedUser && storedUser.name ? storedUser.name : (user ? user.email : 'User');
                        const rawPhoto = storedUser && (storedUser.photo || storedUser.Photo)
                            ? (storedUser.photo || storedUser.Photo)
                            : (user && user.photoURL ? user.photoURL : '');
                        const position = storedUser && (storedUser.position || (storedUser.employment && storedUser.employment.position))
                            ? (storedUser.position || (storedUser.employment && storedUser.employment.position))
                            : 'Member';
                        const uid = storedUser && (storedUser.uid || storedUser.Uid)
                            ? (storedUser.uid || storedUser.Uid)
                            : (user && user.uid ? user.uid : '');
                        if (nameSpan) nameSpan.innerText = userName || 'User';
                        if (roleSpan) roleSpan.innerText = position || 'Member';
                        if (photoImg) {
                            const photoUrl = getDirectPhotoUrl(rawPhoto || "", uid || "");
                            photoImg.src = photoUrl;
                        }
                    }
                } catch (e) {}
                updateSubscriptionUI();
            });

            if (fileId) {
                loadExistingFile();
            }
        });
    </script>
</body>
</html>
