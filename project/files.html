<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>List - Dialogika</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="../assets/css/style.css" rel="stylesheet" />

    <style>
        .todo-row {
            position: relative;
            display: flex;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid #f1f5f9 !important;
            transition: 0.2s;
        }
        .todo-row:hover { background-color: #f8fafc; }
        .task-row-done .task-text-content { text-decoration: line-through; color: #94a3b8; }
        .new-tab-hint {
            opacity: 0;
            font-size: 0.7rem;
            color: #0B2B6A;
            font-weight: 700;
            margin-left: 10px;
            transition: 0.2s;
            text-transform: uppercase;
            cursor: pointer;
        }
        .todo-row:hover .new-tab-hint { opacity: 1; }
        .drag-handle-task { color: #cbd5e1; margin-left: 8px; cursor: grab; }

        .rich-editor {
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            overflow: hidden;
            background: #f9fafb;
        }
        .rich-toolbar {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 6px 10px;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
        }
        .rich-btn {
            border: none;
            background: transparent;
            padding: 4px 6px;
            border-radius: 6px;
            color: #6b7280;
            font-size: 0.9rem;
        }
        .rich-btn:hover {
            background: #e5e7eb;
            color: #111827;
        }
        .rich-editor-body {
            min-height: 90px;
            padding: 10px 12px;
            background: #ffffff;
            outline: none;
        }
        .rich-editor-body[contenteditable="true"]:empty:before {
            content: attr(data-placeholder);
            color: #9ca3af;
        }
        .subtask-indent { margin-left: 40px; border-left: 2px solid #e2e8f0; }

        .search-bar-list input,
        .search-btn,
        .search-btn:before,
        .search-btn:after {
            transition: all 0.25s ease-out;
        }
        .search-bar-list {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0.25rem 0;
            max-width: 100%;
        }
        .search-bar-list input,
        .search-btn {
            width: 3em;
            height: 3em;
        }
        .search-bar-list input:invalid:not(:focus),
        .search-btn {
            cursor: pointer;
        }
        .search-bar-list input:focus,
        .search-bar-list input:valid {
            width: 100%;
        }
        .search-bar-list input:focus,
        .search-bar-list input:not(:focus) + .search-btn:focus {
            outline: transparent;
        }
        .search-bar-list input {
            background: transparent;
            border-radius: 1.5em;
            box-shadow: 0 0 0 0.4em #cbd5e1 inset;
            padding: 0.75em;
            transform: translate(0.5em, 0.5em) scale(0.5);
            transform-origin: 100% 0;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            border: none;
        }
        .search-bar-list input:focus,
        .search-bar-list input:valid {
            background: #ffffff;
            border-radius: 0.375em 0 0 0.375em;
            box-shadow: 0 0 0 0.1em #d9d9d9 inset;
            transform: scale(1);
        }
        .search-btn {
            background: #cbd5e1;
            border-radius: 0 0.75em 0.75em 0 / 0 1.5em 1.5em 0;
            padding: 0.75em;
            position: relative;
            transform: translate(0.25em, 0.25em) rotate(45deg) scale(0.25, 0.125);
            transform-origin: 0 50%;
            border: none;
        }
        .search-btn:before,
        .search-btn:after {
            content: "";
            display: block;
            opacity: 0;
            position: absolute;
        }
        .search-btn:before {
            border-radius: 50%;
            box-shadow: 0 0 0 0.2em #f1f1f1 inset;
            top: 0.75em;
            left: 0.75em;
            width: 1.2em;
            height: 1.2em;
        }
        .search-btn:after {
            background: #f1f1f1;
            border-radius: 0 0.25em 0.25em 0;
            top: 51%;
            left: 51%;
            width: 0.75em;
            height: 0.25em;
            transform: translate(0.2em, 0) rotate(45deg);
            transform-origin: 0 50%;
        }
        .search-btn span {
            display: inline-block;
            overflow: hidden;
            width: 1px;
            height: 1px;
        }
        .search-bar-list input:focus + .search-btn,
        .search-bar-list input:valid + .search-btn {
            background: #0B2B6A;
            border-radius: 0 0.375em 0.375em 0;
            transform: scale(1);
        }
        .search-bar-list input:focus + .search-btn:before,
        .search-bar-list input:focus + .search-btn:after,
        .search-bar-list input:valid + .search-btn:before,
        .search-bar-list input:valid + .search-btn:after {
            opacity: 1;
        }
        .search-bar-list input:focus + .search-btn:hover,
        .search-bar-list input:valid + .search-btn:hover,
        .search-bar-list input:valid:not(:focus) + .search-btn:focus {
            background: #0B2B6A;
        }
        .search-bar-list input:focus + .search-btn:active,
        .search-bar-list input:valid + .search-btn:active {
            transform: translateY(1px);
        }

        .project-context-card {
            max-width: 800px; width: 90%; background: white; color: #1f2937;
            margin: 20px auto -20px auto; padding: 15px 25px 35px 25px;
            border-radius: 16px 16px 0 0; position: relative; z-index: 1;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.05);
        }
        .ph-badge {
            background: #FDE047; color: #854D0E; font-size: 0.7rem; font-weight: 800;
            padding: 4px 8px; border-radius: 4px; text-transform: uppercase;
            position: absolute; left: 30px; top: 38%; transform: translateY(-50%);
        }
        .ph-crumb-container {
            display: flex; align-items: center; gap: 12px;
            background: linear-gradient(to bottom, #0f61a8 5%, #0b2b6a 100%); padding: 8px 20px;
            border-radius: 50px; font-size: 0.95rem; color: white;
        }
        .ph-crumb-link { text-decoration: none; color: #d1d5db; font-weight: 500; transition: 0.2s; }
        .ph-crumb-link:hover { color: white; }
        .ph-crumb-active { color: white; font-weight: 700; border-bottom: 2px solid #FDE047; padding-bottom: 2px; }
        .ph-sep { font-size: 0.8rem; color: white; }

        .main-list-card {
            max-width: 1000px;
            width: 100%;
            margin: 0 auto 50px auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 40px -5px rgba(0, 0, 0, 0.3);
            padding: 50px 60px;
            position: relative;
            z-index: 2;
            border: 0;
        }
        .task-create-panel {
            background: #fff;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 25px;
            margin-top: 15px;
            display: none;
        }
        .task-title-large {
            font-size: 1.5rem;
            font-weight: 700;
            border: none;
            outline: none;
            width: 100%;
            margin-bottom: 15px;
        }

        .status-badge-main {
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            color: white;
        }
        .status-drag-container {
            min-height: 50px;
            background: #f9fafb;
            border-radius: 8px;
            padding: 10px;
        }

        .meta-grid-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px 30px;
        }
        .meta-field-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
        }
        .meta-label-group {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
        }
        .meta-label-text {
            font-size: 0.8rem;
            color: #9ca3af;
        }
        .meta-value {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 6px;
            flex: 1;
        }
        .ghost-input {
            border: 1px solid transparent;
            background: transparent;
            padding: 5px;
            width: 100%;
            border-radius: 4px;
        }
        .ghost-input:hover { background: #f1f5f9; }

        .priority-dropdown {
            position: relative;
            width: 100%;
        }
        .priority-trigger {
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            padding: 6px 10px;
            background: #f9fafb;
            cursor: pointer;
            font-size: 0.9rem;
        }
        .priority-trigger:hover {
            background: #eef2ff;
        }
        .priority-menu {
            position: absolute;
            top: 100%;
            left: 0;
            margin-top: 4px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            box-shadow: 0 10px 20px rgba(15,23,42,0.15);
            padding: 6px 0;
            min-width: 180px;
            z-index: 1050;
            display: none;
        }
        .priority-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        .priority-item:hover {
            background: #f1f5f9;
        }
        .priority-flag {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            color: white;
            font-size: 0.75rem;
        }
        .priority-flag-urgent { background: #ef4444; }
        .priority-flag-high { background: #f59e0b; }
        .priority-flag-normal { background: #3b82f6; }
        .priority-flag-low { background: #6b7280; }

        .tag-selector {
            position: relative;
            width: 100%;
        }
        .tag-selector-control {
            display: flex;
            align-items: center;
            min-height: 34px;
            border-radius: 4px;
            padding: 4px 8px;
            border: 1px solid transparent;
            background: transparent;
            cursor: text;
            width: 100%;
        }
        .tag-selector-control:hover {
            background: #f1f5f9;
        }
        .tag-selected-list {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            flex: 1;
        }
        .tag-placeholder {
            color: #9ca3af;
            font-size: 0.85rem;
        }
        .tag-pill {
            display: inline-flex;
            align-items: center;
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 0.8rem;
            background: #e5e7eb;
            color: #111827;
        }
        .tag-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            margin-top: 4px;
            background: #ffffff;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            box-shadow: 0 18px 45px rgba(15, 23, 42, 0.15);
            padding: 6px 0 4px 0;
            z-index: 40;
            display: none;
        }
        .tag-search-input {
            width: 100%;
            border: none;
            outline: none;
            padding: 6px 12px 8px 12px;
            font-size: 0.85rem;
        }
        .tag-options {
            max-height: 220px;
            overflow-y: auto;
            padding: 0 4px 4px 4px;
        }
        .tag-option {
            display: flex;
            align-items: center;
            padding: 4px 8px;
            cursor: pointer;
            gap: 6px;
        }
        .tag-option:hover {
            background: #f3f4f6;
        }
        .tag-option-selected .tag-pill {
            background: #4338ca;
            color: #eef2ff;
        }
        .tag-create {
            display: flex;
            align-items: center;
            padding: 6px 12px 8px 12px;
            border-top: 1px solid #e5e7eb;
            font-size: 0.8rem;
            color: #6b7280;
            cursor: pointer;
        }
        .tag-create:hover {
            background: #f3f4f6;
        }
        .tag-create-label {
            margin-left: 4px;
            padding: 2px 6px;
            border-radius: 999px;
            background: #e0e7ff;
            color: #4338ca;
        }
        .tag-remove {
            margin-left: 4px;
            cursor: pointer;
            font-size: 0.7rem;
            color: #6b7280;
        }
        .tag-remove:hover {
            color: #111827;
        }

        .user-select {
            position: relative;
            width: 100%;
        }
        .user-select-control {
            display: flex;
            align-items: center;
            width: 100%;
            min-height: 34px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            padding: 6px 10px;
            background: #f9fafb;
            cursor: pointer;
            gap: 8px;
        }
        .user-select-control:hover {
            background: #f3f4ff;
        }
        .user-select-avatar {
            width: 22px;
            height: 22px;
            border-radius: 999px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #e5e7eb;
            flex-shrink: 0;
        }
        .user-select-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .user-select-placeholder {
            font-size: 0.85rem;
            color: #9ca3af;
        }
        .user-select-name {
            font-size: 0.85rem;
            color: #111827;
        }
        .user-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            margin-top: 6px;
            background: #0f172a;
            color: white;
            border-radius: 18px;
            padding: 10px 10px 8px 10px;
            box-shadow: 0 18px 45px rgba(15,23,42,0.45);
            width: 280px;
            z-index: 60;
            display: none;
        }
        .user-search-wrapper {
            display: flex;
            align-items: center;
            background: #020617;
            border-radius: 999px;
            padding: 4px 10px;
            gap: 6px;
            margin-bottom: 8px;
        }
        .user-search-input {
            flex: 1;
            border: none;
            outline: none;
            background: transparent;
            color: #e5e7eb;
            font-size: 0.85rem;
        }
        .user-search-input::placeholder {
            color: #6b7280;
        }
        .user-list-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            color: #9ca3af;
            margin: 4px 2px 4px 2px;
        }
        .user-list {
            max-height: 260px;
            overflow-y: auto;
            padding-right: 4px;
        }
        .user-option {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 4px;
            border-radius: 8px;
            cursor: pointer;
        }
        .user-option:hover {
            background: #111827;
        }
        .user-option-avatar {
            width: 28px;
            height: 28px;
            border-radius: 999px;
            overflow: hidden;
            flex-shrink: 0;
            background: #1f2937;
        }
        .user-option-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .user-option-name {
            font-size: 0.85rem;
        }

        .tag-edit-btn {
            border: none;
            background: transparent;
            padding: 0;
            margin-left: auto;
            color: #9ca3af;
            cursor: pointer;
            font-size: 0.9rem;
        }
        .tag-edit-btn:hover {
            color: #4b5563;
        }
        .tag-editor-popover {
            position: absolute;
            background: #ffffff;
            border-radius: 16px;
            border: 1px solid #e5e7eb;
            box-shadow: 0 18px 45px rgba(15, 23, 42, 0.18);
            padding: 10px 12px 8px 12px;
            z-index: 1000;
            width: 260px;
            display: none;
        }
        .tag-editor-input {
            width: 100%;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 4px 8px;
            font-size: 0.85rem;
            margin-bottom: 8px;
        }
        .tag-color-grid {
            display: grid;
            grid-template-columns: repeat(8, minmax(0, 1fr));
            gap: 4px;
            margin-bottom: 8px;
        }
        .tag-color-swatch {
            width: 18px;
            height: 18px;
            border-radius: 999px;
            border: 2px solid transparent;
            cursor: pointer;
        }
        .tag-color-swatch-selected {
            border-color: #111827;
        }
        .tag-editor-delete {
            display: flex;
            align-items: center;
            gap: 6px;
            color: #ef4444;
            font-size: 0.8rem;
            cursor: pointer;
            padding-top: 4px;
            border-top: 1px solid #e5e7eb;
            margin-top: 4px;
        }

        .comment-bubble {
            background: #f8fafc;
            border-radius: 12px;
            padding: 12px;
            border: 1px solid #e2e8f0;
        }

        .modal-content-custom {
            border-radius: 20px;
            border: 1px solid #e5e7eb;
            box-shadow: 0 18px 45px rgba(15, 23, 42, 0.18);
            background: #f9fafb;
        }
        #projectToolsModal .modal-header {
            padding-bottom: 0.25rem;
        }
        #projectToolsModal .modal-title {
            font-size: 1.1rem;
            letter-spacing: 0.02em;
        }
        .modal-tools-grid {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 16px;
            margin-top: 1.25rem;
        }
        .tool-nav-card {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 16px;
            border-radius: 16px;
            background: #ffffff;
            border: 1px solid #e5e7eb;
            text-decoration: none;
            color: #111827;
            transition: transform 0.18s ease, box-shadow 0.18s ease, border-color 0.18s ease, background-color 0.18s ease;
        }
        .tool-nav-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 16px 40px rgba(15, 23, 42, 0.16);
            border-color: #0b2b6a;
            background: #f9fafb;
        }
        .tool-title {
            font-weight: 600;
            font-size: 0.95rem;
        }
        .tool-nav-icon {
            width: 40px;
            height: 40px;
            border-radius: 999px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #ffffff;
            box-shadow: 0 8px 18px rgba(15, 23, 42, 0.25);
        }
        .tool-nav-icon i {
            font-size: 1.1rem;
        }

        @media (max-width: 768px) {
            .main-content.w-100 {
                margin-left: 0 !important;
            }
            #projectToolsModal .modal-dialog {
                margin: 0.75rem;
            }
            .modal-tools-grid {
                grid-template-columns: repeat(2, minmax(0, 1fr));
                gap: 12px;
            }
            .main-list-card {
                padding: 24px 16px;
                margin: 0 12px 32px 12px;
                border-radius: 14px;
            }
            .project-context-card {
                width: 95%;
                margin: 16px auto -10px auto;
                padding: 12px 16px 28px 16px;
                border-radius: 14px 14px 0 0;
            }
            .ph-badge {
                left: 16px;
                top: 42%;
            }
            .ph-crumb-container {
                max-width: 100%;
                padding: 6px 14px;
                font-size: 0.8rem;
            }
            .main-list-card > .d-flex.justify-content-between.align-items-center {
                flex-direction: column;
                align-items: stretch !important;
                gap: 16px;
            }
            .main-list-card .search-bar-list {
                max-width: 100%;
            }
            .main-list-card .search-bar-list input:focus,
            .main-list-card .search-bar-list input:valid {
                width: 100%;
            }
            .main-list-card .text-center.flex-grow-1 {
                order: -1;
                margin-bottom: 4px;
            }
            .main-list-card h1.fw-bold {
                font-size: 1.4rem;
            }
            .main-list-card p.text-muted {
                font-size: 0.85rem;
            }
            .main-list-card > .d-flex.justify-content-between.align-items-center > button {
                align-self: center;
                width: 100%;
                max-width: 200px;
            }
        }

        @media (max-width: 576px) {
            .modal-tools-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body style="background-color: #f1f7fd;">

    <nav class="top-bar">
        <div class="logo-center">
            <img src="https://www.dialogika.co/assets/img/logo.webp" alt="Dialogika" height="35">
        </div>
        <div class="d-flex align-items-center gap-3 ms-auto pe-4">
            <div class="text-end d-none d-lg-block lh-1">
                <span id="user-name-display" class="fw-bold small">Loading...</span>
            </div>
            <img id="user-photo-display" src="" class="profile-img" style="width:35px; height:35px; border-radius:50%">
        </div>
    </nav>

    <div class="dashboard-container">
        <aside class="sidebar" id="sidebarNav">
            
            <!-- WRAPPER UNTUK AREA YANG BISA DI-SCROLL -->
            <div class="sidebar-scroll-wrapper">
                
                <!-- Smart Filters (4 Kotak Besar) -->
                <div class="smart-filters-grid">
                    <a href="#" class="filter-card">
                        <div class="filter-top"><div class="filter-icon bg-icon-dark"><i class="bi bi-archive-fill"></i></div><div class="filter-count">429</div></div>
                        <div class="filter-label">All Tasks</div>
                    </a>
                    <a href="#" class="filter-card">
                        <div class="filter-top"><div class="filter-icon bg-icon-blue"><i class="bi bi-calendar-event-fill"></i></div><div class="filter-count">25</div></div>
                        <div class="filter-label">Today</div>
                    </a>
                    <a href="#" class="filter-card">
                        <div class="filter-top"><div class="filter-icon bg-icon-orange"><i class="bi bi-flag-fill"></i></div><div class="filter-count">21</div></div>
                        <div class="filter-label">Urgent</div>
                    </a>
                    <a href="#" class="filter-card">
                        <div class="filter-top"><div class="filter-icon bg-icon-red"><i class="bi bi-calendar-check-fill"></i></div><div class="filter-count">30</div></div>
                        <div class="filter-label">Assigned</div>
                    </a>
                </div>

                <!-- Navigation Links -->
                <div class="nav-category">Main Navigation</div>
                <a href="#" class="sidebar-link active"><i class="bi bi-columns-gap"></i> Dashboard</a>
                <a href="#" class="sidebar-link"><i class="bi bi-list-columns-reverse"></i> Lineup <span class="sidebar-badge">4</span></a>
                <a href="#" class="sidebar-link"><i class="bi bi-chat-dots"></i> Pings</a>
                <a href="#" class="sidebar-link"><i class="bi bi-bell"></i> Hey!</a>
                <a href="#" class="sidebar-link"><i class="bi bi-activity"></i> Activity</a>
                <a href="#" class="sidebar-link"><i class="bi bi-person-circle"></i> My Stuff</a>

                <div class="nav-category mt-4">System</div>
                <a href="#" class="sidebar-link"><i class="bi bi-gear"></i> Settings</a>
                <a href="#" class="sidebar-link text-danger"><i class="bi bi-box-arrow-right"></i> Logout</a>

            </div> <!-- End Scroll Wrapper -->

            <!-- PENDING WIDGET (Pinned di Bawah, di luar scroll wrapper) -->
            <div class="pending-widget">
                <div class="fire-icon-wrapper"><i class="bi bi-fire fire-icon"></i></div>
                <h6 class="fw-bold" style="color:#0B2B6A; margin-bottom: 5px;">Pending Tasks</h6>
                <p class="small text-muted mb-3">You have 5 approvals waiting.</p>
                <button class="btn-review">Review Now</button>
                
                <!-- COPYRIGHT (Muncul hanya saat scroll mentok bawah) -->
                <div class="sidebar-copyright">
                    &copy; 2025 PT Dialogika Persona Indonesia
                </div>
            </div>

        </aside>

        <main class="main-content w-100" style="margin-left:290px; padding-top:100px">
            <div class="container-fluid">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div class="dropdown">
                        <button class="btn btn-dlg-green rounded-pill px-4 fw-semibold dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                            + New Things
                        </button>
                        <ul class="dropdown-menu shadow border-0" style="min-width:260px; border-radius:16px;">
                            <li>
                                <a class="dropdown-item d-flex align-items-center gap-3 py-3" href="files-craft.html" id="startNewDocLink">
                                    <i class="bi bi-file-earmark-text fs-5 text-dark"></i>
                                    <span class="fw-semibold">Start a new doc</span>
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item d-flex align-items-center gap-3 py-3" href="#" id="uploadFilesMenuItem">
                                    <i class="bi bi-upload fs-5 text-dark"></i>
                                    <span class="fw-semibold">Upload files</span>
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item d-flex align-items-center gap-3 py-3" href="#" id="uploadLinkLink">
                                    <i class="bi bi-link-45deg fs-5 text-dark"></i>
                                    <span class="fw-semibold">Upload link</span>
                                </a>
                            </li>
                        </ul>
                    </div>
                    <div class="d-flex align-items-center gap-3">
                        <div class="dropdown">
                            <button class="btn btn-light border rounded-pill px-3 py-2 dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                <i id="filesViewModeIcon" class="bi bi-grid-3x3-gap-fill me-1"></i>
                            </button>
                            <ul class="dropdown-menu">
                                <li>
                                    <a class="dropdown-item" href="javascript:void(0)" onclick="window.setFilesViewMode('grid')">
                                        Thumbnail view
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="javascript:void(0)" onclick="window.setFilesViewMode('list')">
                                        List view
                                    </a>
                                </li>
                            </ul>
                        </div>
                        <div class="dropdown">
                            <button id="filesSortDropdownLabel" class="btn btn-light border rounded-pill px-3 py-2 dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                Unsorted
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li>
                                    <a class="dropdown-item" href="javascript:void(0)" onclick="window.setFilesSortMode('unsorted')">
                                        Unsorted
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="javascript:void(0)" onclick="window.setFilesSortMode('newest')">
                                        Newest first
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="javascript:void(0)" onclick="window.setFilesSortMode('oldest')">
                                        Oldest first
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="javascript:void(0)" onclick="window.setFilesSortMode('az')">
                                        A â†’ Z
                                    </a>
                                </li>
                            </ul>
                        </div>
                        <div class="dropdown">
                            <button class="btn btn-light border rounded-pill px-3 py-2" style="border-radius: 100%;" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="bi bi-three-dots"></i>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li>
                                    <a class="dropdown-item text-danger d-flex align-items-center gap-2" href="javascript:void(0)" onclick="window.enterFilesDeleteMode()">
                                        <i class="bi bi-trash3"></i>
                                        <span>Delete</span>
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="d-flex align-items-center justify-content-center mb-3 gap-2">
                    <a id="filesBackHomeLink" href="#" class="text-decoration-none">
                        <i class="bi bi-house-door-fill" style="font-size:1.6rem; color:#0B2B6A;"></i>
                    </a>
                    <span style="font-size:1.1rem; color:#6b7280;">/</span>
                    <h3 class="fw-bold mb-0" style="font-size:1.6rem;">Files</h3>
                </div>

                <div class="row mb-4">
                    <div class="col-md-6 mx-auto">
                        <div class="input-group bg-white border rounded-pill px-2 shadow-sm" style="overflow:hidden;">
                            <span class="input-group-text bg-transparent border-0"><i class="bi bi-search"></i></span>
                            <input type="text"
                                   id="fileSearchInput"
                                   class="form-control bg-transparent border-0 shadow-none"
                                   placeholder="Search files...">
                        </div>
                    </div>
                </div>

                <div class="row g-4" id="filesGrid"></div>
            </div>
        </main>
    </div>

    <div id="filesBulkDeleteBar" class="position-fixed bottom-0 start-0 end-0 bg-white border-top shadow-sm py-2" style="display:none; z-index:1050;">
        <div class="container-fluid d-flex justify-content-between align-items-center">
            <span class="small text-muted" id="filesSelectedCountLabel">0 selected</span>
            <div class="d-flex gap-2">
                <button type="button" class="btn btn-light border rounded-pill px-3" onclick="window.cancelFilesBulkDelete()">Cancel</button>
                <button type="button" class="btn btn-danger rounded-pill px-3 d-flex align-items-center gap-1" id="filesBulkDeleteButton" onclick="window.confirmFilesBulkDelete()" disabled>
                    <i class="bi bi-trash3"></i>
                    <span>Delete</span>
                </button>
            </div>
        </div>
    </div>

    <input type="file" id="uploadFilesInput" multiple style="display:none">

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import {
            getFirestore,
            doc,
            collection,
            getDoc,
            getDocs,
            query,
            where,
            orderBy,
            onSnapshot,
            addDoc,
            serverTimestamp,
            deleteDoc
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import {
            getStorage,
            ref as storageRef,
            uploadBytes,
            getDownloadURL
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDyzzEYbJkkl-N8snrQf14qvj8De4YliV0",
            authDomain: "pre-dialogika.firebaseapp.com",
            projectId: "pre-dialogika",
            storageBucket: "pre-dialogika.firebasestorage.app",
            messagingSenderId: "343771410480",
            appId: "1:343771410480:web:32881c9868522090237df5"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        const params = new URLSearchParams(window.location.search);
        let projectId = params.get("id") || params.get("projectId");
        if (!projectId) {
            try {
                const cached = localStorage.getItem("currentProjectId");
                if (cached) projectId = cached;
            } catch (e) {}
        }
        if (!projectId && document.referrer) {
            try {
                const refUrl = new URL(document.referrer);
                const refParams = refUrl.searchParams;
                projectId = refParams.get("id") || refParams.get("projectId");
            } catch (e) {}
        }
        if (projectId) {
            try {
                localStorage.setItem("currentProjectId", projectId);
            } catch (e) {}
        }

        const filesGrid = document.getElementById("filesGrid");
        const startNewDocLink = document.getElementById("startNewDocLink");
        const fileSearchInput = document.getElementById("fileSearchInput");
        const makeNewFolderLink = document.getElementById("makeNewFolderLink");
        const uploadFilesMenuItem = document.getElementById("uploadFilesMenuItem");
        const uploadFilesInput = document.getElementById("uploadFilesInput");
        const uploadLinkLink = document.getElementById("uploadLinkLink");
        let allFiles = [];
        let allFolders = [];
        let currentSearch = "";
        let isCreatingFolderInline = false;
        let currentUser = null;
        let currentViewMode = "grid";
        let currentSortMode = "unsorted";
        let isBulkDeleteMode = false;
        let selectedFileIds = [];
        
        onAuthStateChanged(auth, (user) => {
            currentUser = user || null;
            try {
                const nameSpan = document.getElementById("user-name-display");
                const photoImg = document.getElementById("user-photo-display");
                if (!nameSpan || !photoImg) return;
                const localData = JSON.parse(localStorage.getItem("userData") || "null");
                const userName = localData && localData.name ? localData.name : (user ? user.email : "User");
                const rawPhoto = localData && localData.photo ? localData.photo : (user && user.photoURL ? user.photoURL : "");
                const uid = localData && localData.uid ? localData.uid : (user && user.uid ? user.uid : "");
                nameSpan.innerText = userName || "User";
                const finalUrl = getDirectPhotoUrl(rawPhoto || "", uid || "");
                if (finalUrl) {
                    photoImg.src = finalUrl;
                }
            } catch (e) {}
        });

        function getDirectPhotoUrl(url, uid) {
            if (!url) return `https://i.pravatar.cc/150?u=${uid || "user"}`;
            if (url.includes("drive.google.com")) {
                let id = "";
                if (url.includes("id=")) {
                    id = url.split("id=")[1].split("&")[0];
                } else if (url.includes("/d/")) {
                    id = url.split("/d/")[1].split("/")[0];
                }
                if (id) return `https://lh3.googleusercontent.com/u/0/d/${id}`;
            }
            return url;
        }

        function getFilesCollectionRef() {
            if (!projectId) return null;
            return collection(db, "projects", projectId, "files");
        }

        function getFoldersCollectionRef() {
            if (!projectId) return null;
            return collection(db, "projects", projectId, "file_folders");
        }

        function getFileAttachmentPath(fileName) {
            return `files/${projectId}/${Date.now()}_${fileName}`;
        }

        function truncateText(text, maxLength) {
            if (!text) return "";
            const clean = String(text);
            if (clean.length <= maxLength) return clean;
            return clean.substring(0, maxLength - 3) + "...";
        }

        async function handleUploadFiles(files) {
            if (!projectId) {
                alert("Project ID tidak ditemukan.");
                return;
            }
            if (!files || !files.length) return;
            const filesRef = getFilesCollectionRef();
            if (!filesRef) {
                alert("Project ID tidak valid.");
                return;
            }
            let localData = null;
            try {
                localData = JSON.parse(localStorage.getItem("userData") || "null");
            } catch (e) {}
            const uid = currentUser && currentUser.uid
                ? currentUser.uid
                : (localData && localData.uid ? localData.uid : "");
            const userName = localData && localData.name
                ? localData.name
                : (currentUser && currentUser.email ? currentUser.email : "User");
            const rawPhoto = localData && localData.photo
                ? localData.photo
                : (currentUser && currentUser.photoURL ? currentUser.photoURL : "");
            const photoUrl = getDirectPhotoUrl(rawPhoto || "", uid || "");
            const initialsSource = userName || uid || "";
            const initials = initialsSource
                ? initialsSource.trim().split(" ").map(part => part[0]).join("").substring(0, 2).toUpperCase()
                : "US";

            for (const file of files) {
                try {
                    const path = getFileAttachmentPath(file.name);
                    const ref = storageRef(storage, path);
                    await uploadBytes(ref, file);
                    const url = await getDownloadURL(ref);
                    const attachments = [{ name: file.name, url }];
                    const baseName = file.name.replace(/\.[^/.]+$/, "");
                    await addDoc(filesRef, {
                        title: baseName || file.name,
                        text: "",
                        text_plain: "",
                        attachments: attachments,
                        user_id: uid,
                        user_name: userName,
                        user_initials: initials,
                        user_photo: photoUrl,
                        category: null,
                        parent_id: null,
                        created_at: serverTimestamp(),
                        parent_comment_id: null,
                        mentioned_user_ids: []
                    });
                } catch (e) {
                    console.error("Failed to upload file", e);
                    alert("Gagal mengunggah file: " + e.message);
                    break;
                }
            }
        }

        function renderFiles(files, folders) {
            if (!filesGrid) return;
            filesGrid.innerHTML = "";
            const hasDraft = isCreatingFolderInline;
            const hasFiles = files && files.length > 0;
            const hasFolders = folders && folders.length > 0;
            if (!hasDraft && !hasFiles && !hasFolders) {
                filesGrid.innerHTML = '<div class="col-12"><p class="text-muted small mb-0 text-center">No docs yet. Start a new doc to see it here.</p></div>';
                return;
            }
            if (hasDraft) {
                const draftHtml = `
                    <div class="col-6 col-sm-4 col-md-3 col-lg-2">
                        <div class="border rounded-3 bg-white p-3 d-flex flex-column justify-content-between" style="min-height:200px;border:0px;">
                            <div class="mb-2">
                                <div style="width:90px; height:22px; border-radius:12px 12px 0 0; background:#e5e7eb;"></div>
                            </div>
                            <div class="flex-grow-1 d-flex align-items-start">
                                <input
                                    type="text"
                                    id="folderInlineNameInput"
                                    class="form-control border-0 px-0 fw-bold"
                                    value="Untitled"
                                    style="font-size:1rem; box-shadow:none;"
                                >
                            </div>
                            <div class="mt-3">
                                <button type="button" class="btn btn-success rounded-pill w-100 mb-2" onclick="saveInlineFolder()">Save</button>
                                <button type="button" class="btn btn-outline-success rounded-pill w-100" onclick="cancelInlineFolder()">Cancel</button>
                            </div>
                        </div>
                    </div>
                `;
                filesGrid.insertAdjacentHTML("beforeend", draftHtml);
            }
            (folders || []).forEach(f => {
                const folderId = f.id;
                const name = f.name || "Untitled";
                const folderUrl = projectId
                    ? "files-folder.html?projectId=" + encodeURIComponent(projectId) + "&folderId=" + encodeURIComponent(folderId)
                    : "#";
                const html = `
                    <div class="col-6 col-sm-4 col-md-3 col-lg-2">
                        <a href="${folderUrl}" class="text-decoration-none text-reset">
                            <div class="border rounded-3 bg-white p-3 d-flex flex-column justify-content-between" style="min-height:200px; border:1px solid #e5e7eb;">
                                <div class="mb-2">
                                    <div style="width:90px; height:22px; border-radius:12px 12px 0 0; background:#e5e7eb;"></div>
                                </div>
                                <div class="flex-grow-1 d-flex align-items-start">
                                    <div class="fw-semibold" style="font-size:1rem; word-break:break-word;">${name}</div>
                                </div>
                                <div class="mt-2 small text-muted">
                                    Folder
                                </div>
                            </div>
                        </a>
                    </div>
                `;
                filesGrid.insertAdjacentHTML("beforeend", html);
            });
            (files || []).forEach(d => {
                const fileId = d.id;
                const detailUrl = projectId
                    ? "files-doc.html?projectId=" + encodeURIComponent(projectId) + "&fileId=" + encodeURIComponent(fileId)
                    : "#";
                const title = d.title || "Untitled doc";
                const plain = d.text_plain || "";
                const preview = truncateText(plain, 120);
                const createdAt = d.created_at && d.created_at.toDate ? d.created_at.toDate() : null;
                const dateStr = createdAt ? createdAt.toLocaleDateString() : "";
                const fileType = d.file_type || "";
                const isLinkFile = fileType === "link";
                const iconHtml = isLinkFile
                    ? '<i class="bi bi-link-45deg fs-5 text-dark"></i>'
                    : '<i class="bi bi-file-earmark-text"></i>';
                const category = d.category || "";
                const categoryHtml = category
                    ? `<span class="badge rounded-pill bg-light text-dark border mb-1">${category}</span>`
                    : "";
                const checkboxStyle = isBulkDeleteMode
                    ? "position:absolute; top:6px; left:6px; z-index:20;"
                    : "display:none; position:absolute; top:6px; left:6px; z-index:20;";
                let html = "";
                if (currentViewMode === "list") {
                    html = `
                        <div class="col-12">
                            <div class="position-relative">
                                <input type="checkbox"
                                       class="form-check-input file-select-checkbox"
                                       data-file-id="${fileId}"
                                       style="${checkboxStyle}"
                                       onclick="window.toggleFileSelection(event, '${fileId}')">
                                <a href="${detailUrl}" class="text-decoration-none text-reset">
                                    <div class="border rounded-3 bg-white p-3 d-flex align-items-center justify-content-between file-card" data-file-id="${fileId}">
                                        <div class="d-flex align-items-start gap-3">
                                            <span class="small text-muted">${iconHtml}</span>
                                            <div>
                                                <div class="fw-semibold mb-1" style="max-height:40px; overflow:hidden;">${title}</div>
                                                <div class="d-flex align-items-start gap-2">
                                                    <div class="file-card-category">
                                                        ${categoryHtml}
                                                    </div>
                                                    <div class="text-muted small" style="font-size:0.8rem; max-height:72px; overflow:hidden;">
                                                        ${preview || ""}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="d-flex flex-column align-items-end gap-2">
                                            <span class="badge rounded-pill" style="background:#0B2B6A;">${dateStr}</span>
                                            <div class="d-flex align-items-center justify-content-end gap-1 file-card-commenters"></div>
                                        </div>
                                    </div>
                                </a>
                            </div>
                        </div>
                    `;
                } else {
                    html = `
                        <div class="col-6 col-sm-4 col-md-3 col-lg-2">
                            <div class="position-relative">
                                <input type="checkbox"
                                       class="form-check-input file-select-checkbox"
                                       data-file-id="${fileId}"
                                       style="${checkboxStyle}"
                                       onclick="window.toggleFileSelection(event, '${fileId}')">
                                <a href="${detailUrl}" class="text-decoration-none text-reset">
                                    <div class="border shadow-purple rounded-3 bg-white p-3 d-flex flex-column justify-content-between file-card" data-file-id="${fileId}" style="min-height:200px;border:0px;">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <span class="small text-muted">${iconHtml}</span>
                                            <span class="badge rounded-pill" style="background:#0B2B6A;">${dateStr}</span>
                                        </div>
                                        <div class="flex-grow-1">
                                            <div class="fw-semibold mb-1" style="max-height:40px; overflow:hidden;">${title}</div>
                                            <div class="text-muted small" style="font-size:0.8rem; max-height:72px; overflow:hidden;">
                                                ${preview || ""}
                                            </div>
                                        </div>
                                        <div class="d-flex justify-content-between align-items-center mt-2">
                                            <div class="file-card-category">
                                                ${categoryHtml}
                                            </div>
                                            <div class="d-flex align-items-center justify-content-end gap-1 file-card-commenters"></div>
                                        </div>
                                    </div>
                                </a>
                            </div>
                        </div>
                    `;
                }
                filesGrid.insertAdjacentHTML("beforeend", html);
            });
            loadFileCommentAvatarsForList(files || []);
        }

        function syncFileCheckboxSelection() {
            if (!filesGrid) return;
            if (!Array.isArray(selectedFileIds) || !selectedFileIds.length) return;
            const checkboxes = filesGrid.querySelectorAll(".file-select-checkbox");
            checkboxes.forEach(cb => {
                const id = cb.getAttribute("data-file-id") || "";
                cb.checked = selectedFileIds.includes(id);
            });
        }

        async function loadFileCommentAvatarsForList(files) {
            if (!projectId) return;
            if (!Array.isArray(files) || files.length === 0) return;
            if (!filesGrid) return;
            const tasks = files.map(async (f) => {
                const fileId = f && f.id ? f.id : "";
                if (!fileId) return;
                try {
                    const ref = collection(db, "projects", projectId, "files", fileId, "comments");
                    const snap = await getDocs(ref);
                    if (snap.empty) return;
                    const commentersMap = {};
                    snap.forEach(docSnap => {
                        const c = docSnap.data() || {};
                        const uid = c.user_id || c.userId || "";
                        if (!uid) return;
                        if (!commentersMap[uid]) {
                            const userName = c.user_name || c.userName || "";
                            const initialsSource = c.user_initials || userName || uid || "";
                            const initials = initialsSource
                                ? initialsSource.trim().split(" ").map(part => part[0]).join("").substring(0, 2).toUpperCase()
                                : "??";
                            const photo = c.user_photo || "";
                            commentersMap[uid] = {
                                uid,
                                name: userName,
                                initials,
                                photo
                            };
                        }
                    });
                    const commenters = Object.values(commentersMap);
                    if (!commenters.length) return;
                    const card = filesGrid.querySelector(`.file-card[data-file-id="${fileId}"]`);
                    if (!card) return;
                    const container = card.querySelector(".file-card-commenters");
                    if (!container) return;
                    container.innerHTML = "";
                    const maxVisible = 3;
                    const visible = commenters.slice(0, maxVisible);
                    visible.forEach((user) => {
                        const avatarHtml = user.photo
                            ? `<img src="${user.photo}" class="rounded-circle border" style="width:22px; height:22px; object-fit:cover;">`
                            : `<div class="rounded-circle bg-secondary text-white d-flex align-items-center justify-content-center" style="width:22px; height:22px; font-size:0.7rem;">${user.initials}</div>`;
                        container.insertAdjacentHTML("beforeend", avatarHtml);
                    });
                    if (commenters.length > maxVisible) {
                        const extraCount = commenters.length - maxVisible;
                        const moreHtml = `<div class="rounded-circle bg-light text-dark border d-flex align-items-center justify-content-center" style="width:22px; height:22px; font-size:0.7rem;">+${extraCount}</div>`;
                        container.insertAdjacentHTML("beforeend", moreHtml);
                    }
                } catch (e) {
                    console.error("Failed to load file commenters for file", fileId, e);
                }
            });
            try {
                await Promise.all(tasks);
            } catch (e) {
                console.error("Failed to load some file commenters", e);
            }
            if (isBulkDeleteMode) {
                syncFileCheckboxSelection();
            }
        }

        function updateFilesBulkDeleteBar() {
            const bar = document.getElementById("filesBulkDeleteBar");
            const label = document.getElementById("filesSelectedCountLabel");
            const btn = document.getElementById("filesBulkDeleteButton");
            const count = selectedFileIds.length;
            if (!bar || !label || !btn) return;
            if (!isBulkDeleteMode) {
                bar.style.display = "none";
                return;
            }
            bar.style.display = "block";
            label.innerText = count + " selected";
            btn.disabled = count === 0;
        }

        window.enterFilesDeleteMode = function () {
            if (!projectId) return;
            isBulkDeleteMode = true;
            selectedFileIds = [];
            applyFileFilter();
            updateFilesBulkDeleteBar();
        };

        window.cancelFilesBulkDelete = function () {
            isBulkDeleteMode = false;
            selectedFileIds = [];
            applyFileFilter();
            updateFilesBulkDeleteBar();
        };

        window.toggleFileSelection = function (event, fileId) {
            if (event && event.stopPropagation) event.stopPropagation();
            if (!isBulkDeleteMode) return;
            if (!fileId) return;
            const index = selectedFileIds.indexOf(fileId);
            if (event.target && event.target.checked) {
                if (index === -1) selectedFileIds.push(fileId);
            } else {
                if (index !== -1) selectedFileIds.splice(index, 1);
            }
            updateFilesBulkDeleteBar();
        };

        window.confirmFilesBulkDelete = async function () {
            if (!projectId) return;
            if (!isBulkDeleteMode) return;
            if (!selectedFileIds || !selectedFileIds.length) return;
            const btn = document.getElementById("filesBulkDeleteButton");
            if (btn) {
                btn.disabled = true;
                btn.innerText = "Deleting...";
            }
            try {
                const ids = selectedFileIds.slice();
                for (const id of ids) {
                    try {
                        await deleteDoc(doc(db, "projects", projectId, "files", id));
                    } catch (e) {
                        console.error("Failed to delete file", id, e);
                    }
                }
            } catch (e) {
                console.error("Bulk delete error", e);
            } finally {
                isBulkDeleteMode = false;
                selectedFileIds = [];
                applyFileFilter();
                updateFilesBulkDeleteBar();
                if (btn) {
                    btn.innerHTML = '<i class="bi bi-trash3"></i><span>Delete</span>';
                    btn.disabled = true;
                }
            }
        };

        window.setFilesViewMode = function (mode) {
            if (mode !== "grid" && mode !== "list") return;
            currentViewMode = mode;
            const icon = document.getElementById("filesViewModeIcon");
            if (icon) {
                if (mode === "grid") {
                    icon.className = "bi bi-grid-3x3-gap-fill me-1";
                } else {
                    icon.className = "bi bi-list-ul me-1";
                }
            }
            applyFileFilter();
        };

        function applyFileFilter() {
            const term = (currentSearch || "").trim().toLowerCase();
            let files = allFiles;
            let folders = allFolders;
            if (term) {
                files = files.filter(d => {
                    const title = (d.title || "").toLowerCase();
                    const plain = (d.text_plain || "").toLowerCase();
                    return title.includes(term) || plain.includes(term);
                });
                folders = folders.filter(f => {
                    const name = (f.name || "").toLowerCase();
                    return name.includes(term);
                });
            }
            if (files && files.length) {
                const list = files.slice();
                if (currentSortMode === "newest") {
                    list.sort((a, b) => {
                        const aDate = a.created_at && a.created_at.toDate ? a.created_at.toDate().getTime() : 0;
                        const bDate = b.created_at && b.created_at.toDate ? b.created_at.toDate().getTime() : 0;
                        return bDate - aDate;
                    });
                    files = list;
                } else if (currentSortMode === "oldest") {
                    list.sort((a, b) => {
                        const aDate = a.created_at && a.created_at.toDate ? a.created_at.toDate().getTime() : 0;
                        const bDate = b.created_at && b.created_at.toDate ? b.created_at.toDate().getTime() : 0;
                        return aDate - bDate;
                    });
                    files = list;
                } else if (currentSortMode === "az") {
                    list.sort((a, b) => {
                        const aTitle = (a.title || "").toLowerCase();
                        const bTitle = (b.title || "").toLowerCase();
                        if (aTitle < bTitle) return -1;
                        if (aTitle > bTitle) return 1;
                        return 0;
                    });
                    files = list;
                }
            }
            renderFiles(files, folders);
        }

        window.setFilesSortMode = function (mode) {
            if (mode !== "unsorted" && mode !== "newest" && mode !== "oldest" && mode !== "az") return;
            currentSortMode = mode;
            const btn = document.getElementById("filesSortDropdownLabel");
            if (btn) {
                let label = "Unsorted";
                if (mode === "newest") {
                    label = "Newest first";
                } else if (mode === "oldest") {
                    label = "Oldest first";
                } else if (mode === "az") {
                    label = "A â†’ Z";
                }
                btn.innerText = label;
            }
            applyFileFilter();
        };

        function listenFiles() {
            try {
                const ref = getFilesCollectionRef();
                if (!ref) {
                    allFiles = [];
                    applyFileFilter();
                    return;
                }
                const q = query(ref, orderBy("created_at", "desc"));
                onSnapshot(q, (snapshot) => {
                    const docs = [];
                    snapshot.forEach(docSnap => {
                        docs.push({ id: docSnap.id, ...docSnap.data() });
                    });
                    allFiles = docs;
                    applyFileFilter();
                }, (error) => {
                    console.error("Failed to listen files", error);
                });
            } catch (e) {
                console.error("Failed to start files listener", e);
                allFiles = [];
                applyFileFilter();
            }
        }

        function listenFolders() {
            try {
                const ref = getFoldersCollectionRef();
                if (!ref) {
                    allFolders = [];
                    applyFileFilter();
                    return;
                }
                const q = query(ref, orderBy("created_at", "asc"));
                onSnapshot(q, (snapshot) => {
                    const docs = [];
                    snapshot.forEach(docSnap => {
                        docs.push({ id: docSnap.id, ...docSnap.data() });
                    });
                    allFolders = docs;
                    applyFileFilter();
                }, (error) => {
                    console.error("Failed to listen folders", error);
                });
            } catch (e) {
                console.error("Failed to start folders listener", e);
                allFolders = [];
                applyFileFilter();
            }
        }

        window.saveInlineFolder = async function () {
            if (!projectId) {
                isCreatingFolderInline = false;
                applyFileFilter();
                return;
            }
            const input = document.getElementById("folderInlineNameInput");
            const rawName = input ? (input.value || "") : "";
            const name = (rawName || "").trim() || "Untitled";
            try {
                const foldersRef = collection(db, "projects", projectId, "file_folders");
                await addDoc(foldersRef, {
                    name,
                    created_at: serverTimestamp()
                });
            } catch (e) {
                console.error("Failed to create folder", e);
            } finally {
                isCreatingFolderInline = false;
                applyFileFilter();
            }
        };

        window.cancelInlineFolder = function () {
            isCreatingFolderInline = false;
            applyFileFilter();
        };

        document.addEventListener("DOMContentLoaded", () => {
            if (startNewDocLink && projectId) {
                startNewDocLink.href = "files-craft.html?projectId=" + encodeURIComponent(projectId);
            }
            if (makeNewFolderLink) {
                makeNewFolderLink.addEventListener("click", (e) => {
                    e.preventDefault();
                    if (!projectId) return;
                    if (isCreatingFolderInline) return;
                    isCreatingFolderInline = true;
                    applyFileFilter();
                    setTimeout(() => {
                        const input = document.getElementById("folderInlineNameInput");
                        if (input) {
                            input.focus();
                            input.select();
                        }
                    }, 50);
                });
            }
            if (fileSearchInput) {
                fileSearchInput.addEventListener("input", () => {
                    currentSearch = fileSearchInput.value || "";
                    applyFileFilter();
                });
            }
            if (uploadFilesMenuItem && uploadFilesInput) {
                uploadFilesMenuItem.addEventListener("click", (e) => {
                    e.preventDefault();
                    if (!projectId) {
                        alert("Project ID tidak ditemukan.");
                        return;
                    }
                    uploadFilesInput.click();
                });
                uploadFilesInput.addEventListener("change", async () => {
                    const files = Array.from(uploadFilesInput.files || []);
                    if (!files.length) return;
                    await handleUploadFiles(files);
                    uploadFilesInput.value = "";
                });
            }
            if (uploadLinkLink && projectId) {
                uploadLinkLink.addEventListener("click", (e) => {
                    e.preventDefault();
                    const url = "files-link.html?projectId=" + encodeURIComponent(projectId);
                    window.location.href = url;
                });
            }
            const backHomeLink = document.getElementById("filesBackHomeLink");
            if (backHomeLink && projectId) {
                backHomeLink.href = "project.html?id=" + encodeURIComponent(projectId);
            }

            if (!projectId) {
                allFiles = [];
                allFolders = [];
                renderFiles([], []);
                return;
            }
            listenFiles();
            listenFolders();
        });
    </script>
</body>
</html>
