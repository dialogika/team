<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest Detail</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="min-h-screen bg-slate-950 text-slate-50">
    <div class="min-h-screen bg-gradient-to-b from-slate-950 via-slate-900 to-slate-950">
        <div class="max-w-5xl mx-auto px-4 py-8 md:py-12">
            <div class="flex items-center justify-between mb-8">
                <div>
                    <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-slate-900/70 border border-slate-700 text-[11px] font-semibold tracking-[0.18em] uppercase text-slate-400">
                        <i data-lucide="sparkles" class="w-3 h-3 text-yellow-400"></i>
                        <span>Quest Detail</span>
                    </div>
                    <h1 id="questTitleDisplay" class="mt-4 text-3xl md:text-4xl font-extrabold tracking-tight text-slate-50">
                        Loading quest...
                    </h1>
                    <p id="questSubtitleDisplay" class="mt-2 text-sm text-slate-400">
                        Mengambil data quest dari ruang petualangan kamu.
                    </p>
                </div>
                <button type="button"
                        class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-slate-800 border border-slate-700 text-xs font-semibold text-slate-200 hover:bg-slate-700 transition"
                        onclick="window.location.href='../home.html'">
                    <i data-lucide="arrow-left" class="w-4 h-4"></i>
                    <span>Kembali ke dashboard</span>
                </button>
            </div>

            <div id="questErrorBox" class="hidden mb-6 rounded-2xl border border-red-500/40 bg-red-500/10 px-4 py-3 text-sm text-red-100">
                Quest tidak ditemukan atau tidak dapat dimuat.
            </div>

            <div class="grid md:grid-cols-[auto,1fr] gap-6 items-start mb-10">
                <button id="questBigCheckbox"
                        type="button"
                        class="w-14 h-14 rounded-2xl border-2 border-slate-600 bg-slate-950 flex items-center justify-center text-slate-500 hover:border-emerald-400 hover:text-emerald-300 transition">
                    <i id="questBigCheckIcon" data-lucide="check" class="w-6 h-6"></i>
                </button>
                <div class="space-y-3">
                    <div class="flex flex-wrap items-center gap-3">
                        <span id="questPriorityBadge"
                              class="inline-flex items-center gap-2 px-3 py-1 rounded-full text-[11px] font-bold uppercase tracking-[0.18em] bg-slate-900 text-slate-300 border border-slate-700">
                            <span class="w-2 h-2 rounded-full bg-slate-500"></span>
                            <span>Priority</span>
                        </span>
                        <span id="questDueBadge"
                              class="inline-flex items-center gap-2 px-3 py-1 rounded-full text-[11px] font-bold uppercase tracking-[0.18em] bg-slate-900 text-slate-300 border border-slate-700">
                            <i data-lucide="calendar-days" class="w-3 h-3"></i>
                            <span>Due date</span>
                        </span>
                        <span id="questStatusBadge"
                              class="inline-flex items-center gap-2 px-3 py-1 rounded-full text-[11px] font-bold uppercase tracking-[0.18em] bg-emerald-500/10 text-emerald-300 border border-emerald-500/40">
                            <span class="w-2 h-2 rounded-full bg-emerald-400 animate-pulse"></span>
                            <span>Status</span>
                        </span>
                    </div>
                    <div id="questTagContainer" class="flex flex-wrap gap-2 text-[11px]"></div>
                </div>
            </div>

            <div class="grid md:grid-cols-3 gap-6 mb-10">
                <div class="md:col-span-2 space-y-6">
                    <div class="rounded-2xl border border-slate-800 bg-slate-900/60 p-5">
                        <div class="flex items-center justify-between mb-3">
                            <h2 class="text-xs font-semibold tracking-[0.2em] uppercase text-slate-400">
                                Deskripsi Quest
                            </h2>
                        </div>
                        <div id="questDescription"
                             class="prose prose-invert prose-sm max-w-none text-slate-200 leading-relaxed">
                            <p class="text-slate-400 text-sm">Belum ada deskripsi yang ditulis untuk quest ini.</p>
                        </div>
                    </div>

                    <div class="rounded-2xl border border-slate-800 bg-slate-900/60 p-5">
                        <div class="flex items-center justify-between mb-3">
                            <h2 class="text-xs font-semibold tracking-[0.2em] uppercase text-slate-400">
                                Reminder & Repeat
                            </h2>
                        </div>
                        <dl class="grid md:grid-cols-2 gap-x-6 gap-y-4 text-sm">
                            <div>
                                <dt class="text-slate-400 text-xs uppercase tracking-wide">Reminder mode</dt>
                                <dd id="questReminderMode" class="text-slate-100 font-medium mt-1">
                                    Tidak ada pengingat.
                                </dd>
                            </div>
                            <div>
                                <dt class="text-slate-400 text-xs uppercase tracking-wide">Reminder dates</dt>
                                <dd id="questReminderDates" class="text-slate-100 font-medium mt-1 text-xs">
                                    -
                                </dd>
                            </div>
                            <div>
                                <dt class="text-slate-400 text-xs uppercase tracking-wide">Recurring</dt>
                                <dd id="questRecurInfo" class="text-slate-100 font-medium mt-1 text-xs">
                                    Tidak berulang.
                                </dd>
                            </div>
                            <div>
                                <dt class="text-slate-400 text-xs uppercase tracking-wide">Quest points</dt>
                                <dd id="questPoints" class="text-slate-100 font-semibold mt-1">
                                    0 XP
                                </dd>
                            </div>
                        </dl>
                    </div>
                </div>

                <div class="space-y-4">
                    <div class="rounded-2xl border border-slate-800 bg-slate-900/60 p-5">
                        <h2 class="text-xs font-semibold tracking-[0.2em] uppercase text-slate-400 mb-4">
                            People
                        </h2>
                        <dl class="space-y-3 text-sm">
                            <div>
                                <dt class="text-slate-400 text-xs uppercase tracking-wide">Created by</dt>
                                <dd id="questCreatedBy" class="text-slate-100 font-medium mt-1">
                                    -
                                </dd>
                            </div>
                            <div>
                                <dt class="text-slate-400 text-xs uppercase tracking-wide">Departments</dt>
                                <dd id="questDepartments" class="text-slate-100 font-medium mt-1 text-xs">
                                    -
                                </dd>
                            </div>
                            <div>
                                <dt class="text-slate-400 text-xs uppercase tracking-wide">Positions</dt>
                                <dd id="questPositions" class="text-slate-100 font-medium mt-1 text-xs">
                                    -
                                </dd>
                            </div>
                            <div>
                                <dt class="text-slate-400 text-xs uppercase tracking-wide">Assigned to</dt>
                                <dd id="questAssignedTo" class="text-slate-100 font-medium mt-1 text-xs">
                                    -
                                </dd>
                            </div>
                            <div>
                                <dt class="text-slate-400 text-xs uppercase tracking-wide">Notify</dt>
                                <dd id="questNotifyTo" class="text-slate-100 font-medium mt-1 text-xs">
                                    -
                                </dd>
                            </div>
                        </dl>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDyzzEYbJkkl-N8snrQf14qvj8De4YliV0",
            authDomain: "pre-dialogika.firebaseapp.com",
            projectId: "pre-dialogika",
            storageBucket: "pre-dialogika.firebasestorage.app",
            messagingSenderId: "343771410480",
            appId: "1:343771410480:web:32881c9868522090237df5"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const params = new URLSearchParams(window.location.search);
        const taskId = params.get("taskId") || params.get("id");

        const titleEl = document.getElementById("questTitleDisplay");
        const subtitleEl = document.getElementById("questSubtitleDisplay");
        const errorBox = document.getElementById("questErrorBox");
        const bigCheckbox = document.getElementById("questBigCheckbox");
        const bigCheckIcon = document.getElementById("questBigCheckIcon");
        const priorityBadge = document.getElementById("questPriorityBadge");
        const dueBadge = document.getElementById("questDueBadge");
        const statusBadge = document.getElementById("questStatusBadge");
        const tagContainer = document.getElementById("questTagContainer");
        const descEl = document.getElementById("questDescription");
        const reminderModeEl = document.getElementById("questReminderMode");
        const reminderDatesEl = document.getElementById("questReminderDates");
        const recurInfoEl = document.getElementById("questRecurInfo");
        const pointsEl = document.getElementById("questPoints");
        const createdByEl = document.getElementById("questCreatedBy");
        const departmentsEl = document.getElementById("questDepartments");
        const positionsEl = document.getElementById("questPositions");
        const assignedToEl = document.getElementById("questAssignedTo");
        const notifyToEl = document.getElementById("questNotifyTo");

        function formatDateString(d) {
            if (!d) return "";
            const parts = String(d).split("/");
            if (parts.length !== 3) return String(d);
            return parts[0] + "/" + parts[1] + "/" + parts[2];
        }

        function renderTags(tags) {
            tagContainer.innerHTML = "";
            if (!Array.isArray(tags) || tags.length === 0) return;
            tags.forEach(t => {
                if (!t) return;
                const span = document.createElement("span");
                span.className = "inline-flex items-center px-2 py-0.5 rounded-full bg-slate-900 text-amber-300 border border-amber-500/40";
                span.textContent = t;
                tagContainer.appendChild(span);
            });
        }

        function renderPeopleList(arr) {
            if (!Array.isArray(arr) || arr.length === 0) return "-";
            return arr.join(", ");
        }

        function renderNamedCollection(arr) {
            if (!Array.isArray(arr) || arr.length === 0) return "-";
            const names = arr.map(x => x && x.name ? String(x.name) : "").filter(Boolean);
            if (!names.length) return "-";
            return names.join(", ");
        }

        function renderReminderDates(arr) {
            if (!Array.isArray(arr) || arr.length === 0) return "-";
            return arr.slice(0, 5).map(s => {
                const d = new Date(s);
                if (isNaN(d.getTime())) return "";
                const dd = d.getDate().toString().padStart(2, "0");
                const mm = (d.getMonth() + 1).toString().padStart(2, "0");
                const yy = d.getFullYear();
                return dd + "/" + mm + "/" + yy;
            }).filter(Boolean).join(", ");
        }

        function renderRecurInfo(recur) {
            if (!recur) return "Tidak berulang.";
            const unit = recur.unit || "";
            const interval = typeof recur.interval === "number" ? recur.interval : 1;
            if (!unit) return "Tidak berulang.";
            if (unit === "day") return "Setiap " + interval + " hari.";
            if (unit === "week") return "Setiap " + interval + " minggu.";
            if (unit === "month") return "Setiap " + interval + " bulan.";
            return "Berulang (" + unit + ").";
        }

        async function loadQuestDetail() {
            if (!taskId) {
                if (errorBox) errorBox.classList.remove("hidden");
                if (titleEl) titleEl.textContent = "Quest tidak ditemukan";
                return;
            }
            try {
                const snap = await getDoc(doc(db, "tasks", taskId));
                if (!snap.exists()) {
                    if (errorBox) errorBox.classList.remove("hidden");
                    if (titleEl) titleEl.textContent = "Quest tidak ditemukan";
                    return;
                }
                const data = snap.data() || {};
                const title = data.title || "Untitled Quest";
                if (titleEl) titleEl.textContent = title;
                if (subtitleEl) subtitleEl.textContent = "Detail lengkap untuk quest ini.";

                const priority = String(data.priority || "normal").toLowerCase();
                if (priorityBadge) {
                    let label = "Normal";
                    let dot = "bg-slate-500";
                    let bg = "bg-slate-900";
                    let border = "border-slate-700";
                    let text = "text-slate-300";
                    if (priority === "urgent") {
                        label = "Urgent";
                        dot = "bg-red-500";
                        bg = "bg-red-500/10";
                        border = "border-red-500/40";
                        text = "text-red-200";
                    } else if (priority === "high") {
                        label = "High";
                        dot = "bg-orange-400";
                        bg = "bg-orange-500/10";
                        border = "border-orange-500/40";
                        text = "text-orange-200";
                    } else if (priority === "low") {
                        label = "Low";
                        dot = "bg-slate-500";
                    }
                    priorityBadge.className = "inline-flex items-center gap-2 px-3 py-1 rounded-full text-[11px] font-bold uppercase tracking-[0.18em] " + bg + " " + text + " " + border;
                    priorityBadge.innerHTML = '<span class="w-2 h-2 rounded-full ' + dot + '"></span><span>' + label + '</span>';
                }

                const dueText = data.due_date || data.dueDate || "";
                if (dueBadge) {
                    if (dueText) {
                        dueBadge.classList.remove("hidden");
                        const label = formatDateString(dueText);
                        dueBadge.innerHTML = '<i data-lucide="calendar-days" class="w-3 h-3"></i><span>' + label + '</span>';
                    } else {
                        dueBadge.classList.add("hidden");
                    }
                }

                const status = String(data.status || "Initiate");
                if (statusBadge) {
                    let bg = "bg-emerald-500/10";
                    let border = "border-emerald-500/40";
                    let text = "text-emerald-300";
                    let dot = "bg-emerald-400";
                    if (status.toLowerCase() === "complete") {
                        bg = "bg-sky-500/10";
                        border = "border-sky-500/40";
                        text = "text-sky-300";
                        dot = "bg-sky-400";
                    }
                    statusBadge.className = "inline-flex items-center gap-2 px-3 py-1 rounded-full text-[11px] font-bold uppercase tracking-[0.18em] " + bg + " " + text + " " + border;
                    statusBadge.innerHTML = '<span class="w-2 h-2 rounded-full ' + dot + '"></span><span>' + status + '</span>';
                }

                const tags = Array.isArray(data.tags) ? data.tags : [];
                renderTags(tags);

                if (descEl) {
                    const html = data.description || "";
                    if (html) {
                        descEl.innerHTML = html;
                    }
                }

                const reminderMode = data.reminder_mode || null;
                if (reminderModeEl) {
                    reminderModeEl.textContent = reminderMode ? String(reminderMode) : "Tidak ada pengingat.";
                }
                const reminderDates = Array.isArray(data.reminder_dates) ? data.reminder_dates : [];
                if (reminderDatesEl) {
                    reminderDatesEl.textContent = renderReminderDates(reminderDates);
                }

                if (recurInfoEl) {
                    recurInfoEl.textContent = renderRecurInfo(data.recur || null);
                }

                const points = typeof data.points === "number" ? data.points : 0;
                if (pointsEl) {
                    pointsEl.textContent = points + " XP";
                }

                if (createdByEl) {
                    const name = data.created_by_name || data.created_by || "-";
                    createdByEl.textContent = name || "-";
                }
                if (departmentsEl) {
                    departmentsEl.textContent = renderNamedCollection(data.departments || []);
                }
                if (positionsEl) {
                    positionsEl.textContent = renderNamedCollection(data.positions || []);
                }
                if (assignedToEl) {
                    const a = Array.isArray(data.assign_to) ? data.assign_to : (data.assign_to ? [data.assign_to] : []);
                    if (a.length === 0) {
                        assignedToEl.textContent = "-";
                    } else {
                        assignedToEl.textContent = a.length + " orang";
                    }
                }
                if (notifyToEl) {
                    const n = Array.isArray(data.notify_to) ? data.notify_to : (data.notify_to ? [data.notify_to] : []);
                    if (n.length === 0) {
                        notifyToEl.textContent = "-";
                    } else {
                        notifyToEl.textContent = n.length + " orang";
                    }
                }

                if (bigCheckbox && bigCheckIcon) {
                    const isComplete = String(data.status || "").toLowerCase() === "complete";
                    if (isComplete) {
                        bigCheckbox.classList.remove("border-slate-600", "text-slate-500", "bg-slate-950");
                        bigCheckbox.classList.add("bg-emerald-500", "border-emerald-500", "text-white");
                    }
                    bigCheckbox.addEventListener("click", function () {
                        const active = bigCheckbox.classList.contains("bg-emerald-500");
                        if (active) {
                            bigCheckbox.classList.remove("bg-emerald-500", "border-emerald-500", "text-white");
                            bigCheckbox.classList.add("border-slate-600", "text-slate-500", "bg-slate-950");
                        } else {
                            bigCheckbox.classList.remove("border-slate-600", "text-slate-500", "bg-slate-950");
                            bigCheckbox.classList.add("bg-emerald-500", "border-emerald-500", "text-white");
                        }
                    });
                }

                if (window.lucide && window.lucide.createIcons) {
                    window.lucide.createIcons();
                }
            } catch (e) {
                if (errorBox) errorBox.classList.remove("hidden");
                if (titleEl) titleEl.textContent = "Terjadi kesalahan saat memuat quest";
                console.error("Failed to load quest detail", e);
            }
        }

        loadQuestDetail();
    </script>
</body>
</html>
