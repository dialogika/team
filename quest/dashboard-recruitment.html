<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recruitment Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="../assets/css/style.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        body { font-family: 'Poppins', sans-serif; }
        .text-muted-custom {
            color: #636e72;
            font-size: 0.85rem;
        }

        .stat-number {
            font-size: 1.8rem;
            font-weight: 700;
            color: #2d3436;
        }

        .btn-weekly {
            background-color: #fff;
            border: 1px solid #e0e0e0;
            padding: 10px 20px;
            border-radius: 12px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .recruitment-step-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f1f1f1;
        }

        .recruitment-step-item:last-child { border-bottom: none; }

        .progress {
            height: 8px;
            border-radius: 10px;
            background-color: #eee;
        }

        .candidate-photo {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .interview-list-item {
            padding: 15px;
            border-radius: 12px;
            background-color: #f9f9f9;
            margin-bottom: 10px;
        }

        .important-note-box {
            background: linear-gradient(135deg, #0B2B6A, #1c84e3);
            color: #f9fafb;
            padding: 24px 28px;
            border-radius: 18px;
            box-shadow: 0 18px 35px rgba(15, 23, 42, 0.25);
        }

        .important-note-title {
            font-size: 1.1rem;
        }

        .important-note-text {
            font-size: 0.95rem;
            line-height: 1.8;
            opacity: 0.95;
        }

        .important-note-box .btn-edit-notes {
            background-color: #f9fafb;
            color: #111827;
            border: none;
        }

        .important-note-box .btn-edit-notes:hover {
            background-color: #e5e7eb;
            color: #111827;
        }

        .card {
            border: none;
            border-radius: 18px;
        }
    </style>
</head>
<body class="p-8">

    <div id="topbarContainer"></div>

    <div class="dashboard-container">
        <div id="sidebarContainer"></div>

        <main class="main-content">
            <div class="container-fluid">
                <section class="d-flex justify-content-between align-items-center mb-5">
                    <div>
                        <h2 class="fw-bold mb-0" id="greetingText">Good Morning,</h2>
                        <p class="text-muted-custom mb-0" id="dateText">Today is Monday, 09 January 2026</p>
                    </div>
                    <div>
                        <input type="text" id="calendarPicker" class="d-none">
                        <button class="btn btn-weekly" onclick="document.getElementById('calendarPicker')._flatpickr.open()">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                <line x1="16" y1="2" x2="16" y2="6"></line>
                                <line x1="8" y1="2" x2="8" y2="6"></line>
                                <line x1="3" y1="10" x2="21" y2="10"></line>
                            </svg>
                            <span class="calendar-text">Monthly Range</span>
                        </button>
                    </div>
                </section>

                <section class="row g-4 mb-5">
                    <div class="col-md-2">
                        <div class="card p-3 h-100 border-0 shadow">
                            <span class="text-muted-custom">Head Count</span>
                            <div class="stat-number mt-2">
                                12
                                <span id="maxHeadCount" style="font-size: 1rem; color: #b2bec3;">/ -</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="card p-3 h-100 border-0 shadow-sm">
                            <span class="text-muted-custom">Total Applicant</span>
                            <div class="stat-number mt-2">150</div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="card p-3 h-100 border-0 shadow-sm">
                            <span class="text-muted-custom">On Leave</span>
                            <div class="stat-number mt-2 text-danger" id="onLeaveCount">0</div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="card p-3 h-100 border-0 shadow-sm">
                            <span class="text-muted-custom">Scouting</span>
                            <div class="stat-number mt-2" id="scoutingCount">0</div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="card p-3 h-100 border-0 shadow-sm">
                            <span class="text-muted-custom">Onboarding</span>
                            <div class="stat-number mt-2 text-success">3</div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="card p-3 h-100 border-0 shadow-sm">
                            <span class="text-muted-custom">Offboarding</span>
                            <div class="stat-number mt-2">1</div>
                        </div>
                    </div>
                </section>

                <section class="row g-4 mb-5">
                    <div class="col-md-4">
                        <div class="card p-4 h-100">
                            <h5 class="fw-bold mb-4">Recruitment Step</h5>
                            <div class="recruitment-step-item">
                                <span>Screening</span> <span class="badge bg-light text-dark rounded-pill">10</span>
                            </div>
                            <div class="recruitment-step-item">
                                <span>Interview</span> <span class="badge bg-light text-dark rounded-pill">15</span>
                            </div>
                            <div class="recruitment-step-item">
                                <span>Decision</span> <span class="badge bg-light text-dark rounded-pill">14</span>
                            </div>
                            <div class="recruitment-step-item">
                                <span>Accept</span> <span class="badge bg-success-subtle text-success rounded-pill">13</span>
                            </div>
                            <div class="recruitment-step-item border-0">
                                <span>Reject</span> <span class="badge bg-danger-subtle text-danger rounded-pill">25</span>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-4">
                        <div class="card p-4 h-100">
                            <h5 class="fw-bold mb-4">Upcoming Interview</h5>
                            <div class="interview-list-item">
                                <div class="fw-bold">Budi <span class="badge bg-primary-subtle text-primary fw-normal ms-2">Internship</span></div>
                                <div class="text-muted-custom small">Design Specialist • 15 April 2026</div>
                            </div>
                            <div class="interview-list-item">
                                <div class="fw-bold">Andi <span class="badge bg-primary-subtle text-primary fw-normal ms-2">Internship</span></div>
                                <div class="text-muted-custom small">Content Writer • 16 April 2026</div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-4">
                        <div class="card p-4 h-100">
                            <h5 class="fw-bold mb-2">Platform Jobposting</h5>
                            <div class="text-muted-custom mb-4">Total Candidate: <span class="text-dark fw-bold">500</span></div>
                            
                            <div class="mb-3">
                                <div class="d-flex justify-content-between small mb-1">
                                    <span>LinkedIn</span><span>30</span>
                                </div>
                                <div class="progress"><div class="progress-bar bg-primary" style="width: 30%"></div></div>
                            </div>
                            <div class="mb-3">
                                <div class="d-flex justify-content-between small mb-1">
                                    <span>Instagram</span><span>40</span>
                                </div>
                                <div class="progress"><div class="progress-bar bg-info" style="width: 40%"></div></div>
                            </div>
                            <div class="mb-3">
                                <div class="d-flex justify-content-between small mb-1">
                                    <span>Facebook</span><span>20</span>
                                </div>
                                <div class="progress"><div class="progress-bar bg-secondary" style="width: 20%"></div></div>
                            </div>
                        </div>
                    </div>
                </section>

                <section class="row g-4">
                    <div class="col-md-8">
                        <div class="card h-100 important-note-box border-0 d-flex flex-column">
                            <div class="mb-3">
                                <h5 class="fw-bold mb-2 important-note-title">Important Notes</h5><hr/>
                                <p class="important-note-text mb-0">
                                    Perhatikan per bulan ini kita lebih fokus dengan pencarian role IT Senior dan Product Manager. Pastikan screening CV tidak lebih dari 2 hari kerja untuk menjaga candidate experience.
                                </p>
                            </div>
                            <div class="mt-auto pt-2">
                                <button class="btn btn-edit-notes btn-sm rounded-pill px-3 d-inline-flex align-items-center gap-2">
                                    <i class="fas fa-pen"></i>
                                    Edit Notes
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-4">
                        <div class="card p-4 h-100">
                            <h5 class="fw-bold mb-4">Scouting Radar</h5>
                            <div class="d-flex flex-wrap gap-3" id="scoutingRadarList"></div>
                            <p class="text-muted-custom mt-4 mb-0">Baru masuk radar scouting hari ini.</p>
                        </div>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script type="module">
        import { renderTopBar } from "../element/topbar.js";
        import { renderSidebar } from "../element/sidebar.js";
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import {
            getFirestore,
            getDocs,
            collection,
            query,
            where
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { 
            apiKey: "AIzaSyDyzzEYbJkkl-N8snrQf14qvj8De4YliV0",
            authDomain: "pre-dialogika.firebaseapp.com", 
            projectId: "pre-dialogika", 
            storageBucket: "pre-dialogika.firebasestorage.app", 
            messagingSenderId: "343771410480", 
            appId: "1:343771410480:web:32881c9868522090237df5", 
            measurementId: "G-SXN811P3N0" 
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const topbarTarget = document.getElementById('topbarContainer');
        renderTopBar(topbarTarget);

        const sidebarTarget = document.getElementById('sidebarContainer');
        renderSidebar(sidebarTarget);

        window.toggleSidebar = () => {
            const sidebar = document.getElementById('sidebarNav');
            if (sidebar) sidebar.classList.toggle('show');
        };

        onAuthStateChanged(auth, (user) => {
            if (!user) {
                window.location.href = "../index.html";
                return;
            }

            fetchMaxHeadCount();
            loadOnLeaveCount();
            loadScoutingRadar(rangeStart, rangeEnd);
        });

        function updateDateTime() {
            const now = new Date();
            const hours = now.getHours();
            let greeting = "";

            if (hours < 12) greeting = "Good Morning";
            else if (hours < 18) greeting = "Good Afternoon";
            else greeting = "Good Evening";

            const greetingEl = document.getElementById('greetingText');
            const dateEl = document.getElementById('dateText');
            if (greetingEl) greetingEl.innerText = greeting + ",";
                if (dateEl) {
                    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                    dateEl.innerText = "Today is " + now.toLocaleDateString('en-US', options);
                }
        }

        async function fetchMaxHeadCount() {
            try {
                let snap = await getDocs(collection(db, "position"));
                if (snap.empty) {
                    try {
                        const fallbackSnap = await getDocs(collection(db, "positions"));
                        snap = fallbackSnap;
                    } catch (e) {
                        console.warn("Fallback positions collection 'positions' not readable", e);
                    }
                }
                if (snap.empty) return;

                let totalHeadCount = 0;
                snap.forEach(docSnap => {
                    const data = docSnap.data() || {};
                    const value = data.headCount ?? data.quota ?? 0;
                    const num = parseInt(value, 10);
                    if (!Number.isNaN(num)) {
                        totalHeadCount += num;
                    }
                });

                const maxHeadCountEl = document.getElementById('maxHeadCount');
                if (maxHeadCountEl) {
                    maxHeadCountEl.textContent = `/ ${totalHeadCount}`;
                }
            } catch (error) {
                console.error("Failed to fetch max head count:", error);
            }
        }

        function normalizeInternshipDate(value) {
            if (!value) return "";
            let dateObj = null;
            if (typeof value.toDate === "function") {
                dateObj = value.toDate();
            } else if (value instanceof Date) {
                dateObj = value;
            } else if (typeof value === "string" || typeof value === "number") {
                const tmp = new Date(value);
                if (!isNaN(tmp.getTime())) {
                    dateObj = tmp;
                }
            }
            if (!dateObj || isNaN(dateObj.getTime())) return "";
            return dateObj;
        }

        function getInternshipDisplayStatus(u) {
            const base = (u.status || "").toLowerCase();
            const end = u.endDateObj instanceof Date && !isNaN(u.endDateObj.getTime()) ? u.endDateObj : null;
            const today = new Date();
            const todayMid = new Date(today.getFullYear(), today.getMonth(), today.getDate());
            let label = u.status || "-";
            let type = "success";

            if (base === "left") {
                label = "Left";
                type = "danger";
                return { label, type };
            }

            if (base === "graduate") {
                label = "Graduate";
                type = "success";
                return { label, type };
            }

            if (!end) {
                label = u.status || "Active";
                type = "success";
                return { label, type };
            }

            const endMid = new Date(end.getFullYear(), end.getMonth(), end.getDate());
            const diffDays = Math.round((endMid - todayMid) / 86400000);
            if (diffDays < 0) {
                label = "Graduate";
                type = "success";
            } else if (diffDays <= 20) {
                label = "On Leave";
                type = "warning";
            } else {
                label = "Active";
                type = "success";
            }
            return { label, type };
        }

        async function loadOnLeaveCount() {
            try {
                const onLeaveEl = document.getElementById("onLeaveCount");
                if (!onLeaveEl) return;

                const usersRef = collection(db, "users");
                const q = query(usersRef, where("role", "in", ["Internship", "internship"]));
                const snap = await getDocs(q);

                const list = [];
                snap.forEach(docSnap => {
                    const data = docSnap.data() || {};
                    const employment = data.employment || {};
                    const status = data.status || data.internshipStatus || "";
                    const endDateRaw = data.endDate || data.internshipEndDate || (data.internship && data.internship.endDate) || employment.endDate || employment.end_date || null;
                    const endDateObj = normalizeInternshipDate(endDateRaw);

                    list.push({
                        status,
                        endDateObj
                    });
                });

                let onLeaveCount = 0;
                list.forEach(u => {
                    const s = getInternshipDisplayStatus(u).label;
                    if (s === "On Leave") onLeaveCount += 1;
                });

                onLeaveEl.textContent = onLeaveCount.toString();
            } catch (error) {
                console.error("Failed to load on leave count:", error);
            }
        }

        async function loadScoutingRadar(startDate, endDate) {
            try {
                const container = document.getElementById('scoutingRadarList');
                const scoutingCountEl = document.getElementById('scoutingCount');
                if (container) container.innerHTML = "";

                const talentsRef = collection(db, "talents");
                const q = query(talentsRef, where("recruitment_status.current", "==", "radar"));
                const snap = await getDocs(q);

                if (!container && !scoutingCountEl) return;

                const talents = [];
                snap.forEach(docSnap => {
                    talents.push({ id: docSnap.id, data: docSnap.data() || {} });
                });

                let filteredTalents = talents;
                if (startDate && endDate) {
                    const s = new Date(startDate);
                    const e = new Date(endDate);
                    s.setHours(0, 0, 0, 0);
                    e.setHours(23, 59, 59, 999);
                    filteredTalents = talents.filter(item => {
                        const data = item.data || {};
                        const raw = data.created_at || data.createdAt || data.created || null;
                        if (!raw) return false;
                        let d = null;
                        if (raw && typeof raw.toDate === "function") {
                            d = raw.toDate();
                        } else if (raw instanceof Date) {
                            d = raw;
                        } else {
                            const tmp = new Date(raw);
                            if (!isNaN(tmp.getTime())) d = tmp;
                        }
                        if (!d) return false;
                        return d >= s && d <= e;
                    });
                }

                if (scoutingCountEl) {
                    scoutingCountEl.textContent = filteredTalents.length ? String(filteredTalents.length) : "0";
                }

                if (!container || !filteredTalents.length) return;

                const maxVisible = 5;
                const visible = filteredTalents.slice(0, maxVisible);
                const remaining = filteredTalents.length - visible.length;

                visible.forEach(item => {
                    const basic = item.data.basic_info || {};
                    const scouting = item.data.scouting_info || {};
                    const recruitment = item.data.recruitment_status || {};
                    const name = basic.full_name || scouting.full_name || item.data.full_name || "Tanpa Nama";
                    const avatarUrl = basic.avatar_url || item.data.photo || "";

                    const img = document.createElement('img');
                    img.src = avatarUrl || ("https://i.pravatar.cc/150?u=" + item.id);
                    img.alt = name;
                    img.className = "candidate-photo";
                    img.setAttribute("data-bs-toggle", "tooltip");
                    img.setAttribute("data-bs-placement", "top");
                    img.setAttribute("title", name);
                    container.appendChild(img);
                });

                if (remaining > 0) {
                    const moreDiv = document.createElement('div');
                    moreDiv.className = "candidate-photo bg-light d-flex align-items-center justify-content-center text-muted small fw-bold";
                    moreDiv.textContent = "+" + remaining;
                    container.appendChild(moreDiv);
                }

                if (typeof bootstrap !== "undefined" && bootstrap.Tooltip) {
                    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
                    tooltipTriggerList.forEach(el => {
                        bootstrap.Tooltip.getOrCreateInstance(el);
                    });
                }
            } catch (error) {
                console.error("Failed to load scouting radar talents:", error);
            }
        }

        const calendarButton = document.querySelector('.btn-weekly');
        const calendarTextEl = calendarButton ? calendarButton.querySelector('.calendar-text') : null;

        const today = new Date();
        const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
        let rangeStart = startOfMonth;
        let rangeEnd = today;

        function formatDate(date) {
            const options = { day: 'numeric', month: 'short', year: 'numeric' };
            return date.toLocaleDateString('id-ID', options);
        }

        flatpickr("#calendarPicker", {
            mode: "range",
            dateFormat: "Y-m-d",
            positionElement: calendarButton || undefined,
            defaultDate: [startOfMonth, today],
            onChange: (selectedDates) => {
                if (selectedDates.length === 2) {
                    rangeStart = selectedDates[0];
                    rangeEnd = selectedDates[1];
                    if (calendarTextEl) {
                        const startDate = formatDate(rangeStart);
                        const endDate = formatDate(rangeEnd);
                        calendarTextEl.textContent = `${startDate} - ${endDate}`;
                    }
                    loadScoutingRadar(rangeStart, rangeEnd);
                }
            }
        });

        if (calendarTextEl) {
            calendarTextEl.textContent = `${formatDate(startOfMonth)} - ${formatDate(today)}`;
        }

        updateDateTime();
    </script>
</body>
</html>
