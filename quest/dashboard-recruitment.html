<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recruitment Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="../assets/css/style.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        body { font-family: 'Poppins', sans-serif; }
        .text-muted-custom {
            color: #636e72;
            font-size: 0.85rem;
        }

        .stat-number {
            font-size: 1.8rem;
            font-weight: 700;
            color: #2d3436;
        }

        .btn-weekly {
            background-color: #fff;
            border: 1px solid #e0e0e0;
            padding: 10px 20px;
            border-radius: 12px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .recruitment-step-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f1f1f1;
        }

        .recruitment-step-item:last-child { border-bottom: none; }

        .progress {
            height: 8px;
            border-radius: 10px;
            background-color: #eee;
        }

        .candidate-photo {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        #stepScreeningAvatars .candidate-photo,
        #stepInterviewAvatars .candidate-photo,
        #stepDecisionAvatars .candidate-photo,
        #stepAcceptedAvatars .candidate-photo,
        #stepRejectedAvatars .candidate-photo {
            width: 26px;
            height: 26px;
            border-width: 1px;
        }

        .interview-list-item {
            padding: 15px;
            border-radius: 12px;
            background-color: #f9f9f9;
            margin-bottom: 10px;
        }

        .important-note-box {
            background: linear-gradient(135deg, #0B2B6A, #1c84e3);
            color: #f9fafb;
            padding: 24px 28px;
            border-radius: 18px;
            box-shadow: 0 18px 35px rgba(15, 23, 42, 0.25);
        }

        .important-note-title {
            font-size: 1.1rem;
        }

        .important-note-text {
            font-size: 0.95rem;
            line-height: 1.8;
            opacity: 0.95;
        }

        .important-note-box .btn-edit-notes {
            background-color: #f9fafb;
            color: #111827;
            border: none;
        }

        .important-note-box .btn-edit-notes:hover {
            background-color: #e5e7eb;
            color: #111827;
        }

        .card {
            border: none;
            border-radius: 18px;
        }

        .stats-clickable {
            cursor: pointer;
        }

        .stats-clickable:focus-visible {
            outline: 3px solid rgba(13, 110, 253, 0.35);
            outline-offset: 2px;
        }

        .stats-modal-photo {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            object-fit: cover;
            border: 1px solid rgba(0,0,0,0.08);
        }

        .sticky-menu-trigger {
            position: fixed;
            right: 30px;
            top: 30%;
            z-index: 1000;
            cursor: pointer;
            background: linear-gradient(to bottom, #0f61a8 5%, #0b2b6a 100%);
            color: #ffffff;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0px 5px 16px -6px rgba(114, 4, 207, 1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .sticky-menu-trigger:hover {
            transform: scale(1.05) rotate(90deg);
        }

        .menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(8px);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.4s ease;
        }

        .menu-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .menu-container {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -60%) scale(0.9);
            z-index: 1001;
            width: 90%;
            max-width: 800px;
            background: rgba(255, 255, 255, 0.95);
            padding: 32px;
            border-radius: 24px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            opacity: 0;
            visibility: hidden;
            transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .menu-container.active {
            opacity: 1;
            visibility: visible;
            transform: translate(-50%, -50%) scale(1);
        }

        .menu-header {
            text-align: center;
            margin-bottom: 24px;
        }

        .menu-header h2 {
            font-size: 1.4rem;
            font-weight: 600;
            color: #334155;
        }

        .menu-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
        }

        .menu-item {
            background: #ffffff;
            padding: 24px 16px;
            border-radius: 16px;
            text-align: center;
            text-decoration: none;
            color: #1f2933;
            transition: all 0.3s ease;
            border: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
        }

        .menu-item:hover {
            background: #0B2B6A;
            color: #ffffff;
            transform: translateY(-4px);
            box-shadow: 0 15px 30px rgba(11, 43, 106, 0.35);
            border-color: #0B2B6A;
        }

        .menu-item i {
            width: 40px;
            height: 40px;
            stroke-width: 1.5;
        }

        .menu-item span {
            font-weight: 600;
            font-size: 0.95rem;
        }

        .close-btn {
            position: absolute;
            top: 16px;
            right: 16px;
            cursor: pointer;
            color: #64748b;
            transition: color 0.3s;
        }

        .close-btn:hover {
            color: #ef4444;
        }

        @media (max-width: 600px) {
            .menu-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .menu-item {
                padding: 20px 10px;
            }
        }
    </style>
</head>
<body class="p-8">

    <div id="topbarContainer"></div>

    <div class="dashboard-container">
        <div id="sidebarContainer"></div>

        <main class="main-content">
            <div class="container-fluid">
                <section class="d-flex justify-content-between align-items-center mb-5">
                    <div>
                        <h2 class="fw-bold mb-0" id="greetingText">Good Morning,</h2>
                        <p class="text-muted-custom mb-0" id="dateText">Today is Monday, 09 January 2026</p>
                    </div>
                    <div>
                        <input type="text" id="calendarPicker" class="d-none">
                        <button class="btn btn-weekly" onclick="document.getElementById('calendarPicker')._flatpickr.open()">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                <line x1="16" y1="2" x2="16" y2="6"></line>
                                <line x1="8" y1="2" x2="8" y2="6"></line>
                                <line x1="3" y1="10" x2="21" y2="10"></line>
                            </svg>
                            <span class="calendar-text">Monthly Range</span>
                        </button>
                    </div>
                </section>

                <section class="row g-4 mb-5">
                    <div class="col-md-2">
                        <div class="card p-3 h-100 border-0 shadow-sm stats-clickable" id="headCountCard" tabindex="0">
                            <span class="text-muted-custom">Head Count</span>
                            <div class="stat-number mt-2">
                                <span id="currentHeadCount">0</span>
                                <span id="maxHeadCount" style="font-size: 1rem; color: #b2bec3;">/ -</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="card p-3 h-100 border-0 shadow-sm stats-clickable" id="applicantsCard" tabindex="0">
                            <span class="text-muted-custom">Applicants</span>
                            <div class="stat-number mt-2" id="applicantsCount">0</div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="card p-3 h-100 border-0 shadow-sm stats-clickable" id="onLeaveCard" tabindex="0">
                            <span class="text-muted-custom">On Leave</span>
                            <div class="stat-number mt-2 text-danger" id="onLeaveCount">0</div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="card p-3 h-100 border-0 shadow-sm stats-clickable" id="scoutingCard" tabindex="0">
                            <span class="text-muted-custom">Scouting</span>
                            <div class="stat-number mt-2" id="scoutingCount">0</div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="card p-3 h-100 border-0 shadow-sm stats-clickable" id="onboardingCard" tabindex="0">
                            <span class="text-muted-custom">Onboarding</span>
                            <div class="stat-number mt-2 text-success" id="onboardingCount">0</div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="card p-3 h-100 border-0 shadow-sm stats-clickable" id="offboardingCard" tabindex="0">
                            <span class="text-muted-custom">Offboarding</span>
                            <div class="stat-number mt-2" id="offboardingCount">0</div>
                        </div>
                    </div>
                </section>

                <section class="row g-4 mb-5">
                    <div class="col-md-4">
                        <div class="card p-4 h-100 shadow-sm">
                            <h5 class="fw-bold mb-4">Recruitment Step</h5>
                            <div class="recruitment-step-item">
                                <span>Screening</span>
                                <div class="d-flex align-items-center gap-2">
                                    <div class="d-flex flex-wrap align-items-center gap-2" id="stepScreeningAvatars"></div>
                                    <span class="badge bg-light text-dark rounded-pill" id="stepScreeningCount">0</span>
                                </div>
                            </div>
                            <div class="recruitment-step-item">
                                <span>Interview</span>
                                <div class="d-flex align-items-center gap-2">
                                    <div class="d-flex flex-wrap align-items-center gap-2" id="stepInterviewAvatars"></div>
                                    <span class="badge bg-light text-dark rounded-pill" id="stepInterviewCount">0</span>
                                </div>
                            </div>
                            <div class="recruitment-step-item">
                                <span>Decision</span>
                                <div class="d-flex align-items-center gap-2">
                                    <div class="d-flex flex-wrap align-items-center gap-2" id="stepDecisionAvatars"></div>
                                    <span class="badge bg-light text-dark rounded-pill" id="stepDecisionCount">0</span>
                                </div>
                            </div>
                            <div class="recruitment-step-item">
                                <span>Accepted</span>
                                <div class="d-flex align-items-center gap-2">
                                    <div class="d-flex flex-wrap align-items-center gap-2" id="stepAcceptedAvatars"></div>
                                    <span class="badge bg-success-subtle text-success rounded-pill" id="stepAcceptedCount">0</span>
                                </div>
                            </div>
                            <div class="recruitment-step-item border-0">
                                <span>Rejected</span>
                                <div class="d-flex align-items-center gap-2">
                                    <div class="d-flex flex-wrap align-items-center gap-2" id="stepRejectedAvatars"></div>
                                    <span class="badge bg-danger-subtle text-danger rounded-pill" id="stepRejectedCount">0</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-4">
                        <div class="card p-4 h-100 shadow-sm">
                            <h5 class="fw-bold mb-4">Upcoming Interview</h5>
                            <div id="upcomingInterviewList"></div>
                        </div>
                    </div>

                    <div class="col-md-4">
                        <div class="card p-4 h-100 shadow-sm">
                            <h5 class="fw-bold mb-2">Platform Jobposting</h5>
                            <div class="text-muted-custom mb-4">Total Candidate: <span class="text-dark fw-bold" id="platformTotalCandidate">0</span></div>
                            <div id="platformJobpostingList"></div>
                        </div>
                    </div>
                </section>

                <section class="row g-4">
                    <div class="col-md-8">
                        <div class="card h-100 important-note-box border-0 d-flex flex-column">
                            <div class="mb-3">
                                <h5 class="fw-bold mb-2 important-note-title">Important Notes</h5><hr/>
                                <p class="important-note-text mb-0" id="recruitmentImportantNotesText">
                                    Perhatikan per bulan ini kita lebih fokus dengan pencarian role IT Senior dan Product Manager. Pastikan screening CV tidak lebih dari 2 hari kerja untuk menjaga candidate experience.
                                </p>
                            </div>
                            <div class="mt-auto pt-2">
                                <button class="btn btn-edit-notes btn-sm rounded-pill px-3 d-inline-flex align-items-center gap-2" id="editRecruitmentNotesBtn">
                                    <i class="fas fa-pen"></i>
                                    Edit Notes
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-4">
                        <div class="card p-4 h-100 shadow-sm">
                            <h5 class="fw-bold mb-4">Scouting Radar</h5>
                            <div class="d-flex flex-wrap gap-3" id="scoutingRadarList"></div>
                            <p class="text-muted-custom mt-4 mb-0">Baru masuk radar scouting hari ini.</p>
                        </div>
                    </div>
                </section>

                <section class="row g-4 mb-5" style="margin-top: 10px;">
                    <div class="col-md-4">
                        <div class="card p-4 h-100 shadow-sm">
                            <h5 class="fw-bold mb-3">Internship Radar</h5>
                            <div class="d-flex flex-wrap gap-3" id="internshipRadarList"></div>
                            <p class="text-muted-custom mt-4 mb-0 small">Candidate internship yang terdaftar di sistem.</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card p-4 h-100 shadow-sm">
                            <h5 class="fw-bold mb-3">Mentor Radar</h5>
                            <div class="d-flex flex-wrap gap-3" id="mentorRadarList"></div>
                            <p class="text-muted-custom mt-4 mb-0 small">Candidate mentor yang terdaftar di sistem.</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card p-4 h-100 shadow-sm">
                            <h5 class="fw-bold mb-3">Team Radar</h5>
                            <div class="d-flex flex-wrap gap-3" id="teamRadarList"></div>
                            <p class="text-muted-custom mt-4 mb-0 small">Candidate team selain internship dan mentor.</p>
                        </div>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <div class="modal fade" id="statsDetailsModal" tabindex="-1" aria-labelledby="statsDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="statsDetailsModalLabel">Detail</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div class="text-muted small" id="statsDetailsModalSubtitle"></div>
                        <div class="text-muted small" id="statsDetailsModalCount"></div>
                    </div>
                    <div id="statsDetailsModalBody"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="recruitmentNotesModal" tabindex="-1" aria-labelledby="recruitmentNotesModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="recruitmentNotesModalLabel">Important Notes</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <textarea class="form-control" id="recruitmentNotesInput" rows="8" placeholder="Tulis notes..."></textarea>
                    </div>
                    <div class="d-flex justify-content-end gap-2">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                        <button type="button" class="btn btn-primary" id="saveRecruitmentNotesBtn">Simpan</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script type="module">
        import { renderTopBar } from "../element/topbar.js";
        import { renderSidebar } from "../element/sidebar.js";
        import { renderRightbarRecruit } from "../element/rightbar-recruit.js";
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import {
            getFirestore,
            getDocs,
            collection,
            query,
            where,
            doc,
            getDoc,
            setDoc,
            serverTimestamp
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { 
            apiKey: "AIzaSyDyzzEYbJkkl-N8snrQf14qvj8De4YliV0",
            authDomain: "pre-dialogika.firebaseapp.com", 
            projectId: "pre-dialogika", 
            storageBucket: "pre-dialogika.firebasestorage.app", 
            messagingSenderId: "343771410480", 
            appId: "1:343771410480:web:32881c9868522090237df5", 
            measurementId: "G-SXN811P3N0" 
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let currentUser = null;
        const recruitmentNotesRef = doc(db, "recruitment_dashboard_notes", "default");

        const topbarTarget = document.getElementById('topbarContainer');
        renderTopBar(topbarTarget);

        const sidebarTarget = document.getElementById('sidebarContainer');
        renderSidebar(sidebarTarget);
        renderRightbarRecruit();

        window.app = app;
        window.auth = auth;
        window.db = db;
        window.collection = collection;
        window.getDocs = getDocs;
        window.query = query;
        window.where = where;

        window.toggleSidebar = () => {
            const sidebar = document.getElementById('sidebarNav');
            if (sidebar) sidebar.classList.toggle('show');
        };

        onAuthStateChanged(auth, (user) => {
            if (!user) {
                window.location.href = "../index.html";
                return;
            }

            currentUser = user;
            loadRecruitmentNotes();
            refreshDashboard(rangeStart, rangeEnd);
        });

        function updateDateTime() {
            const now = new Date();
            const hours = now.getHours();
            let greeting = "";

            if (hours < 12) greeting = "Good Morning";
            else if (hours < 18) greeting = "Good Afternoon";
            else greeting = "Good Evening";

            const greetingEl = document.getElementById('greetingText');
            const dateEl = document.getElementById('dateText');
            if (greetingEl) greetingEl.innerText = greeting + ",";
                if (dateEl) {
                    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                    dateEl.innerText = "Today is " + now.toLocaleDateString('en-US', options);
                }
        }

        async function fetchMaxHeadCount() {
            try {
                let snap = await getDocs(collection(db, "position"));
                if (snap.empty) {
                    try {
                        const fallbackSnap = await getDocs(collection(db, "positions"));
                        snap = fallbackSnap;
                    } catch (e) {
                        console.warn("Fallback positions collection 'positions' not readable", e);
                    }
                }
                if (snap.empty) return;

                let totalHeadCount = 0;
                snap.forEach(docSnap => {
                    const data = docSnap.data() || {};
                    const value = data.headCount ?? data.quota ?? 0;
                    const num = parseInt(value, 10);
                    if (!Number.isNaN(num)) {
                        totalHeadCount += num;
                    }
                });

                const maxHeadCountEl = document.getElementById('maxHeadCount');
                if (maxHeadCountEl) {
                    maxHeadCountEl.textContent = `/ ${totalHeadCount}`;
                }
            } catch (error) {
                console.error("Failed to fetch max head count:", error);
            }
        }

        function normalizeInternshipDate(value) {
            if (!value) return "";
            let dateObj = null;
            if (typeof value.toDate === "function") {
                dateObj = value.toDate();
            } else if (value instanceof Date) {
                dateObj = value;
            } else if (typeof value === "string" || typeof value === "number") {
                let tmp = null;
                if (typeof value === "string") {
                    const isoDateOnly = value.trim();
                    const m = isoDateOnly.match(/^(\d{4})-(\d{2})-(\d{2})$/);
                    if (m) {
                        tmp = new Date(Number(m[1]), Number(m[2]) - 1, Number(m[3]));
                    } else {
                        tmp = new Date(value);
                    }
                } else {
                    tmp = new Date(value);
                }
                if (!isNaN(tmp.getTime())) {
                    dateObj = tmp;
                }
            }
            if (!dateObj || isNaN(dateObj.getTime())) return "";
            return dateObj;
        }

        function getInternshipDisplayStatus(u, referenceDate = new Date()) {
            const base = (u.status || "").toLowerCase();
            const end = u.endDateObj instanceof Date && !isNaN(u.endDateObj.getTime()) ? u.endDateObj : null;
            const ref = referenceDate instanceof Date && !isNaN(referenceDate.getTime()) ? referenceDate : new Date();
            const refMid = new Date(ref.getFullYear(), ref.getMonth(), ref.getDate());
            let label = u.status || "-";
            let type = "success";

            if (base === "left") {
                label = "Left";
                type = "danger";
                return { label, type };
            }

            if (base === "graduate") {
                label = "Graduate";
                type = "success";
                return { label, type };
            }

            if (!end) {
                label = u.status || "Active";
                type = "success";
                return { label, type };
            }

            const endMid = new Date(end.getFullYear(), end.getMonth(), end.getDate());
            const diffDays = Math.round((endMid - refMid) / 86400000);
            if (diffDays < 0) {
                label = "Graduate";
                type = "success";
            } else if (diffDays <= 20) {
                label = "On Leave";
                type = "warning";
            } else {
                label = "Active";
                type = "success";
            }
            return { label, type };
        }

        function normalizeRangeDates(startDate, endDate) {
            if (!startDate || !endDate) return { s: null, e: null };
            const s = new Date(startDate);
            const e = new Date(endDate);
            if (isNaN(s.getTime()) || isNaN(e.getTime())) return { s: null, e: null };
            s.setHours(0, 0, 0, 0);
            e.setHours(23, 59, 59, 999);
            return { s, e };
        }

        function isDateInRange(dateObj, s, e) {
            if (!(dateObj instanceof Date) || isNaN(dateObj.getTime())) return false;
            if (!(s instanceof Date) || !(e instanceof Date)) return false;
            return dateObj >= s && dateObj <= e;
        }

        function getUserInternshipDates(data) {
            const employment = (data && data.employment) || {};
            const startDateRaw = data.internshipStartDate || (data.internship && data.internship.startDate) || employment.startDate || employment.start_date || null;
            const endDateRaw = data.endDate || data.internshipEndDate || (data.internship && data.internship.endDate) || employment.endDate || employment.end_date || null;
            return {
                startDateObj: normalizeInternshipDate(startDateRaw),
                endDateObj: normalizeInternshipDate(endDateRaw)
            };
        }

        function isUserActiveInRange(startDateObj, endDateObj, s, e) {
            if (!(s instanceof Date) || !(e instanceof Date)) return true;
            const hasStart = startDateObj instanceof Date && !isNaN(startDateObj.getTime());
            const hasEnd = endDateObj instanceof Date && !isNaN(endDateObj.getTime());
            if (!hasStart && !hasEnd) return true;
            if (hasStart && startDateObj > e) return false;
            if (hasEnd && endDateObj < s) return false;
            return true;
        }

        function getTalentCreatedAtDate(data) {
            const raw = (data && (data.created_at || data.createdAt || data.created)) ?? null;
            return normalizeInternshipDate(raw);
        }

        function normalizeCompact(value) {
            return (value || "").toString().trim().toLowerCase().replace(/\s/g, "");
        }

        function getTalentRolePair(data) {
            const scouting = (data && data.scouting_info) || {};
            const internship = (data && (data.internship || data.internship_info)) || {};
            const basic = (data && data.basic_info) || {};
            const roleIdRaw = data.role_id || data.roleId || scouting.role_id || internship.role_id || "";
            const roleNameRaw = data.role_name || data.role || basic.current_role || scouting.role_name || "";
            return {
                roleId: normalizeCompact(roleIdRaw),
                roleName: normalizeCompact(roleNameRaw)
            };
        }

        function getUserDisplay(data, id) {
            const employment = (data && data.employment) || {};
            const name = data.name || data.fullName || data.username || data.email || "";
            const role = data.role || "-";
            const position = data.position || employment.position || "-";
            const photo = data.photo || `https://i.pravatar.cc/150?u=${id}`;
            return { id, photo, name, role, position };
        }

        function getTalentDisplay(data, id) {
            const basic = (data && data.basic_info) || {};
            const scouting = (data && data.scouting_info) || {};
            const internship = (data && (data.internship || data.internship_info)) || {};
            const photo = basic.avatar_url || data.photo || "";
            const name = basic.full_name || scouting.full_name || data.full_name || "Tanpa Nama";
            const role = data.role_name || data.role || scouting.role_name || data.role_id || scouting.role_id || "-";
            const position =
                data.position ||
                scouting.position ||
                internship.position ||
                data.position_name ||
                data.positionName ||
                (data.employment && data.employment.position) ||
                "-";
            return { id, photo, name, role, position };
        }

        function getAcceptedStatusDate(data) {
            const recruitment = (data && (data.recruitment_status || data.recruitment_system)) || {};
            const historyArray = Array.isArray(recruitment.history) ? recruitment.history : [];
            const acceptedEntries = historyArray.filter(entry => {
                const st = normalizeStatus(entry && entry.status);
                return st === "accept" || st === "accepted";
            });
            if (!acceptedEntries.length) return null;
            let latestDate = null;
            acceptedEntries.forEach(entry => {
                const d = normalizeInternshipDate(entry && entry.date);
                if (d instanceof Date && !isNaN(d.getTime())) {
                    if (!latestDate || d > latestDate) latestDate = d;
                }
            });
            return latestDate;
        }

        async function loadOnLeaveCount(startDate, endDate) {
            try {
                const onLeaveEl = document.getElementById("onLeaveCount");
                const headCountEl = document.getElementById("currentHeadCount");
                const offboardingEl = document.getElementById("offboardingCount");
                if (!onLeaveEl && !headCountEl && !offboardingEl) return;

                const { s, e } = normalizeRangeDates(startDate, endDate);

                const usersRef = collection(db, "users");
                const q = query(usersRef, where("role", "in", ["Internship", "internship"]));
                const snap = await getDocs(q);

                const list = [];
                snap.forEach(docSnap => {
                    const data = docSnap.data() || {};
                    const status = data.status || data.internshipStatus || "";
                    const { startDateObj, endDateObj } = getUserInternshipDates(data);

                    list.push({
                        id: docSnap.id,
                        data,
                        status,
                        startDateObj,
                        endDateObj
                    });
                });

                const filtered = s && e ? list.filter(u => isUserActiveInRange(u.startDateObj, u.endDateObj, s, e)) : list;
                if (headCountEl) headCountEl.textContent = filtered.length.toString();

                let onLeaveCount = 0;
                let graduateCount = 0;
                const refDate = e || new Date();
                filtered.forEach(u => {
                    const label = getInternshipDisplayStatus(u, refDate).label;
                    if (label === "On Leave") onLeaveCount += 1;
                    if (label === "Graduate") {
                        if (!e) {
                            graduateCount += 1;
                        } else if (u.endDateObj instanceof Date && !isNaN(u.endDateObj.getTime())) {
                            if (isDateInRange(u.endDateObj, s, e)) graduateCount += 1;
                        }
                    }
                });

                if (onLeaveEl) {
                    onLeaveEl.textContent = onLeaveCount.toString();
                }
                if (offboardingEl) {
                    offboardingEl.textContent = graduateCount.toString();
                }
            } catch (error) {
                console.error("Failed to load on leave count:", error);
            }
        }

        function normalizeStatus(value) {
            if (!value) return "";
            return value.toString().trim().toLowerCase();
        }

        async function fetchTalentsItems() {
            const snap = await getDocs(collection(db, "talents"));
            const items = [];
            snap.forEach(docSnap => {
                items.push({ id: docSnap.id, data: docSnap.data() || {} });
            });
            return items;
        }

        async function loadOnboardingCount(startDate, endDate, talentsItems) {
            try {
                const el = document.getElementById("onboardingCount");
                if (!el) return;
                const items = Array.isArray(talentsItems) ? talentsItems : await fetchTalentsItems();
                const { s, e } = normalizeRangeDates(startDate, endDate);
                let count = 0;
                items.forEach(item => {
                    const data = item.data || {};
                    const recruitment = data.recruitment_status || data.recruitment_system || {};
                    const current = normalizeStatus(recruitment.current || "");
                    if (current !== "accept" && current !== "accepted") return;
                    const latestDate = getAcceptedStatusDate(data);
                    if (!latestDate) return;
                    if (s && e) {
                        if (latestDate >= s && latestDate <= e) count += 1;
                    } else {
                        count += 1;
                    }
                });
                el.textContent = count.toString();
            } catch (error) {
                console.error("Failed to load onboarding count:", error);
            }
        }

        async function loadRecruitmentStats(talentsItems) {
            try {
                const screeningEl = document.getElementById("stepScreeningCount");
                const interviewEl = document.getElementById("stepInterviewCount");
                const decisionEl = document.getElementById("stepDecisionCount");
                const acceptedEl = document.getElementById("stepAcceptedCount");
                const rejectedEl = document.getElementById("stepRejectedCount");
                const screeningAvatarsEl = document.getElementById("stepScreeningAvatars");
                const interviewAvatarsEl = document.getElementById("stepInterviewAvatars");
                const decisionAvatarsEl = document.getElementById("stepDecisionAvatars");
                const acceptedAvatarsEl = document.getElementById("stepAcceptedAvatars");
                const rejectedAvatarsEl = document.getElementById("stepRejectedAvatars");

                const items = Array.isArray(talentsItems) ? talentsItems : await fetchTalentsItems();

                let screeningCount = 0;
                let interviewCount = 0;
                let decisionCount = 0;
                let acceptedCount = 0;
                let rejectedCount = 0;
                const screeningItems = [];
                const interviewItems = [];
                const decisionItems = [];
                const acceptedItems = [];
                const rejectedItems = [];

                items.forEach(item => {
                    const data = item.data || {};
                    const recruitment = data.recruitment_status || {};
                    const currentRaw = recruitment.current || "";
                    const current = normalizeStatus(currentRaw);
                    const display = getTalentDisplay(data, item.id);
                    const row = { id: item.id, name: display.name, avatarUrl: display.photo };

                    if (current === "screening") {
                        screeningCount += 1;
                        screeningItems.push(row);
                    } else if (current === "interview") {
                        interviewCount += 1;
                        interviewItems.push(row);
                    } else if (current === "decision") {
                        decisionCount += 1;
                        decisionItems.push(row);
                    } else if (current === "accepted" || current === "accept") {
                        acceptedCount += 1;
                        acceptedItems.push(row);
                    } else if (current === "rejected" || current === "reject") {
                        rejectedCount += 1;
                        rejectedItems.push(row);
                    }
                });

                if (screeningEl) screeningEl.textContent = screeningCount.toString();
                if (interviewEl) interviewEl.textContent = interviewCount.toString();
                if (decisionEl) decisionEl.textContent = decisionCount.toString();
                if (acceptedEl) acceptedEl.textContent = acceptedCount.toString();
                if (rejectedEl) rejectedEl.textContent = rejectedCount.toString();

                renderRadarAvatars(screeningAvatarsEl, screeningItems);
                renderRadarAvatars(interviewAvatarsEl, interviewItems);
                renderRadarAvatars(decisionAvatarsEl, decisionItems);
                renderRadarAvatars(acceptedAvatarsEl, acceptedItems);
                renderRadarAvatars(rejectedAvatarsEl, rejectedItems);
            } catch (error) {
                console.error("Failed to load recruitment stats:", error);
            }
        }

        async function loadApplicantsCount(startDate, endDate, talentsItems) {
            try {
                const el = document.getElementById("applicantsCount");
                if (!el) return;
                const { s, e } = normalizeRangeDates(startDate, endDate);
                const items = Array.isArray(talentsItems) ? talentsItems : await fetchTalentsItems();
                const allowed = new Set(["internship", "mentor", "subteam", "employee", "superteam"]);
                let count = 0;
                items.forEach(item => {
                    const data = item.data || {};
                    const createdAt = getTalentCreatedAtDate(data);
                    if (s && e && !isDateInRange(createdAt, s, e)) return;
                    const { roleId, roleName } = getTalentRolePair(data);
                    if (!allowed.has(roleId) && !allowed.has(roleName)) return;
                    count += 1;
                });
                el.textContent = count.toString();
            } catch (error) {
                console.error("Failed to load applicants count:", error);
            }
        }

        function normalizeRolePair(roleIdRaw, roleNameRaw) {
            const idVal = (roleIdRaw || "").toString().trim().toLowerCase();
            const nameVal = (roleNameRaw || "").toString().trim().toLowerCase();
            return {
                normalizedRoleId: idVal.replace(/\s/g, ""),
                normalizedRoleName: nameVal.replace(/\s/g, "")
            };
        }

        function renderRadarAvatars(container, items) {
            if (!container) return;
            container.innerHTML = "";
            if (!items.length) return;

            const maxVisible = 5;
            const visible = items.slice(0, maxVisible);
            const remaining = items.length - visible.length;

            visible.forEach(item => {
                const img = document.createElement('img');
                img.src = item.avatarUrl || ("https://i.pravatar.cc/150?u=" + item.id);
                img.alt = item.name;
                img.className = "candidate-photo";
                img.setAttribute("data-bs-toggle", "tooltip");
                img.setAttribute("data-bs-placement", "top");
                img.setAttribute("title", item.name);
                container.appendChild(img);
            });

            if (remaining > 0) {
                const moreDiv = document.createElement('div');
                moreDiv.className = "candidate-photo bg-light d-flex align-items-center justify-content-center text-muted small fw-bold";
                moreDiv.textContent = "+" + remaining;
                container.appendChild(moreDiv);
            }

            if (typeof bootstrap !== "undefined" && bootstrap.Tooltip) {
                const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
                tooltipTriggerList.forEach(el => {
                    bootstrap.Tooltip.getOrCreateInstance(el);
                });
            }
        }

        async function loadRecruitmentAvatars(talentsItems) {
            try {
                const container = document.getElementById("recruitmentStepAvatars");
                if (!container) return;
                container.innerHTML = "";
                const items = Array.isArray(talentsItems) ? talentsItems : await fetchTalentsItems();
                const rows = [];
                items.forEach(item => {
                    const data = item.data || {};
                    const recruitment = data.recruitment_status || data.recruitment_system || {};
                    const current = normalizeStatus(recruitment.current || "");
                    if (current === "screening" || current === "interview" || current === "decision") {
                        const display = getTalentDisplay(data, item.id);
                        rows.push({
                            id: item.id,
                            name: display.name,
                            avatarUrl: display.photo,
                            createdAt: getTalentCreatedAtDate(data)
                        });
                    }
                });
                rows.sort((a, b) => {
                    const at = a.createdAt instanceof Date && !isNaN(a.createdAt.getTime()) ? a.createdAt.getTime() : 0;
                    const bt = b.createdAt instanceof Date && !isNaN(b.createdAt.getTime()) ? b.createdAt.getTime() : 0;
                    return bt - at;
                });
                renderRadarAvatars(container, rows);
            } catch (error) {
                console.error("Failed to load recruitment avatars:", error);
            }
        }

        async function loadScoutingRadar(startDate, endDate, talentsItems) {
            try {
                const container = document.getElementById('scoutingRadarList');
                const scoutingCountEl = document.getElementById('scoutingCount');
                if (container) container.innerHTML = "";

                if (!container && !scoutingCountEl) return;

                const talents = Array.isArray(talentsItems) ? talentsItems : await fetchTalentsItems();
                const radarTalents = talents.filter(item => {
                    const data = item.data || {};
                    const recruitment = data.recruitment_status || data.recruitment_system || {};
                    return normalizeStatus(recruitment.current || "") === "radar";
                });

                let filteredTalents = radarTalents;
                if (startDate && endDate) {
                    const s = new Date(startDate);
                    const e = new Date(endDate);
                    s.setHours(0, 0, 0, 0);
                    e.setHours(23, 59, 59, 999);
                    filteredTalents = radarTalents.filter(item => {
                        const data = item.data || {};
                        const d = getTalentCreatedAtDate(data);
                        if (!(d instanceof Date) || isNaN(d.getTime())) return false;
                        return d >= s && d <= e;
                    });
                }

                if (scoutingCountEl) {
                    scoutingCountEl.textContent = filteredTalents.length ? String(filteredTalents.length) : "0";
                }

                if (!container || !filteredTalents.length) return;

                const mapped = filteredTalents.map(item => {
                    const basic = item.data.basic_info || {};
                    const scouting = item.data.scouting_info || {};
                    const name = basic.full_name || scouting.full_name || item.data.full_name || "Tanpa Nama";
                    const avatarUrl = basic.avatar_url || item.data.photo || "";
                    return {
                        id: item.id,
                        name,
                        avatarUrl
                    };
                });

                renderRadarAvatars(container, mapped);
            } catch (error) {
                console.error("Failed to load scouting radar talents:", error);
            }
        }

        async function loadInternshipRadar(talentsItems) {
            try {
                const container = document.getElementById("internshipRadarList");
                if (!container) return;
                container.innerHTML = "";
                const talents = Array.isArray(talentsItems) ? talentsItems : await fetchTalentsItems();

                const items = [];
                talents.forEach(item => {
                    const data = item.data || {};
                    const basic = data.basic_info || {};
                    const scouting = data.scouting_info || {};
                    const internship = data.internship || data.internship_info || {};

                    const roleIdRaw = data.role_id || data.roleId || scouting.role_id || internship.role_id || "";
                    const roleNameRaw = data.role_name || data.role || basic.current_role || scouting.role_name || "";
                    const { normalizedRoleId, normalizedRoleName } = normalizeRolePair(roleIdRaw, roleNameRaw);
                    const isInternshipRole = normalizedRoleId === "internship" && normalizedRoleName === "internship";
                    if (!isInternshipRole) return;

                    const name = basic.full_name || scouting.full_name || data.full_name || "Tanpa Nama";
                    const avatarUrl = basic.avatar_url || data.photo || "";
                    items.push({ id: item.id, name, avatarUrl });
                });

                renderRadarAvatars(container, items);
            } catch (error) {
                console.error("Failed to load internship radar talents:", error);
            }
        }

        async function loadMentorRadar(talentsItems) {
            try {
                const container = document.getElementById("mentorRadarList");
                if (!container) return;
                container.innerHTML = "";
                const talents = Array.isArray(talentsItems) ? talentsItems : await fetchTalentsItems();

                const items = [];
                talents.forEach(item => {
                    const data = item.data || {};
                    const basic = data.basic_info || {};
                    const scouting = data.scouting_info || {};
                    const internship = data.internship || data.internship_info || {};

                    const roleIdRaw = data.role_id || data.roleId || scouting.role_id || internship.role_id || "";
                    const roleNameRaw = data.role_name || data.role || basic.current_role || scouting.role_name || "";
                    const { normalizedRoleId, normalizedRoleName } = normalizeRolePair(roleIdRaw, roleNameRaw);
                    const isMentorRole = normalizedRoleId === "mentor" || normalizedRoleName === "mentor";
                    if (!isMentorRole) return;

                    const name = basic.full_name || scouting.full_name || data.full_name || "Tanpa Nama";
                    const avatarUrl = basic.avatar_url || data.photo || "";
                    items.push({ id: item.id, name, avatarUrl });
                });

                renderRadarAvatars(container, items);
            } catch (error) {
                console.error("Failed to load mentor radar talents:", error);
            }
        }

        async function loadTeamRadar(talentsItems) {
            try {
                const container = document.getElementById("teamRadarList");
                if (!container) return;
                container.innerHTML = "";
                const talents = Array.isArray(talentsItems) ? talentsItems : await fetchTalentsItems();

                const items = [];
                talents.forEach(item => {
                    const data = item.data || {};
                    const basic = data.basic_info || {};
                    const scouting = data.scouting_info || {};
                    const internship = data.internship || data.internship_info || {};

                    const roleIdRaw = data.role_id || data.roleId || scouting.role_id || internship.role_id || "";
                    const roleNameRaw = data.role_name || data.role || basic.current_role || scouting.role_name || "";
                    const { normalizedRoleId, normalizedRoleName } = normalizeRolePair(roleIdRaw, roleNameRaw);
                    const isInternshipRole = normalizedRoleId === "internship" && normalizedRoleName === "internship";
                    const isMentorRole = normalizedRoleId === "mentor" && normalizedRoleName === "mentor";

                    const recruitment = data.recruitment_status || data.recruitment_system || {};
                    const currentStatus = normalizeStatus(recruitment.current || "");
                    const historyArray = Array.isArray(recruitment.history) ? recruitment.history : [];
                    const hasRadarHistory = historyArray.some(entry => normalizeStatus(entry && entry.status) === "radar");
                    const isRadar = currentStatus === "radar" || hasRadarHistory;

                    if (isInternshipRole || isMentorRole || isRadar) return;

                    const name = basic.full_name || scouting.full_name || data.full_name || "Tanpa Nama";
                    const avatarUrl = basic.avatar_url || data.photo || "";
                    items.push({ id: item.id, name, avatarUrl });
                });

                renderRadarAvatars(container, items);
            } catch (error) {
                console.error("Failed to load team radar talents:", error);
            }
        }

        const calendarButton = document.querySelector('.btn-weekly');
        const calendarTextEl = calendarButton ? calendarButton.querySelector('.calendar-text') : null;

        const today = new Date();
        const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
        let rangeStart = startOfMonth;
        let rangeEnd = today;

        function formatDate(date) {
            const options = { day: 'numeric', month: 'short', year: 'numeric' };
            return date.toLocaleDateString('id-ID', options);
        }

        function setModalLoading(title, subtitle) {
            const modalEl = document.getElementById("statsDetailsModal");
            const titleEl = document.getElementById("statsDetailsModalLabel");
            const subtitleEl = document.getElementById("statsDetailsModalSubtitle");
            const countEl = document.getElementById("statsDetailsModalCount");
            const bodyEl = document.getElementById("statsDetailsModalBody");
            if (!modalEl || !titleEl || !subtitleEl || !countEl || !bodyEl) return null;
            titleEl.textContent = title || "Detail";
            subtitleEl.textContent = subtitle || "";
            countEl.textContent = "";
            bodyEl.innerHTML = `
                <div class="d-flex align-items-center gap-2 text-muted">
                    <div class="spinner-border spinner-border-sm" role="status"></div>
                    <div>Loading...</div>
                </div>
            `;
            const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
            modal.show();
            return { bodyEl, countEl };
        }

        function renderModalTable(ctx, columns, rows) {
            const { bodyEl, countEl } = ctx;
            countEl.textContent = `${rows.length} data`;
            if (!rows.length) {
                bodyEl.innerHTML = `<div class="text-muted">Tidak ada data pada rentang tanggal ini.</div>`;
                return;
            }
            const thead = columns.map(c => `<th>${c.label}</th>`).join("");
            const tbody = rows
                .map(r => {
                    const tds = columns
                        .map(c => {
                            if (c.key === "photo") {
                                const src = r.photo || `https://i.pravatar.cc/150?u=${r.id || r.name || "x"}`;
                                return `<td><img class="stats-modal-photo" src="${src}" alt=""></td>`;
                            }
                            const v = (r[c.key] ?? "-").toString();
                            return `<td>${v}</td>`;
                        })
                        .join("");
                    return `<tr>${tds}</tr>`;
                })
                .join("");
            bodyEl.innerHTML = `
                <div class="table-responsive">
                    <table class="table align-middle">
                        <thead><tr>${thead}</tr></thead>
                        <tbody>${tbody}</tbody>
                    </table>
                </div>
            `;
        }

        async function openHeadCountModal() {
            const { s, e } = normalizeRangeDates(rangeStart, rangeEnd);
            const subtitle = s && e ? `${formatDate(s)} - ${formatDate(e)}` : "";
            const ctx = setModalLoading("Head Count (Internship)", subtitle);
            if (!ctx) return;
            try {
                const usersRef = collection(db, "users");
                const q = query(usersRef, where("role", "in", ["Internship", "internship"]));
                const snap = await getDocs(q);
                const rows = [];
                snap.forEach(docSnap => {
                    const data = docSnap.data() || {};
                    const { startDateObj, endDateObj } = getUserInternshipDates(data);
                    if (s && e && !isUserActiveInRange(startDateObj, endDateObj, s, e)) return;
                    rows.push(getUserDisplay(data, docSnap.id));
                });
                renderModalTable(ctx, [
                    { key: "photo", label: "Photo" },
                    { key: "name", label: "Nama" },
                    { key: "role", label: "Role" },
                    { key: "position", label: "Posisi" }
                ], rows);
            } catch (error) {
                ctx.bodyEl.innerHTML = `<div class="text-danger">Gagal memuat data.</div>`;
                console.error(error);
            }
        }

        async function openApplicantsModal() {
            const { s, e } = normalizeRangeDates(rangeStart, rangeEnd);
            const subtitle = s && e ? `${formatDate(s)} - ${formatDate(e)}` : "";
            const ctx = setModalLoading("Applicants (Talents)", subtitle);
            if (!ctx) return;
            try {
                const talentsRef = collection(db, "talents");
                const snap = await getDocs(talentsRef);
                const allowed = new Set(["internship", "mentor", "subteam", "employee", "superteam"]);
                const rows = [];
                snap.forEach(docSnap => {
                    const data = docSnap.data() || {};
                    const createdAt = getTalentCreatedAtDate(data);
                    if (s && e && !isDateInRange(createdAt, s, e)) return;
                    const { roleId, roleName } = getTalentRolePair(data);
                    if (!allowed.has(roleId) && !allowed.has(roleName)) return;
                    rows.push(getTalentDisplay(data, docSnap.id));
                });
                renderModalTable(ctx, [
                    { key: "photo", label: "Photo" },
                    { key: "name", label: "Nama" },
                    { key: "role", label: "Role" },
                    { key: "position", label: "Posisi" }
                ], rows);
            } catch (error) {
                ctx.bodyEl.innerHTML = `<div class="text-danger">Gagal memuat data.</div>`;
                console.error(error);
            }
        }

        async function openOnLeaveModal() {
            const { s, e } = normalizeRangeDates(rangeStart, rangeEnd);
            const subtitle = s && e ? `${formatDate(s)} - ${formatDate(e)}` : "";
            const ctx = setModalLoading("On Leave (Internship)", subtitle);
            if (!ctx) return;
            try {
                const usersRef = collection(db, "users");
                const q = query(usersRef, where("role", "in", ["Internship", "internship"]));
                const snap = await getDocs(q);
                const rows = [];
                const refDate = e || new Date();
                snap.forEach(docSnap => {
                    const data = docSnap.data() || {};
                    const { startDateObj, endDateObj } = getUserInternshipDates(data);
                    if (s && e && !isUserActiveInRange(startDateObj, endDateObj, s, e)) return;
                    const u = { status: data.status || data.internshipStatus || "", startDateObj, endDateObj };
                    const label = getInternshipDisplayStatus(u, refDate).label;
                    if (label !== "On Leave") return;
                    rows.push(getUserDisplay(data, docSnap.id));
                });
                renderModalTable(ctx, [
                    { key: "photo", label: "Photo" },
                    { key: "name", label: "Nama" },
                    { key: "role", label: "Role" },
                    { key: "position", label: "Posisi" }
                ], rows);
            } catch (error) {
                ctx.bodyEl.innerHTML = `<div class="text-danger">Gagal memuat data.</div>`;
                console.error(error);
            }
        }

        async function openScoutingModal() {
            const { s, e } = normalizeRangeDates(rangeStart, rangeEnd);
            const subtitle = s && e ? `${formatDate(s)} - ${formatDate(e)}` : "";
            const ctx = setModalLoading("Scouting (Radar)", subtitle);
            if (!ctx) return;
            try {
                const talentsRef = collection(db, "talents");
                const q = query(talentsRef, where("recruitment_status.current", "==", "radar"));
                const snap = await getDocs(q);
                const rows = [];
                snap.forEach(docSnap => {
                    const data = docSnap.data() || {};
                    const createdAt = getTalentCreatedAtDate(data);
                    if (s && e && !isDateInRange(createdAt, s, e)) return;
                    const d = getTalentDisplay(data, docSnap.id);
                    rows.push({ id: d.id, photo: d.photo, name: d.name });
                });
                renderModalTable(ctx, [
                    { key: "photo", label: "Photo" },
                    { key: "name", label: "Nama" }
                ], rows);
            } catch (error) {
                ctx.bodyEl.innerHTML = `<div class="text-danger">Gagal memuat data.</div>`;
                console.error(error);
            }
        }

        async function openOnboardingModal() {
            const { s, e } = normalizeRangeDates(rangeStart, rangeEnd);
            const subtitle = s && e ? `${formatDate(s)} - ${formatDate(e)}` : "";
            const ctx = setModalLoading("Onboarding (Accepted Talents)", subtitle);
            if (!ctx) return;
            try {
                const talentsRef = collection(db, "talents");
                const snap = await getDocs(talentsRef);
                const rows = [];
                snap.forEach(docSnap => {
                    const data = docSnap.data() || {};
                    const recruitment = data.recruitment_status || data.recruitment_system || {};
                    const current = normalizeStatus(recruitment.current || "");
                    if (current !== "accept" && current !== "accepted") return;
                    const acceptedDate = getAcceptedStatusDate(data);
                    if (!acceptedDate) return;
                    if (s && e && !isDateInRange(acceptedDate, s, e)) return;
                    rows.push(getTalentDisplay(data, docSnap.id));
                });
                renderModalTable(ctx, [
                    { key: "photo", label: "Photo" },
                    { key: "name", label: "Nama" },
                    { key: "role", label: "Role" },
                    { key: "position", label: "Posisi" }
                ], rows);
            } catch (error) {
                ctx.bodyEl.innerHTML = `<div class="text-danger">Gagal memuat data.</div>`;
                console.error(error);
            }
        }

        async function openOffboardingModal() {
            const { s, e } = normalizeRangeDates(rangeStart, rangeEnd);
            const subtitle = s && e ? `${formatDate(s)} - ${formatDate(e)}` : "";
            const ctx = setModalLoading("Offboarding (Graduate Internship)", subtitle);
            if (!ctx) return;
            try {
                const usersRef = collection(db, "users");
                const q = query(usersRef, where("role", "in", ["Internship", "internship"]));
                const snap = await getDocs(q);
                const rows = [];
                const refDate = e || new Date();
                snap.forEach(docSnap => {
                    const data = docSnap.data() || {};
                    const statusRaw = normalizeStatus(data.status || data.internshipStatus || "");
                    const { startDateObj, endDateObj } = getUserInternshipDates(data);
                    if (s && e && !isUserActiveInRange(startDateObj, endDateObj, s, e)) return;
                    const u = { status: data.status || data.internshipStatus || "", startDateObj, endDateObj };
                    const label = getInternshipDisplayStatus(u, refDate).label;
                    const isGraduate = statusRaw === "graduate" || statusRaw === "graduated" || label === "Graduate";
                    if (!isGraduate) return;
                    if (s && e) {
                        if (!(endDateObj instanceof Date) || isNaN(endDateObj.getTime())) return;
                        if (!isDateInRange(endDateObj, s, e)) return;
                    }
                    rows.push(getUserDisplay(data, docSnap.id));
                });
                renderModalTable(ctx, [
                    { key: "photo", label: "Photo" },
                    { key: "name", label: "Nama" },
                    { key: "role", label: "Role" },
                    { key: "position", label: "Posisi" }
                ], rows);
            } catch (error) {
                ctx.bodyEl.innerHTML = `<div class="text-danger">Gagal memuat data.</div>`;
                console.error(error);
            }
        }

        function getTalentPlatformValue(data) {
            const internship = (data && (data.internship || data.internship_info)) || {};
            const scouting = (data && data.scouting_info) || {};
            const raw =
                internship.platform ||
                data.platform ||
                scouting.platform ||
                scouting.source ||
                "";
            return (raw || "").toString().trim();
        }

        function getFirstName(value) {
            const full = (value || "").toString().trim();
            if (!full) return "Tanpa Nama";
            const parts = full.split(/\s+/).filter(Boolean);
            return parts[0] || full;
        }

        function formatLongDate(dateObj) {
            if (!(dateObj instanceof Date) || isNaN(dateObj.getTime())) return "-";
            return dateObj.toLocaleDateString("id-ID", { day: "numeric", month: "long", year: "numeric" });
        }

        function getRoleLabelFromTalent(data) {
            const { roleId, roleName } = getTalentRolePair(data || {});
            const v = roleId || roleName || "";
            if (v === "internship") return "Internship";
            if (v === "mentor") return "Mentor";
            if (v === "subteam") return "Sub Team";
            if (v === "superteam") return "Super Team";
            if (v === "employee") return "Employee";
            return (data && (data.role_name || data.role)) || "-";
        }

        function getRoleBadgeHtml(roleLabel) {
            const label = (roleLabel || "-").toString();
            const key = normalizeCompact(label);
            let cls = "bg-secondary-subtle text-secondary";
            if (key === "internship") cls = "bg-primary-subtle text-primary";
            else if (key === "mentor") cls = "bg-warning-subtle text-warning";
            else if (key === "employee") cls = "bg-success-subtle text-success";
            else if (key === "subteam" || key === "superteam") cls = "bg-info-subtle text-info";
            return `<span class="badge ${cls} fw-normal ms-2">${label}</span>`;
        }

        function getInterviewScheduleDate(data) {
            const recruitment = (data && (data.recruitment_status || data.recruitment_system)) || {};
            const raw =
                recruitment.due_date ||
                recruitment.dueDate ||
                recruitment.interview_date ||
                recruitment.interviewDate ||
                data.interview_date ||
                data.interviewDate ||
                "";
            const fromField = normalizeInternshipDate(raw);
            if (fromField instanceof Date && !isNaN(fromField.getTime())) return fromField;
            const historyArray = Array.isArray(recruitment.history) ? recruitment.history : [];
            const interviewEntries = historyArray.filter(entry => normalizeStatus(entry && entry.status) === "interview");
            if (!interviewEntries.length) return null;
            let latest = null;
            interviewEntries.forEach(entry => {
                const d = normalizeInternshipDate(entry && entry.date);
                if (d instanceof Date && !isNaN(d.getTime())) {
                    if (!latest || d > latest) latest = d;
                }
            });
            return latest;
        }

        function renderUpcomingInterviewList(container, rows) {
            if (!container) return;
            if (!rows.length) {
                container.innerHTML = `<div class="text-muted-custom small">Belum ada upcoming interview.</div>`;
                return;
            }
            container.innerHTML = rows
                .map(r => {
                    const photo = r.photo || `https://i.pravatar.cc/150?u=${r.id || r.name || "x"}`;
                    return `
                        <div class="interview-list-item">
                            <div class="d-flex align-items-center gap-3">
                                <img class="stats-modal-photo" src="${photo}" alt="">
                                <div>
                                    <div class="fw-bold">${r.firstName}${getRoleBadgeHtml(r.roleLabel)}</div>
                                    <div class="text-muted-custom small">${r.position}  ${formatLongDate(r.dateObj)}</div>
                                </div>
                            </div>
                        </div>
                    `;
                })
                .join("");
        }

        async function loadUpcomingInterviews(startDate, endDate, talentsItems) {
            try {
                const container = document.getElementById("upcomingInterviewList");
                if (!container) return;
                container.innerHTML = "";
                const items = Array.isArray(talentsItems) ? talentsItems : await fetchTalentsItems();
                const { e } = normalizeRangeDates(startDate, endDate);
                const min = e instanceof Date ? new Date(e.getFullYear(), e.getMonth(), e.getDate()) : new Date();
                const list = [];
                items.forEach(item => {
                    const data = item.data || {};
                    const recruitment = data.recruitment_status || data.recruitment_system || {};
                    if (normalizeStatus(recruitment.current || "") !== "interview") return;
                    const interviewDate = getInterviewScheduleDate(data);
                    if (!(interviewDate instanceof Date) || isNaN(interviewDate.getTime())) return;
                    if (interviewDate < min) return;
                    const d = getTalentDisplay(data, item.id);
                    list.push({
                        id: item.id,
                        photo: d.photo,
                        firstName: getFirstName(d.name),
                        roleLabel: getRoleLabelFromTalent(data),
                        position: d.position || "-",
                        dateObj: interviewDate
                    });
                });
                list.sort((a, b) => a.dateObj - b.dateObj);
                renderUpcomingInterviewList(container, list.slice(0, 6));
            } catch (error) {
                console.error("Failed to load upcoming interviews:", error);
            }
        }

        function getPlatformColorClass(platformLabel) {
            const key = normalizeCompact(platformLabel);
            if (key.includes("linkedin")) return "bg-primary";
            if (key.includes("instagram")) return "bg-info";
            if (key.includes("msib")) return "bg-secondary";
            if (key.includes("website")) return "bg-success";
            if (key.includes("other")) return "bg-dark";
            return "bg-primary";
        }

        async function loadPlatformJobposting(startDate, endDate, talentsItems) {
            try {
                const listEl = document.getElementById("platformJobpostingList");
                const totalEl = document.getElementById("platformTotalCandidate");
                if (!listEl || !totalEl) return;
                const items = Array.isArray(talentsItems) ? talentsItems : await fetchTalentsItems();
                const { s, e } = normalizeRangeDates(startDate, endDate);
                const platforms = ["Website Dialogika", "Website MSIB", "LinkedIn", "Instagram", "Other"];
                const counts = {};
                platforms.forEach(p => (counts[p] = 0));
                items.forEach(item => {
                    const data = item.data || {};
                    const createdAt = getTalentCreatedAtDate(data);
                    if (s && e && !isDateInRange(createdAt, s, e)) return;
                    const raw = getTalentPlatformValue(data);
                    if (!raw) return;
                    const match = platforms.find(p => normalizeCompact(p) === normalizeCompact(raw));
                    if (match) counts[match] += 1;
                    else counts["Other"] += 1;
                });
                const total = platforms.reduce((acc, p) => acc + (counts[p] || 0), 0);
                totalEl.textContent = total.toString();
                listEl.innerHTML = platforms
                    .map(p => {
                        const count = counts[p] || 0;
                        const pct = total > 0 ? Math.round((count / total) * 1000) / 10 : 0;
                        const color = getPlatformColorClass(p);
                        return `
                            <div class="mb-3">
                                <div class="d-flex justify-content-between small mb-1">
                                    <span>${p}</span><span>${count}</span>
                                </div>
                                <div class="progress"><div class="progress-bar ${color}" style="width: ${pct}%"></div></div>
                            </div>
                        `;
                    })
                    .join("");
            } catch (error) {
                console.error("Failed to load platform jobposting:", error);
            }
        }

        async function loadRecruitmentNotes() {
            try {
                const textEl = document.getElementById("recruitmentImportantNotesText");
                if (!textEl) return;
                const snap = await getDoc(recruitmentNotesRef);
                if (!snap.exists()) return;
                const data = snap.data() || {};
                const content = (data.content || "").toString().trim();
                if (content) textEl.textContent = content;
            } catch (error) {
                console.error("Failed to load recruitment notes:", error);
            }
        }

        function openRecruitmentNotesModal() {
            const modalEl = document.getElementById("recruitmentNotesModal");
            const inputEl = document.getElementById("recruitmentNotesInput");
            const textEl = document.getElementById("recruitmentImportantNotesText");
            if (!modalEl || !inputEl) return;
            inputEl.value = textEl ? (textEl.textContent || "").trim() : "";
            const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
            modal.show();
        }

        async function saveRecruitmentNotes() {
            const btn = document.getElementById("saveRecruitmentNotesBtn");
            const inputEl = document.getElementById("recruitmentNotesInput");
            const textEl = document.getElementById("recruitmentImportantNotesText");
            const modalEl = document.getElementById("recruitmentNotesModal");
            if (!inputEl || !textEl || !modalEl) return;
            const content = (inputEl.value || "").toString().trim();
            try {
                if (btn) btn.disabled = true;
                await setDoc(recruitmentNotesRef, {
                    content: content || "",
                    updated_at: serverTimestamp(),
                    updated_by: currentUser ? (currentUser.email || currentUser.uid || null) : null
                }, { merge: true });
                textEl.textContent = content || "";
                const modal = bootstrap.Modal.getInstance(modalEl);
                if (modal) modal.hide();
            } catch (error) {
                console.error("Failed to save recruitment notes:", error);
            } finally {
                if (btn) btn.disabled = false;
            }
        }

        function attachRecruitmentNotesHandlers() {
            const editBtn = document.getElementById("editRecruitmentNotesBtn");
            const saveBtn = document.getElementById("saveRecruitmentNotesBtn");
            if (editBtn) editBtn.addEventListener("click", openRecruitmentNotesModal);
            if (saveBtn) saveBtn.addEventListener("click", saveRecruitmentNotes);
        }

        function attachCardOpen(cardId, fn) {
            const el = document.getElementById(cardId);
            if (!el) return;
            el.addEventListener("click", fn);
            el.addEventListener("keydown", e => {
                if (e.key === "Enter" || e.key === " ") {
                    e.preventDefault();
                    fn();
                }
            });
        }

        function attachCardModals() {
            attachCardOpen("headCountCard", openHeadCountModal);
            attachCardOpen("applicantsCard", openApplicantsModal);
            attachCardOpen("onLeaveCard", openOnLeaveModal);
            attachCardOpen("scoutingCard", openScoutingModal);
            attachCardOpen("onboardingCard", openOnboardingModal);
            attachCardOpen("offboardingCard", openOffboardingModal);
        }

        async function refreshDashboard(startDate, endDate) {
            fetchMaxHeadCount();
            await loadOnLeaveCount(startDate, endDate);
            const talentsItems = await fetchTalentsItems();
            await loadApplicantsCount(startDate, endDate, talentsItems);
            loadRecruitmentStats(talentsItems);
            loadRecruitmentAvatars(talentsItems);
            loadScoutingRadar(startDate, endDate, talentsItems);
            loadOnboardingCount(startDate, endDate, talentsItems);
            loadUpcomingInterviews(startDate, endDate, talentsItems);
            loadPlatformJobposting(startDate, endDate, talentsItems);
            loadInternshipRadar(talentsItems);
            loadMentorRadar(talentsItems);
            loadTeamRadar(talentsItems);
        }

        flatpickr("#calendarPicker", {
            mode: "range",
            dateFormat: "Y-m-d",
            positionElement: calendarButton || undefined,
            defaultDate: [startOfMonth, today],
            onChange: (selectedDates) => {
                if (selectedDates.length === 2) {
                    rangeStart = selectedDates[0];
                    rangeEnd = selectedDates[1];
                    if (calendarTextEl) {
                        const startDate = formatDate(rangeStart);
                        const endDate = formatDate(rangeEnd);
                        calendarTextEl.textContent = `${startDate} - ${endDate}`;
                    }
                    refreshDashboard(rangeStart, rangeEnd);
                }
            }
        });

        if (calendarTextEl) {
            calendarTextEl.textContent = `${formatDate(startOfMonth)} - ${formatDate(today)}`;
        }

        attachCardModals();
        attachRecruitmentNotesHandlers();
        updateDateTime();
    </script>
</body>
</html>
